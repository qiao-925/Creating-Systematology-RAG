# Cursor AI Agent 协作规则

> **文档类型**: Cursor Rules 规则文档  
> **版本**: 2.1（精简版）  
> **更新日期**: 2025-11-03

## 💡 使用说明

通过规则约束 Agent 解决实际问题。本文档内容来源于：实践经验总结、工程实践吸纳。发现问题 → 总结规则 → 更新文档 → 同步规则文件。

---

## 📋 文档结构

> **🔵 前置任务** | 任务开始前必须完成
> 
> 📝 **方案讨论**：不要着急修改代码 • 充分讨论 • 主动思考边界  
> 🔍 **需求理解与边界分析**：识别核心功能点 • 明确边界条件 • 识别潜在风险 • 确认可参考实现

> **🟢 任务中的工程实践** | 任务执行过程中必须遵守
> 
> ⚙️ **执行原则**：严格按步骤执行 • 最小改动原则 • 参考现有业务  
> 💻 **代码规范**：详细规范见 [代码规范扩展文档](.cursor/agents-expansion/AGENTS-EXPANSION-CODE_STANDARDS.md) • 核心要求：使用日志代替print • 使用枚举(Enum) • 文件行数限制(300行) • 类型提示 • Docstring • 导入规范 • 命名规范 • 异常处理 • 上下文管理器  
> 🐛 **错误处理与自纠错**：Bug修复策略 • Agent自纠错机制  
> 🤝 **协作与决策**：决策原则 • 协作要点（角色分工 • 协作流程 • 效率优化）

> **🔴 后置任务** | 任务完成后必须执行
> 
> 📋 **任务日志管理**：文件命名规范 • 文档类型 • 日志内容要求  
> ✅ **测试与验证**：代码实现后测试 • Bug修复后验证  
> 📝 **文档更新**：API/架构文档 • 重大功能变更 • 日期处理规范  
> 🔄 **规则文件同步**：全量同步机制 • 同步流程  

---

## 一、🔵 前置任务

> **执行时机**: 任务开始前必须完成

### 方案讨论

当用户要求"先讨论方案"时：

1. **不要着急修改代码** - 直到方案确定才可以修改代码
2. **充分讨论** - 方案讨论需要在我们双方都没疑问的情况下才可以输出具体方案文档
3. **主动思考边界** - 方案评估请**主动思考需求边界，合理质疑当下方案的完善性**

#### 方案文档必需内容

方案文档**必须包含**以下 4 项内容：

1. **重要逻辑的实现思路**
   - 核心算法或设计模式
   - 关键技术选型理由
   - 关键数据流和状态管理

2. **需求按技术实现的依赖关系拆解并排序**
   - 明确依赖关系（A → B → C）
   - 按依赖顺序排列实施步骤
   - 便于渐进式开发

3. **输出修改或新增文件的路径**
   - 列出所有需要修改的文件
   - 列出所有需要新增的文件
   - 说明每个文件的职责

4. **输出测试要点**
   - 单元测试要点
   - 集成测试要点
   - 边界条件测试
   - 异常情况测试
   - 利于需求完成后的自动化测试

---

### 需求理解与边界分析

在开始实施前，必须：

- ✅ 仔细阅读用户需求，识别核心功能点
- ✅ 明确边界条件和约束
- ✅ 识别潜在风险和问题点
- ✅ 确认是否有可参考的现有业务实现

---

## 二、🟢 任务中的工程实践

> **执行时机**: 任务执行过程中必须遵守

### 执行原则

#### 1. 严格按步骤执行

- **每次只专注当前讨论的步骤**
- **不允许跨步骤实现功能**或"顺便"完成其他步骤任务
- **每个步骤完成后必须明确汇报**，等待 Review 确认后才能进入下一步

#### 2. 最小改动原则

- **任何代码修改请始终遵守最小改动原则**
- 除非用户明确要求优化或重构
- 避免"顺便"完成其他任务
- 保持代码变更的原子性

#### 3. 参考现有业务

- 代码实现前先思考哪些业务可以参考或复用
- 尽可能参考现有业务的实现风格
- 避免重复造轮子
- 如果不明确可让用户提供参考示例

---

### 代码规范

> **详细规范**：参见 [代码规范扩展文档](.cursor/agents-expansion/AGENTS-EXPANSION-CODE_STANDARDS.md)

**核心要求**：

- **使用日志代替 print**：所有业务代码必须使用 logging 模块记录日志，禁止使用 print 语句
- **使用枚举（Enum）**：固定常量集合使用枚举类型，提高代码清晰度和类型安全
- **文件行数限制**：所有代码文件不允许超过 300 行，超过必须拆分
- **类型提示**：所有函数必须提供类型提示，使用 `typing` 模块
- **文档字符串（Docstring）**：所有公共函数、类必须有 docstring，使用 Google 或 NumPy 风格
- **导入规范**：标准库 → 第三方库 → 本地模块（三部分，空行分隔）
- **命名规范**：类名（PascalCase）、函数/变量（snake_case）、常量（UPPER_CASE）、私有成员（_prefix）
- **异常处理**：必须使用具体的异常类型，避免裸露的 `except:`，捕获后记录日志或重新抛出
- **上下文管理器**：文件操作和资源管理必须使用 `with` 语句，确保资源正确释放

---

### 错误处理与自纠错

> **详细指南**：参见 [代码错误处理与自纠错指南](.cursor/agents-expansion/AGENTS-EXPANSION-ERROR_HANDLING.md)

**核心原则**（代码层面）：
- **Bug修复策略**：渐进式修复（第一次直接修复 → 第二次分析根本原因 → 超过2次增强诊断）
- **测试驱动验证**：整合测试用例智能选择、自动执行和生成机制
- **项目运行验证**：修复后必须通过测试和项目运行验证
- **Agent自纠错**：错误分类细化（低级/中级/高级/环境级），最多3次自动纠正
- **错误恢复验证**：完整的代码层面、功能层面、日志检查流程

---

### 协作与决策

#### 8. 决策原则

**凡是在方案、编码过程遇到任何争议或不确定，必须在第一时间主动告知我由我做决策**

- ❌ 不要默认采用一种方案实现
- ✅ 重大决策必须让我确认
- ✅ 提供 2-3 个方案供选择
- ✅ 解释每个方案的优劣

#### 9. 协作要点

##### 角色分工

| 任务类型 | Agent 能力 | Human 能力 | 最佳负责人 |
|---------|-----------|-----------|-----------|
| 代码生成 | ⭐⭐⭐⭐⭐ | ⭐⭐ | Agent |
| 代码阅读 | ⭐⭐ | ⭐⭐⭐⭐⭐ | Human |
| 问题诊断 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 协作 |
| 方案决策 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Human |
| 重复任务 | ⭐⭐⭐⭐⭐ | ⭐⭐ | Agent |
| 架构设计 | ⭐⭐ | ⭐⭐⭐⭐⭐ | Human |

##### 协作流程

**理想流程**：
```
1. Human: 提出需求/问题
   ↓
2. Agent: 快速生成方案 A/B/C
   ↓
3. Human: 选择方案（决策点）
   ↓
4. Agent: 实现方案
   ↓
5. Human: 审查代码
   ↓
6. Agent: 根据反馈迭代
```

**关键原则**：Agent 可以自主尝试多次，但关键决策点应该让人类介入

##### Human 应该介入的时刻

- **方案选择** - 多个可行方案，需要权衡
- **架构决策** - 影响长期维护
- **取舍判断** - 例如性能 vs 可维护性
- **风险评估** - 涉及技术债务或临时方案
- **超过 3 次失败** - Agent 尝试多次仍未解决

##### Agent 应该自主完成

- **问题诊断** - 自动尝试多种诊断方法（最多3次）
- **代码实现** - 按既定方案执行
- **测试运行** - 持续验证
- **文档记录** - 记录过程到 agent-task-log/

##### Agent 工作原则

**应该做的**：
- ✅ 主动尝试多种方案（2-3次）
- ✅ 记录所有尝试过程（包括失败的）
- ✅ 提供选项而非单一方案
- ✅ 解释思考过程
- ✅ 一次性诊断所有问题，然后汇报并请求决策

**不应该做的**：
- ❌ 超过 3 次失败应暂停并请求指导
- ❌ 不要过度生成文档
- ❌ 不要隐藏失败的尝试
- ❌ 重大决策不要独断专行
- ❌ 不要每次只问一件事（来回多次）

##### 语言简洁性

**强制要求**：Agent 的语言表达应简单且准确，避免冗余

- 直接说明要点，不重复已说内容
- 使用简洁句式，避免长段落
- 准确表达，避免模糊词汇
- 必要时使用列表、表格等结构化展示

##### 效率优化

- **Agent 应提供完整上下文**：一次性报告所有尝试（成功/失败）和推荐方案
- **Human 应信任 Agent 执行**：在关键点介入，而非每个步骤都干预
- **批量处理**：Agent 自主尝试 2-3 次后再汇报，减少来回沟通

---

## 三、🔴 后置任务

> **执行时机**: 任务完成后必须执行

### 任务日志管理

**所有 AI Agent 执行任务的日志文档都必须保存在 `agent-task-log/` 目录中！**

#### 文件命名规范

```
agent-task-log/YYYY-MM-DD-N_任务名称_文档类型.md
```

**示例**：
- `agent-task-log/2025-10-14-1_RAG推理能力增强_快速摘要.md`
- `agent-task-log/2025-10-14-2_UI布局重构_实施总结.md`

#### 文档类型

- **快速摘要** - 任务的简要总结
- **详细过程** - 完整的实施过程记录
- **实施总结** / **完成总结** - 任务完成后的总结（**必须包含优化分析**）
- **实施方案** - 任务实施前的方案设计

#### 禁止行为

- ❌ 禁止在项目根目录创建任务总结文档
- ❌ 禁止在其他目录创建任务日志
- ❌ 禁止使用其他文件命名格式

#### 日志内容要求

任务日志**必须包含**：

- ✅ 任务开始和结束时间
- ✅ 实施的步骤和关键决策
- ✅ 遇到的问题和解决方案
- ✅ 失败的尝试和原因
- ✅ **优化分析**（完成总结类型必须包含，参考 `post-task-optimization.mdc`）

---

### 测试与验证

#### 代码实现后

- ✅ **必须进行基本测试**
- ✅ 至少验证核心功能正常
- ✅ 检查是否有明显错误

#### Bug 修复后

- ✅ 验证修复效果
- ✅ 主动清除调试日志
- ✅ 确保不影响其他功能

---

### 文档更新

以下情况必须更新文档：

- ✅ 修改了 API 接口 → 更新 `docs/API.md`
- ✅ 修改了架构设计 → 更新 `docs/ARCHITECTURE.md`
- ✅ 重大功能变更 → 更新 `README.md` 或 `CHANGELOG.md`
- ✅ 添加新模块 → 更新 `docs/PROJECT_STRUCTURE.md`

**日期处理规范**：更新文档时必须使用系统当前日期，不要推测日期。更新后需验证日期正确性（参考 `file-organization.mdc`）

**文档长度限制**：

**强制要求**：所有文档文件不允许超过 300 行（与代码文件限制一致）

**主文档特殊规则**：
- ✅ **AGENTS.md 主文档**：允许扩展到 500 行（需用户明确决策确认）
  - AGENTS.md 作为核心规则主文档，保持完整性便于查阅
  - 当前限制：500 行以内
- ✅ **其他文档标准限制**：单个文档必须控制在 300 行以内（强制规定）

**复杂规则独立处理**：
- ✅ **独立原则**：只有**特别大且复杂**的规则才独立出去到 `.cursor/agents-expansion/` 目录
- ✅ **示例**：错误处理与自纠错指南（已独立为 `AGENTS-EXPANSION-ERROR_HANDLING.md`）
- ✅ **主文档保留**：更多内容仍保留在 AGENTS.md 中，通过引用链接到扩展文档
- ✅ **拆分原则**：按主题、模块、职责边界进行合理拆分
- ✅ **目标**：保持文档的可读性和可维护性，避免文档爆炸性增长

**拆分流程**（适用于其他文档，AGENTS.md 除外）：
1. 检测文档行数（超过 300 行时）
2. 主动告知用户文档过长
3. 提供拆分方案建议（按主题/模块拆分）
4. 等待用户确认拆分方案或申请扩展
5. 执行拆分或按用户决策处理

---

### 规则文件同步

**⚠️ 全量同步机制**：当 AGENTS.md 更新时，必须全量同步更新 `.cursor/rules/` 中的对应规则文件

**同步原则**：
- 全量同步：确保所有章节都有对应的规则文件
- 一致性验证：同步后验证内容语义一致

**同步流程**：
1. 检查映射关系（对照 `AGENTS-MAPPING.md`）
2. 更新规则文件（已有文件更新内容，缺失文件创建新文件）
3. 验证一致性（内容、格式、类型）
4. 更新映射文档和规则索引

**同步时机**：立即同步（修改后）| 验证步骤（提交前）| 定期维护（每周）

**Agency 聊天框引用检测**：

当在项目中的 agency 聊天框内引用 AGENTS.md 文件时，必须执行以下检测与更新：

1. **规则检测**：
   - ✅ 检测当前任务是否遵循 AGENTS.md 中定义的规则
   - ✅ 检查当前任务的执行阶段（前置/执行/后置）
   - ✅ 识别可能违反规则的操作或决策

2. **规则更新**：
   - ✅ 如果发现规则不一致，主动提示并建议调整
   - ✅ 如果发现缺失的规则检查项，补充到任务执行中
   - ✅ 确保当前任务的所有步骤符合 AGENTS.md 的要求

3. **执行要求**：
   - ✅ 在引用 AGENTS.md 后，必须立即进行规则检测
   - ✅ 检测结果应明确反馈给用户
   - ✅ 如有需要调整的地方，提供具体的调整建议

**参考文档**：`.cursor/rules/AGENTS-MAPPING.md` | `.cursor/rules/README.md` | `.cursor/rules/agents-sync-workflow.mdc`
