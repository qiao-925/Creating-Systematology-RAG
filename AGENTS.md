# Cursor AI Agent 协作规则

> **文档类型**: Cursor Rules 规则文档  
> **版本**: 2.4（规则执行日志全局任务）  
> **更新日期**: 2025-11-04

## 💡 使用说明

通过规则约束 Agent 解决实际问题。本文档内容来源于：实践经验总结、工程实践吸纳。发现问题 → 总结规则 → 更新文档 → 同步规则文件。

### 规则系统架构

**核心机制**: Agent 驱动的自动规则选择

- **规则选择器**: `.cursor/rules/rule-selector.mdc` 作为"元规则"，指导 Agent 如何根据任务场景自动选择和应用规则
- **三层架构**: Always 规则（核心，6个）→ Auto Attached 规则（文件路径触发，3个）→ Manual 规则（场景驱动，Agent 自动应用）
- **完全自动化**: Agent 根据任务类型自动识别并应用相关规则要求，**用户无需手动 @引用任何规则**
- **规则校验机制**: 任务完成后自动校验关键规则是否被执行，如果未执行则分析原因并立即补救（参见 `.cursor/rules/rule-execution-validator.mdc`）
- **详细说明**: 参见 `.cursor/rules/RULE-SYSTEM-DESIGN.md` 和 `.cursor/rules/README.md`

### 规则系统设计经验与边界

> **核心问题**: 在构建规则系统过程中，我们发现规则失效和 AI 注意力限制是设计规则系统必须考虑的重要边界

**实践经验**: 这是从规则系统构建过程中总结的宝贵经验，需要在设计规则时始终考虑这些限制。

#### ⚠️ 规则失效问题

**现象**: 规则定义后，Agent 可能不执行某些规则，导致规则失效

**根本原因**:
- AI 注意力有限，无法面面俱到
- 规则内容过长，AI 难以关注所有规则
- 规则描述不够清晰，AI 难以理解

**解决方案检查清单**:
- [ ] **规则简洁性** - 单条规则不超过 300 行，核心要求在前 50 行
- [ ] **规则清晰性** - 使用检查清单格式，明确的步骤列表，而非长篇描述
- [ ] **规则分层设计** - 三层架构，减少默认负担
- [ ] **规则选择器** - 运行时动态选择规则，而非全部加载
- [ ] **规则执行校验** - 自动检测规则是否被执行，发现未执行则分析原因并补救

#### ⚠️ AI 注意力限制（最重要）

**核心问题**: AI 的注意力有限，当规则内容过长时，Agent 可能无法面面俱到，导致规则被忽略

**设计原则检查清单**:
- [ ] **控制规则整体量** - Always 规则控制在 6 个以内，总 Always 规则内容控制在 800-1000 行以内
- [ ] **规则描述更清晰** - 使用检查清单格式，明确的步骤列表，避免长篇描述
- [ ] **规则需要更简化** - 核心要求在前，详细说明在后，使用检查清单而非段落描述
- [ ] **规则分层设计** - Always 规则最小化，通过规则选择器自动选择相关规则
- [ ] **规则选择器机制** - 运行时动态选择规则，Agent 根据任务场景自动选择需要的规则

#### 📋 Cursor 规则系统边界

**已知限制**:
- AI 注意力有限，无法同时关注所有规则
- 规则内容过长时，Agent 可能忽略部分规则
- 规则描述抽象时，Agent 难以执行

**设计边界**:
- **规则数量限制**: Always 规则不超过 6 个，单个规则不超过 300 行
- **规则格式要求**: 使用检查清单格式，核心要求在前 50 行
- **规则选择机制**: 必须通过规则选择器动态选择，而非全部加载
- **规则校验机制**: 必须通过规则执行校验确保规则被执行

#### 🎯 规则设计最佳实践

**基于实践经验的规则设计原则**:

- [ ] **简洁性原则** - 规则简洁，核心要求在前，单条规则不超过 300 行
- [ ] **清晰性原则** - 使用检查清单格式，明确的步骤列表，避免长篇描述
- [ ] **分层架构原则** - Always 规则最小化，通过规则选择器自动选择相关规则
- [ ] **动态选择原则** - 运行时动态选择规则，Agent 根据任务场景自动选择
- [ ] **强制校验原则** - 通过规则执行校验机制确保规则被执行
- [ ] **执行日志原则** - 生成规则执行日志，检测规则系统是否良好运行

#### 📚 规则系统演进历程

**问题发现**:
1. 规则失效问题 - 规则定义后，Agent 可能不执行
2. AI 注意力限制 - 规则过长时，Agent 无法面面俱到

**解决方案演进**:
1. **规则简化** - 将长篇描述改为检查清单格式
2. **规则分层** - 三层架构，减少默认负担
3. **规则选择器** - 运行时动态选择规则，智能方案
4. **规则校验** - 自动检测规则执行情况，发现未执行则补救
5. **执行日志** - 生成规则执行日志，持续监控规则系统健康度

**持续优化**:
- 根据规则执行日志分析规则失效原因
- 持续优化规则设计，提高规则可执行性
- 改进规则选择器，提高规则选择准确性

---

## 📋 文档结构

> **🔵 前置任务** | 任务开始前必须完成
> 
> 📝 **方案讨论**：不要着急修改代码 • 充分讨论 • 主动思考边界  
> 🔍 **需求理解与边界分析**：识别核心功能点 • 明确边界条件 • 识别潜在风险 • 确认可参考实现

> **🟢 任务中的工程实践** | 任务执行过程中必须遵守
> 
> ⚙️ **执行原则**：严格按步骤执行 • 最小改动原则 • 参考现有业务  
> 💻 **代码规范**：详细规范见 [代码规范扩展文档](.cursor/agents-expansion/AGENTS-EXPANSION-CODE_STANDARDS.md) • 核心要求：使用日志代替print • 使用枚举(Enum) • 文件行数限制(300行) • 类型提示 • Docstring • 导入规范 • 命名规范 • 异常处理 • 上下文管理器  
> 🐛 **错误处理与自纠错**：Bug修复策略 • Agent自纠错机制  
> 🤝 **协作与决策**：决策原则 • 协作要点（角色分工 • 协作流程 • 效率优化）

> **🔴 后置任务** | 任务完成后必须执行
> 
> 📊 **任务执行汇报**：任务完成后对话框汇报（任务概述 • 关键步骤 • 实施方法 • 测试情况 • 执行结果）  
> 📋 **任务日志管理**：文件命名规范 • 文档类型 • 日志内容要求  
> ✅ **测试与验证**：代码实现后测试 • Bug修复后验证  
> 📝 **文档更新**：API/架构文档 • 重大功能变更 • 日期处理规范  
> 🔄 **规则文件同步**：全量同步机制 • 同步流程  

---

## 一、🔵 前置任务

> **执行时机**: 任务开始前必须完成

### 方案讨论

**⚠️ 强制要求**：当用户要求"先讨论方案"时，必须执行以下检查清单：

#### 方案讨论检查清单

- [ ] **不要着急修改代码** - 直到方案确定才可以修改代码
- [ ] **充分讨论** - 方案讨论需要在我们双方都没疑问的情况下才可以输出具体方案文档
- [ ] **主动思考边界** - 方案评估请**主动思考需求边界，合理质疑当下方案的完善性**

#### 方案文档必需内容检查清单

方案文档**必须包含**以下 4 项内容：

- [ ] **重要逻辑的实现思路**
  - [ ] 核心算法或设计模式
  - [ ] 关键技术选型理由
  - [ ] 关键数据流和状态管理

- [ ] **需求按技术实现的依赖关系拆解并排序**
  - [ ] 明确依赖关系（A → B → C）
  - [ ] 按依赖顺序排列实施步骤
  - [ ] 便于渐进式开发

- [ ] **输出修改或新增文件的路径**
  - [ ] 列出所有需要修改的文件
  - [ ] 列出所有需要新增的文件
  - [ ] 说明每个文件的职责

- [ ] **输出测试要点**
  - [ ] 单元测试要点
  - [ ] 集成测试要点
  - [ ] 边界条件测试
  - [ ] 异常情况测试
  - [ ] 利于需求完成后的自动化测试

---

### 需求理解与边界分析

在开始实施前，必须：

- ✅ 仔细阅读用户需求，识别核心功能点
- ✅ 明确边界条件和约束
- ✅ 识别潜在风险和问题点
- ✅ 确认是否有可参考的现有业务实现

---

## 二、🟢 任务中的工程实践

> **执行时机**: 任务执行过程中必须遵守

### 执行原则

#### ⚠️ 必须遵守的检查清单

- [ ] **严格按步骤执行**
  - [ ] 每次只专注当前讨论的步骤
  - [ ] 不允许跨步骤实现功能或"顺便"完成其他步骤任务
  - [ ] 每个步骤完成后必须明确汇报，等待 Review 确认后才能进入下一步
- [ ] **最小改动原则**
  - [ ] 任何代码修改请始终遵守最小改动原则
  - [ ] 除非用户明确要求优化或重构
  - [ ] 避免"顺便"完成其他任务
  - [ ] 保持代码变更的原子性
- [ ] **参考现有业务**
  - [ ] 代码实现前先思考哪些业务可以参考或复用
  - [ ] 尽可能参考现有业务的实现风格
  - [ ] 避免重复造轮子
  - [ ] 如果不明确可让用户提供参考示例

---

### 代码规范

> **详细规范**：参见 [代码规范扩展文档](.cursor/agents-expansion/AGENTS-EXPANSION-CODE_STANDARDS.md)

**核心要求检查清单**：

- [ ] **使用日志代替 print** - 所有业务代码必须使用 logging 模块记录日志，禁止使用 print 语句
- [ ] **使用枚举（Enum）** - 固定常量集合使用枚举类型，提高代码清晰度和类型安全
- [ ] **文件行数限制** - 所有代码文件不允许超过 300 行，超过必须拆分
- [ ] **类型提示** - 所有函数必须提供类型提示，使用 `typing` 模块
- [ ] **文档字符串（Docstring）** - 所有公共函数、类必须有 docstring，使用 Google 或 NumPy 风格
- [ ] **导入规范** - 标准库 → 第三方库 → 本地模块（三部分，空行分隔）
- [ ] **命名规范** - 类名（PascalCase）、函数/变量（snake_case）、常量（UPPER_CASE）、私有成员（_prefix）
- [ ] **异常处理** - 必须使用具体的异常类型，避免裸露的 `except:`，捕获后记录日志或重新抛出
- [ ] **上下文管理器** - 文件操作和资源管理必须使用 `with` 语句，确保资源正确释放

---

### 错误处理与自纠错

> **详细指南**：参见 [代码错误处理与自纠错指南](.cursor/agents-expansion/AGENTS-EXPANSION-ERROR_HANDLING.md)

**核心原则**（代码层面）：
- **Bug修复策略**：渐进式修复（第一次直接修复 → 第二次分析根本原因 → 超过2次增强诊断）
- **测试驱动验证**：整合测试用例智能选择、自动执行和生成机制
- **项目运行验证**：修复后必须通过测试和项目运行验证
- **Agent自纠错**：错误分类细化（低级/中级/高级/环境级），最多3次自动纠正
- **错误恢复验证**：完整的代码层面、功能层面、日志检查流程

---

### 协作与决策

#### 决策原则检查清单

**⚠️ 强制要求**：凡是在方案、编码过程遇到任何争议或不确定，必须在第一时间主动告知我由我做决策

- [ ] ❌ 不要默认采用一种方案实现
- [ ] ✅ 重大决策必须让我确认
- [ ] ✅ 提供 2-3 个方案供选择
- [ ] ✅ 解释每个方案的优劣

#### 9. 协作要点

##### 角色分工

| 任务类型 | Agent 能力 | Human 能力 | 最佳负责人 |
|---------|-----------|-----------|-----------|
| 代码生成 | ⭐⭐⭐⭐⭐ | ⭐⭐ | Agent |
| 代码阅读 | ⭐⭐ | ⭐⭐⭐⭐⭐ | Human |
| 问题诊断 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 协作 |
| 方案决策 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Human |
| 重复任务 | ⭐⭐⭐⭐⭐ | ⭐⭐ | Agent |
| 架构设计 | ⭐⭐ | ⭐⭐⭐⭐⭐ | Human |

##### 协作流程

**理想流程**：
```
1. Human: 提出需求/问题
   ↓
2. Agent: 快速生成方案 A/B/C
   ↓
3. Human: 选择方案（决策点）
   ↓
4. Agent: 实现方案
   ↓
5. Human: 审查代码
   ↓
6. Agent: 根据反馈迭代
```

**关键原则**：Agent 可以自主尝试多次，但关键决策点应该让人类介入

##### Human 应该介入的时刻

- **方案选择** - 多个可行方案，需要权衡
- **架构决策** - 影响长期维护
- **取舍判断** - 例如性能 vs 可维护性
- **风险评估** - 涉及技术债务或临时方案
- **超过 3 次失败** - Agent 尝试多次仍未解决

##### Agent 应该自主完成

- **问题诊断** - 自动尝试多种诊断方法（最多3次）
- **代码实现** - 按既定方案执行
- **测试运行** - 持续验证
- **文档记录** - 记录过程到 agent-task-log/

##### Agent 工作原则

**应该做的**：
- ✅ 主动尝试多种方案（2-3次）
- ✅ 记录所有尝试过程（包括失败的）
- ✅ 提供选项而非单一方案
- ✅ 解释思考过程
- ✅ 一次性诊断所有问题，然后汇报并请求决策

**不应该做的**：
- ❌ 超过 3 次失败应暂停并请求指导
- ❌ 不要过度生成文档
- ❌ 不要隐藏失败的尝试
- ❌ 重大决策不要独断专行
- ❌ 不要每次只问一件事（来回多次）

##### 语言简洁性

**强制要求**：Agent 的语言表达应简单且准确，避免冗余

- 直接说明要点，不重复已说内容
- 使用简洁句式，避免长段落
- 准确表达，避免模糊词汇
- 必要时使用列表、表格等结构化展示

##### 效率优化

- **Agent 应提供完整上下文**：一次性报告所有尝试（成功/失败）和推荐方案
- **Human 应信任 Agent 执行**：在关键点介入，而非每个步骤都干预
- **批量处理**：Agent 自主尝试 2-3 次后再汇报，减少来回沟通

---

## 三、🔴 后置任务

> **执行时机**: 任务完成后必须执行

### 任务执行汇报

**强制要求**：每个 Agent 任务执行完成后，**第一步**必须在对话框中进行任务执行汇报（不保存为文档）

**目的**：帮助用户快速了解任务进度和整体情况，特别是当执行多个任务时，提供上下文载入

**⚠️ 重要说明**：任务执行汇报是**第一步**，在对话框中即时显示。完成后**必须继续执行第二步**（保存任务日志到 `agent-task-log/` 目录），两者是顺序执行的，不是二选一。

#### 汇报时机

- ✅ **每个任务完成后立即汇报**（不等待所有任务完成）
- ✅ **多个任务场景**：每个任务独立汇报，便于追踪进度
- ✅ **对话上下文**：在 Agent 对话框里直接显示，无需生成文档文件

#### 汇报内容检查清单

任务执行汇报**必须包含**以下 5 项内容：

- [ ] **当前执行的任务是什么**
  - [ ] 任务名称和简要描述
  - [ ] 任务的初始目标和范围

- [ ] **用了哪些关键步骤**
  - [ ] 按顺序列出关键实施步骤
  - [ ] 每个步骤的核心操作

- [ ] **用了什么办法**
  - [ ] 主要技术方案或方法
  - [ ] 关键实现思路和决策点

- [ ] **执行了什么测试**
  - [ ] 测试类型（单元测试/集成测试/手动验证等）
  - [ ] 测试范围（测试了哪些功能/模块）
  - [ ] 测试结果摘要

- [ ] **最后结果如何**
  - [ ] 任务完成状态（✅ 成功 / ⚠️ 部分完成 / ❌ 失败）
  - [ ] 核心成果和产出
  - [ ] 遗留问题或后续建议（如有）

#### 汇报格式要求

- ✅ **简洁清晰**：使用结构化格式（列表、表格等）
- ✅ **重点突出**：突出关键步骤和结果
- ✅ **易于理解**：避免技术术语堆砌，必要时用通俗语言说明

#### 汇报示例模板

```markdown
## 📊 任务执行汇报

**任务名称**: [任务名称]

### 1. 任务概述
- **目标**: [任务目标]
- **范围**: [涉及的功能/模块]

### 2. 关键步骤
1. [步骤1] - [做了什么]
2. [步骤2] - [做了什么]
3. [步骤3] - [做了什么]

### 3. 实施方法
- **技术方案**: [使用的技术/方法]
- **关键决策**: [重要决策点]

### 4. 测试情况
- **测试类型**: [单元测试/集成测试/手动验证]
- **测试范围**: [测试了哪些功能]
- **测试结果**: ✅ 通过 / ⚠️ 部分通过 / ❌ 失败

### 5. 执行结果
- **完成状态**: ✅ 成功
- **核心成果**: [主要产出]
- **遗留问题**: [如有]
```

#### 执行顺序说明

**⚠️ 两个步骤必须顺序执行**：

1. **第一步：任务执行汇报**（当前步骤）
   - 在对话框中即时汇报，用于用户快速了解进度
   - **不保存文件**，仅在对话中显示
   - 完成后**必须继续执行第二步**

2. **第二步：保存任务日志**（见下方"任务日志管理"章节）
   - 保存到 `agent-task-log/` 目录的详细文档
   - **必须保存文件**，提供完整记录和存档
   - 包含更详细的过程、问题和优化分析

**两者关系**：
- 汇报提供快速概览（即时反馈）
- 日志提供详细记录（永久存档）
- **两者缺一不可，顺序执行**

---

### 任务日志管理

**⚠️ 第二步（必须执行）**：所有 AI Agent 执行任务的日志文档都必须保存在 `agent-task-log/` 目录中！

**执行时机**：完成第一步"任务执行汇报"后，**立即执行第二步**保存任务日志。

**⚠️ 规则执行日志（必须）**：每个任务完成后必须生成规则执行日志，检测规则系统是否良好运行。即使没有匹配到任何规则也要记录，以便让用户知道规则系统是生效的（参见下方"规则执行日志"章节）。

#### 文件命名规范

```
agent-task-log/YYYY-MM-DD-N_任务名称_文档类型.md
```

**示例**：
- `agent-task-log/2025-10-14-1_RAG推理能力增强_快速摘要.md`
- `agent-task-log/2025-10-14-2_UI布局重构_实施总结.md`

#### 文档类型

- **快速摘要** - 任务的简要总结
- **详细过程** - 完整的实施过程记录
- **实施总结** / **完成总结** - 任务完成后的总结（**必须包含优化分析**）
- **实施方案** - 任务实施前的方案设计

#### 禁止行为

- ❌ 禁止在项目根目录创建任务总结文档
- ❌ 禁止在其他目录创建任务日志
- ❌ 禁止使用其他文件命名格式

#### 日志内容要求检查清单

任务日志**必须包含**：

- [ ] 任务开始和结束时间
- [ ] 实施的步骤和关键决策
- [ ] 遇到的问题和解决方案
- [ ] 失败的尝试和原因
- [ ] **优化分析**（完成总结类型必须包含，参考 `post-task-optimization.mdc`）
- [ ] **规则执行校验结果**（必须包含，检测规则系统是否良好运行，参考 `rule-execution-validator.mdc`）

---

### 规则执行日志

**⚠️ 全局任务（必须执行）**：每个 Agent 任务完成后必须生成规则执行日志，**即使没有匹配到任何规则也要记录**，以便让用户知道规则系统是生效的。

**执行时机**：任何 Agent 任务完成后立即执行（无论任务类型、无论是否匹配到规则）

**核心目的**：
- **检测规则系统是否良好运行** - 通过日志了解规则是否被执行
- **验证规则系统有效性** - 即使没有匹配到规则，也要记录"没有匹配到任何规则"
- **持续监控规则健康度** - 通过日志分析规则执行情况，发现规则失效问题

#### 规则执行日志检查清单

**每个 Agent 任务完成后必须执行**：

- [ ] **识别任务类型** - 确定任务类型（代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等）
- [ ] **检查规则匹配情况** - 检查哪些规则被应用了
  - [ ] Always 规则（6个核心规则）
  - [ ] Auto Attached 规则（根据文件路径自动附加）
  - [ ] Manual 规则（由规则选择器自动应用）
- [ ] **记录规则执行情况** - 即使没有匹配到任何规则，也要记录"没有匹配到任何规则"
- [ ] **生成规则执行日志文件** - 保存到 `agent-task-log/` 目录
  - 文件命名：`YYYY-MM-DD-N_任务名称_规则执行日志.md`
  - 或作为任务日志的一部分（在完成总结中包含规则执行校验章节）
- [ ] **记录校验统计** - 执行率统计
  - 总规则数（或"未匹配到任何规则"）
  - 已执行数
  - 未执行数（已补救）
  - 执行率（补救前/后）

#### 规则执行日志内容要求

规则执行日志**必须包含**：

- [ ] **任务信息** - 任务名称、任务类型、执行时间
- [ ] **规则匹配情况** - 哪些规则被应用了（或"没有匹配到任何规则"）
- [ ] **规则执行情况** - 每个规则的执行状态（已执行/未执行/已补救）
- [ ] **原因分析** - 如果规则未执行，分析原因
- [ ] **补救措施** - 如果规则未执行，记录补救措施
- [ ] **执行率统计** - 总规则数、已执行数、未执行数、执行率
- [ ] **规则系统健康度评估** - 规则系统是否良好运行

#### 规则执行日志格式模板

```markdown
# 规则执行日志

> **任务名称**: [任务名称]  
> **任务类型**: [代码修改/方案讨论/测试/Bug修复/架构设计/文档更新]  
> **校验日期**: YYYY-MM-DD HH:MM:SS  
> **校验结果**: ✅ 全部通过 / ⚠️ 部分失败（已补救） / ❌ 失败 / ⚠️ 未匹配到任何规则

---

## 📋 规则匹配情况

### Always 规则（6个核心规则）
- [x] rule-selector.mdc - 规则选择器
- [x] python-code-style.mdc - 代码风格
- [x] file-organization.mdc - 文件组织
- [x] development-workflow.mdc - 开发工作流
- [x] collaboration-guidelines.mdc - 协作要点
- [x] agents-sync-workflow.mdc - 规则同步工作流

### Auto Attached 规则（根据文件路径自动附加）
- [x] rag-architecture.mdc - RAG架构规范（编辑 src/business/ 或 src/query/ 时自动附加）
- [ ] modular-design.mdc - 模块化设计（未匹配）
- [ ] testing-standards.mdc - 测试规范（未匹配）

### Manual 规则（由规则选择器自动应用）
- [x] agent-testing-integration-simple.mdc - 测试规则（代码修改任务自动应用）
- [x] task-log-workflow.mdc - 任务日志工作流（任务完成后自动应用）
- [x] rule-execution-validator.mdc - 规则执行校验（任务完成后自动应用）
- [ ] proposal-discussion-workflow.mdc - 方案讨论工作流（未匹配）

**⚠️ 特殊情况**：如果没有匹配到任何规则，必须明确记录：
```
⚠️ **未匹配到任何规则** - 当前任务类型为 [任务类型]，规则选择器未识别到需要应用的规则
- **原因分析**: [分析为什么没有匹配到规则]
- **建议**: [建议是否需要添加新规则或改进规则选择器]
```

---

## 📋 规则执行情况

### ✅ 已执行的规则

| 规则名称 | 执行状态 | 执行时间 | 备注 |
|---------|---------|---------|------|
| 任务日志记录 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | agent-task-log/xxx.md |
| 单元测试验证 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | pytest ✅ 通过 |
| 任务执行汇报 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 已在对话框中汇报 |
| 优化分析 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 识别X个优化点 |

### ❌ 未执行的规则（已补救）

| 规则名称 | 初始状态 | 原因分析 | 补救措施 | 补救时间 | 最终状态 |
|---------|---------|---------|---------|---------|---------|
| 任务日志记录 | ❌ 未执行 | 忘记执行日志记录步骤 | 已创建日志文件 | YYYY-MM-DD HH:MM:SS | ✅ 已补救 |

---

## 📊 校验统计

- **总规则数**: 4
- **已执行**: 3
- **未执行**: 1（已补救）
- **执行率（补救前）**: 75%
- **执行率（补救后）**: 100%

---

## 🔍 原因分析

### 规则未执行的原因

1. **任务日志记录** - 忘记执行日志记录步骤
   - **根本原因**: Agent注意力分散，忽略了规则要求
   - **改进建议**: 增强规则可见性，使用更强烈的视觉标记

---

## 💡 规则系统健康度评估

- **规则执行率**: 100%（补救后）✅
- **规则有效性**: 高 ✅
- **规则系统状态**: 良好运行 ✅
- **需要改进**: 增强规则可见性

---

**日志生成时间**: YYYY-MM-DD HH:MM:SS
```

#### ⚠️ 强制要求

- [ ] **每个 Agent 任务完成后必须生成规则执行日志**（全局任务，无例外）
- [ ] **即使没有匹配到任何规则也要记录** - 明确记录"没有匹配到任何规则"，以便让用户知道规则系统是生效的
- [ ] **日志必须保存到文件** - `agent-task-log/YYYY-MM-DD-N_任务名称_规则执行日志.md` 或作为任务日志的一部分
- [ ] **日志内容完整** - 包含规则匹配情况、执行情况、原因分析、统计信息、健康度评估

#### 禁止行为

- ❌ 不要跳过规则执行日志记录（即使没有匹配到任何规则也要记录）
- ❌ 不要只在对话框中报告而不保存到文件
- ❌ 不要忽略未匹配到规则的情况（必须明确记录）

**详细说明**: 参见 `.cursor/rules/rule-execution-validator.mdc`

---

### 测试与验证

> **详细指南**: 参见 [测试规范扩展文档](.cursor/rules/testing-standards.mdc) 和 [Agent测试整合规则](.cursor/rules/agent-testing-integration.mdc)

#### 代码实现后（强制要求）

- ✅ **必须运行单元测试** - 使用 Mock，无外部依赖
- ✅ **禁止运行集成测试/E2E测试** - 需要环境依赖，由人工处理
- ✅ **使用 Agent 测试工具选择相关测试**（只选择 `tests/unit/` 目录下的测试）
- ✅ 至少验证核心功能正常
- ✅ 检查是否有明显错误
- ✅ **参考 `agent-testing-integration.mdc` 详细流程和检查清单**

#### Bug 修复后

- ✅ 验证修复效果
- ✅ 主动清除调试日志
- ✅ 确保不影响其他功能
- ✅ **运行相关测试确保修复有效**（超过2次失败的修复必须测试）

#### Agent 测试工具使用

Agent 应使用以下工具辅助测试：
- `tests/tools/agent_test_selector.py` - 根据修改的文件选择相关测试
- `tests/tools/agent_test_info.py` - 查询测试详细信息
- `tests/tools/agent_test_summary.py` - 生成测试执行摘要
- `tests/AGENTS-TESTING-INDEX.md` - 测试体系索引文档（Agent 主索引）

---

### 文档更新

以下情况必须更新文档：

- ✅ 修改了 API 接口 → 更新 `docs/API.md`
- ✅ 修改了架构设计 → 更新 `docs/ARCHITECTURE.md`
- ✅ 重大功能变更 → 更新 `README.md` 或 `CHANGELOG.md`
- ✅ 添加新模块 → 更新 `docs/PROJECT_STRUCTURE.md`

**日期处理规范**：更新文档时必须使用系统当前日期，不要推测日期。更新后需验证日期正确性（参考 `file-organization.mdc`）

**文档长度限制**：

**强制要求**：所有文档文件不允许超过 300 行（与代码文件限制一致）

**主文档特殊规则**：
- ✅ **AGENTS.md 主文档**：允许扩展到 500 行（需用户明确决策确认）
  - AGENTS.md 作为核心规则主文档，保持完整性便于查阅
  - 当前限制：500 行以内
- ✅ **其他文档标准限制**：单个文档必须控制在 300 行以内（强制规定）

**复杂规则独立处理**：
- ✅ **独立原则**：只有**特别大且复杂**的规则才独立出去到 `.cursor/agents-expansion/` 目录
- ✅ **示例**：错误处理与自纠错指南（已独立为 `AGENTS-EXPANSION-ERROR_HANDLING.md`）
- ✅ **主文档保留**：更多内容仍保留在 AGENTS.md 中，通过引用链接到扩展文档
- ✅ **拆分原则**：按主题、模块、职责边界进行合理拆分
- ✅ **目标**：保持文档的可读性和可维护性，避免文档爆炸性增长

**拆分流程检查清单**（适用于其他文档，AGENTS.md 除外）：
- [ ] 检测文档行数（超过 300 行时）
- [ ] 主动告知用户文档过长
- [ ] 提供拆分方案建议（按主题/模块拆分）
- [ ] 等待用户确认拆分方案或申请扩展
- [ ] 执行拆分或按用户决策处理

---

### 规则系统与规则选择

**规则选择机制**（核心）：

Agent 必须在执行任务时，根据任务场景自动选择并应用相关规则：

- [ ] **自动识别任务类型**（代码修改/方案讨论/测试/Bug修复/架构设计等）
- [ ] **自动应用规则要求**（根据 `.cursor/rules/rule-selector.mdc` 的场景映射）
- [ ] **自动执行规则步骤**（无需加载规则文件到上下文，直接执行步骤）
- [ ] **自动执行规则校验**（每个任务完成后必须执行，检测规则系统是否良好运行）

**规则类型**：

- **Always 规则**（6个核心规则）：自动加载，包含规则选择器、代码风格、文件组织、开发工作流、协作要点、规则同步工作流
- **Auto Attached 规则**（3个）：根据文件路径自动附加（RAG架构、模块化设计、测试规范）
- **Manual 规则**（场景驱动）：Agent 根据规则选择器的指导自动应用（测试规则、任务日志、方案讨论、优化分析等）

**关键原则**：
- ✅ Agent 自动选择和应用规则，无需用户手动 @引用
- ✅ 规则选择器包含所有场景的规则映射和核心要求
- ✅ Agent 根据映射直接执行步骤，无需加载具体规则文件
- ✅ **规则执行校验**：任务完成后自动校验关键规则是否被执行，如果未执行则分析原因并立即补救

**规则校验机制**：
- **校验时机**: 任何任务完成后自动执行（每个 Agent 任务必须执行）
- **校验内容**: 任务日志记录、单元测试验证、任务执行汇报、优化分析
- **校验目的**: 确保规则系统有效性，防止规则因注意力分散而被忽略
- **规则执行日志**: 每个任务完成后必须生成规则执行日志，检测规则系统是否良好运行
- **详细说明**: 参见 `.cursor/rules/rule-execution-validator.mdc`

**规则设计原则**：
- **简洁性**: 规则简洁，核心要求在前（单条规则不超过 300 行）
- **分层架构**: Always 规则最小化，通过规则选择器自动选择相关规则
- **强制校验**: 通过规则执行校验机制确保规则被执行
- **可执行性**: 使用明确的步骤列表和检查清单
- **考虑AI注意力限制**: 避免规则过长导致注意力分散
- **详细说明**: 参见 `.cursor/rules/RULE-DESIGN-PRINCIPLES.md`

**AGENTS.md 与 Cursor Rules 的关系**：
- **AGENTS.md**: 规则的主文档（source of truth），人类可读的完整规则
- **Cursor Rules** (`.cursor/rules/*.mdc`): AGENTS.md 的结构化规则版本，供 AI 使用
- **关系**: 互补关系，不是覆盖关系。AGENTS.md 提供完整上下文，Cursor Rules 提供可执行的结构化规则
- **同步**: 通过 `agents-sync-workflow.mdc` 确保内容一致

**详细说明**：参见 `.cursor/rules/rule-selector.mdc`、`.cursor/rules/RULE-SYSTEM-DESIGN.md` 和 `.cursor/rules/RULE-DESIGN-PRINCIPLES.md`

---

### 规则文件同步

**⚠️ 全量同步机制**：当 AGENTS.md 更新时，必须全量同步更新 `.cursor/rules/` 中的对应规则文件

**同步原则**：
- 全量同步：确保所有章节都有对应的规则文件
- 一致性验证：同步后验证内容语义一致

**同步流程检查清单**：
- [ ] 检查映射关系（对照 `AGENTS-MAPPING.md`）
- [ ] 更新规则文件（已有文件更新内容，缺失文件创建新文件）
- [ ] 验证一致性（内容、格式、类型）
- [ ] 更新映射文档和规则索引

**同步时机**：立即同步（修改后）| 验证步骤（提交前）| 定期维护（每周）

**Agency 聊天框引用检测**：

当在项目中的 agency 聊天框内引用 AGENTS.md 文件时，必须执行以下检测与更新：

- [ ] **规则检测**
  - [ ] 检测当前任务是否遵循 AGENTS.md 中定义的规则
  - [ ] 检查当前任务的执行阶段（前置/执行/后置）
  - [ ] 识别可能违反规则的操作或决策

- [ ] **规则更新**
  - [ ] 如果发现规则不一致，主动提示并建议调整
  - [ ] 如果发现缺失的规则检查项，补充到任务执行中
  - [ ] 确保当前任务的所有步骤符合 AGENTS.md 的要求

- [ ] **执行要求**
  - [ ] 在引用 AGENTS.md 后，必须立即进行规则检测
  - [ ] 检测结果应明确反馈给用户
  - [ ] 如有需要调整的地方，提供具体的调整建议

**参考文档**：`.cursor/rules/AGENTS-MAPPING.md` | `.cursor/rules/README.md` | `.cursor/rules/agents-sync-workflow.mdc`
