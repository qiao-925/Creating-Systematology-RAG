# AI Agent 协作指南

## ⚠️ 核心规则：任务日志管理

### 任务日志必须保存在 agent-task-log/ 目录

**所有 AI Agent 执行任务的日志文档都必须保存在 `agent-task-log/` 目录中！**

#### 文件命名规范
```
agent-task-log/YYYY-MM-DD-N_任务名称_文档类型.md
```

**示例**：
- `agent-task-log/2025-10-14-1_RAG推理能力增强_快速摘要.md`
- `agent-task-log/2025-10-14-2_UI布局重构_实施总结.md`

#### 文档类型
- **快速摘要** - 任务的简要总结
- **详细过程** - 完整的实施过程记录
- **实施总结** / **完成总结** - 任务完成后的总结
- **实施方案** - 任务实施前的方案设计

#### 禁止行为
- ❌ 禁止在项目根目录创建任务总结文档
- ❌ 禁止在其他目录创建任务日志
- ❌ 禁止使用其他文件命名格式

---

## 🔧 开发规范

### 方案讨论
1. 如果我要求先讨论方案时，**不要着急修改代码**，直到方案确定才可以修改代码
2. 方案讨论需要在我们双方都没疑问的情况下才可以输出具体方案文档
3. 方案评估请**主动思考需求边界，合理质疑当下方案的完善性**
4. 方案需包含：
   - 重要逻辑的实现思路
   - 需求按技术实现的依赖关系拆解并排序
   - 输出修改或新增文件的路径
   - 输出测试要点

### 代码修改
5. **严格按步骤执行**，每次只专注当前讨论的步骤
   - 不允许跨步骤实现功能或"顺便"完成其他步骤任务
   - 每个步骤完成后必须明确汇报，等待 Review 确认后才能进入下一步

6. **最小改动原则** - 任何代码修改请始终遵守最小改动原则，除非我主动要求优化或重构

7. **参考现有业务** - 代码实现请先思考哪些业务可以参考或复用，尽可能参考现有业务的实现风格

8. **Bug修复策略** - 如果超过 2 次修复失败，请主动添加关键日志后再进行尝试修复

9. **使用日志代替print** - **强制要求**：所有业务代码必须使用logging模块记录日志，禁止使用print语句
   - 使用内置的`logging`模块来记录日志，可以控制日志级别、输出格式和输出位置
   - 通过`src.logger.setup_logger`创建日志器，统一管理日志配置
   - 日志级别选择：
     - `logger.info()` - 一般信息性消息（如操作成功、进度信息）
     - `logger.warning()` - 警告消息（如降级处理、配置问题）
     - `logger.error()` - 错误消息（如操作失败、异常情况）
     - `logger.debug()` - 调试信息（如详细步骤、调试输出）
   - 保留print的情况（允许）：
     - 测试代码中的示例输出（如`__main__`块中的测试）
     - 文档示例代码（如docstring中的`>>> print(...)`）
     - 启动脚本中的关键信息输出
   - 所有业务逻辑代码必须使用logger，确保日志可追踪、可配置

10. **使用枚举（Enum）** - 对于固定的常量集合，使用枚举类型可以使代码更清晰、类型安全
   - 使用 `from enum import Enum` 定义枚举类
   - 枚举值应使用清晰的名称，如 `StrategyType`, `ModuleType`
   - 优先使用枚举替代字符串字面量常量

11. **代码文件行数限制** - **强制要求**：所有代码文件不允许超过 300 行
   - 单个文件必须控制在 300 行以内（强制规定）
   - 如果遇到复杂任务，必须拆分成多个文件
   - 拆分原则：按功能模块、职责边界进行合理拆分
   - 目标：保持整个项目的可读性和可维护性

12. **代码注释规范** - **强制要求**：在复杂逻辑处添加注释，解释**为什么这样做**，而不是**做什么**
   - 代码本身已经表明在做什么，注释应该解释设计决策和实现原因
   - 复杂逻辑包括但不限于：
     - 算法选择和实现原因
     - 架构设计决策（如延迟初始化、全局缓存等）
     - 异常处理策略（如为什么捕获所有异常、为什么采用保守策略）
     - 性能优化手段（如为什么使用缓存、为什么延迟加载）
     - 兼容性处理（如为什么支持多种接口、为什么采用适配器模式）
   - 注释示例：
     ```python
     # ❌ 不好的注释（只说明做什么）
     # 创建目录
     self.persist_dir.mkdir(parents=True, exist_ok=True)
     
     # ✅ 好的注释（说明为什么这样做）
     # ChromaDB的PersistentClient要求路径必须存在，否则会抛出异常
     # 使用parents=True确保父目录链也被创建，exist_ok=True避免目录已存在时报错
     self.persist_dir.mkdir(parents=True, exist_ok=True)
     ```
   - 注释目标：帮助其他开发者（包括未来的自己）理解代码的设计意图和实现原因

---

## 🎯 决策原则

**凡是在方案、编码过程遇到任何争议或不确定，必须在第一时间主动告知我由我做决策**

- 不要默认采用一种方案实现
- 重大决策必须让我确认
- 提供 2-3 个方案供选择
- 解释每个方案的优劣

---

## 🤝 协作要点

### Human 应该介入的时刻
1. **方案选择** - 多个可行方案，需要权衡
2. **架构决策** - 影响长期维护
3. **取舍判断** - 例如性能 vs 可维护性
4. **风险评估** - 涉及技术债务或临时方案

### Agent 应该自主完成
1. **问题诊断** - 自动尝试多种诊断方法（但失败 3 次需暂停）
2. **代码实现** - 按既定方案执行
3. **测试运行** - 持续验证
4. **文档记录** - 记录过程到 agent-task-log/

### Agent 工作原则
- ✅ 主动尝试多种方案（2-3次）
- ✅ 记录所有尝试过程（包括失败的）
- ✅ 提供选项而非单一方案
- ✅ 解释思考过程
- ❌ 超过 3 次失败应暂停并请求指导
- ❌ 不要过度生成文档
- ❌ 不要隐藏失败的尝试
- ❌ 重大决策不要独断专行

---

## 📂 项目结构

### 目录用途
- `agent-task-log/` - **所有AI任务日志文档存放处**（重要！）
- `src/` - 源代码
- `docs/` - 项目文档
- `tests/` - 测试代码
- `data/` - 数据文件
- `pages/` - Streamlit多页面应用

### 文档更新规则
- 修改代码后，同步更新相关文档（如 ARCHITECTURE.md、API.md 等）
- 重大变更需在 CHANGELOG.md 中记录
- 技术决策需在 DECISIONS.md 中说明

---

## 🧪 测试规范

- 代码实现完成后需要进行基本测试
- Bug修复超过2次失败时，先添加日志再修复
- 修复完成后主动清除调试日志

---

## 💬 语言规范

- Always respond in Chinese-simplified（始终使用简体中文回复）

---

## 🛡️ Agent 自纠错规则

### 1. 错误检测

#### 1.1 语法错误
- 使用工具: `pylint` 用于 Python 代码, `eslint` 用于 JavaScript 代码
- 规则: 在代码执行前进行静态检查

#### 1.2 逻辑错误
- 使用单元测试: 对每个函数编写单元测试
- 断言: 在关键步骤使用断言

#### 1.3 运行时错误
- 异常捕获: 使用 try-catch 块捕获异常
- 错误代码: 检查系统调用返回的错误代码

#### 1.4 结果验证
- 验证函数: 定义验证函数检查输出是否符合预期
- 数据校验: 检查数据的完整性和一致性

### 2. 错误分类

#### 2.1 严重性级别
- **低级**: 记录日志，继续执行
- **中级**: 尝试自动纠正，最多重试3次
- **高级**: 停止执行，通知用户

### 3. 纠正策略

#### 3.1 重试策略
- 指数退避: 第一次重试等待1秒，第二次2秒，第三次4秒
- 最大重试次数: 3次
- 遵循规则: 超过 3 次失败应暂停并请求指导（参考"Agent 工作原则"）

#### 3.2 参数调整
- 自动调整: 根据错误信息调整参数
- 参数范围: 确保参数在合理范围内

#### 3.3 算法替换
- 备用算法: 当主算法失败时，切换到备用算法
- 方案选择: 提供 2-3 个方案供选择

#### 3.4 回滚操作
- 事务回滚: 对于数据库操作，执行回滚
- 状态恢复: 恢复到操作前的状态

### 4. 重试机制

#### 4.1 重试条件
- **网络错误**: 重试（如 Git push、API 调用失败）
- **资源繁忙**: 重试（如文件锁定、数据库连接）
- **数据错误**: 不重试，需要调整数据（如参数错误、配置问题）

#### 4.2 超时控制
- 每次重试超时: 30秒
- 总超时时间: 不超过 90秒

### 5. 日志和报告

#### 5.1 错误日志
- 记录内容: 错误时间、错误类型、纠正措施、重试次数
- 存储位置: 遵循"任务日志管理"规则，保存到 `agent-task-log/`
- 格式要求: 记录所有尝试过程（包括失败的）

#### 5.2 性能指标
- 记录内容: 纠正耗时、重试次数、成功率
- 用于优化: 分析失败原因，改进策略

#### 5.3 报告原则
- 失败报告: 超过 3 次失败应主动报告用户
- 进度报告: 每次重试后说明当前状态
- 成功率: 跟踪任务成功率，识别问题模式

### 6. 与现有规范的整合

#### 6.1 Bug 修复策略整合
- 先尝试自纠错（最多3次）
- 失败后添加关键日志
- 再尝试修复
- 修复完成后主动清除调试日志

#### 6.2 决策原则整合
- 自纠错失败后，必须主动告知用户
- 提供 2-3 个方案供选择
- 解释每个方案的优劣
- 重大决策必须让用户确认

#### 6.3 协作要点整合
- **Agent 应该自主完成**: 问题诊断（最多3次尝试）
- **Human 应该介入**: 超过3次失败、风险评估、取舍判断
- **Agent 工作原则**: ✅ 主动尝试多种方案 ✅ 记录所有尝试过程

---

**更新日期**: 2025-11-01  
**参考文档**: [人机协作范式](agent-task-log/人机协作范式.md)

