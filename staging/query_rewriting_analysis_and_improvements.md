# Query改写功能分析与改进方案

**创建日期**：2026-01-08  
**文档类型**：技术分析与改进方案  
**相关模块**：`backend/business/rag_engine/processing/query_processor.py`

---

## 1. 当前实现概述

### 1.1 核心功能

**QueryProcessor** 是 RAG 引擎的查询处理模块，负责统一处理意图理解和查询改写。

**主要特性**：
- ✅ 一次 LLM 调用完成意图理解和改写
- ✅ 分层决策：简单查询跳过 LLM，降低成本和延迟
- ✅ LRU 缓存机制（最多100条）
- ✅ 模板文件化：支持从文件加载模板，方便修改
- ✅ 完整的错误处理和降级机制

### 1.2 实现细节

**文件位置**：
- 代码：`backend/business/rag_engine/processing/query_processor.py`
- 模板：`query_rewrite_template.txt`（项目根目录）

**核心流程**：
```
原始查询 → 缓存检查 → 复杂度评估 → LLM处理（意图理解+改写） → 结果验证 → 返回
```

**查询类型**（当前支持）：
- `factual`: 事实查询
- `comparative`: 对比查询
- `explanatory`: 解释性查询
- `exploratory`: 探索性查询
- `specific`: 特定查询

**复杂度评估规则**：
- **简单查询**：长度<30、词数<4、明确关键词、无复杂意图词
- **复杂查询**：长度>100、多个问题、复杂意图词、复合查询、多个分句

---

## 2. 业界最佳实践分析

### 2.1 美团搜索查询改写实现

#### 核心架构

**三层架构**：
```
离线挖掘 → 语义判别 → 在线服务
```

**多策略组合**：
1. **词典改写**：高精度，覆盖头部流量
2. **SMT统计翻译**：中等精度，覆盖中长尾
3. **NMT神经网络翻译**：生成式，覆盖长尾
4. **向量召回**：语义检索，解决模糊匹配

#### 关键技术点

**离线挖掘方法**：
- 搜索日志挖掘：点击共现、Session挖掘、词对齐
- 图方法：SimRank++、DeepWalk、GNN
- 语义向量：fastText、Sentence-BERT、SimCSE

**语义判别模型**：
- BERT句间关系模型（准确率94%+）
- 协同训练（NMT + BERT）
- 负例挖掘（同位词、上下位词）

**在线服务**：
- 高精度词典改写
- SMT + XGBoost排序
- 强化学习优化的NMT
- Sentence-BERT向量召回

#### 可借鉴点

| 技术点 | 优先级 | 实施难度 | 预期收益 |
|--------|--------|---------|---------|
| 多策略分层改写 | 🔴 高 | 中 | 提升覆盖率，降低LLM成本 |
| 语义判别模型 | 🟡 中 | 中 | 提升改写质量，减少漂移 |
| 向量召回改写 | 🟡 中 | 低 | 利用现有基础设施 |
| 数据挖掘积累 | 🟢 低 | 高 | 长期优化 |

### 2.2 腾讯云RAG Query改写最佳实践

#### 核心观点

**Query改写的6种类型**：
1. **上下文依赖型**：依赖对话历史
2. **对比型**：比较两个事物
3. **模糊指代型**：使用代词、口语化
4. **多意图型**：一个查询包含多个问题
5. **反问型**：否定、反问语气
6. **标准型**：常规查询

#### 意图识别驱动的改写流程

```
原始Query → 意图识别 → 选择改写策略 → 生成改写Query
```

**每种类型的专门策略**：
- 上下文依赖：补全上下文信息
- 对比型：添加比较词汇（"与"、"区别"、"对比"）
- 模糊指代：替换为具体术语
- 多意图：分解为多个子查询
- 反问型：转为正向意图

#### 可借鉴点

| 改进点 | 优先级 | 实施难度 | 预期收益 |
|--------|--------|---------|---------|
| 多意图查询分解 | 🔴 高 | 中 | 显著提升多问题查询的召回率 |
| 类型驱动的改写策略 | 🔴 高 | 低 | 提升改写精准度 |
| 上下文依赖处理 | 🟡 中 | 中 | 支持多轮对话 |
| 模糊指代消解 | 🟡 中 | 中 | 提升指代查询的准确性 |

---

## 3. 当前实现的问题分析

### 3.1 已发现的问题

**问题1：改写可能丢失关键信息**
- **现象**：用户查询"从定性到定量的综合集成法如何与马克思主义哲学结合起来理解？"
- **原因**：Prompt未强调必须保留所有关键实体
- **影响**：检索失败，无法找到相关内容

**问题2：缺少多意图查询处理**
- **现象**：多问题查询（如"门票多少钱？需要提前预约吗？"）可能只匹配部分意图
- **原因**：未实现查询分解功能
- **影响**：回答不完整

**问题3：缺少上下文和指代处理**
- **现象**：对话中的"这个"、"那个"等指代无法理解
- **原因**：未处理对话历史
- **影响**：多轮对话效果差

### 3.2 与业界对比的差距

| 维度 | 美团 | 腾讯云建议 | 当前项目 | 差距 |
|------|------|-----------|---------|------|
| 改写策略 | 4种（词典+SMT+NMT+向量） | 6种类型专门策略 | 1种（LLM生成） | 缺少多策略 |
| 查询类型 | - | 6种（含上下文/模糊/多意图/反问） | 5种（基础类型） | 缺少特殊类型 |
| 语义判别 | BERT（94%+） | - | 无独立判别 | 缺少质量保障 |
| 多意图处理 | - | 分解为子查询 | 未处理 | 缺少分解能力 |
| 上下文处理 | - | 补全上下文 | 未处理 | 缺少上下文补全 |

---

## 4. 改进方案

### 4.1 已完成的改进

#### ✅ 模板文件化

**改进内容**：
- 将查询改写模板从代码中独立为文件
- 支持从 `query_rewrite_template.txt` 加载模板
- 支持自定义模板路径
- 支持运行时重新加载模板

**文件位置**：
- 模板文件：`query_rewrite_template.txt`（项目根目录）
- 使用说明：`config/prompts/README.md`

**优势**：
- ✅ 修改模板无需改代码
- ✅ 易于版本控制和协作
- ✅ 向后兼容（文件不存在时使用默认模板）

### 4.2 待实施的改进

#### 🔴 高优先级改进

**1. 优化Prompt强调保留关键实体**

**改进内容**：
- 在模板中明确强调"必须保留所有关键实体"
- 添加关键信息验证机制
- 增强日志输出，记录所有改写查询

**实施步骤**：
1. 修改 `query_rewrite_template.txt`，强化保留实体的要求
2. 添加实体保留验证函数
3. 增强日志输出

**预期收益**：解决改写丢失关键信息的问题

**2. 多意图查询分解**

**改进内容**：
- 检测多意图查询（多个问号、分隔符）
- 将多意图查询分解为多个子查询
- 分别处理每个子查询后合并结果

**实施步骤**：
1. 添加 `_detect_multi_intent()` 方法
2. 添加 `_decompose_multi_intent()` 方法
3. 修改 `process()` 方法支持多意图处理
4. 添加结果合并逻辑

**预期收益**：显著提升多问题查询的召回率和完整性

**3. 扩展查询类型识别**

**改进内容**：
- 增加特殊查询类型：`context_dependent`、`ambiguous_reference`、`multi_intent`、`rhetorical`
- 在模板中添加类型识别指导
- 根据类型应用不同的改写策略

**实施步骤**：
1. 修改模板文件，扩展查询类型说明
2. 更新 `QueryProcessor` 的类型处理逻辑
3. 添加类型特定的改写策略

**预期收益**：提升改写的精准度和覆盖率

#### 🟡 中优先级改进

**4. 上下文依赖处理**

**改进内容**：
- 支持传入对话历史
- 检测上下文依赖查询
- 补全上下文信息到查询中

**实施步骤**：
1. 修改 `process()` 方法，添加 `conversation_history` 参数
2. 添加 `_is_context_dependent()` 检测方法
3. 添加 `_enrich_with_context()` 补全方法

**预期收益**：支持多轮对话，提升用户体验

**5. 模糊指代消解**

**改进内容**：
- 检测模糊指代词（"这个"、"那个"、"它"等）
- 从对话历史中提取指代对象
- 替换为具体实体名称

**实施步骤**：
1. 添加 `_has_ambiguous_reference()` 检测方法
2. 添加 `_resolve_ambiguous_reference()` 消解方法
3. 集成到主处理流程

**预期收益**：提升指代查询的准确性

**6. 语义相似度验证**

**改进内容**：
- 使用现有 embedding 模型计算改写前后的相似度
- 过滤低质量改写（相似度低于阈值）
- 记录验证结果用于优化

**实施步骤**：
1. 创建 `QueryRewritingValidator` 类
2. 使用现有 embedding 模型计算相似度
3. 设置阈值过滤低质量改写

**预期收益**：提升改写质量，减少语义漂移

#### 🟢 低优先级改进（长期）

**7. 词典改写模块**

**改进内容**：
- 构建同义词词典（从历史查询中挖掘）
- 简单查询优先使用词典改写
- 降低 LLM 调用成本

**实施步骤**：
1. 实现数据挖掘工具
2. 构建同义词词典
3. 添加词典改写模块
4. 集成到主处理流程

**预期收益**：降低 LLM 成本，提升简单查询响应速度

**8. 向量召回改写**

**改进内容**：
- 利用现有向量检索基础设施
- 构建改写候选池
- 通过向量检索找到相似查询

**实施步骤**：
1. 从历史查询日志构建候选池
2. 使用现有 embedding 模型向量化
3. 实现向量检索改写模块

**预期收益**：解决模糊匹配问题，提升覆盖率

---

## 5. 实施优先级和时间规划

### 阶段1：快速改进（1-2周）

**目标**：解决当前发现的关键问题

1. ✅ 模板文件化（已完成）
2. 🔴 优化Prompt强调保留关键实体
3. 🔴 多意图查询分解
4. 🔴 扩展查询类型识别

### 阶段2：能力增强（1个月）

**目标**：提升查询改写的覆盖率和准确性

5. 🟡 上下文依赖处理
6. 🟡 模糊指代消解
7. 🟡 语义相似度验证

### 阶段3：长期优化（3-6个月）

**目标**：构建完整的查询改写体系

8. 🟢 词典改写模块
9. 🟢 向量召回改写
10. 🟢 数据挖掘和积累
11. 🟢 强化学习优化（可选）

---

## 6. 技术参考

### 6.1 美团实现参考

**核心架构**：
- 离线挖掘：搜索日志、图方法、语义向量
- 语义判别：BERT句间关系模型（94%+准确率）
- 在线服务：词典+SMT+NMT+向量召回

**关键技术**：
- SimRank++、DeepWalk（图方法）
- Sentence-BERT、SimCSE（向量表示）
- 强化学习优化NMT（RL-based NMT）
- Faiss向量检索

### 6.2 腾讯云实践参考

**核心观点**：
- Query改写的6种类型
- 意图识别驱动的改写流程
- 类型特定的改写策略
- 多意图查询分解

**关键技术**：
- 上下文补全
- 指代消解
- 查询分解
- 意图分类

---

## 7. 总结

### 7.1 当前状态

**已完成**：
- ✅ 查询改写模板文件化
- ✅ 基础意图理解和改写功能
- ✅ 分层决策和缓存机制

**待改进**：
- ❌ 多意图查询处理
- ❌ 上下文和指代处理
- ❌ 语义质量验证
- ❌ 多策略改写

### 7.2 改进方向

**短期（1-2周）**：
- 优化Prompt，强调保留关键实体
- 实现多意图查询分解
- 扩展查询类型识别

**中期（1个月）**：
- 支持上下文依赖处理
- 实现模糊指代消解
- 添加语义相似度验证

**长期（3-6个月）**：
- 构建词典改写模块
- 实现向量召回改写
- 数据挖掘和积累

### 7.3 预期收益

**覆盖率提升**：
- 多意图查询：+30-50%
- 上下文依赖查询：+20-30%
- 模糊指代查询：+15-25%

**质量提升**：
- 改写准确性：+10-15%
- 语义漂移减少：-20-30%

**成本优化**：
- LLM调用减少：-15-25%（通过词典改写）
- 响应速度提升：+20-30%（简单查询）

---

## 8. 相关文件

- **代码实现**：`backend/business/rag_engine/processing/query_processor.py`
- **模板文件**：`query_rewrite_template.txt`
- **使用说明**：`config/prompts/README.md`
- **测试文件**：`tests/unit/test_query_processor.py`

---

## 9. 参考资料

1. **美团搜索查询改写技术**：美团技术团队，2022年
2. **RAG Query改写最佳实践**：腾讯云开发者社区，2025年
3. **Sentence-BERT论文**：Reimers & Gurevych, 2019
4. **SimCSE论文**：Gao et al., 2021

---

**文档版本**：v1.0  
**最后更新**：2026-01-08

