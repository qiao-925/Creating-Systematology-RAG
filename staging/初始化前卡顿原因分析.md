# åˆå§‹åŒ–å‰å¡é¡¿åŸå› åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-01-03  
**é—®é¢˜**: åˆå§‹åŒ–å‰è¿˜ä¼šå¡ä¸€ä¼š

---

## 1. é—®é¢˜å®šä½

### 1.1 å¯åŠ¨æµç¨‹

å¯åŠ¨æµç¨‹å¦‚ä¸‹ï¼š

```
app.py
  â†“
frontend/main.py (å¯¼å…¥æ—¶)
  â†“
configure_all() (ç¬¬9-10è¡Œ)
  â†“
from backend.infrastructure.config import config (ç¬¬13è¡Œ)
  â†“
backend/infrastructure/config/__init__.py
  â†“
config = Config() (ç¬¬14è¡Œ) âš ï¸ ç«‹å³æ‰§è¡Œ
  â†“
Config.__init__() (settings.py ç¬¬102è¡Œ)
  â†“
load_yaml_config() (ç¬¬114è¡Œ) âš ï¸ è¯»å–æ–‡ä»¶
```

### 1.2 å¡é¡¿åŸå› 

åœ¨ `initialize_app()` è°ƒç”¨ä¹‹å‰ï¼Œä»¥ä¸‹æ“ä½œä¼šåœ¨å¯¼å…¥æ—¶æ‰§è¡Œï¼š

1. **`load_dotenv()`**ï¼ˆ`settings.py` ç¬¬26è¡Œï¼‰
   - åœ¨æ¨¡å—çº§åˆ«æ‰§è¡Œ
   - è¯»å– `.env` æ–‡ä»¶
   - è€—æ—¶ï¼š< 0.1ç§’ï¼ˆé€šå¸¸å¾ˆå¿«ï¼‰

2. **`config = Config()`**ï¼ˆ`config/__init__.py` ç¬¬14è¡Œï¼‰
   - åœ¨å¯¼å…¥æ—¶ç«‹å³åˆ›å»º Config å®ä¾‹
   - è§¦å‘ `Config.__init__()` æ‰§è¡Œ

3. **`load_yaml_config()`**ï¼ˆ`Config.__init__()` ç¬¬114è¡Œï¼‰
   - è¯»å– `application.yml` æ–‡ä»¶
   - è§£æ YAML å†…å®¹
   - è€—æ—¶ï¼š0.1-0.5ç§’ï¼ˆå–å†³äºæ–‡ä»¶å¤§å°ï¼‰

4. **Pydantic æ¨¡å‹éªŒè¯**ï¼ˆ`Config.__init__()` ç¬¬118è¡Œï¼‰
   - åˆ›å»º `ConfigModel` å®ä¾‹
   - éªŒè¯é…ç½®æ•°æ®
   - è€—æ—¶ï¼š0.1-0.3ç§’ï¼ˆå–å†³äºé…ç½®å¤æ‚åº¦ï¼‰

5. **å¯èƒ½çš„ GPU æ£€æµ‹**ï¼ˆå¦‚æœè¢«è°ƒç”¨ï¼‰
   - å¯¼å…¥ `torch` åº“
   - æ£€æµ‹ GPU è®¾å¤‡
   - è€—æ—¶ï¼š1-3ç§’ï¼ˆå¦‚æœ torch æœªé¢„åŠ è½½ï¼‰

---

## 2. è¯¦ç»†åˆ†æ

### 2.1 é…ç½®åŠ è½½è€—æ—¶

**æ–‡ä»¶**: `backend/infrastructure/config/settings.py`

```python
# ç¬¬26è¡Œï¼šæ¨¡å—çº§åˆ«æ‰§è¡Œ
load_dotenv()  # è¯»å– .env æ–‡ä»¶

class Config:
    def __init__(self):
        # ç¬¬114è¡Œï¼šè¯»å– YAML æ–‡ä»¶
        yaml_data = load_yaml_config(self.PROJECT_ROOT)
        
        # ç¬¬118è¡Œï¼šPydantic éªŒè¯
        self._model = ConfigModel(**yaml_data)
```

**è€—æ—¶ä¼°ç®—**ï¼š
- `load_dotenv()`: < 0.1ç§’
- `load_yaml_config()`: 0.1-0.5ç§’ï¼ˆæ–‡ä»¶ I/O + YAML è§£æï¼‰
- Pydantic éªŒè¯: 0.1-0.3ç§’
- **æ€»è®¡**: 0.3-0.9ç§’

### 2.2 GPU æ£€æµ‹è€—æ—¶ï¼ˆå¦‚æœè¢«è°ƒç”¨ï¼‰

**æ–‡ä»¶**: `backend/infrastructure/config/device.py`

å¦‚æœ `get_gpu_device()` åœ¨å¯¼å…¥æ—¶è¢«è°ƒç”¨ï¼Œä¼šè§¦å‘ï¼š

```python
def detect_gpu_device():
    import torch  # âš ï¸ å¯¼å…¥ torch å¯èƒ½å¾ˆæ…¢ï¼ˆ1-2ç§’ï¼‰
    _GPU_AVAILABLE = torch.cuda.is_available()  # GPU æ£€æµ‹
    # ...
```

**è€—æ—¶ä¼°ç®—**ï¼š
- å¯¼å…¥ `torch`: 1-3ç§’ï¼ˆå¦‚æœæœªé¢„åŠ è½½ï¼‰
- GPU æ£€æµ‹: 0.1-0.5ç§’
- **æ€»è®¡**: 1.1-3.5ç§’

### 2.3 å…¶ä»–å¯èƒ½çš„è€—æ—¶æ“ä½œ

1. **å¯¼å…¥å…¶ä»–æ¨¡å—**
   - `backend.infrastructure.logger`ï¼ˆå¦‚æœè¢«å¯¼å…¥ï¼‰
   - `backend.infrastructure.initialization.bootstrap`ï¼ˆå¯¼å…¥æ—¶å¯èƒ½æ‰§è¡Œæ“ä½œï¼‰

2. **Streamlit åˆå§‹åŒ–**
   - `st.set_page_config()`ï¼ˆ`frontend/config.py` ç¬¬63è¡Œï¼‰
   - Streamlit æœ¬èº«çš„å¯åŠ¨å¼€é”€

---

## 3. ä¼˜åŒ–å»ºè®®

### 3.1 å»¶è¿Ÿé…ç½®åŠ è½½ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆ**: å°† `config = Config()` æ”¹ä¸ºå»¶è¿Ÿåˆ›å»º

**ä¿®æ”¹**:
```python
# backend/infrastructure/config/__init__.py

# ä¿®æ”¹å‰
config = Config()

# ä¿®æ”¹å
_config_instance: Optional[Config] = None

def get_config() -> Config:
    """è·å–é…ç½®å®ä¾‹ï¼ˆå»¶è¿Ÿåˆ›å»ºï¼‰"""
    global _config_instance
    if _config_instance is None:
        _config_instance = Config()
    return _config_instance

# ä¸ºäº†å‘åå…¼å®¹ï¼Œæä¾›ä¸€ä¸ªå±æ€§è®¿é—®å™¨
class _ConfigProxy:
    def __getattr__(self, name):
        return getattr(get_config(), name)

config = _ConfigProxy()
```

**æ•ˆæœ**: é…ç½®åªåœ¨é¦–æ¬¡è®¿é—®æ—¶åŠ è½½ï¼Œå¯åŠ¨æ—¶ä¸å†å¡é¡¿

### 3.2 å»¶è¿Ÿ GPU æ£€æµ‹ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆ**: ç¡®ä¿ `detect_gpu_device()` ä¸åœ¨å¯¼å…¥æ—¶è¢«è°ƒç”¨

**æ£€æŸ¥**: ç¡®è®¤æ²¡æœ‰æ¨¡å—åœ¨å¯¼å…¥æ—¶è°ƒç”¨ `get_gpu_device()` æˆ– `detect_gpu_device()`

**æ•ˆæœ**: é¿å…å¯¼å…¥ `torch` çš„è€—æ—¶

### 3.3 ä¼˜åŒ– YAML åŠ è½½ï¼ˆå¯é€‰ï¼‰

**æ–¹æ¡ˆ**: ç¼“å­˜ YAML è§£æç»“æœ

**ä¿®æ”¹**:
```python
_yaml_cache: Optional[Dict[str, Any]] = None

def load_yaml_config(project_root: Path) -> Dict[str, Any]:
    global _yaml_cache
    if _yaml_cache is not None:
        return _yaml_cache
    
    # ... åŠ è½½é€»è¾‘ ...
    _yaml_cache = config
    return config
```

**æ•ˆæœ**: å¤šæ¬¡è®¿é—®é…ç½®æ—¶é¿å…é‡å¤è§£æ

---

## 4. å®æ–½ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰

1. **å»¶è¿Ÿé…ç½®åŠ è½½**
   - å½±å“ï¼šå‡å°‘ 0.3-0.9ç§’å¯åŠ¨æ—¶é—´
   - å®æ–½éš¾åº¦ï¼šä¸­
   - é£é™©ï¼šä½ï¼ˆéœ€è¦ç¡®ä¿å‘åå…¼å®¹ï¼‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰

2. **æ£€æŸ¥ GPU æ£€æµ‹è°ƒç”¨**
   - å½±å“ï¼šå¦‚æœè¢«è°ƒç”¨ï¼Œå‡å°‘ 1-3ç§’å¯åŠ¨æ—¶é—´
   - å®æ–½éš¾åº¦ï¼šä½
   - é£é™©ï¼šä½

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

3. **ä¼˜åŒ– YAML åŠ è½½**
   - å½±å“ï¼šå‡å°‘é‡å¤è§£ææ—¶é—´
   - å®æ–½éš¾åº¦ï¼šä½
   - é£é™©ï¼šä½

---

## 5. æµ‹è¯•æ–¹æ³•

### 5.1 æµ‹é‡å¯¼å…¥è€—æ—¶

```python
import time

start = time.time()
from backend.infrastructure.config import config
elapsed = time.time() - start
print(f"é…ç½®å¯¼å…¥è€—æ—¶: {elapsed:.2f}ç§’")
```

### 5.2 æµ‹é‡å„æ­¥éª¤è€—æ—¶

```python
import time

# 1. load_dotenv
start = time.time()
from dotenv import load_dotenv
load_dotenv()
print(f"load_dotenv: {time.time() - start:.2f}ç§’")

# 2. load_yaml_config
start = time.time()
from backend.infrastructure.config.yaml_loader import load_yaml_config
from pathlib import Path
yaml_data = load_yaml_config(Path(__file__).parent.parent.parent.parent)
print(f"load_yaml_config: {time.time() - start:.2f}ç§’")

# 3. Config åˆ›å»º
start = time.time()
from backend.infrastructure.config.settings import Config
config = Config()
print(f"Configåˆ›å»º: {time.time() - start:.2f}ç§’")
```

---

## 6. ç›¸å…³æ–‡ä»¶

### 6.1 æ¶‰åŠçš„æ–‡ä»¶

- `backend/infrastructure/config/__init__.py`ï¼šé…ç½®æ¨¡å—å…¥å£
- `backend/infrastructure/config/settings.py`ï¼šConfig ç±»å®šä¹‰
- `backend/infrastructure/config/yaml_loader.py`ï¼šYAML åŠ è½½å™¨
- `backend/infrastructure/config/device.py`ï¼šGPU æ£€æµ‹
- `frontend/main.py`ï¼šå¯åŠ¨å…¥å£

### 6.2 å‚è€ƒæ–‡æ¡£

- `staging/å¯åŠ¨è€—æ—¶åˆ†ææŠ¥å‘Š.md`ï¼šå¯åŠ¨è€—æ—¶åˆ†æ
- `staging/å»¶è¿ŸåŠ è½½ä¼˜åŒ–å®æ–½æ€»ç»“.md`ï¼šå»¶è¿ŸåŠ è½½ä¼˜åŒ–è®°å½•

---

**æœ€åæ›´æ–°**: 2025-01-03  
**ç‰ˆæœ¬**: v1.0

