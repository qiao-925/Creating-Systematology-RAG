# /browser-restart-and-test

## 1. Command Summary
- 目的：重启 Streamlit 应用并在浏览器中测试，验证修复效果或新功能
- 触发时机：代码修复完成后、新功能开发完成后、需要验证更改时
- 关联规则：`browser_visual_editor_integration.mdc`
- 依赖工具：`streamlit`、`@browser`

## 2. 输入
- **无需用户提供**：命令会自动从上下文提取测试内容
- 可选：如用户明确指定测试类型或场景，则优先使用用户输入

## 2.1 上下文自动分析（核心功能）

**Agent 必须自动分析以下上下文来源**：

1. **对话历史**：
   - 最近的修复描述（如"修复主题配置"、"修复控制台错误"）
   - 用户提到的修改内容
   - 修复完成后的总结

2. **代码变更**：
   - 最近修改的文件列表
   - 文件变更内容（通过 git diff 或文件读取）
   - 修改类型（CSS、配置、功能等）

3. **修复描述**：
   - 用户提供的修复总结
   - 修复涉及的功能点
   - 修复目标（如"减少控制台错误"）

4. **文件内容**：
   - 修改的文件内容
   - 相关的配置文件
   - 样式文件变更

**自动生成测试场景**：
- 根据修复内容自动识别验证点
- 根据修改的文件类型选择测试类型
- 根据修复描述生成测试步骤

## 3. 执行步骤

### 3.1 上下文分析（第一步，必须执行）

**自动分析上下文，提取测试内容**：

1. **分析对话历史**：
   - 查找最近的修复描述、修改内容
   - 提取修复涉及的功能点
   - 识别修复目标（如"减少控制台错误"、"修复主题配置"）

2. **分析代码变更**：
   ```bash
   # 检查最近修改的文件
   git diff --name-only HEAD
   # 或读取最近修改的文件内容
   ```
   - 识别修改的文件类型（`.py`、`.toml`、`.css` 等）
   - 分析修改内容（主题配置、CSS 样式、功能代码等）

3. **生成测试场景**：
   - **主题/配置修复** → 验证主题配置、检查控制台错误
   - **CSS 样式修复** → 验证样式应用、视觉检查
   - **功能修复** → 功能测试、交互验证
   - **JavaScript 修复** → 控制台错误检查、功能验证

4. **生成验证点列表**：
   - 根据修复内容自动生成验证点
   - 标记必须验证的关键点
   - 准备测试步骤

**输出**：
- 识别的修复类型
- 生成的测试场景
- 验证点列表

### 3.2 应用重启
1. **停止现有应用**（如运行中）：
   - 检查端口占用（默认 8501）
   - 如发现运行中的应用，提示用户确认停止
   - 停止现有进程

2. **启动应用**：
   ```bash
   uv run --no-sync python -m streamlit run app.py --server.port <port> --server.headless true
   ```
   - 等待应用启动完成（最多等待 15 秒）
   - 验证应用是否正常启动（检查健康状态）

3. **打开浏览器**：
   - 使用 `@browser` 打开 `http://localhost:<port>`
   - 等待页面加载完成
   - 截图记录初始状态

4. **执行测试**（根据上下文分析结果）：
   - **自动选择测试类型**（基于修复内容）：
     - **主题/配置修复** → 验证主题配置、检查控制台错误
     - **CSS 样式修复** → 验证样式应用、视觉检查
     - **功能修复** → 功能测试、交互验证
     - **JavaScript 修复** → 控制台错误检查、功能验证
   - **执行自动生成的测试场景**：
     - 按照验证点列表逐一检查
     - 执行相关功能测试
     - 检查控制台错误（过滤已知警告）
   - **视觉测试**（如涉及样式）：
     - 截图记录当前状态
     - 与基准对比（如存在）

5. **生成测试报告**：
   - 测试结果摘要
   - 控制台错误列表（过滤已知警告）
   - 截图保存路径
   - 验证点检查结果

## 4. 输出

### 4.1 上下文分析结果
- 识别的修复类型
- 生成的测试场景
- 验证点列表

### 4.2 测试执行结果
- 应用重启状态（已停止/已启动）
- 测试执行摘要
- 验证点检查结果（通过/失败）
- 控制台错误分析（过滤已知警告）
- 测试报告路径

## 5. 特殊处理

### 5.1 控制台错误过滤
自动过滤以下已知的 Streamlit 内部警告（不影响功能）：
- 主题颜色配置警告
- Popper.js 修饰符警告
- 元素未找到错误（已知的 Streamlit 内部行为）

### 5.2 验证点自动生成（智能分析）

**Agent 必须根据上下文自动生成验证点**：

**分析修复描述**：
- 如果提到"主题配置修复" → 生成：检查主题配置是否正确应用
- 如果提到"控制台错误减少" → 生成：检查控制台错误是否减少（过滤已知警告）
- 如果提到"CSS 样式修复" → 生成：检查样式是否正确应用、视觉验证
- 如果提到"功能修复" → 生成：测试相关功能是否正常

**分析修改的文件**：
- `.streamlit/config.toml` → 主题配置验证
- `frontend/main.py`（CSS 部分）→ 样式验证、控制台错误检查
- `frontend/components/*.py` → 功能测试、交互验证

**自动生成验证点示例**：
```
修复内容：主题配置修复 + CSS 样式增强 + JavaScript 错误处理

自动生成的验证点：
1. ✅ 检查主题配置是否正确应用（.streamlit/config.toml）
2. ✅ 检查侧边栏样式是否正确（frontend/main.py CSS）
3. ✅ 检查控制台错误是否减少（过滤已知警告）
4. ✅ 验证应用功能是否正常（基本交互测试）
```

## 6. 示例

### 示例 1：自动上下文分析（推荐用法）

**用户场景**：
```
修复完成
1. 主题配置修复
文件：.streamlit/config.toml
添加了侧边栏主题配置，修复颜色警告

2. CSS 样式增强
文件：frontend/main.py
添加侧边栏组件样式，确保颜色正确应用

3. JavaScript 错误处理
文件：frontend/main.py
添加了错误过滤器，静默处理已知的 Streamlit 内部警告

需要我重启应用并重新测试吗？
```

**用户命令**：
```
/browser-restart-and-test
```

**Agent 自动执行**：
1. **上下文分析**：
   - 识别修复内容：主题配置、CSS 样式、JavaScript 错误处理
   - 识别修改文件：`.streamlit/config.toml`、`frontend/main.py`
   - 生成验证点：
     * 检查主题配置是否正确应用
     * 检查侧边栏样式是否正确
     * 检查控制台错误是否减少（过滤已知警告）
     * 验证应用功能是否正常

2. **执行测试**：
   - 停止现有应用
   - 启动新应用
   - 打开浏览器
   - 验证主题配置
   - 验证 CSS 样式
   - 检查控制台错误（过滤已知警告）
   - 基本功能测试
   - 生成测试报告

### 示例 2：用户明确指定（可选）

**用户命令**：
```
/browser-restart-and-test 功能测试 - 测试新的聊天输入功能
```

**执行**：
- 优先使用用户指定的测试类型
- 仍然分析上下文，补充验证点

### 示例 3：无上下文时的默认行为

**用户命令**：
```
/browser-restart-and-test
```

**无明确上下文时**：
- 执行默认测试：功能测试 + 控制台错误检查
- 生成基础测试报告
- 提示用户如有特定验证需求可补充说明

## 7. 与相关命令的区别

| 命令 | 用途 | 区别 |
|------|------|------|
| `/browser-start` | 启动应用（如未运行） | 不停止现有应用 |
| `/browser-restart-and-test` | 重启并测试 | **强制重启**，适合修复后验证 |
| `/browser-test` | 仅测试（应用需运行） | 不重启应用 |

## 8. 使用场景

**适合使用此命令的场景**：
- ✅ **代码修复完成后验证**（最常用，自动分析修复内容）
- ✅ 配置更改后验证（自动识别配置变更）
- ✅ 新功能开发完成后测试（自动识别新功能）
- ✅ 需要确保应用完全重启的场景

**使用方式**：
- **推荐**：直接使用 `/browser-restart-and-test`，Agent 自动分析上下文
- **可选**：如需要特定测试，可补充说明，如 `/browser-restart-and-test 功能测试`

**不适合使用的场景**：
- ❌ 应用已在运行且只需测试（使用 `/browser-test`）
- ❌ 仅需启动应用（使用 `/browser-start`）

## 9. AI Agent 行为要求

### 9.1 必须执行的上下文分析

**执行命令前，Agent 必须**：
1. [ ] 分析对话历史，提取修复描述
2. [ ] 检查最近修改的文件（git diff 或文件读取）
3. [ ] 根据修复内容自动生成测试场景
4. [ ] 生成验证点列表
5. [ ] 选择测试类型（功能/视觉/全部）

### 9.2 禁止行为

- ❌ 要求用户提供测试内容（除非上下文完全缺失）
- ❌ 跳过上下文分析直接执行测试
- ❌ 使用固定的测试场景，不根据修复内容调整
