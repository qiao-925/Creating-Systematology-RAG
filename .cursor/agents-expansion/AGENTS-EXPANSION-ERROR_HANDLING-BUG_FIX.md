# Bug 修复策略详细指南

> **文档类型**: AGENTS 规则扩展文档 - Bug修复策略  
> **版本**: 1.0  
> **更新日期**: 2025-11-03  
> **关联文档**: [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) | [AGENTS.md](../../AGENTS.md) 第234-243行

---

## 📖 文档说明

本文档是**代码错误处理与自纠错指南**的详细子文档，专门针对 **Bug 修复策略（代码层面）**。

---

## 一、错误记录与分类

### 8.1 第一次尝试前必须记录

在修复之前，必须完整记录以下信息：

- **错误类型**：语法错误、逻辑错误、运行时错误、环境错误
- **完整错误堆栈信息**：包含调用链和文件位置
- **修改的文件和代码位置**：精确定位问题代码
- **触发错误的上下文**：
  - 输入数据或参数
  - 操作步骤
  - 相关的配置文件或环境变量

### 错误分类依据

| 错误类型 | 判断标准 | 示例 |
|---------|---------|------|
| **语法错误** | 代码无法解析 | `SyntaxError`, `IndentationError`, `ImportError` |
| **逻辑错误** | 代码可运行但结果不正确 | `AssertionError`, 测试失败, 功能不符合预期 |
| **运行时错误** | 执行过程中异常 | `ValueError`, `KeyError`, `TypeError`, `AttributeError` |
| **环境错误** | 依赖缺失、配置问题 | `ModuleNotFoundError`, 配置文件错误, 权限问题 |

---

## 二、修复流程

### 8.2 第一次尝试：直接修复

根据错误信息直接修复：

- **语法错误**：修复语法问题（括号、缩进、导入等）
- **运行时错误**：添加异常处理或修正逻辑
- **环境错误**：检查依赖和配置

### 第二次尝试：分析根本原因

如果第一次失败，必须：

1. **分析调用链和依赖关系**
   - 查看错误的完整堆栈
   - 检查相关文件和模块
   - 理解数据流和调用关系

2. **分析根本原因**
   - 为什么会出现这个错误？
   - 是否有其他相关的错误？
   - 是否有设计层面的问题？

3. **制定修复方案**
   - 确定修复策略
   - 评估修复的影响范围

### 超过 2 次失败：增强诊断

如果前两次都失败：

1. **主动添加关键日志**
   - 记录关键变量值
   - 记录执行路径
   - 记录函数参数和返回值

2. **再次尝试修复**
   - 基于日志信息重新分析
   - 尝试不同的修复策略

3. **修复验证**（必须）
   - 运行相关测试用例（见测试整合指南）
   - 运行项目验证（见测试整合指南）

4. **清理调试日志**
   - 修复完成后主动清除临时调试日志
   - 保留必要的错误记录（用于后续分析）

---

## 三、修复验证（强制要求）

### 8.3 修复后必须执行验证流程

修复后必须执行验证流程，未通过验证不能视为修复完成。

#### 验证步骤

1. **单元测试验证**
   - 运行修改代码对应的测试用例（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
   - 确保所有相关测试通过

2. **项目运行验证**
   - 尝试启动/运行整个项目（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
   - 验证核心功能正常

3. **日志检查**
   - 确认没有新增错误日志
   - 清除临时调试日志
   - 保留必要的错误记录

#### 验证失败的处理

如果验证失败：
- 返回修复流程（8.2）继续修复
- 如果超过 3 次失败，主动报告用户（见协作要点）

---

## 📋 检查清单

### Bug修复检查清单

- [ ] 错误信息已完整记录（类型、堆栈、位置、上下文）
- [ ] 错误已分类（语法/逻辑/运行时/环境）
- [ ] 已执行修复流程（最多3次）
- [ ] 修复后运行了相关测试用例
- [ ] 修复后运行了项目验证
- [ ] 测试全部通过
- [ ] 调试日志已清除
- [ ] 错误记录已保存到任务日志

---

## 🔗 相关文档

- [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) - 完整指南索引
- [测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md) - 测试验证流程
- [自纠错机制](./AGENTS-EXPANSION-ERROR_HANDLING-SELF_CORRECTION.md) - 自动纠正策略
- [AGENTS.md](../../AGENTS.md) - 主规则文档

---

**最后更新**: 2025-11-03  
**维护者**: 当Bug修复策略更新时，同步更新本文档

