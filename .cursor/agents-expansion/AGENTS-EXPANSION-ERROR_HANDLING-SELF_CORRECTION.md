# Agent 自纠错机制详细指南

> **文档类型**: AGENTS 规则扩展文档 - 自纠错机制  
> **版本**: 1.0  
> **更新日期**: 2025-11-03  
> **关联文档**: [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) | [AGENTS.md](../../AGENTS.md) 第234-243行

---

## 📖 文档说明

本文档是**代码错误处理与自纠错指南**的详细子文档，专门针对 **Agent 自纠错机制（代码层面）**。

---

## 一、错误检测机制

### 9.1 错误检测

#### 语法错误检测

使用静态检查工具：

```bash
# 使用 pylint 检查语法和代码质量
pylint src/xxx.py

# 使用 mypy 进行类型检查
mypy src/xxx.py

# 使用 flake8 检查代码风格
flake8 src/xxx.py
```

**检测时机**：
- 修改代码后自动运行
- 提交代码前必须通过

#### 逻辑错误检测

通过单元测试检测：

- 修改后自动运行相关测试用例（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
- 验证功能正确性
- 验证边界条件

#### 运行时错误检测

通过项目运行验证：

- 尝试启动/运行项目（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
- 捕获异常并记录
- 检查错误日志

#### 结果验证

- ✅ 验证函数返回值是否符合预期
- ✅ 验证输出结果是否正确
- ✅ 验证副作用是否正确（如文件创建、数据库更新）

---

## 二、错误分类标准（细化）

### 9.2 错误分类

| 错误级别 | 判断标准 | 处理策略 | 是否需要用户介入 |
|---------|---------|---------|----------------|
| **低级** | 语法错误、格式问题、警告信息 | 自动修复，记录日志继续 | ❌ 不需要 |
| **中级** | 逻辑错误、测试失败、运行时异常 | 自动纠正最多3次，每次修复后运行测试验证 | ⚠️ 3次失败后需要 |
| **高级** | 架构问题、数据损坏、系统崩溃 | 立即停止并通知用户 | ✅ 立即介入 |
| **环境级** | 依赖缺失、配置错误、权限问题 | 尝试自动修复，失败则报告用户 | ⚠️ 自动修复失败后需要 |

#### 判断依据详解

**低级错误**：
- 仅影响代码格式，不涉及逻辑
- 示例：缩进错误、未使用的导入、代码风格问题
- 处理：自动修复，不影响功能

**中级错误**：
- 影响功能正确性，但可以通过修复代码解决
- 示例：逻辑错误、边界条件未处理、测试失败
- 处理：自动修复，每次修复后运行测试验证

**高级错误**：
- 影响系统稳定性或数据完整性
- 示例：架构设计问题、数据损坏、系统崩溃、安全漏洞
- 处理：立即停止，报告用户，等待决策

**环境级错误**：
- 与运行环境相关，可能无法通过代码修复
- 示例：依赖库缺失、配置文件错误、权限不足、网络问题
- 处理：尝试自动修复（如安装依赖），失败则报告用户

---

## 三、纠正策略（增强）

### 9.3 纠正策略

#### 重试策略

**重试条件**：

- ✅ **可重试**：
  - 网络错误（`ConnectionError`, `TimeoutError`）
  - 资源繁忙（文件锁定、数据库连接超时）
  - 临时性错误（API调用失败、服务暂时不可用）

- ❌ **不可重试**：
  - 数据错误（`ValueError`, 类型错误）
  - 配置错误（需要用户干预）
  - 逻辑错误（需要修复代码）

**重试机制**：
- 指数退避：1秒 → 2秒 → 4秒
- 最大重试次数：3次
- 超过3次暂停并请求指导

**超时控制**：
- 单次操作：30秒
- 总计重试时间：90秒

#### 参数调整

- 自动尝试不同的参数配置
- 记录成功的参数组合
- 用于后续优化

#### 算法替换

- 仅在明确可替换的情况下使用
- 需要评估替换的影响范围
- 替换后必须运行测试验证

#### 回滚操作

- 记录修改前的代码状态（可通过 `git diff`）
- 如果修复失败超过3次，建议回滚
- 回滚后必须运行测试确认状态恢复

---

## 四、错误恢复后的验证流程

### 9.4 验证流程

修复完成后必须执行以下验证：

#### 代码层面验证

- [ ] 运行相关测试用例（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
- [ ] 静态检查通过（pylint、mypy）
- [ ] 代码可以正常导入

#### 功能层面验证

- [ ] 尝试运行项目（见[测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md)）
- [ ] 执行关键操作
- [ ] 验证功能正常

#### 日志检查

- [ ] 清除调试日志
- [ ] 确认没有新增错误日志
- [ ] 保留必要的错误记录

#### 文档更新（如需要）

- [ ] 更新相关API文档（如果是接口变更）
- [ ] 记录到任务日志（`agent-task-log/`）

---

## 五、错误统计与学习机制

### 9.5 错误统计

#### 记录内容

- 错误类型和频率
- 修复方式和成功率
- 测试用例覆盖情况
- 项目运行状态

#### 学习目标

- 识别常见错误模式
- 优化修复策略
- 改进测试覆盖
- 预防性检查（在编码前避免常见错误）

---

## 六、测试驱动的自纠错流程

### 完整工作流

```
修改代码
    ↓
自动运行相关测试用例（测试整合指南）
    ↓
测试通过？ → 是 → 运行项目验证（测试整合指南） → 成功 → 完成
    ↓ 否
分析测试失败原因
    ↓
修复代码（遵循Bug修复策略）
    ↓
重新运行测试（测试整合指南）
    ↓
超过3次失败？ → 是 → 报告用户
    ↓ 否
继续重试
```

### 关键检查点

1. **修改代码后**：立即运行测试
2. **修复错误后**：必须验证测试通过
3. **功能完成后**：运行完整测试套件
4. **项目运行验证**：确保整体正常

---

## 📋 检查清单

### 自纠错检查清单

- [ ] 错误已正确分类（低级/中级/高级/环境级）
- [ ] 已执行相应的纠正策略（重试/调整/替换/回滚）
- [ ] 重试次数未超过限制（最大3次）
- [ ] 错误恢复后已完成验证（代码层面 + 功能层面 + 日志检查）
- [ ] 错误统计已记录（用于学习机制）

---

## 🔗 相关文档

- [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) - 完整指南索引
- [Bug修复策略](./AGENTS-EXPANSION-ERROR_HANDLING-BUG_FIX.md) - 修复流程
- [测试整合指南](./AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md) - 测试验证
- [AGENTS.md](../../AGENTS.md) - 主规则文档

---

**最后更新**: 2025-11-03  
**维护者**: 当自纠错机制更新时，同步更新本文档

