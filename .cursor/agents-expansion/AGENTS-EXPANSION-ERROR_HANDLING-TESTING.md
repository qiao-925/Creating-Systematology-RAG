# 测试整合指南

> **文档类型**: AGENTS 规则扩展文档 - 测试整合  
> **版本**: 1.0  
> **更新日期**: 2025-11-03  
> **关联文档**: [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) | [AGENTS.md](../../AGENTS.md) 第234-243行

---

## 📖 文档说明

本文档是**代码错误处理与自纠错指南**的详细子文档，专门针对**测试用例整合**（智能选择、自动执行、缺失检测与生成、项目运行验证）。

---

## 一、测试用例智能选择与执行

### 8.4 测试用例智能选择与执行

**目标**：自动识别并运行与修改代码相关的测试用例，确保修改不会破坏现有功能。

#### 执行策略

##### 步骤 1: 识别修改范围

记录所有修改的文件路径和范围：
- 修改的文件列表
- 修改的模块和函数
- 修改的代码行号范围

##### 步骤 2: 智能选择测试用例（方案C：混合策略）

**策略 A：基于文件名匹配**（优先级最高）
- `src/indexer.py` → `tests/unit/test_indexer.py`
- `src/query/engine.py` → `tests/unit/test_query_engine.py`

**策略 B：基于导入关系分析**（如果策略A未找到）
- 分析 `import` 语句找到依赖模块
- 运行依赖模块的测试用例

**策略 C：基于模块依赖关系**（补充）
- 识别可能影响的集成测试
- 运行相关功能的端到端测试

**执行顺序**：
1. 优先运行直接对应的单元测试（策略A）
2. 运行相关的集成测试（策略B）
3. 运行可能影响的功能测试（策略C）

##### 步骤 3: 测试执行命令

```bash
# 运行特定文件的测试
pytest tests/unit/test_indexer.py -v

# 运行特定模块的测试（使用关键字匹配）
pytest tests/unit/ -k "indexer" -v

# 运行所有相关测试（根据修改文件智能选择）
pytest tests/unit/ tests/integration/ -v

# 运行特定类或函数的测试
pytest tests/unit/test_indexer.py::TestIndexManager -v
```

##### 步骤 4: 测试结果处理

**测试通过** ✅：
- 继续下一步验证（项目运行验证）

**部分失败** ⚠️：
- 分析失败原因
- **区分类型**：
  - **修改导致的失败**：需要修复代码或测试
  - **原本就失败的测试**：记录但不阻塞（可能需要后续修复）
- 如果所有失败都是新引入的，必须修复

**全部失败** ❌：
- 立即停止，分析根本原因
- 可能需要回滚修改
- 如果超过 3 次修复失败，主动报告用户

#### 测试执行时机

- ✅ 修复Bug后（超过2次失败的修复）
- ✅ 添加新功能后
- ✅ 修改核心逻辑后
- ✅ 代码重构后

---

## 二、测试用例缺失检测与自动生成

### 8.5 测试用例缺失检测与自动生成

**目标**：确保新功能和修改的代码都有对应的测试用例覆盖。

#### 检测时机

- 添加新功能后
- 修改核心逻辑后
- 修复Bug后（如果发现缺少测试覆盖）

#### 检测逻辑（方案C：根据函数签名和文档自动推断）

##### 步骤 1: 检查测试覆盖

1. **新添加的函数是否有对应测试**
   - 检查是否有 `test_函数名` 或 `Test类名` 的测试
   - 检查测试文件是否存在

2. **修改的逻辑是否在测试范围内**
   - 检查修改的函数是否被测试覆盖
   - 检查关键路径是否被测试

3. **关键路径是否被测试覆盖**
   - 正常流程测试
   - 边界条件测试
   - 异常情况测试

##### 步骤 2: 自动生成测试用例（方案A：完整模板）

**检测到缺失时，自动生成基础测试模板**，包含：

**正常流程测试**：
```python
def test_function_normal():
    """测试函数的正常流程"""
    # Arrange
    # Act
    # Assert
    pass
```

**边界条件测试**：
```python
def test_function_edge_cases():
    """测试边界条件"""
    # 空值、None、最大值、最小值等
    pass
```

**异常情况测试**：
```python
def test_function_errors():
    """测试异常情况"""
    # 无效输入、错误参数等
    pass
```

##### 步骤 3: 测试用例生成要求

1. **遵循项目命名规范**
   - 测试文件：`test_*.py`
   - 测试函数：`test_函数名_场景`

2. **使用项目已有的测试工具和fixture**
   - 参考 `tests/conftest.py` 中的fixture
   - 使用项目已有的测试辅助函数

3. **参考现有测试用例的风格和结构**
   - 查看类似功能的测试用例
   - 保持测试风格一致

4. **生成的测试应该可以独立运行**
   - 不依赖外部资源（除非必要）
   - 使用Mock隔离外部依赖

#### 生成示例

如果添加了新函数 `src/query/new_feature.py::process_query`，应自动生成：

```python
# tests/unit/test_new_feature.py
import pytest
from src.query.new_feature import process_query

class TestProcessQuery:
    """测试 process_query 函数"""
    
    def test_process_query_normal(self):
        """测试正常流程"""
        # TODO: 补充测试内容
        pass
    
    def test_process_query_edge_cases(self):
        """测试边界条件"""
        # TODO: 补充测试内容（空值、None等）
        pass
    
    def test_process_query_errors(self):
        """测试异常情况"""
        # TODO: 补充测试内容（无效输入等）
        pass
```

---

## 三、项目整体运行验证

### 8.6 项目整体运行验证（方案B：启动+核心功能）

**目标**：确保修复后项目能够正常运行，核心功能不受影响。

#### 验证时机

- 修复Bug后（超过2次失败的修复）
- 完成功能开发后
- 重大代码修改后

#### 验证方式

##### 1. 启动验证

尝试启动主程序：

```bash
# Streamlit应用
streamlit run app.py

# 或命令行应用
python main.py --help

# 或特定功能
python main.py query --question "test"
```

**检查项**：
- ✅ 启动是否成功（无崩溃、无严重错误）
- ✅ 关键模块是否加载正常（无ImportError）
- ✅ 配置是否正确加载
- ✅ 日志中是否有启动错误

##### 2. 核心功能验证（方案B）

执行关键操作验证核心流程：

**对于RAG项目**：
- ✅ 文档导入功能：尝试导入一个测试文档
- ✅ 查询功能：执行一次查询操作
- ✅ 索引管理：检查索引状态

**通用验证**：
- ✅ 核心业务逻辑能否正常运行
- ✅ 关键API调用是否正常
- ✅ 数据流是否正确

##### 3. 集成验证

验证模块间协作：

- ✅ 模块间调用是否正常
- ✅ 数据流是否正确（输入→处理→输出）
- ✅ 配置和依赖是否正常
- ✅ 是否有运行时错误

#### 验证失败处理

如果验证失败：

1. **记录启动日志和错误信息**
   - 完整错误堆栈
   - 相关配置文件内容
   - 环境信息

2. **分析失败原因**
   - 是否是修复引入的新问题
   - 是否是环境或配置问题
   - 是否是依赖问题

3. **修复或报告**
   - 如果可以修复，返回修复流程（见[Bug修复策略](./AGENTS-EXPANSION-ERROR_HANDLING-BUG_FIX.md)）
   - 如果无法解决，主动报告用户

---

## 📋 检查清单

### 测试整合检查清单

- [ ] 已识别修改的文件范围
- [ ] 已智能选择相关测试用例（文件名匹配 → 导入关系 → 依赖关系）
- [ ] 测试用例已执行
- [ ] 测试结果已分析（区分修改导致的失败 vs 原本失败）
- [ ] 新功能是否缺少测试用例已检查
- [ ] 缺失的测试用例已生成（如需要）
- [ ] 项目可以正常启动
- [ ] 核心功能已验证
- [ ] 没有新增错误日志
- [ ] 集成功能正常

---

## 🔗 相关文档

- [主索引](./AGENTS-EXPANSION-ERROR_HANDLING.md) - 完整指南索引
- [Bug修复策略](./AGENTS-EXPANSION-ERROR_HANDLING-BUG_FIX.md) - 修复流程
- [自纠错机制](./AGENTS-EXPANSION-ERROR_HANDLING-SELF_CORRECTION.md) - 自动纠正
- [AGENTS.md](../../AGENTS.md) - 主规则文档

---

**最后更新**: 2025-11-03  
**维护者**: 当测试整合机制更新时，同步更新本文档

