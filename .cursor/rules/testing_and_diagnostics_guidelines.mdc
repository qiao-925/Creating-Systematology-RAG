# 测试与诊断规范
---
description: 测试与诊断规范 - 代码变更后的测试执行与排障升级流程
alwaysApply: true
---

# 测试与诊断规范

> 适用于代码变更后的测试执行与排障协作，确保结果可靠、补救完整、升级及时。

---

## 1. 适用范围
- 修改 `src/`、`tests/` 或工具脚本后准备交付时。
- 包括新功能、Bug 修复、重构、依赖升级等引起的代码变更。
- 测试过程中出现阻塞、异常或失败需要排查时。

---

## 2. 触发条件
- 代码改动准备交付，需要执行验证测试。
- 测试执行失败、出现异常或用户要求复盘诊断。

---

## 3. 必须执行的命令链
1. `/select-tests`：根据改动文件生成推荐测试列表（失败时人工补充并记录原因）。
2. `/run-unit-tests`：执行推荐测试并按需补充其他用例，记录命令与输出。
3. `/summarize-test-results`：汇总测试命令、通过/失败结果及补救情况。
4. 若测试失败或出现异常：触发 `/auto-diagnose`，进行最多三轮排查并决定补救或升级。

---

## 4. 基线约束
- 单元测试优先于集成/E2E 测试；后者仅在必要时手动执行。
- 测试完成前不得提交交付结果，失败时必须先修复再继续。
- 无法执行测试时，需要说明原因、风险，并给出补测计划。
- 将 `/summarize-test-results` 输出写入任务日志，记录覆盖范围、命令、结论与补救动作。
- `/auto-diagnose` 输出需包含每轮“观察 → 推断 → 操作 → 结果”，并在命令结束后整理总结写入日志。
- 连续三轮排查无果、出现高风险或涉及架构/安全决策时，立即升级给用户，列出尝试方案、风险评估与后续选项。

---

## 5. 协作说明
- 如测试失败或排障需要用户参与，应在日志/对话中提供背景信息与已尝试方案，避免重复操作。
- 补救完成后重新运行相关测试，并更新 `/summarize-test-results` 与 `/auto-diagnose` 记录。

---

## 6. 禁止事项
- ❌ 跳过或延迟单元测试。
- ❌ 在未记录结果的情况下报告测试已完成。
- ❌ 失败后继续提交或进入后续流程。
- ❌ 隐瞒排查尝试或擅自决策重大风险事项。

---

## 7. 关联命令与资料
- 命令：`/select-tests`、`/run-unit-tests`、`/summarize-test-results`、`/auto-diagnose`
- 工具：`tests/tools/agent_test_selector.py`、`tests/tools/agent_test_summary.py`
- 索引：`tests/tools/generate_test_index.py`、`tests/agent/README.md`
- 命令目录：`.cursor/commands/testing_and_diagnostics/`
- 参考：`task_closure_guidelines.mdc`
