---
description: 任务完成后优化分析规则 - 每完成Agent任务后必须进行优化分析
alwaysApply: true
---

# 任务完成后优化分析规则

> **强制要求**：每完成一个 Agent Task，必须分析当前实施后的可优化策略

---

## 🎯 核心原则

**每个任务完成后，不仅要记录完成情况，还要主动思考如何优化改进！**

---

## 📋 触发时机

### 何时进行分析
- ✅ **任务完成后立即进行**（无论是成功、部分完成还是失败）
- ✅ **代码提交前**（确保优化建议被记录）
- ✅ **任务日志记录时**（作为日志的一部分）

### 分析对象
- 本次任务修改的代码
- 本次任务涉及的架构设计
- 本次任务的实施流程
- 本次任务遇到的问题和解决方案

---

## 🔍 分析维度

### 1. 代码质量维度

#### 1.1 代码结构
- **可读性**: 代码是否清晰易懂？
- **可维护性**: 未来修改是否容易？
- **可扩展性**: 是否容易添加新功能？
- **文件大小**: 是否超过300行限制？是否需要拆分？

#### 1.2 代码规范
- **类型提示**: 是否完整？
- **文档字符串**: 是否充分？
- **命名规范**: 是否符合项目约定？
- **导入规范**: 是否符合导入顺序？

**检查清单**:
```markdown
- [ ] 所有函数都有类型提示
- [ ] 所有公共函数都有docstring
- [ ] 文件行数 < 300行
- [ ] 命名符合项目规范
- [ ] 导入顺序正确
```

### 2. 架构设计维度

#### 2.1 模块化程度
- **职责分离**: 是否遵循单一职责原则？
- **耦合度**: 模块间耦合是否过高？
- **可插拔性**: 是否符合模块化设计？
- **接口设计**: 接口是否清晰合理？

#### 2.2 设计模式
- **工厂模式**: 是否需要使用工厂模式？
- **适配器模式**: 是否有接口不匹配问题？
- **观察者模式**: 是否适合使用观察者模式？

**检查清单**:
```markdown
- [ ] 符合三层架构原则（前端→业务→基础设施）
- [ ] 模块职责单一
- [ ] 依赖注入而非全局单例
- [ ] 接口定义清晰
```

### 3. 性能维度

#### 3.1 执行效率
- **时间复杂度**: 是否有性能瓶颈？
- **资源使用**: 内存、CPU使用是否合理？
- **缓存机制**: 是否需要添加缓存？
- **批量处理**: 是否可以批量优化？

#### 3.2 扩展性
- **并发处理**: 是否支持并发？
- **负载处理**: 能否处理大量数据？

**检查清单**:
```markdown
- [ ] 没有明显的性能瓶颈
- [ ] 大数据量测试通过
- [ ] 内存使用合理
- [ ] 支持并发（如需要）
```

### 4. 测试维度

#### 4.1 测试覆盖率
- **单元测试**: 是否覆盖核心逻辑？
- **集成测试**: 是否覆盖关键流程？
- **边界测试**: 是否测试边界条件？
- **异常测试**: 是否测试异常情况？

#### 4.2 测试质量
- **测试隔离**: 测试是否独立？
- **Mock使用**: Mock使用是否合理？
- **断言清晰**: 断言是否有意义？

**检查清单**:
```markdown
- [ ] 核心功能有单元测试
- [ ] 关键流程有集成测试
- [ ] 测试覆盖率 ≥ 目标值
- [ ] 测试独立可重复
```

### 5. 可维护性维度

#### 5.1 文档完整性
- **代码文档**: 是否有足够的注释？
- **架构文档**: 是否更新架构图？
- **API文档**: 是否更新API文档？
- **使用示例**: 是否有使用示例？

#### 5.2 可观测性
- **日志记录**: 关键操作是否有日志？
- **错误追踪**: 错误是否可追踪？
- **性能监控**: 是否有性能指标？

**检查清单**:
```markdown
- [ ] 关键函数有文档说明
- [ ] 架构变更已更新文档
- [ ] 关键操作有日志记录
- [ ] 错误可追踪
```

### 6. 技术债务维度

#### 6.1 临时方案
- **临时方案识别**: 是否有临时解决方案？
- **技术债务记录**: 是否记录了技术债务？
- **重构计划**: 是否有重构计划？

#### 6.2 代码异味
- **重复代码**: 是否有代码重复？
- **复杂度过高**: 是否有过于复杂的逻辑？
- **未使用代码**: 是否有死代码？

**检查清单**:
```markdown
- [ ] 识别了所有临时方案
- [ ] 技术债务已记录
- [ ] 重构计划已制定
- [ ] 没有明显的代码异味
```

---

## 📊 优化策略输出模板

### 模板格式

```markdown
## 🔍 任务优化分析

**任务名称**: [任务名称]  
**分析日期**: YYYY-MM-DD  
**分析范围**: [本次任务修改的文件/模块]

---

### 1. 代码质量分析

#### ✅ 做得好的地方
- [优点1]
- [优点2]

#### ⚠️ 可优化的地方
- **问题1**: [问题描述]
  - **影响**: [影响范围]
  - **优化建议**: [具体建议]
  - **优先级**: 🔴高 / 🟡中 / 🟢低
  
- **问题2**: [问题描述]
  - [同上]

---

### 2. 架构设计分析

#### ✅ 符合规范
- [符合的点]

#### ⚠️ 改进建议
- **建议1**: [架构改进建议]
  - **理由**: [为什么需要改进]
  - **实施难度**: [简单/中等/复杂]
  
---

### 3. 性能分析

#### 📈 性能指标
- [性能指标1]: [当前值]
- [性能指标2]: [当前值]

#### 🚀 优化机会
- **优化1**: [优化建议]
  - **预期提升**: [预期效果]
  - **实施成本**: [成本评估]
  
---

### 4. 测试分析

#### ✅ 测试覆盖情况
- 单元测试: X/Y 个函数
- 集成测试: X/Y 个流程
- 覆盖率: X%

#### 📝 测试改进建议
- [测试改进建议]
  
---

### 5. 可维护性分析

#### ✅ 文档完整性
- [文档情况]

#### 📚 文档改进建议
- [文档改进建议]
  
---

### 6. 技术债务识别

#### 💳 新增技术债务
- **债务1**: [债务描述]
  - **类型**: 临时方案 / 代码异味 / 架构问题
  - **影响范围**: [影响范围]
  - **偿还计划**: [计划]

---

## 🎯 优化优先级排序

### 高优先级（立即处理）🔴
1. [优化项1]
2. [优化项2]

### 中优先级（近期处理）🟡
1. [优化项1]

### 低优先级（长期规划）🟢
1. [优化项1]

---

## 📅 优化计划

### 短期（1周内）
- [ ] [优化项1]
- [ ] [优化项2]

### 中期（1个月内）
- [ ] [优化项1]

### 长期（3个月内）
- [ ] [优化项1]

---

## 💡 经验总结

### 做得好的
- [经验1]
- [经验2]

### 下次改进
- [改进点1]
- [改进点2]
```

---

## 🔄 与任务日志的整合

### 方式1: 作为任务日志的一部分

优化分析可以作为任务日志的固定部分：

```
agent-task-log/YYYY-MM-DD-N_任务名称_完成总结.md

内容结构:
1. 任务概述
2. 实施过程
3. 完成情况
4. **优化分析** ← 新增部分
5. 后续计划
```

### 方式2: 独立的优化分析文档

也可以创建独立的优化分析文档：

```
agent-task-log/YYYY-MM-DD-N_任务名称_优化分析.md
```

### 推荐方式

**推荐方式1**（作为完成总结的一部分），因为：
- ✅ 保持任务完整性
- ✅ 便于回顾和跟踪
- ✅ 减少文件数量

---

## ✅ 验证检查

### 优化分析完整性检查

每个任务完成后，必须完成以下检查：

- [ ] 已完成代码质量分析
- [ ] 已完成架构设计分析
- [ ] 已完成性能分析（如适用）
- [ ] 已完成测试分析
- [ ] 已识别技术债务
- [ ] 已排序优化优先级
- [ ] 已制定优化计划
- [ ] 优化分析已记录到任务日志

---

## 🎯 分析深度要求

### 最小要求（必须）
- ✅ 至少识别 2-3 个可优化点
- ✅ 至少覆盖 3 个分析维度
- ✅ 提供优先级排序
- ✅ 记录技术债务（如有）

### 推荐要求（建议）
- ✅ 覆盖所有 6 个分析维度
- ✅ 提供具体的优化建议（不只是问题描述）
- ✅ 评估优化成本和收益
- ✅ 制定明确的优化计划

---

## 💡 优化分析示例

### 示例1: 代码文件过大

```markdown
#### ⚠️ 可优化的地方

**问题**: `src/indexer.py` 文件超过300行（当前1200行）

- **影响**: 
  - 可读性差
  - 难以维护
  - 违反项目规范
  
- **优化建议**:
  1. 按职责拆分为多个文件：
     - `indexer/index_core.py` - 核心索引逻辑
     - `indexer/index_manager.py` - 索引管理
     - `indexer/index_builder.py` - 构建流程
     - `indexer/index_utils.py` - 工具函数
  2. 保持接口不变，确保向后兼容
  3. 更新导入路径
  
- **优先级**: 🔴 高（违反强制规范）
- **实施成本**: 🟡 中等（需要重构，但结构清晰）
```

### 示例2: 缺少单元测试

```markdown
**问题**: 新增模块缺少单元测试

- **影响**:
  - 无法验证功能正确性
  - 未来重构风险高
  
- **优化建议**:
  1. 为核心函数添加单元测试
  2. 目标覆盖率 ≥ 90%
  3. 测试边界条件和异常情况
  
- **优先级**: 🟡 中（功能正常，但测试不足）
- **实施成本**: 🟢 低（易于补充）
```

---

## 🔗 与其他规则的整合

### 与任务日志工作流的整合
- 优化分析是任务日志完成总结的必需部分
- 参考 `task-log-workflow.mdc`

### 与开发工作流的整合
- 优化建议应该转化为后续任务
- 参考 `development-workflow.mdc`

### 与决策原则的整合
- 重大优化决策需要用户确认
- 参考 `decision-making-principles.mdc`

---

## 📚 相关规则

- 任务日志管理：`task-log-workflow.mdc`
- 开发工作流：`development-workflow.mdc`
- 代码风格规范：`python-code-style.mdc`
- 模块化设计：`modular-design.mdc`
- 测试规范：`testing-standards.mdc`

---

## 🎯 核心要求总结

1. **强制要求**: 每个任务完成后必须进行优化分析
2. **分析维度**: 至少覆盖3个维度，推荐覆盖全部6个维度
3. **输出格式**: 使用标准模板，包含问题、建议、优先级
4. **记录位置**: 作为任务日志的一部分，或独立文档
5. **后续跟踪**: 优化建议应该转化为后续任务

---

**重要**: 优化分析不是可选的，而是每个任务完成后的必需步骤！