---
description: 任务完成后优化分析规则 - 每完成Agent任务后必须进行优化分析
alwaysApply: false
---

# 任务完成后优化分析规则

> **强制要求**：每完成一个 Agent Task，必须分析当前实施后的可优化策略

**⚠️ 重要**: 优化分析是任务日志完成总结的**必需部分**

---

## ✅ 任务完成后必须执行（核心要求，前 50 行）

### 优化分析检查清单

- [ ] **代码质量分析**
  - [ ] 所有函数都有类型提示
  - [ ] 所有公共函数都有docstring
  - [ ] 文件行数 < 300行（如超过需拆分）
  - [ ] 命名符合项目规范
  - [ ] 导入顺序正确
- [ ] **架构设计分析**
  - [ ] 符合三层架构原则（前端→业务→基础设施）
  - [ ] 模块职责单一
  - [ ] 依赖注入而非全局单例
  - [ ] 接口定义清晰
- [ ] **性能分析**（如适用）
  - [ ] 没有明显的性能瓶颈
  - [ ] 大数据量测试通过
  - [ ] 内存使用合理
  - [ ] 支持并发（如需要）
- [ ] **测试分析**
  - [ ] 核心功能有单元测试
  - [ ] 关键流程有集成测试
  - [ ] 测试覆盖率 ≥ 目标值
  - [ ] 测试独立可重复
- [ ] **可维护性分析**
  - [ ] 关键函数有文档说明
  - [ ] 架构变更已更新文档
  - [ ] 关键操作有日志记录
  - [ ] 错误可追踪
- [ ] **技术债务识别**
  - [ ] 识别了所有临时方案
  - [ ] 技术债务已记录
  - [ ] 重构计划已制定
  - [ ] 没有明显的代码异味

### 优化分析输出要求

- [ ] **识别优化点** - 至少识别 2-3 个可优化点
- [ ] **优先级排序** - 高/中/低优先级
- [ ] **输出优化建议** - 具体建议，不只是问题描述
- [ ] **记录到任务日志** - 作为完成总结的一部分

---

## 📊 优化分析输出模板

```markdown
## 🔍 任务优化分析

**任务名称**: [任务名称]  
**分析日期**: YYYY-MM-DD  
**分析范围**: [本次任务修改的文件/模块]

### 1. 代码质量分析

#### ✅ 做得好的地方
- [优点1]
- [优点2]

#### ⚠️ 可优化的地方
- **问题1**: [问题描述]
  - **影响**: [影响范围]
  - **优化建议**: [具体建议]
  - **优先级**: 🔴高 / 🟡中 / 🟢低

### 2. 架构设计分析

#### ✅ 符合规范
- [符合的点]

#### ⚠️ 改进建议
- **建议1**: [架构改进建议]
  - **理由**: [为什么需要改进]
  - **实施难度**: [简单/中等/复杂]

### 3. 性能分析（如适用）

#### 📈 性能指标
- [性能指标1]: [当前值]

#### 🚀 优化机会
- **优化1**: [优化建议]
  - **预期提升**: [预期效果]
  - **实施成本**: [成本评估]

### 4. 测试分析

#### ✅ 测试覆盖情况
- 单元测试: X/Y 个函数
- 覆盖率: X%

#### 📝 测试改进建议
- [测试改进建议]

### 5. 可维护性分析

#### ✅ 文档完整性
- [文档情况]

#### 📚 文档改进建议
- [文档改进建议]

### 6. 技术债务识别

#### 💳 新增技术债务
- **债务1**: [债务描述]
  - **类型**: 临时方案 / 代码异味 / 架构问题
  - **影响范围**: [影响范围]
  - **偿还计划**: [计划]

## 🎯 优化优先级排序

### 高优先级（立即处理）🔴
1. [优化项1]
2. [优化项2]

### 中优先级（近期处理）🟡
1. [优化项1]

### 低优先级（长期规划）🟢
1. [优化项1]
```

---

## 📋 分析深度要求

### 最小要求（必须）

- [ ] 至少识别 2-3 个可优化点
- [ ] 至少覆盖 3 个分析维度
- [ ] 提供优先级排序
- [ ] 记录技术债务（如有）

### 推荐要求（建议）

- [ ] 覆盖所有 6 个分析维度
- [ ] 提供具体的优化建议（不只是问题描述）
- [ ] 评估优化成本和收益
- [ ] 制定明确的优化计划

---

## 🔄 与任务日志的整合

**推荐方式**: 作为任务日志完成总结的一部分

```
agent-task-log/YYYY-MM-DD-N_任务名称_完成总结.md

内容结构:
1. 任务概述
2. 实施过程
3. 完成情况
4. **优化分析** ← 必需部分
5. 后续计划
```

**原因**:
- ✅ 保持任务完整性
- ✅ 便于回顾和跟踪
- ✅ 减少文件数量

---

## 💡 优化分析示例

### 示例1: 代码文件过大

```markdown
#### ⚠️ 可优化的地方

**问题**: `src/indexer.py` 文件超过300行（当前1200行）

- **影响**: 
  - 可读性差
  - 难以维护
  - 违反项目规范
  
- **优化建议**:
  1. 按职责拆分为多个文件：
     - `indexer/index_core.py` - 核心索引逻辑
     - `indexer/index_manager.py` - 索引管理
     - `indexer/index_builder.py` - 构建流程
     - `indexer/index_utils.py` - 工具函数
  2. 保持接口不变，确保向后兼容
  
- **优先级**: 🔴 高（违反强制规范）
- **实施成本**: 🟡 中等（需要重构，但结构清晰）
```

### 示例2: 缺少单元测试

```markdown
**问题**: 新增模块缺少单元测试

- **影响**:
  - 无法验证功能正确性
  - 未来重构风险高
  
- **优化建议**:
  1. 为核心函数添加单元测试
  2. 目标覆盖率 ≥ 90%
  3. 测试边界条件和异常情况
  
- **优先级**: 🟡 中（功能正常，但测试不足）
- **实施成本**: 🟢 低（易于补充）
```

---

## 📚 相关规则

- 任务日志管理：`task-log-workflow.mdc`（优化分析是完成总结的必需部分）
- 开发工作流：`development-workflow.mdc`
- 代码风格规范：`python-code-style.mdc`

---

## 🎯 核心要求总结

1. **强制要求**: 每个任务完成后必须进行优化分析
2. **分析维度**: 至少覆盖3个维度，推荐覆盖全部6个维度
3. **输出格式**: 使用标准模板，包含问题、建议、优先级
4. **记录位置**: 作为任务日志完成总结的一部分
5. **后续跟踪**: 优化建议应该转化为后续任务

---

**重要**: 优化分析不是可选的，而是每个任务完成后的必需步骤！

**最后更新**: 2025-01-27  
**版本**: v2.0（检查清单格式，精简到300行以内）  
**目的**: 确保任务完成后主动思考优化改进
