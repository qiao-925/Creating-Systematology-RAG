---
description: 开发工作流与协作规范
alwaysApply: true
---

# 开发工作流规范

## 核心工作原则

### 1. 最小改动原则
- **任何代码修改必须遵守最小改动原则**
- 除非用户明确要求优化或重构
- 避免"顺便"完成其他任务
- 保持代码变更的原子性

### 2. 严格按步骤执行
- 每次只专注当前讨论的步骤
- **不允许跨步骤实现功能**
- **不允许"顺便"完成其他步骤任务**
- 每个步骤完成后明确汇报，等待确认后进入下一步

### 3. 参考现有业务
- 代码实现前先思考哪些业务可以参考或复用
- 尽可能参考现有业务的实现风格
- 避免重复造轮子
- 如果不明确可让用户提供参考示例

---

## 方案讨论流程

### 1. 方案讨论阶段
- 用户要求讨论方案时，**不要着急修改代码**
- 方案确定后才开始代码修改
- 双方都无疑问时才能输出具体方案文档

### 2. 方案要求
方案文档必须包含：
- **重要逻辑的实现思路**
- **需求按技术实现的依赖关系拆解并排序**（便于渐进式开发）
- **修改或新增文件的路径**
- **测试要点**（利于需求完成后的自动化测试）

### 3. 方案评估
- **主动思考需求边界**
- **合理质疑当下方案的完善性**
- 识别潜在风险和问题
- 提供替代方案（如有）

---

## 代码修改流程

### 修改前
1. 确认方案已确定
2. 明确当前步骤的范围
3. 识别需要修改的文件
4. 检查是否有可参考的实现

### 修改中
1. 遵循最小改动原则
2. 保持代码风格一致
3. 添加必要的类型提示和文档
4. 记录关键决策点

### 修改后
1. 运行基本测试验证
2. 检查是否有语法错误
3. 更新相关文档（如需要）
4. 明确汇报完成情况

---

## Bug 修复策略

### 修复流程
1. **第一次尝试**：根据错误信息直接修复
2. **第二次尝试**：如果失败，分析根本原因后再修复
3. **超过2次失败**：
   - 主动添加关键日志
   - 再次尝试修复
   - 修复完成后主动清除调试日志

### 错误处理
- 使用具体的异常类型
- 记录详细的错误日志
- 提供有意义的错误信息
- 必要时添加用户友好的提示

---

## 决策原则

### 何时需要用户决策
**遇到任何争议或不确定时，必须在第一时间主动告知用户**

包括但不限于：
- 方案选择：多个可行方案需要权衡
- 架构决策：影响长期维护
- 取舍判断：如性能 vs 可维护性
- 风险评估：涉及技术债务或临时方案

### 决策方式
- **不要默认采用一种方案实现**
- **提供 2-3 个方案供选择**
- **解释每个方案的优劣**
- **重大决策必须让用户确认**

---

## 测试要求

### 代码实现后
- **必须进行基本测试**
- 至少验证核心功能正常
- 检查是否有明显错误

### 测试运行
```bash
# 运行相关测试
pytest tests/unit/test_module.py -v

# 运行所有测试
make test
```

---

## 文档更新

### 必须更新的情况
- 修改了 API 接口 → 更新 `docs/API.md`
- 修改了架构设计 → 更新 `docs/ARCHITECTURE.md`
- 重大功能变更 → 更新 `README.md` 或 `CHANGELOG.md`
- 添加新模块 → 更新 `docs/PROJECT_STRUCTURE.md`

### 文档位置
- 核心文档：`docs/`
- 任务日志：`agent-task-log/`（必须）
- Agent指南：`AGENTS.md`

---

## Agent 自纠错机制

### 错误检测
- **语法错误**：使用 `pylint` 静态检查
- **逻辑错误**：编写单元测试，使用断言
- **运行时错误**：使用 try-except 捕获异常

### 重试策略
- **最大重试次数**：3次
- **指数退避**：1秒 → 2秒 → 4秒
- **超过3次失败**：暂停并请求用户指导

### 重试条件
- ✅ **可重试**：网络错误、资源繁忙
- ❌ **不可重试**：数据错误、参数错误、配置问题

### 错误报告
- **超过3次失败**：主动报告用户
- **记录所有尝试过程**（包括失败的）
- **保存到任务日志**：`agent-task-log/`

---

## 任务日志管理

### 必须记录
- 任务开始和结束时间
- 实施的步骤和关键决策
- 遇到的问题和解决方案
- 失败的尝试和原因

### 日志位置
- **所有任务日志保存在 `agent-task-log/` 目录**

### 日志格式
```
agent-task-log/YYYY-MM-DD-N_任务名称_文档类型.md
```

---

## 协作要点总结

### Human 应该介入的时刻
1. 方案选择 - 多个可行方案需要权衡
2. 架构决策 - 影响长期维护
3. 取舍判断 - 如性能 vs 可维护性
4. 风险评估 - 涉及技术债务
5. **超过3次失败** - Agent 无法解决

### Agent 应该自主完成
1. **问题诊断** - 自动尝试多种方法（最多3次）
2. **代码实现** - 按既定方案执行
3. **测试运行** - 持续验证
4. **文档记录** - 记录到 agent-task-log/

### Agent 工作原则
- ✅ 主动尝试多种方案（2-3次）
- ✅ 记录所有尝试过程（包括失败的）
- ✅ 提供选项而非单一方案
- ✅ 解释思考过程
- ❌ 超过3次失败应暂停并请求指导
- ❌ 不要过度生成文档
- ❌ 不要隐藏失败的尝试
- ❌ 重大决策不要独断专行

---

## 参考文档

- Agent协作指南：`AGENTS.md`
- 人机协作范式：`agent-task-log/人机协作范式.md`