---
description: 执行测试工作流 - Agent测试工作流 - 包含测试工作流、Bug修复策略、自纠错机制 - 代码修改后必须运行单元测试验证
alwaysApply: true
---

# Agent 测试工作流

> 包含Agent测试工作流、Bug修复策略、自纠错机制

---

## 1. 测试要求（代码实现后）

**代码实现后必须进行基本测试**：
- **必须进行基本测试**
- 至少验证核心功能正常
- 检查是否有明显错误

**测试运行命令**:
```bash
# 运行相关测试
pytest tests/unit/test_module.py -v

# 运行所有测试
make test
```

---

## 2. 核心原则

Agent 在执行任务时必须：
1. **理解测试体系**: 通过索引文档快速了解测试结构
2. **选择相关测试**: 根据修改的代码自动识别相关测试
3. **运行测试验证**: 修改代码后运行相关测试确保功能正常
4. **理解测试结果**: 能够分析测试结果并提供修复建议

---

## 3. 运行策略（强制要求）

**⚠️ 核心原则**: 只关注单元测试和 Mock 测试，避免环境依赖问题

**优先级顺序（严格执行）**:
1. **单元测试优先（必须）** - 使用 Mock，无外部依赖，快速验证核心功能
2. **集成测试跳过** - 需要环境依赖，由人工处理，Agent 不执行
3. **E2E测试跳过** - 需要完整环境，由人工处理，Agent 不执行

**执行规则**:
- ✅ **必须执行**: 修改代码后立即运行相关单元测试
- ❌ **禁止执行**: 集成测试、E2E测试（需要环境依赖）
- ✅ **使用 Mock**: 所有单元测试必须使用 Mock，避免真实依赖

---

## 4. 测试执行时机（强制要求）

Agent **必须在以下情况立即运行单元测试**：
- ✅ **修改代码后** - 立即运行相关单元测试
- ✅ **添加新功能后** - 运行单元测试验证新功能
- ✅ **修复 Bug 后** - 运行单元测试验证修复有效（超过2次失败的修复必须测试）
- ✅ **重构代码后** - 运行单元测试确保功能未受影响

**⚠️ 重要**: 代码修改完成后，必须立即执行测试，不能跳过！

---

## 5. 代码修改后必须执行（按顺序）

**⚠️ 这是强制要求，每个步骤必须完成！**

1. **识别修改的文件** ✅
   - [ ] 列出所有修改的源文件路径

2. **选择相关单元测试** ✅
   - [ ] 使用 `agent_test_selector.py` 选择相关测试
   - [ ] **过滤结果，只保留 `tests/unit/` 目录下的测试**

3. **运行单元测试** ✅ **必须执行**
   - [ ] 执行 `pytest tests/unit/test_xxx.py -v` 命令
   - [ ] 记录测试执行结果

4. **分析测试结果** ✅
   - [ ] 测试通过：继续下一步
   - [ ] 测试失败：分析失败原因并修复

5. **修复测试失败** ✅
   - [ ] 如果是代码问题：修复代码（最多3次尝试）
   - [ ] 如果是测试问题：更新测试用例
   - [ ] 验证修复效果：重新运行测试

6. **记录到任务日志** ✅
   - [ ] 记录测试执行情况和结果

**⚠️ 如果跳过以上任何步骤，必须明确说明原因！**

---

## 6. 禁止行为

- ❌ **禁止运行集成测试/E2E测试**（需要环境依赖）
- ❌ **禁止跳过测试步骤**
- ❌ **禁止在测试失败时继续**

---

## 7. Agent 测试工具使用

### 工具列表

1. **`tests/tools/agent_test_selector.py`** - 根据修改的文件选择相关测试
2. **`tests/tools/agent_test_info.py`** - 查询测试文件详细信息
3. **`tests/tools/agent_test_summary.py`** - 生成测试执行摘要
4. **`tests/tools/generate_test_index.py`** - 生成测试元数据索引

### 使用示例

**选择相关测试**:
```bash
python tests/tools/agent_test_selector.py src/indexer.py src/query_engine.py
```

**查询测试信息**:
```bash
python tests/tools/agent_test_info.py tests/unit/test_indexer.py
```

**生成测试摘要**:
```bash
pytest tests/unit/test_indexer.py -v | python tests/tools/agent_test_summary.py
```

---

## 8. Agent 如何理解测试体系

### 查阅测试索引文档

Agent 应优先查阅以下文档：
- **主索引**: `tests/agent/README.md` - 测试体系索引和映射表
- **元数据索引**: `tests/test_index.json` - 测试文件元数据（自动生成）

### 查询测试元数据

使用测试元数据索引 (`tests/test_index.json`) 获取测试详细信息：
- 测试的目的和覆盖范围
- 测试的依赖关系
- 测试的分类和标签

---

## 9. Agent 如何理解测试结果

### 测试通过 ✅
- 继续下一步验证或开发
- 记录到任务日志

### 测试失败 ❌
- 分析失败原因：查看详细错误信息，运行单个失败的测试
- 区分失败类型：修改导致的失败（必须修复）vs 原本就失败的测试（记录但不阻塞）
- **超过3次修复失败**: 主动报告用户，请求指导

---

## 10. 常见场景示例

### 示例1: 修改索引管理器

```bash
# 1. 选择相关测试（只关注单元测试）
python tests/tools/agent_test_selector.py src/indexer.py | grep "tests/unit/"

# 2. 运行单元测试（必须执行）
pytest tests/unit/test_indexer.py -v

# 3. 记录测试结果到任务日志
```

### 示例2: 添加新的查询功能

```bash
# 1. 查询测试信息
python tests/tools/agent_test_info.py tests/unit/test_query_engine.py

# 2. 检查覆盖范围，如缺少测试则创建
# 3. 运行新测试
pytest tests/unit/test_query_engine.py::TestQueryEngine::test_new_feature -v
```

---

## 11. Bug 修复策略

### 修复流程
1. **第一次尝试**：根据错误信息直接修复
2. **第二次尝试**：如果失败，分析根本原因后再修复
3. **超过2次失败**：
   - 主动添加关键日志
   - 再次尝试修复
   - 修复完成后主动清除调试日志

### 错误处理
- 使用具体的异常类型
- 记录详细的错误日志
- 提供有意义的错误信息
- 必要时添加用户友好的提示

---

## 12. Agent 自纠错机制

### 错误检测
- **语法错误**：使用 `pylint` 静态检查
- **逻辑错误**：编写单元测试，使用断言
- **运行时错误**：使用 try-except 捕获异常

### 重试策略
- **最大重试次数**：3次
- **指数退避**：1秒 → 2秒 → 4秒
- **超过3次失败**：暂停并请求用户指导

### 重试条件
- ✅ **可重试**：网络错误、资源繁忙
- ❌ **不可重试**：数据错误、参数错误、配置问题

### 错误报告
- **超过3次失败**：主动报告用户
- **记录所有尝试过程**（包括失败的）
- **保存到任务日志**：`agent-task-log/`

---

## 13. 参考文档

- **测试规范**: `.cursor/rules/任务中-测试规范-8.mdc`
- **Agent测试索引**: `tests/agent/README.md`
- **测试用例生成**: `.cursor/agents-expansion/AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md`

---

**最后更新**: 2025-01-27  
**版本**: v1.0（拆分版，包含Agent测试工作流、Bug修复策略、自纠错机制）
