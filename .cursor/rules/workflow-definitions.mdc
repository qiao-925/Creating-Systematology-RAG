---
description: 工作流定义示例与最佳实践
alwaysApply: false
---

# 工作流定义指南

本文档展示如何在 Cursor Rules 中定义工作流。

---

## 📋 工作流定义方式

### 方式1: 结构化步骤列表（推荐）

在规则中使用明确的步骤列表定义工作流：

```markdown
## 新功能开发工作流

### 阶段1: 需求分析
1. **理解需求**
   - 仔细阅读用户需求
   - 识别核心功能点
   - 明确边界条件
   
2. **方案设计**
   - 提供 2-3 个实现方案
   - 说明各方案优劣
   - **等待用户确认**（必须）

### 阶段2: 方案实施
3. **代码实现**
   - 遵循最小改动原则
   - 参考现有业务实现
   - 保持代码风格一致

4. **测试验证**
   - 运行单元测试
   - 验证核心功能
   - 检查是否有错误

### 阶段3: 文档更新
5. **文档同步**
   - 更新 API 文档（如修改接口）
   - 更新架构文档（如修改架构）
   - 记录任务日志
```

### 方式2: 条件触发工作流

根据不同的触发条件执行不同的工作流：

```markdown
## 条件化工作流

### IF: 用户要求"讨论方案"
THEN:
1. **不要修改代码**
2. 先进行方案讨论
3. 等待方案确认后开始实现

### IF: 用户要求"修复Bug"
THEN:
1. 第一次尝试：直接修复
2. 第二次尝试：分析根本原因
3. 超过2次失败：添加日志 + 再次尝试
4. 修复完成：清除调试日志

### IF: 文件超过300行
THEN:
1. 识别可拆分的模块
2. 按职责拆分文件
3. 更新导入路径
4. 验证功能正常
```

### 方式3: 模板化工作流

定义可复用的工作流模板：

```markdown
## 工作流模板

### 模板: 添加新模块
**触发条件**: 用户要求添加新功能模块

**执行步骤**:
1. 创建抽象基类（如需要）
   ```python
   # src/module_name/base.py
   from abc import ABC, abstractmethod
   
   class BaseModuleName(ABC):
       @abstractmethod
       def method_name(self):
           pass
   ```

2. 创建具体实现
   ```python
   # src/module_name/impl.py
   from .base import BaseModuleName
   ```

3. 创建工厂函数
   ```python
   # src/module_name/factory.py
   def create_module(module_type: str):
       ...
   ```

4. 注册到 ModuleRegistry（如适用）

5. 编写单元测试
   ```python
   # tests/unit/test_module_name.py
   ```

6. 更新文档
   - `docs/PROJECT_STRUCTURE.md`
   - `docs/ARCHITECTURE.md`
```

---

## 🎯 工作流规则类型选择

### Always 类型：全局工作流

适用于：
- 通用的开发流程（如代码修改流程）
- 核心工作原则（如最小改动原则）
- 必须始终遵循的规范

示例：`development-workflow.mdc`（已创建）

### Auto Attached 类型：上下文工作流

适用于：
- 特定场景的工作流（如测试场景、特定模块）
- 根据文件路径自动触发的工作流

```markdown
---
description: Bug修复工作流
globs:
  - "**/bugfix/**"
  - "**/*bug*.py"
alwaysApply: false
---

# Bug修复专用工作流

当处理bug修复相关文件时，自动应用此工作流：
1. 复现问题
2. 定位原因
3. 修复问题
4. 添加回归测试
5. 验证修复
```

### Manual 类型：按需工作流

适用于：
- 特殊场景的工作流
- 可选的工作流步骤
- 需要明确引用的工作流

```markdown
---
description: 性能优化工作流
alwaysApply: false
---

# 性能优化工作流

使用 @performance-optimization 引用此工作流

1. 性能分析
2. 识别瓶颈
3. 优化方案设计
4. 实施优化
5. 性能测试对比
```

---

## 📝 工作流定义最佳实践

### 1. 使用清晰的步骤编号

```markdown
## 工作流名称

### 步骤 1: [步骤名称]
- 具体操作 1
- 具体操作 2

### 步骤 2: [步骤名称]
- 具体操作 1
```

### 2. 明确触发条件和决策点

```markdown
### 决策点: 选择实现方案
**条件**: 多个可行方案
**操作**:
1. 列出所有方案（2-3个）
2. 说明各方案优劣
3. **等待用户决策**（必须）
```

### 3. 定义检查点和验证步骤

```markdown
### 验证步骤
- [ ] 代码语法检查通过
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 文档更新完成
```

### 4. 使用示例代码

在工作流中提供代码模板：

```markdown
### 步骤: 创建新接口
```python
from abc import ABC, abstractmethod

class BaseNewInterface(ABC):
    """接口说明"""
    
    @abstractmethod
    def required_method(self, param: str) -> bool:
        """方法说明"""
        pass
```
```

### 5. 定义错误处理流程

```markdown
### 错误处理工作流

**尝试1**: 直接修复
**如果失败** → **尝试2**: 分析根本原因
**如果失败** → **尝试3**: 添加详细日志
**超过3次失败** → **暂停并报告用户**
```

---

## 🔄 复杂工作流示例

### 完整的新功能开发工作流

```markdown
# 新功能开发完整工作流

## 前置条件检查
- [ ] 需求明确
- [ ] 技术方案已确认
- [ ] 依赖关系已梳理

## 阶段1: 设计阶段
### 1.1 架构设计
- 确定模块位置（业务层/基础设施层）
- 定义接口契约
- 设计依赖关系

### 1.2 方案确认
- **必须等待用户确认**
- 如有疑问主动提出

## 阶段2: 实现阶段
### 2.1 创建接口（如需要）
- 定义抽象基类
- 明确接口方法签名

### 2.2 实现具体逻辑
- 遵循最小改动原则
- 参考现有实现风格
- 添加类型提示和文档

### 2.3 集成测试
- 在模块中使用新功能
- 验证功能正常

## 阶段3: 质量保障
### 3.1 单元测试
- 覆盖率 ≥ 90%
- 边界条件测试
- 异常情况测试

### 3.2 集成测试
- 端到端流程验证
- 与现有模块集成验证

## 阶段4: 文档更新
### 4.1 代码文档
- 更新模块 docstring
- 添加使用示例

### 4.2 项目文档
- 更新 `docs/ARCHITECTURE.md`
- 更新 `docs/API.md`（如修改接口）
- 更新 `docs/PROJECT_STRUCTURE.md`

### 4.3 任务日志
- 记录到 `agent-task-log/`
- 包含实施过程和关键决策
```

---

## 🎨 工作流组织建议

### 1. 按场景拆分工作流

```
.cursor/rules/
├── workflow-feature-dev.mdc    # 功能开发工作流
├── workflow-bugfix.mdc          # Bug修复工作流
├── workflow-refactor.mdc        # 重构工作流
├── workflow-testing.mdc          # 测试工作流
└── workflow-documentation.mdc   # 文档工作流
```

### 2. 使用工作流模板库

创建一个 `workflow-templates.mdc` 文件，包含所有可复用的工作流模板。

### 3. 嵌套规则引用

在一个工作流中引用其他规则：

```markdown
# 功能开发工作流

遵循以下规则：
- @python-code-style - 代码风格
- @modular-design - 模块化设计
- @testing-standards - 测试规范
```

---

## 💡 实际应用示例

### 示例1: 添加新数据源工作流

```markdown
---
description: 添加新数据源工作流
globs:
  - "src/data_source/**"
alwaysApply: false
---

# 添加新数据源工作流

## 步骤1: 创建数据源类
1. 继承 `BaseDataSource`
2. 实现 `load()` 方法
3. 返回 `List[Document]`

## 步骤2: 注册到工厂
1. 在 `factory.py` 中添加注册
2. 支持配置切换

## 步骤3: 编写测试
1. 单元测试：测试 `load()` 方法
2. 集成测试：端到端验证

## 步骤4: 更新文档
1. 更新 `docs/ARCHITECTURE.md`
2. 添加使用示例
```

### 示例2: Bug修复工作流（Auto Attached）

```markdown
---
description: Bug修复工作流
globs:
  - "**/*bug*.py"
  - "**/*fix*.py"
alwaysApply: false
---

# Bug修复专用工作流

## 修复流程
1. **第一次尝试**: 根据错误信息直接修复
2. **第二次尝试**: 如果失败，分析根本原因
3. **超过2次失败**:
   - 添加关键日志
   - 再次尝试修复
   - 修复完成后清除调试日志

## 验证要求
- [ ] 运行相关测试
- [ ] 验证修复效果
- [ ] 检查是否有回归
```

---

## 📚 参考

- 现有工作流规则：`.cursor/rules/development-workflow.mdc`
- Cursor Rules 文档：https://docs.cursor.com/rules
- 项目协作指南：`AGENTS.md`