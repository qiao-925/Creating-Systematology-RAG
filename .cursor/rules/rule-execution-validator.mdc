---
description: 规则执行校验规则 - 任务完成后自动检查规则是否被执行
alwaysApply: false
---

# 规则执行校验规则

> **核心原则**: Agent 必须在任务完成后自动校验关键规则是否被成功执行，如果没有执行则分析原因

**⚠️ 重要**: 这是规则系统的自检机制，确保规则不会被忽略。

---

## ✅ 任务完成后必须执行（核心要求，前 50 行）

### 自动执行校验检查清单

**⚠️ 全局任务（必须执行）**：每个 Agent 任务完成后必须执行规则校验，并生成规则执行日志。**即使没有匹配到任何规则也要记录"没有匹配到任何规则"**，以便让用户知道规则系统是生效的。

任务完成后立即执行（无需用户请求）：

- [ ] **检查任务日志记录** - 是否在 `agent-task-log/` 创建了日志文件？
  - 文件命名：`YYYY-MM-DD-N_任务名称_文档类型.md`
  - 内容包含：任务开始/结束时间、关键步骤、优化分析
- [ ] **检查单元测试验证**（代码修改任务必须） - 是否运行了单元测试？
  - 使用 `agent_test_selector.py` 选择相关测试（只选择 `tests/unit/` 目录）
  - 执行 `pytest tests/unit/test_xxx.py -v`
  - 记录测试结果（通过/失败）
- [ ] **检查任务执行汇报** - 是否在对话框中进行了汇报？
  - 包含：任务概述、关键步骤、实施方法、测试情况、执行结果
- [ ] **检查优化分析** - 是否进行了优化分析？
  - 6个维度：代码质量、架构、性能、测试、可维护性、技术债务
  - 识别优化点和技术债务
  - 输出优化建议

### 规则执行日志记录（必须）

**⚠️ 即使没有匹配到任何规则也要记录**

- [ ] **识别任务类型** - 确定任务类型（代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等）
- [ ] **检查规则匹配情况** - 检查哪些规则被应用了
  - [ ] Always 规则（6个核心规则）
  - [ ] Auto Attached 规则（根据文件路径自动附加）
  - [ ] Manual 规则（由规则选择器自动应用）
  - [ ] **如果没有匹配到任何规则，必须明确记录"没有匹配到任何规则"**
- [ ] **生成规则执行日志** - 保存到 `agent-task-log/` 目录
  - 文件命名：`YYYY-MM-DD-N_任务名称_规则执行日志.md`
  - 或作为任务日志的一部分（在完成总结中包含规则执行校验章节）
- [ ] **记录校验结果** - 每个规则的执行状态
  - 已执行的规则列表
  - 未执行的规则列表（已补救）
  - **如果没有匹配到任何规则，记录"未匹配到任何规则"**
  - 原因分析（如果规则未执行或未匹配）
  - 补救措施（如果规则未执行）
- [ ] **记录校验统计** - 执行率统计
  - 总规则数（或"未匹配到任何规则"）
  - 已执行数
  - 未执行数（已补救）
  - 执行率（补救前/后）

### 如果发现未执行规则

- [ ] **分析原因** - 为什么规则未执行？
  - 是否忘记执行？
  - 是否在错误位置创建？
  - 是否环境问题？
  - 是否规则被忽略（注意力分散）？
- [ ] **立即补救** - 立即执行未执行的规则
  - 创建任务日志文件
  - 运行单元测试
  - 进行任务执行汇报
  - 执行优化分析
- [ ] **记录到日志** - 将未执行原因和补救措施记录到规则执行日志
- [ ] **报告校验结果** - 向用户报告校验结果

---

## 📋 校验执行流程

### 步骤 1: 自动触发（任务完成后立即执行）

### 步骤 2: 检查关键规则（按照检查清单逐一检查）

### 步骤 3: 记录校验结果（成功/失败）

### 步骤 4: 分析未执行原因（如果规则未执行）

### 步骤 5: 立即补救（如果发现未执行的规则）

### 步骤 6: 报告校验结果（向用户报告）

---

## 📊 规则匹配情况记录

### 必须记录规则匹配情况

**⚠️ 即使没有匹配到任何规则也要记录**：

- [ ] **Always 规则匹配情况** - 记录哪些 Always 规则被应用了
- [ ] **Auto Attached 规则匹配情况** - 记录哪些 Auto Attached 规则被应用了（根据文件路径）
- [ ] **Manual 规则匹配情况** - 记录哪些 Manual 规则被应用了（由规则选择器自动应用）
- [ ] **未匹配情况** - 如果没有匹配到任何规则，必须明确记录：
  - 当前任务类型
  - 为什么没有匹配到规则
  - 是否需要添加新规则或改进规则选择器

### 未匹配到任何规则的记录格式

```markdown
## ⚠️ 未匹配到任何规则

**当前任务类型**: [任务类型]  
**规则选择器状态**: 未识别到需要应用的规则

**原因分析**: 
- [分析为什么没有匹配到规则]
- 是否是新任务类型？
- 是否需要改进规则选择器？

**建议**: 
- [建议是否需要添加新规则]
- [建议是否需要改进规则选择器]
```

---

## 📊 校验结果报告格式

### 对话框报告格式（即时反馈）

```
## 📋 规则执行校验报告

### ✅ 已执行的规则
- [x] 任务日志记录 - agent-task-log/2025-01-27-1_xxx.md
- [x] 单元测试验证 - pytest tests/unit/test_xxx.py ✅ 通过
- [x] 任务执行汇报 - 已在对话框中汇报
- [x] 优化分析 - 已完成，识别X个优化点

### ❌ 未执行的规则（已补救）
- [ ] 任务日志记录 - **未执行** → **已补救**
  - **原因分析**: 忘记执行日志记录步骤
  - **立即补救**: 已创建日志文件 agent-task-log/xxx.md

### 📊 校验统计
- 总规则数: 4
- 已执行: 3
- 未执行: 1（已补救）
- 执行率: 75% → 100%（补救后）
```

### 规则执行日志格式（保存到文件）

```markdown
# 规则执行日志

> **任务名称**: [任务名称]  
> **校验日期**: YYYY-MM-DD HH:MM:SS  
> **校验结果**: ✅ 全部通过 / ⚠️ 部分失败（已补救） / ❌ 失败

---

## 📋 规则执行情况

### ✅ 已执行的规则

| 规则名称 | 执行状态 | 执行时间 | 备注 |
|---------|---------|---------|------|
| 任务日志记录 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | agent-task-log/xxx.md |
| 单元测试验证 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | pytest ✅ 通过 |
| 任务执行汇报 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 已在对话框中汇报 |
| 优化分析 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 识别X个优化点 |

### ❌ 未执行的规则（已补救）

| 规则名称 | 初始状态 | 原因分析 | 补救措施 | 补救时间 | 最终状态 |
|---------|---------|---------|---------|---------|---------|
| 任务日志记录 | ❌ 未执行 | 忘记执行日志记录步骤 | 已创建日志文件 | YYYY-MM-DD HH:MM:SS | ✅ 已补救 |

---

## 📊 校验统计

- **总规则数**: 4
- **已执行**: 3
- **未执行**: 1（已补救）
- **执行率（补救前）**: 75%
- **执行率（补救后）**: 100%

---

## 🔍 原因分析

### 规则未执行的原因

1. **任务日志记录** - 忘记执行日志记录步骤
   - **根本原因**: Agent注意力分散，忽略了规则要求
   - **改进建议**: 增强规则可见性，使用更强烈的视觉标记

---

## 💡 规则系统健康度评估

- **规则执行率**: 100%（补救后）✅
- **规则有效性**: 高 ✅
- **需要改进**: 增强规则可见性

---

**日志生成时间**: YYYY-MM-DD HH:MM:SS
```

---

## ⚠️ 强制要求

### Agent 必须执行

- [ ] **任务完成后立即执行校验**（无需用户请求）
- [ ] **检查所有关键规则**（按照检查清单）
- [ ] **记录校验结果**（成功/失败）
- [ ] **生成规则执行日志**（保存到文件，检测规则系统是否良好运行）
- [ ] **分析未执行原因**（如果规则未执行）
- [ ] **立即补救**（如果发现未执行的规则）
- [ ] **报告校验结果**（向用户报告，对话框即时反馈）

### 规则执行日志要求

- [ ] **必须生成日志文件** - 每个任务完成后必须生成规则执行日志（全局任务，无例外）
- [ ] **即使没有匹配到任何规则也要记录** - 明确记录"没有匹配到任何规则"，以便让用户知道规则系统是生效的
- [ ] **日志保存位置** - `agent-task-log/YYYY-MM-DD-N_任务名称_规则执行日志.md` 或作为任务日志的一部分
- [ ] **日志内容完整** - 包含规则匹配情况、校验结果、原因分析、统计信息、健康度评估
- [ ] **日志格式规范** - 使用标准模板格式，便于分析和追踪

### 禁止行为

- ❌ 不要跳过校验步骤
- ❌ 不要忽略未执行的规则
- ❌ 不要只检查部分规则
- ❌ 不要跳过规则执行日志记录（这是检测规则系统是否良好运行的重要手段）

---

## 💡 校验示例

### 示例 1: 代码修改任务校验

```
任务完成：修改了 src/indexer.py

规则执行校验：
✅ 任务日志记录 - 已创建 agent-task-log/2025-01-27-1_索引器优化_完成总结.md
✅ 单元测试验证 - 已运行 pytest tests/unit/test_indexer.py ✅ 通过
✅ 任务执行汇报 - 已在对话框中汇报
✅ 优化分析 - 已完成，识别2个优化点

执行率: 100% ✅
```

### 示例 2: 发现未执行规则

```
任务完成：修改了 src/query/engine.py

规则执行校验：
❌ 任务日志记录 - **未执行** → **已补救**
  - 原因分析: 忘记执行日志记录步骤
  - 立即补救: 已创建日志文件...
✅ 单元测试验证 - 已运行 pytest tests/unit/test_query_engine.py ✅ 通过
✅ 任务执行汇报 - 已在对话框中汇报
⚠️ 优化分析 - **未执行** → **已补救**
  - 原因分析: 可能因为规则内容过长，Agent注意力分散
  - 立即补救: 正在执行优化分析...

执行率: 50% ⚠️
补救后执行率: 100% ✅
```

---

## 🎯 核心要点

1. **自动执行**: 任务完成后自动执行，无需用户请求
2. **全面检查**: 检查所有关键规则的执行状态
3. **立即补救**: 发现未执行规则后立即补救
4. **原因分析**: 分析规则未执行的原因，帮助改进规则系统

---

**最后更新**: 2025-01-27  
**版本**: v2.0（检查清单格式）  
**目的**: 确保规则系统有效性，防止规则被忽略
