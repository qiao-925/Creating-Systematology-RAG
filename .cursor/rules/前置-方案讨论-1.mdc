---
description: 执行方案讨论工作流 - 方案讨论任务必须遵循的完整工作流 - 包含需求分析、方案设计、决策原则 - 用户要求讨论方案时，不要着急修改代码，必须充分讨论并输出方案文档
alwaysApply: true
---
# 方案讨论工作流：需求分析、方案讨论、决策原则

> 合并了需求分析、方案讨论、决策原则三个规则

---

## 🎯 工作流概述

**核心原则**: **不要着急修改代码**，直到方案确定才可以修改代码

**执行流程**: 需求分析 → 方案设计 → 决策确认 → 代码实现

---

## 📋 阶段 1: 需求理解与边界分析

### 1.1 需求理解

#### 核心要求
- ✅ **仔细阅读用户需求**，识别核心功能点
- ✅ **明确边界条件和约束**
- ✅ **识别潜在风险和问题点**
- ✅ **确认是否有可参考的现有业务实现**

#### 详细步骤

**步骤 1.1: 识别核心功能点**
- 仔细阅读用户需求
- 提取关键功能点
- 明确功能优先级

**步骤 1.2: 明确边界条件**
- 功能边界：哪些功能需要实现，哪些不需要
- 技术边界：技术选型的约束和限制
- 时间边界：截止时间、里程碑节点

**步骤 1.3: 明确约束条件**
- 性能约束（响应时间、吞吐量等）
- 资源约束（内存、CPU、存储等）
- 兼容性约束（系统版本、依赖版本等）

**步骤 1.4: 风险识别**
- 技术风险：技术实现的难点和不确定性
- 时间风险：可能的时间延迟因素
- 依赖风险：外部依赖的可用性和稳定性
- 兼容性风险：与现有系统的兼容性问题

**步骤 1.5: 问题点识别**
- 需求不明确的地方
- 技术方案不确定的地方
- 需要用户决策的点

**步骤 1.6: 现有业务参考**
- 代码实现前先思考哪些业务可以参考或复用
- 查看现有代码库中的类似实现
- 识别可复用的模式和组件
- 尽可能参考现有业务的实现风格
- 如果不明确可让用户提供参考示例

### 1.2 需求边界思考

- **主动思考需求边界**
- **合理质疑当下方案的完善性**
- 识别潜在风险和问题点

### 1.3 验证检查清单

- [ ] 已识别核心功能点
- [ ] 已明确边界条件
- [ ] 已明确约束条件
- [ ] 已识别潜在风险
- [ ] 已识别问题点
- [ ] 已查找可参考的实现
- [ ] 已确认现有业务风格
- [ ] 如有需要，已请求用户提供参考示例

---

## 📋 阶段 2: 方案设计

### 2.1 生成方案选项

**⚠️ 强制要求**: 必须提供 **2-3 个可行方案**（不能只有单一方案）

每个方案必须包含：
- 实现思路
- 优缺点分析
- 风险评估

### 2.2 方案文档要求

方案文档**必须包含**以下内容：

**1. 重要逻辑的实现思路**
   - 核心算法或设计模式
   - 关键技术选型理由
   - 关键数据流和状态管理

**2. 需求按技术实现的依赖关系拆解并排序**
   - 明确依赖关系（A → B → C）
   - 按依赖顺序排列实施步骤
   - 便于渐进式开发

**3. 输出修改或新增文件的路径**
   - 列出所有需要修改的文件
   - 列出所有需要新增的文件
   - 说明每个文件的职责

**4. 输出测试要点**
   - 单元测试要点
   - 集成测试要点
   - 边界条件测试
   - 异常情况测试
   - 利于需求完成后的自动化测试

---

## 📋 阶段 3: 决策原则与方案确认

### 3.1 决策原则

**核心原则**: **凡是在方案、编码过程遇到任何争议或不确定，必须在第一时间主动告知用户由用户决策**

#### 需要用户决策的场景

**1. 方案选择**
- 触发条件: 多个可行方案，需要权衡
- 处理流程:
  1. 列出所有可行方案（2-3个）
  2. **不要默认采用一种方案实现**
  3. 说明每个方案的优劣
  4. **等待用户选择**

**2. 架构决策**
- 触发条件: 影响长期维护的架构选择
- 处理流程:
  1. 说明架构影响范围
  2. 分析长期维护成本
  3. **重大决策必须让用户确认**
  4. 提供风险评估

**3. 取舍判断**
- 触发条件: 需要在不同维度间权衡（如性能 vs 可维护性）
- 处理流程:
  1. 明确冲突的维度
  2. 分析各方案的权衡点
  3. 说明推荐方案的理由
  4. **等待用户决策**

**4. 风险评估**
- 触发条件: 涉及技术债务或临时方案
- 处理流程:
  1. 识别技术债务风险
  2. 说明临时方案的影响
  3. 提供长期方案建议
  4. **等待用户确认是否接受风险**

**5. 不确定性问题**
- 触发条件: 任何不明确、有争议的点
- 处理流程:
  1. **第一时间主动告知用户**
  2. 说明不确定的原因
  3. 提供可能的选项
  4. **等待用户决策**

#### 决策原则清单

**必须遵循**:
- ✅ **遇到争议或不确定，第一时间主动告知用户**
- ✅ **不要默认采用一种方案实现**
- ✅ **重大决策必须让用户确认**
- ✅ **提供 2-3 个方案供选择**（不是单一方案）
- ✅ **解释每个方案的优劣**

**禁止行为**:
- ❌ 不要独断专行做重大决策
- ❌ 不要隐藏不确定或争议点
- ❌ 不要只提供单一方案
- ❌ 不要在用户未确认时执行重大变更

#### 决策优先级

**高优先级（必须等待用户）**:
1. 架构决策（影响系统设计）
2. 技术选型（影响长期维护）
3. 性能 vs 可维护性取舍
4. 技术债务决策

**中优先级（建议询问用户）**:
1. 实现方式选择（有多种方案）
2. 文件组织方式
3. 命名规范争议

**低优先级（可自主判断）**:
1. 代码风格细节
2. 注释格式
3. 临时变量命名

#### 决策报告模板

当需要用户决策时，使用以下格式：

```markdown
## 需要决策的问题

**问题描述**: [简要描述问题]

**背景**: [为什么需要决策]

## 方案选项

### 方案 A: [方案名称]
**优点**:
- ...
**缺点**:
- ...
**风险评估**: [风险描述]

### 方案 B: [方案名称]
[同上]

## 推荐方案
基于[理由]，推荐方案[?]，但最终由您决定。

**请选择**: [等待用户输入]
```

### 3.2 方案确认

#### 等待双方确认
- **方案讨论需要在我们双方都没疑问的情况下才可以输出具体方案文档**
- 如有疑问，主动提出并讨论
- 不理解的点必须澄清

#### 方案确认检查清单
- [ ] 用户已确认方案选择
- [ ] 双方对实现思路无疑问
- [ ] 依赖关系已明确
- [ ] 文件路径已确认
- [ ] 测试要点已明确
- [ ] 所有争议点已解决
- [ ] 所有不确定点已澄清

---

## ✅ 验证检查

### 方案文档完整性检查
- [ ] 包含重要逻辑的实现思路
- [ ] 包含依赖关系拆解和排序
- [ ] 包含文件路径列表（修改+新增）
- [ ] 包含测试要点

### 方案确认检查
- [ ] 用户已明确选择方案
- [ ] 双方对方案无疑问
- [ ] 所有决策点已确认
- [ ] 可以开始代码修改

---

## 🚫 禁止行为

- ❌ **禁止在方案未确认时开始修改代码**
- ❌ **禁止跳过方案讨论直接实现**
- ❌ **禁止只提供单一方案**（必须提供2-3个选项）
- ❌ **禁止方案文档缺少必需内容**
- ❌ **禁止在争议或不确定时默认采用一种方案**
- ❌ **禁止隐藏不确定或争议点**

---

## 🔄 与代码修改的衔接

### 方案确认后的流程
1. 方案确认 ✅
2. 开始代码实现（遵循开发工作流规范）
3. 按步骤执行（不允许跨步骤）
4. 每个步骤完成后汇报

---

## 📚 相关规则

- 协作要点：`任务中-协作规范-3.mdc`
- AGENTS.md 原始规则：第 62-77 行

---

**最后更新**: 2025-11-05  
**版本**: v2.0（合并需求分析、方案讨论、决策原则三个规则）
