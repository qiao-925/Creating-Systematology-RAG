# Cursor 规则系统诊断指南

> **目标**: 理解规则如何工作，诊断为什么规则可能没有被触发

---

## 🔍 规则系统工作原理

### 1. 规则类型和加载机制

#### Always 规则 (`alwaysApply: true`)
- **加载时机**: 每次对话开始时自动加载
- **上下文**: 包含在所有上下文中
- **限制**: 过多会占用大量上下文窗口，可能影响性能

#### Auto Attached 规则 (`alwaysApply: false` + `globs`)
- **加载时机**: 当编辑匹配 `globs` 模式的文件时自动附加
- **上下文**: 仅在相关文件编辑时包含
- **优势**: 更精确，减少上下文负担

#### Manual 规则 (`alwaysApply: false` + 无 `globs`)
- **加载时机**: 需要用户使用 `@ruleName` 明确引用
- **上下文**: 仅在明确引用时包含
- **使用场景**: 特定场景的详细规则

### 2. 上下文窗口限制

**⚠️ 关键问题**: Cursor 的上下文窗口是有限的

- **影响**: 如果 Always 规则太多或太长，可能：
  1. 规则被截断（部分内容不在上下文中）
  2. AI 注意力分散（无法聚焦关键规则）
  3. 规则优先级降低（后加载的规则可能被忽略）

**当前状态**: 
- Always 规则数量: **10+ 个**
- 某些规则文件长度: **300+ 行**
- 总规则内容可能超过上下文窗口限制

---

## 🎯 规则可能被忽略的原因

### 1. 上下文窗口溢出（最可能）

**症状**:
- 规则已定义，但 AI 没有执行
- AI 忽略了规则中的某些要求
- 规则部分生效，部分不生效

**诊断方法**:
```bash
# 统计 Always 规则的总行数
# 如果超过 2000-3000 行，可能被截断
```

**解决方案**:
- 减少 Always 规则数量
- 缩短规则文件长度（< 300 行）
- 将详细内容移到 Manual 规则

### 2. 规则优先级冲突

**症状**:
- 多个规则要求不同行为
- AI 选择了其中一个，忽略了另一个

**诊断方法**:
- 检查是否有规则冲突
- 查看规则执行顺序

**解决方案**:
- 明确规则优先级
- 合并冲突的规则
- 使用更明确的触发条件

### 3. 规则描述不够明确

**症状**:
- 规则存在，但 AI 不知道何时应用
- AI 理解规则，但没有执行

**诊断方法**:
- 规则是否使用了"必须"、"强制要求"等明确措辞？
- 规则是否有具体的执行步骤？
- 规则是否有检查清单？

**解决方案**:
- 使用更明确的命令式语言
- 添加检查清单
- 提供具体示例

### 4. 规则触发条件不匹配

**症状**:
- Auto Attached 规则没有触发
- Manual 规则没有被引用

**诊断方法**:
- 检查 `globs` 模式是否匹配目标文件
- 检查是否使用了 `@ruleName` 引用

**解决方案**:
- 调整 `globs` 模式
- 明确告知 AI 需要引用某个规则

---

## 📊 当前规则体系诊断

### Always 规则统计

| 规则文件 | 行数 | 复杂度 | 风险 |
|---------|------|--------|------|
| `agent-testing-integration.mdc` | ~306 | 高 | ⚠️ 过长 |
| `development-workflow.mdc` | ~215 | 中 | ✅ |
| `python-code-style.mdc` | ~200 | 中 | ✅ |
| `file-organization.mdc` | ~300 | 中 | ⚠️ 接近限制 |
| `task-log-workflow.mdc` | ~150 | 低 | ✅ |
| `proposal-discussion-workflow.mdc` | ~100 | 低 | ✅ |
| `decision-making-principles.mdc` | ~150 | 低 | ✅ |
| `collaboration-guidelines.mdc` | ~200 | 中 | ✅ |
| `post-task-optimization.mdc` | ~300 | 高 | ⚠️ 接近限制 |
| `requirement-analysis.mdc` | ~100 | 低 | ✅ |
| `agents-sync-workflow.mdc` | ~200 | 中 | ✅ |

**总估计**: 约 2000+ 行 Always 规则内容

**⚠️ 问题**: 
- Always 规则太多（10+ 个）
- 总内容过长（可能超过上下文窗口）
- AI 可能无法关注到所有规则

---

## 🛠️ 诊断工具和方法

### 方法 1: 检查规则是否被加载

**测试**: 在对话中直接询问 AI
```
请列出当前加载的所有规则文件名称
```

**预期**: AI 应该能列出所有 Always 规则

### 方法 2: 检查规则是否被理解

**测试**: 询问特定规则的要求
```
根据 agent-testing-integration.mdc 规则，代码修改后应该做什么？
```

**预期**: AI 应该能准确回答规则要求

### 方法 3: 检查规则执行情况

**测试**: 执行一个应该触发规则的任务
```
修改 src/indexer.py 文件，然后告诉我你执行了什么测试步骤
```

**预期**: AI 应该自动执行测试选择、运行等步骤

---

## 💡 优化建议（按优先级）

### 高优先级 ⭐⭐⭐

#### 1. 减少 Always 规则数量

**当前**: 10+ 个 Always 规则

**建议**: 
- 将 `agent-testing-integration.mdc` 改为 **Auto Attached**（仅在编辑代码时触发）
- 将 `task-log-workflow.mdc` 改为 **Manual**（仅在需要记录日志时引用）
- 将 `proposal-discussion-workflow.mdc` 改为 **Auto Attached**（关键词触发）

**目标**: Always 规则减少到 **5-7 个**

#### 2. 缩短规则文件长度

**当前**: `agent-testing-integration.mdc` 有 306 行

**建议**:
- 核心规则保留在 Always（< 150 行）
- 详细说明和示例移到 Manual 规则
- 使用"参见其他规则"减少重复

**目标**: 每个 Always 规则 < 200 行

#### 3. 简化规则描述

**当前**: 规则描述可能过于详细

**建议**:
- 使用更简洁的命令式语言
- 突出核心要求（用 ⚠️ 标记）
- 将详细说明移到示例部分

### 中优先级 ⭐⭐

#### 4. 添加规则触发验证

**建议**: 创建测试脚本验证规则是否被加载
```python
# scripts/check_rules_loaded.py
# 测试规则是否被正确加载
```

#### 5. 优化规则结构

**建议**: 
- 每个规则文件包含：
  1. 核心要求（前 50 行）
  2. 详细说明（中间部分）
  3. 示例和快速参考（最后部分）

---

## 🔬 诊断步骤

### 步骤 1: 检查规则加载

1. 打开新对话
2. 询问: "请列出当前加载的规则文件"
3. 检查是否包含所有 Always 规则

### 步骤 2: 测试规则理解

1. 询问: "代码修改后应该执行什么测试步骤？"
2. 检查 AI 是否提到 `agent-testing-integration.mdc` 的要求
3. 检查 AI 是否知道使用 `agent_test_selector.py`

### 步骤 3: 测试规则执行

1. 执行一个代码修改任务
2. 观察 AI 是否自动执行测试步骤
3. 如果未执行，询问原因

### 步骤 4: 分析结果

根据测试结果：
- **如果规则未加载**: 检查规则文件格式
- **如果规则未理解**: 简化规则描述
- **如果规则未执行**: 强化触发条件

---

## 📋 规则优化检查清单

### 规则文件优化

- [ ] Always 规则数量 < 7 个
- [ ] 每个 Always 规则 < 200 行
- [ ] 使用明确的命令式语言
- [ ] 包含检查清单
- [ ] 提供具体示例

### 规则内容优化

- [ ] 核心要求在前 50 行
- [ ] 使用 ⚠️ 标记强制要求
- [ ] 避免重复内容
- [ ] 引用其他规则而非重复

### 规则类型优化

- [ ] 只有核心规则设为 Always
- [ ] 场景特定规则设为 Auto Attached
- [ ] 详细参考规则设为 Manual

---

## 🎯 快速诊断命令

```bash
# 1. 统计 Always 规则总行数
# 2. 检查是否有规则冲突
# 3. 验证规则文件格式
```

---

## 📚 参考

- [Cursor Rules 文档](https://docs.cursor.com/rules)
- 项目规则索引: `.cursor/rules/README.md`
- 规则优化建议: `.cursor/rules/RULE-OPTIMIZATION.md`

---

**创建日期**: 2025-01-27  
**目的**: 诊断和优化 Cursor 规则系统  
**维护者**: 开发团队

