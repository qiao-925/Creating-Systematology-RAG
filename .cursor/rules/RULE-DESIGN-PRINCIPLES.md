# 规则设计原则 - 考虑AI注意力限制

> **核心问题**: 大模型的注意力有限，规则过长时容易被忽略  
> **设计目标**: 设计易被AI理解和执行的规则系统

---

## 🎯 核心设计原则

### 1. 规则简洁性原则（最重要）

**问题**: 规则过长时，AI无法面面俱到，导致规则被无视

**解决方案**:
- ✅ **单条规则不超过 300 行**（与代码文件限制一致）
- ✅ **核心要求在前 50 行**（最重要的内容放在前面）
- ✅ **使用检查清单**而非长篇描述（便于AI快速扫描）
- ✅ **关键规则强制校验**（通过规则执行校验机制确保执行）

**示例对比**:
```markdown
❌ 不好的规则（冗长描述）:
"在任务完成后，你需要进行以下步骤：首先，你需要检查任务是否成功完成，然后你需要分析任务的执行过程，接着你需要识别优化点，最后你需要记录到任务日志中。在分析执行过程时，你需要考虑代码质量、架构设计、性能优化等多个维度..."

✅ 好的规则（检查清单）:
## 任务完成后必须执行
- [ ] 检查任务完成状态
- [ ] 分析执行过程（6个维度：代码质量、架构、性能、可维护性、安全性、用户体验）
- [ ] 识别优化点
- [ ]

---

### 2. 分层架构原则

**问题**: 所有规则都是 Always 规则时，上下文过长，AI注意力分散

**解决方案**: 三层架构
- **Always 规则**（6个核心）：最小化，只包含最核心的规则
- **Auto Attached 规则**（3个）：按文件路径自动附加，减少默认负担
- **Manual 规则**（场景驱动）：由规则选择器根据任务自动应用

**设计考虑**:
- Always 规则数量控制在 6 个以内（核心规则）
- 每个 Always 规则控制在 300 行以内
- 使用规则选择器自动选择相关规则，而非全部加载

---

### 3. 强制校验机制

**问题**: 规则被忽略后，无法及时发现和补救

**解决方案**: 规则执行校验规则（`rule-execution-validator.mdc`）
- **自动校验**: 任务完成后自动检查关键规则是否被执行
- **立即补救**: 发现未执行规则后立即补救
- **原因分析**: 分析规则未执行的原因，帮助改进规则系统

**关键校验点**:
1. 任务日志是否创建
2. 单元测试是否运行（代码修改任务）
3. 任务执行汇报是否完成
4. 优化分析是否完成

---

### 4. 规则可执行性原则

**问题**: 规则描述过于抽象，AI难以执行

**解决方案**:
- ✅ **使用明确的步骤列表**（1、2、3...）
- ✅ **使用检查清单**（- [ ] 格式）
- ✅ **提供具体示例**（展示期望的输出格式）
- ✅ **使用强制要求标记**（⚠️ 必须、✅ 应该、❌ 禁止）

**示例对比**:
```markdown
❌ 抽象描述:
"在代码修改后，应该进行测试验证"

✅ 可执行步骤:
## 代码修改后必须执行
1. 使用 `agent_test_selector.py` 选择相关单元测试（只选择 `tests/unit/` 目录）
2. 执行 `pytest tests/unit/test_xxx.py -v`
3. 分析测试结果，如有失败必须修复
4. 在任务执行汇报中记录测试结果
```

---

### 5. 规则优先级原则

**问题**: 所有规则看起来同等重要，AI不知道优先级

**解决方案**:
- ✅ **使用视觉标记**（⚠️ 必须、✅ 应该、❌ 禁止）
- ✅ **核心要求在前**（最重要的内容放在规则开头）
- ✅ **分级标记**（必须/应该/可选）

**优先级标记**:
- ⚠️ **必须** - 违反会导致任务失败
- ✅ **应该** - 最佳实践，建议遵循
- ❌ **禁止** - 明确不允许的行为

---

## 📋 AGENTS.md 与 Cursor Rules 的关系

### 关系说明

**AGENTS.md**:
- **定位**: 规则的主文档（source of truth）
- **用途**: 人类可读的完整规则文档
- **内容**: 完整的规则描述、原则说明、详细指南
- **维护**: 由人类维护，作为规则的权威来源

**Cursor Rules** (`.cursor/rules/*.mdc`):
- **定位**: AGENTS.md 的结构化规则版本
- **用途**: 供 AI Agent 使用的可执行规则
- **内容**: 从 AGENTS.md 转换的结构化规则，更简洁、可执行
- **维护**: 从 AGENTS.md 同步更新（通过 `agents-sync-workflow.mdc`）

### 覆盖关系

**✅ 互补关系，不是覆盖关系**:
- **AGENTS.md**: 提供完整的规则上下文和原则说明
- **Cursor Rules**: 提供可执行的结构化规则和检查清单
- **两者一致**: 通过 `agents-sync-workflow.mdc` 确保内容一致

**同步机制**:
- 当 AGENTS.md 更新时，必须同步更新对应的 `.cursor/rules/*.mdc` 文件
- 通过 `AGENTS-MAPPING.md` 维护映射关系
- 通过 `agents-sync-workflow.mdc` 执行同步流程

### 设计考虑

**为什么需要两个版本？**:
1. **AGENTS.md**: 人类可读，便于理解规则背后的原则和上下文
2. **Cursor Rules**: AI可执行，结构化和简洁，便于AI理解和应用

**避免的问题**:
- ❌ 如果只有 AGENTS.md：规则过长，AI注意力分散
- ❌ 如果只有 Cursor Rules：缺乏上下文和原则说明
- ✅ 两者结合：既有完整上下文，又有可执行的结构化规则

---

## 🔧 规则设计检查清单

设计新规则时，必须考虑：

### 1. 简洁性检查
- [ ] 规则文件是否超过 300 行？（如果超过，需要拆分）
- [ ] 核心要求是否在前 50 行？
- [ ] 是否使用检查清单而非长篇描述？

### 2. 可执行性检查
- [ ] 是否使用明确的步骤列表？
- [ ] 是否提供具体示例？
- [ ] 是否使用强制要求标记？

### 3. 优先级检查
- [ ] 是否使用视觉标记（⚠️ 必须、✅ 应该、❌ 禁止）？
- [ ] 核心要求是否在前？
- [ ] 是否明确优先级？

### 4. 注意力限制考虑
- [ ] 是否为 Always 规则？（如果是，是否真的需要 Always？）
- [ ] 是否可以通过 Auto Attached 或 Manual 规则替代？
- [ ] 是否考虑了 AI 的注意力限制？

### 5. 校验机制
- [ ] 是否可以通过 `rule-execution-validator.mdc` 校验？
- [ ] 是否有关键检查点可以自动验证？

---

## 💡 规则设计最佳实践

### 1. 规则结构模板

```markdown
---
description: 规则简要描述（一句话）
alwaysApply: true/false
---

# 规则名称

> **核心原则**: 一句话说明核心原则

**⚠️ 重要**: 如果有特别重要的说明，放在这里

---

## 🎯 规则目的

1-2 段说明规则的目的和背景

---

## ✅ 必须执行（核心要求，前 50 行）

### 检查清单
- [ ] 必须项 1
- [ ] 必须项 2
- [ ] 必须项 3

---

## 📋 详细说明（可选）

如果需要详细说明，放在这里

---

## 💡 示例

提供具体示例

---

**最后更新**: YYYY-MM-DD
```

### 2. 规则长度控制

- **Always 规则**: 控制在 200 行以内（核心规则）
- **Auto Attached 规则**: 控制在 300 行以内
- **Manual 规则**: 控制在 300 行以内

### 3. 规则拆分原则

如果规则超过 300 行，按以下原则拆分：
- **按场景拆分**: 不同场景使用不同规则文件
- **按层级拆分**: 核心规则和扩展规则分离
- **按职责拆分**: 不同职责使用不同规则文件

---

## 🎯 总结

### 核心原则
1. **简洁性**: 规则简洁，核心要求在前
2. **分层架构**: 三层架构，减少默认负担
3. **强制校验**: 自动校验规则执行情况
4. **可执行性**: 明确的步骤和检查清单
5. **优先级**: 明确优先级标记

### AGENTS.md 与 Cursor Rules
- **关系**: 互补关系，不是覆盖关系
- **AGENTS.md**: 人类可读的完整规则（source of truth）
- **Cursor Rules**: AI可执行的结构化规则
- **同步**: 通过 `agents-sync-workflow.mdc` 确保一致

### 设计目标
- **减少注意力负担**: 通过分层架构和规则选择器
- **确保规则执行**: 通过强制校验机制
- **提高可执行性**: 通过明确的步骤和检查清单

---

**最后更新**: 2025-01-27  
**版本**: v1.0  
**目的**: 指导规则设计，考虑AI注意力限制

