---
description: "代码实现规范 - Python 代码风格与最佳实践，强制要求类型提示、文件行数限制、日志规范等"
globs:
  - "**/*.py"
alwaysApply: true
priority: 1
---

# 代码实现规范

> Python 代码实现阶段的统一基线，覆盖类型、结构、日志、异常、命名与注释要求。

---

## ⚠️ 核心强制要求（必须遵守）

### 1. 文件行数限制

**⚠️ 单个代码文件必须 ≤ 300 行，这是硬性限制，不允许例外。**

- **检查时机**：创建新文件时、修改现有文件后
- **执行方式**：
  1. 如果文件超过 300 行，**必须立即拆分**
  2. 拆分前与用户讨论职责划分方案
  3. 拆分后每个文件必须 ≤ 300 行
- **禁止行为**：❌ 不允许以"功能复杂"、"暂时无法拆分"等理由超过 300 行

### 2. 类型提示

**所有函数、方法、类声明必须补全类型提示。**

- 缺值返回使用 `-> None`
- 公共 API（类、函数、模块）必须提供完整 docstring（参数、返回值、异常）

### 3. 日志规范

**业务代码统一通过 `src.logger.setup_logger` 获取 logger，禁止使用 `print`。**

- 测试示例代码除外
- 错误路径必须使用 `logger.error` 或 `logger.exception`

---

## AI Agent 行为要求

### 创建新文件时

1. **必须检查行数**：
   - 创建文件后立即检查行数
   - 如果超过 300 行，**立即停止**，与用户讨论拆分方案
   - 拆分后确保每个文件 ≤ 300 行

2. **必须添加类型提示**：
   - 所有函数、方法、类声明补全类型提示
   - 公共 API 提供完整 docstring

3. **必须使用日志**：
   - 通过 `src.logger.setup_logger` 获取 logger
   - 禁止使用 `print`（测试示例除外）

### 修改现有文件时

1. **必须检查行数**：
   - 修改后立即检查文件总行数
   - 如果超过 300 行，**必须主动提出拆分建议**
   - 提供具体的拆分方案（文件列表、职责划分、依赖关系）

2. **必须保持规范**：
   - 新增代码必须符合类型提示要求
   - 新增日志必须使用 logger，禁止 print
   - 保持代码结构顺序和命名规范

### 代码审查时

1. **必须检查行数**：
   - 检查所有相关文件是否 ≤ 300 行
   - 如果发现超过 300 行的文件，**必须立即指出并要求拆分**

2. **必须检查类型提示**：
   - 检查所有函数、方法、类是否有类型提示
   - 检查公共 API 是否有完整 docstring

3. **必须检查日志**：
   - 检查是否使用了 `print`（测试示例除外）
   - 检查错误路径是否使用了 `logger.error` 或 `logger.exception`

---

## 详细规范要求

### 1. 结构与命名

- **模块文件名**：使用 `snake_case.py`，测试文件遵循 `test_*.py`
- **代码结构顺序**：模块 docstring → 导入（标准库/第三方/本地）→ 常量 → 类 → 函数
- **导入规范**：
  - 按分组+字母序排列
  - 避免 `from module import *`
  - 跨包引用使用绝对导入
- **命名约束**：
  - 类用 `PascalCase`
  - 函数/变量用 `snake_case`
  - 常量全大写
  - 私有成员前缀 `_`
- **枚举**：固定枚举值使用 `Enum`，禁止散落字符串常量

### 2. 日志与异常

- **日志获取**：统一通过 `src.logger.setup_logger` 获取 logger
- **日志级别**：根据语义选择（info/warning/error/debug）
- **错误处理**：
  - 捕获具体异常类型，记录日志后合理抛出
  - 严禁裸 `except`
  - 关键路径提供降级或恢复策略说明

### 3. 注释与可读性

- **注释重点**：在复杂逻辑处注明"为什么这样做"，避免描述"做了什么"
- **理由说明**：对性能优化、兼容性处理、架构选择附带理由
- **注释维护**：避免无意义或过时注释，修改代码时同步更新

---

## 验收标准

- [ ] 所有文件 ≤ 300 行（硬性要求）
- [ ] 所有函数、方法、类有类型提示
- [ ] 公共 API 有完整 docstring
- [ ] 通过 `pylint`/`mypy`/`pytest` 等工具检查无基础问题
- [ ] 关键模块的日志覆盖正常运行与异常分支
- [ ] 重大结构调整在提交说明或文档中补充背景

---

## 参考资料

- `src/business/protocols.py`（枚举定义示例）
- `src/business/strategy_manager.py`（策略管理结构）
- `src/query/modular/retriever_factory.py`（导入与工厂模式组织）
- `src/embeddings/base.py`（抽象类+类型提示）
- `src/config.py`（配置模块、日志初始化）

---

## 版本信息

- **最后更新**：2025-12-06
- **版本**：v3.0（重构为突出强制要求，明确 AI Agent 行为要求）
