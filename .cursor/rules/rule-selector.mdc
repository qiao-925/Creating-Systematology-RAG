---
description: Agent 规则选择器 - 根据任务场景自动选择和应用规则
alwaysApply: true
---

# Agent 规则自动选择器

> **核心原则**: Agent 必须根据当前任务自动选择并应用相关规则，无需用户手动引用

**⚠️ 重要**: 这是自动机制！Agent 看到此规则后，应该自动根据任务类型加载和应用相关规则，用户不需要手动 @引用任何规则。

---

## 🎯 自动规则选择机制

### 工作原理（全自动）

1. **Agent 识别任务类型** → 自动判断需要的规则
2. **Agent 自动应用规则要求** → 无需用户手动 @引用，无需规则文件在上下文中
3. **Agent 执行规则要求** → 按照规则选择器的指导执行任务

**⚠️ 关键理解**: 
- Agent 不需要实际加载规则文件到上下文中
- Agent 只需要根据本规则选择器的指导，执行相应规则的要求
- 规则选择器已经包含了所有规则的核心要求，Agent 直接执行即可

### 规则类型

- **Always 规则**: 自动加载（只有核心规则，已在上下文中）
- **Auto Attached 规则**: 根据文件路径自动附加（Cursor 自动处理）
- **场景规则**: Agent 根据本规则选择器的指导自动执行（无需加载文件）

---

## 📋 任务场景与规则自动映射

### 场景 1: 代码修改任务

**触发条件**: 用户要求修改代码、添加功能、重构代码

**Agent 必须自动应用**:
1. **agent-testing-integration-simple.mdc** - 测试规则（必须）
2. **development-workflow.mdc** - 开发工作流（已 Always 加载）
3. **python-code-style.mdc** - 代码风格（已 Always 加载）

**Agent 自动判断附加**:
- 如修改 `src/business/` 或 `src/query/` → 自动应用 `rag-architecture.mdc` (Auto Attached)
- 如修改模块相关代码 → 自动应用 `modular-design.mdc` (Auto Attached)
- 如修改测试代码 → 自动应用 `testing-standards.mdc` (Auto Attached)

**Agent 执行流程**:
1. **自动识别**: 任务类型为"代码修改"
2. **自动加载**: 加载 `agent-testing-integration-simple.mdc` 规则
3. **执行任务**: 按照规则要求修改代码
4. **自动执行**: 运行单元测试验证（根据测试规则）
5. **自动记录**: 任务完成后应用 `post-task-optimization.mdc` 和 `task-log-workflow.mdc`

---

### 场景 2: 测试相关任务

**触发条件**: 用户要求运行测试、添加测试、修复测试

**Agent 必须自动应用**:
1. **agent-testing-integration.mdc** - 详细测试规则（自动加载）
2. **testing-standards.mdc** - 测试规范（Auto Attached，编辑 tests/ 时自动加载）

**Agent 自动判断附加**:
- 如涉及代码修改 → 自动应用 `development-workflow.mdc`（已 Always 加载）

---

### 场景 3: 方案讨论任务

**触发条件**: 用户要求"先讨论方案"、"制定方案"、"方案设计"

**Agent 必须自动应用**:
1. **proposal-discussion-workflow.mdc** - 方案讨论工作流（自动加载）
2. **requirement-analysis.mdc** - 需求理解（自动加载）
3. **decision-making-principles.mdc** - 决策原则（自动加载）

**Agent 执行流程**:
1. **自动识别**: 任务类型为"方案讨论"
2. **自动加载**: 加载上述3个规则
3. **自动执行**: 
   - **不要着急修改代码**
   - 充分讨论方案
   - 输出方案文档（必须包含4项内容）
   - 等待用户确认

---

### 场景 4: 任务完成后的优化分析和规则校验

**触发条件**: 任何任务完成后（无论成功/失败、无论是否匹配到规则）

**⚠️ 全局任务（必须执行）**: 每个 Agent 任务完成后必须执行规则校验，并生成规则执行日志。**即使没有匹配到任何规则也要记录"没有匹配到任何规则"**，以便让用户知道规则系统是生效的。

**Agent 必须自动应用**:
1. **post-task-optimization.mdc** - 优化分析（自动加载）
2. **task-log-workflow.mdc** - 任务日志（自动加载）
3. **rule-execution-validator.mdc** - 规则执行校验（自动加载，必须）

**Agent 执行流程**:
1. **自动识别**: 任务已完成
2. **自动加载**: 加载上述3个规则
3. **自动执行**:
   - 分析代码质量、架构、性能等6个维度
   - 识别优化点和技术债务
   - 记录到任务日志
   - 输出优化建议
4. **自动校验**（必须，全局任务）:
   - **识别任务类型** - 确定任务类型（代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等）
   - **检查规则匹配情况** - 检查哪些规则被应用了（Always/Auto Attached/Manual）
   - **即使没有匹配到任何规则也要记录** - 明确记录"没有匹配到任何规则"
   - 检查任务日志是否已创建
   - 检查单元测试是否已运行（代码修改任务）
   - 检查任务执行汇报是否已完成
   - 检查优化分析是否已完成
   - 如果发现未执行的规则，分析原因并立即补救
   - **生成规则执行日志**（必须，检测规则系统是否良好运行）
   - 报告校验结果

---

### 场景 5: Bug 修复任务

**触发条件**: 用户报告 Bug、修复错误

**Agent 必须自动应用**:
1. **development-workflow.mdc** - Bug修复策略（已 Always 加载）
2. **agent-testing-integration-simple.mdc** - 测试验证（必须，超过2次失败必须测试）

**Agent 执行流程**:
1. **自动识别**: 任务类型为"Bug修复"
2. **自动应用**: Bug修复策略和测试规则要求
3. **执行修复**: 
   - 第一次尝试：直接修复
   - 第二次尝试：分析根本原因
   - 超过2次失败：必须运行测试验证

---

### 场景 6: 架构设计任务

**触发条件**: 用户要求设计架构、重构架构、模块化拆分

**Agent 必须自动应用**:
1. **rag-architecture.mdc** - RAG架构规范（Auto Attached，编辑相关目录时自动附加）
2. **modular-design.mdc** - 模块化设计（Auto Attached，编辑相关目录时自动附加）
3. **decision-making-principles.mdc** - 架构决策需要用户确认（自动应用）

**Agent 执行流程**:
1. **自动识别**: 任务类型为"架构设计"
2. **自动应用**: 架构规范和决策原则要求
3. **执行设计**: 按照架构规范设计，重要决策请求用户确认

---

### 场景 7: 文档更新任务

**触发条件**: 用户要求更新文档、创建文档

**Agent 必须自动应用**:
1. **file-organization.mdc** - 文档位置和命名规范（已 Always 加载）

**Agent 自动判断附加**:
- 如更新任务日志 → 自动应用 `task-log-workflow.mdc` 的要求

**Agent 执行流程**:
1. **自动识别**: 任务类型为"文档更新"
2. **自动应用**: 文件组织规范要求
3. **执行更新**: 按照文档位置和命名规范更新文档

---

## ⚠️ 强制要求（自动化）

### Agent 必须自动执行

1. **任务开始时（自动识别）**
   - [ ] **自动识别**任务类型和场景
   - [ ] **自动判断**需要哪些规则
   - [ ] **自动加载**相关规则（无需用户 @引用）
   - [ ] **自动应用**规则要求

2. **任务执行中（自动遵循）**
   - [ ] **自动遵循**已加载的规则要求
   - [ ] 如遇到规则冲突，请求用户决策
   - [ ] 根据任务进展自动加载额外需要的规则

3. **任务完成后（自动执行）**
   - [ ] **自动加载** `post-task-optimization.mdc` 进行优化分析
   - [ ] **自动加载** `task-log-workflow.mdc` 记录任务日志
   - [ ] **自动执行**优化分析和日志记录

### 禁止行为

- ❌ **不要**要求用户手动 @引用规则（这是 Agent 的职责）
- ❌ **不要**跳过规则加载步骤（必须根据场景自动加载）
- ❌ **不要**忽略场景判断（必须准确识别任务类型）

---

## 🔍 Agent 自动规则加载机制

### 自动加载流程

```
用户: 修改 src/indexer.py 文件

Agent 内部思考（自动）:
1. 识别任务: 代码修改任务
2. 自动判断: 需要以下规则
   - agent-testing-integration-simple.mdc (代码修改必须)
   - development-workflow.mdc (已 Always 加载)
   - python-code-style.mdc (已 Always 加载)
3. 自动加载: 加载 agent-testing-integration-simple.mdc
4. 执行任务: 按照规则要求修改代码并运行测试

Agent 响应（无需显示规则引用）:
好的，我将修改 src/indexer.py 文件...
[执行修改]
[自动运行单元测试 - 根据测试规则]
[自动记录结果]
```

**⚠️ 关键**: Agent 不需要在响应中显示规则引用，而是在内部自动加载和应用。

---

## 📊 规则自动选择决策树

```
任务开始
  ↓
Agent 自动识别任务类型
  ↓
┌─────────────────────────────────────────────────┐
│ 代码修改? → 自动加载: agent-testing-integration-simple │
│          → 已加载: development-workflow │
│          → 已加载: python-code-style   │
│          → 自动判断: rag-architecture (如修改相关目录) │
├─────────────────────────────────────────────────┤
│ 方案讨论? → 自动加载: proposal-discussion-workflow │
│          → 自动加载: requirement-analysis │
│          → 自动加载: decision-making-principles │
├─────────────────────────────────────────────────┤
│ 测试相关? → 自动加载: agent-testing-integration │
│          → 自动附加: testing-standards (Auto Attached) │
├─────────────────────────────────────────────────┤
│ Bug修复? → 自动加载: agent-testing-integration-simple │
│         → 已加载: development-workflow │
├─────────────────────────────────────────────────┤
│ 架构设计? → 自动附加: rag-architecture (Auto Attached) │
│          → 自动附加: modular-design (Auto Attached) │
└─────────────────────────────────────────────────┘
  ↓
Agent 自动执行任务（遵循已加载的规则）
  ↓
任务完成
  ↓
Agent 自动加载并执行:
  - post-task-optimization.mdc
  - task-log-workflow.mdc
  - rule-execution-validator.mdc（必须，校验规则执行情况）
```

---

## 📚 规则文件清单

### Always 规则（默认加载）
- `rule-selector.mdc` - 本规则（规则选择器）
- `python-code-style.mdc` - Python代码风格（核心）
- `file-organization.mdc` - 文件组织规范（核心）
- `development-workflow.mdc` - 开发工作流（核心）
- `collaboration-guidelines.mdc` - 协作要点（核心）

### Manual 规则（需要 @引用）
- `@agent-testing-integration-simple` - 测试规则（简化版）
- `@agent-testing-integration` - 测试规则（详细版）
- `@testing-standards` - 测试规范
- `@rag-architecture` - RAG架构规范
- `@modular-design` - 模块化设计
- `@proposal-discussion-workflow` - 方案讨论工作流
- `@task-log-workflow` - 任务日志工作流
- `@decision-making-principles` - 决策原则
- `@post-task-optimization` - 优化分析
- `@requirement-analysis` - 需求分析
- `@agents-sync-workflow` - 规则同步工作流
- `@rule-execution-validator` - **规则执行校验（必须）** - 确保规则被成功执行

---

## ✅ Agent 自动规则选择检查清单

**⚠️ 这是 Agent 的自动化流程，用户无需参与**

任务开始时（Agent 自动执行）：
- [ ] **自动识别**任务类型（代码修改/方案讨论/测试/Bug修复等）
- [ ] **自动判断**任务场景（使用决策树）
- [ ] **自动加载**相关规则（根据场景映射）
- [ ] **自动确认**规则要求

任务执行中（Agent 自动执行）：
- [ ] **自动遵循**已加载的规则
- [ ] 如遇到规则冲突，请求用户决策
- [ ] 根据任务进展自动加载额外需要的规则

任务完成后（Agent 自动执行）：
- [ ] **自动加载** post-task-optimization.mdc
- [ ] **自动加载** task-log-workflow.mdc
- [ ] **自动加载** rule-execution-validator.mdc（必须）
- [ ] **自动执行**优化分析和日志记录
- [ ] **自动校验**规则执行情况（必须，全局任务）
  - [ ] **识别任务类型** - 确定任务类型
  - [ ] **检查规则匹配情况** - 检查哪些规则被应用了
  - [ ] **即使没有匹配到任何规则也要记录** - 明确记录"没有匹配到任何规则"
  - [ ] 检查任务日志是否已创建
  - [ ] 检查单元测试是否已运行（代码修改任务）
  - [ ] 检查任务执行汇报是否已完成
  - [ ] 检查优化分析是否已完成
  - [ ] 如果发现未执行的规则，分析原因并立即补救
  - [ ] **生成规则执行日志**（必须，检测规则系统是否良好运行）
  - [ ] 报告校验结果

---

## 💡 示例

### 示例 1: 代码修改任务（自动）

```
用户: 修改 src/query/engine.py，添加新功能

Agent 内部思考（自动，用户不可见）:
1. 识别任务类型: 代码修改
2. 自动判断需要规则:
   - agent-testing-integration-simple.mdc (代码修改必须)
   - development-workflow.mdc (已 Always 加载)
   - python-code-style.mdc (已 Always 加载)
   - rag-architecture.mdc (Auto Attached，编辑 src/query/ 时自动附加)
3. 自动加载规则并应用

Agent 响应（用户看到）:
好的，我将修改 src/query/engine.py 添加新功能...
[执行修改]
[自动运行单元测试 - 根据测试规则]
[自动记录结果]
[任务完成后自动执行优化分析和日志记录]
```

### 示例 2: 方案讨论任务（自动）

```
用户: 先讨论一下如何实现XX功能

Agent 内部思考（自动，用户不可见）:
1. 识别任务类型: 方案讨论
2. 自动判断需要规则:
   - proposal-discussion-workflow.mdc (方案讨论必须)
   - requirement-analysis.mdc (方案讨论必须)
   - decision-making-principles.mdc (方案讨论必须)
3. 自动加载规则并应用

Agent 响应（用户看到）:
好的，我们先讨论方案...
[不着急修改代码 - 根据规则要求]
[充分讨论 - 根据规则要求]
[输出方案文档 - 必须包含4项内容]
```

---

## 🎯 核心要点（全自动）

1. **默认规则最小化**: 只有最核心的规则设为 Always
2. **场景驱动自动选择**: Agent 根据任务场景自动选择并加载规则
3. **无需用户参与**: 用户不需要手动 @引用任何规则
4. **自动执行**: Agent 自动识别→自动加载→自动应用→自动执行
5. **强制要求**: 某些场景必须自动加载特定规则（如测试、优化分析）

---

**最后更新**: 2025-01-27  
**版本**: v1.0  
**目的**: 让 Agent 具备规则选择能力，减少默认规则负担
