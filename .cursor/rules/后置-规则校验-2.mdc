---
description: 执行规则执行校验 - 任务完成后必须执行的规则执行校验和监控机制 - 确保规则被正确执行，防止规则因注意力分散而被忽略
alwaysApply: true
---
# 规则执行校验

> **核心目的**：基于AI有限的注意力可能导致规则失效，通过持续监控和校验确保规则被正确执行

**⚠️ 强制要求**：每次任务完成后必须进行规则校验和日志输出，防止规则因注意力分散而被忽略

---

## ✅ 规则执行校验检查清单

**⚠️ 全局任务（必须执行）**：每个 Agent 任务完成后必须执行规则执行校验，**即使没有匹配到任何规则也要记录"没有匹配到任何规则"**。

### 步骤1: 检查关键规则执行情况

- [ ] **检查任务日志记录** - 是否在 `agent-task-log/` 创建了日志文件？（参考 `后置-工作流-1.mdc`）
- [ ] **检查单元测试验证**（代码修改任务必须） - 使用 `agent_test_selector.py` 选择相关测试（只选择 `tests/unit/`），执行 `pytest tests/unit/test_xxx.py -v`（参考 `任务中-测试工作流-4.mdc`）
- [ ] **检查任务执行汇报** - 是否在对话框中进行了汇报？（任务概述、关键步骤、实施方法、测试情况、执行结果）
- [ ] **检查优化分析** - 是否进行了优化分析？（6个维度：代码质量、架构、性能、测试、可维护性、技术债务）（参考 `后置-工作流-1.mdc`）

### 步骤2: 检查规则匹配情况

- [ ] **识别任务类型** - 代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等
- [ ] **检查规则匹配情况** - Always规则（6个）/Auto Attached规则/Agent Requested规则/Manual规则
- [ ] **如果没有匹配到任何规则，必须明确记录"没有匹配到任何规则"**

### 步骤3: 生成规则执行日志

- [ ] **规则执行情况检查** - 检查所有匹配的规则是否被执行
- [ ] **规则执行日志生成** - 生成规则执行日志（即使没有匹配到任何规则也要记录）
- [ ] **执行率统计** - 计算规则执行率
- [ ] **健康度评估** - 评估规则系统健康度
- [ ] **未执行规则补救** - 如果规则未执行，立即分析原因并补救

---

## 📋 规则执行监控机制

### 1. 监控时机

**任务完成后**：
- 识别任务类型（代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等）
- 列出应该匹配的规则（Always/Auto Attached/Agent Requested/Manual）
- 完整校验所有规则执行情况
- 生成规则执行日志
- 记录执行率统计和健康度评估

### 2. 监控内容

**规则匹配检查**：
- Always 规则（6个）：是否全部加载？
- Auto Attached 规则：是否根据文件路径正确触发？
- Agent Requested 规则：是否根据任务场景正确选择？
- Manual 规则：是否需要@引用？

**规则执行检查**：
- 规则要求的关键步骤是否被执行？
- 规则要求的检查清单是否被完成？
- 规则要求的输出是否被生成？

**规则执行日志**：
- 记录规则匹配情况
- 记录规则执行情况
- 记录未执行规则及原因
- 记录补救措施

---

## 🔧 未执行规则补救机制

### 1. 补救流程

1. **检测未执行规则** - 通过检查清单发现规则未执行
2. **分析根本原因** - 为什么规则未执行？（注意力分散/规则描述不清/规则冲突等）
3. **立即补救** - 补充执行缺失的规则要求
4. **记录补救过程** - 在规则执行日志中记录补救措施
5. **更新执行状态** - 将未执行规则标记为"已补救"

### 2. 补救示例

**示例1：任务日志记录未执行**
- **检测**：任务完成后未生成日志文件
- **原因**：注意力分散，忽略了规则要求
- **补救**：立即创建日志文件，记录任务信息
- **记录**：在规则执行日志中记录补救过程

**示例2：单元测试验证未执行**
- **检测**：代码修改后未运行单元测试
- **原因**：忘记执行测试步骤
- **补救**：立即运行相关单元测试
- **记录**：在规则执行日志中记录测试结果

---

## 📊 规则系统健康度评估

### 1. 评估指标

**执行率**：
- 目标：100%
- 计算：已执行规则数 / 总规则数

**补救率**：
- 目标：0%（理想情况）
- 计算：已补救规则数 / 总规则数

**规则有效性**：
- 高：规则清晰，易于执行
- 中：规则基本清晰，偶有忽略
- 低：规则描述不清，经常被忽略

### 2. 健康度等级

- **优秀**：执行率100%，补救率0%，规则有效性高
- **良好**：执行率≥90%，补救率≤10%，规则有效性中高
- **一般**：执行率≥75%，补救率≤25%，规则有效性中
- **需改进**：执行率<75%，补救率>25%，规则有效性低

---

## 📝 规则执行日志格式

```markdown
# 规则执行日志

> **任务名称**: [任务名称]  
> **任务类型**: [代码修改/方案讨论/测试/Bug修复/架构设计/文档更新]  
> **校验日期**: YYYY-MM-DD HH:MM:SS  
> **校验结果**: ✅ 全部通过 / ⚠️ 部分失败（已补救） / ❌ 失败 / ⚠️ 未匹配到任何规则

---

## 📋 规则匹配情况

### Always 规则（6个核心规则）
- [x] 前置-方案讨论-1.mdc - 方案讨论工作流
- [x] 任务中-代码规范-1.mdc - 代码风格
- [x] 任务中-文档规范-2.mdc - 文档规范
- [x] 任务中-协作规范-3.mdc - 协作要点
- [x] 任务中-测试工作流-4.mdc - Agent测试工作流
- [x] 后置-工作流-1.mdc - 任务完成后工作流（任务日志记录、优化分析）
- [x] 后置-规则校验-2.mdc - 规则执行校验（当前规则）

### Auto Attached 规则（根据文件路径自动附加）
- [x] 任务中-架构规范-5.mdc - RAG架构规范（编辑 src/business/ 或 src/query/ 时自动附加）

### Agent Requested 规则（由 Cursor 根据 description 自动选择）
- [x] 任务中-规则设计-6.mdc - 规则设计原则（规则设计或优化任务时使用）

**⚠️ 特殊情况**：如果没有匹配到任何规则，必须明确记录：
```
⚠️ **未匹配到任何规则** - 当前任务类型为 [任务类型]，Cursor 未识别到需要应用的规则
- **原因分析**: [分析为什么没有匹配到规则]
- **建议**: [建议是否需要添加新规则或改进规则配置]
```

---

## 📋 规则执行情况

### ✅ 已执行的规则

| 规则名称 | 执行状态 | 执行时间 | 备注 |
|---------|---------|---------|------|
| 任务日志记录 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | agent-task-log/xxx.md |
| 单元测试验证 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | pytest ✅ 通过 |
| 任务执行汇报 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 已在对话框中汇报 |
| 优化分析 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 识别X个优化点 |

### ❌ 未执行的规则（已补救）

| 规则名称 | 初始状态 | 原因分析 | 补救措施 | 补救时间 | 最终状态 |
|---------|---------|---------|---------|---------|---------|
| 任务日志记录 | ❌ 未执行 | 忘记执行日志记录步骤 | 已创建日志文件 | YYYY-MM-DD HH:MM:SS | ✅ 已补救 |

---

## 📊 校验统计

- **总规则数**: 4
- **已执行**: 3
- **未执行**: 1（已补救）
- **执行率（补救前）**: 75%
- **执行率（补救后）**: 100%

---

## 🔍 原因分析

### 规则未执行的原因

1. **任务日志记录** - 忘记执行日志记录步骤
   - **根本原因**: Agent注意力分散，忽略了规则要求
   - **改进建议**: 增强规则可见性，使用更强烈的视觉标记

---

## 💡 规则系统健康度评估

- **规则执行率**: 100%（补救后）✅
- **规则有效性**: 高 ✅
- **规则系统状态**: 良好运行 ✅
- **需要改进**: 增强规则可见性

---

**日志生成时间**: YYYY-MM-DD HH:MM:SS
```

---

## 🎯 执行时机

**⚠️ 规则执行校验必须在任务完成后执行**：

1. **执行顺序**：
   - 先执行 `后置-工作流-1.mdc`（任务日志记录、优化分析）
   - 再执行本规则（规则执行校验）

2. **执行位置**：
   - 规则执行日志可包含在任务日志中（`agent-task-log/` 目录）
   - 也可以单独记录

3. **执行要求**：
   - 必须生成规则执行日志
   - 即使没有匹配到任何规则也要记录
   - 必须记录执行率统计和健康度评估

---

## ⚠️ 禁止行为

- ❌ 禁止跳过规则执行校验（必须执行）
- ❌ 禁止跳过规则执行日志记录（即使没有匹配到任何规则也要记录）
- ❌ 禁止忽略未执行规则的补救
- ❌ 禁止虚假记录规则执行情况

---

## 📚 相关规则

- 任务完成后工作流：`后置-工作流-1.mdc`（任务日志记录、优化分析）
- Agent测试工作流：`任务中-测试工作流-4.mdc`（单元测试验证）
- 规则索引：`.cursor/rules/README.md`

---

**最后更新**: 2025-01-27  
**版本**: v1.0（从 `后置-工作流-1.mdc` 拆分）  
**目的**: 专门负责规则执行校验和监控机制，确保规则被正确执行
