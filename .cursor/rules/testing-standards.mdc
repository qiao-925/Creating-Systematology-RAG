---
description: æµ‹è¯•è§„èŒƒä¸æœ€ä½³å®è·µ
globs:
  - "tests/**"
alwaysApply: false
---

# æµ‹è¯•è§„èŒƒ

## æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ conftest.py          # å…±äº«fixtures
â”œâ”€â”€ unit/                # å•å…ƒæµ‹è¯•ï¼ˆå¿«é€Ÿï¼Œæ— å¤–éƒ¨ä¾èµ–ï¼‰
â”œâ”€â”€ integration/         # é›†æˆæµ‹è¯•ï¼ˆéœ€è¦çœŸå®ç¯å¢ƒï¼‰
â””â”€â”€ performance/         # æ€§èƒ½åŸºå‡†æµ‹è¯•
```

---

## æµ‹è¯•åˆ†ç±»

### 1. å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰
ä½ç½®ï¼š`tests/unit/`

ç‰¹ç‚¹ï¼š
- **å¿«é€Ÿæ‰§è¡Œ**ï¼šæ— å¤–éƒ¨ä¾èµ–ï¼ˆAPIã€æ•°æ®åº“ã€ç½‘ç»œï¼‰
- **éš”ç¦»æµ‹è¯•**ï¼šä½¿ç”¨ Mock å’Œ Fixture
- **é«˜è¦†ç›–ç‡**ï¼šç›®æ ‡ 90%+

```python
import pytest
from unittest.mock import Mock, patch
from src.embeddings.local_embedding import LocalEmbedding

def test_local_embedding_embed_query(mock_model):
    """æµ‹è¯•æœ¬åœ°EmbeddingæŸ¥è¯¢å‘é‡åŒ–"""
    embedding = LocalEmbedding(model_name="test-model")
    result = embedding.embed_query("æµ‹è¯•æ–‡æœ¬")
    
    assert isinstance(result, list)
    assert len(result) > 0
    assert all(isinstance(x, float) for x in result)
```

### 2. é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰
ä½ç½®ï¼š`tests/integration/`

ç‰¹ç‚¹ï¼š
- **ç«¯åˆ°ç«¯æµç¨‹**ï¼šæµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹
- **çœŸå®ç¯å¢ƒ**ï¼šéœ€è¦çœŸå®APIã€æ•°æ®åº“ç­‰
- **æ ‡è®°æ…¢é€Ÿ**ï¼šä½¿ç”¨ `@pytest.mark.slow`

```python
import pytest

@pytest.mark.slow
@pytest.mark.integration
def test_rag_query_pipeline(test_index, test_llm):
    """æµ‹è¯•å®Œæ•´RAGæŸ¥è¯¢æµç¨‹"""
    query_engine = create_query_engine(test_index, test_llm)
    response = query_engine.query("æµ‹è¯•é—®é¢˜")
    
    assert response is not None
    assert len(response.source_nodes) > 0
```

### 3. æ€§èƒ½æµ‹è¯•ï¼ˆPerformance Testsï¼‰
ä½ç½®ï¼š`tests/performance/`

ç‰¹ç‚¹ï¼š
- **åŸºå‡†æµ‹è¯•**ï¼šè®°å½•æ€§èƒ½æŒ‡æ ‡
- **å›å½’æ£€æµ‹**ï¼šé˜²æ­¢æ€§èƒ½é€€åŒ–
- **æ ‡è®°æ€§èƒ½**ï¼šä½¿ç”¨ `@pytest.mark.performance`

---

## æµ‹è¯•æ ‡è®°ï¼ˆMarkersï¼‰

é¡¹ç›®å®šä¹‰çš„æµ‹è¯•æ ‡è®°ï¼š

```python
@pytest.mark.slow          # æ…¢é€Ÿæµ‹è¯•ï¼ˆéœ€è¦çœŸå®APIï¼‰
@pytest.mark.integration   # é›†æˆæµ‹è¯•
@pytest.mark.unit          # å•å…ƒæµ‹è¯•
@pytest.mark.performance   # æ€§èƒ½æµ‹è¯•
@pytest.mark.requires_api  # éœ€è¦APIå¯†é’¥
```

### è¿è¡Œç‰¹å®šæ ‡è®°çš„æµ‹è¯•
```bash
pytest -m unit              # åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m "not slow"        # è·³è¿‡æ…¢é€Ÿæµ‹è¯•
pytest -m integration        # åªè¿è¡Œé›†æˆæµ‹è¯•
```

---

## æµ‹è¯• Fixtures

### å…±äº« Fixtures
åœ¨ `tests/conftest.py` ä¸­å®šä¹‰å…±äº« fixturesï¼š

```python
import pytest
from src.config import Config

@pytest.fixture
def test_config():
    """æµ‹è¯•é…ç½®"""
    return Config(
        EMBEDDING_MODEL="test-model",
        DEEPSEEK_API_KEY="test-key"
    )

@pytest.fixture
def mock_embedding():
    """Mock Embeddingæ¨¡å‹"""
    from unittest.mock import Mock
    embedding = Mock()
    embedding.embed_query.return_value = [0.1] * 384
    return embedding
```

---

## Mock ä½¿ç”¨è§„èŒƒ

### 1. å¤–éƒ¨ä¾èµ–å¿…é¡» Mock
- API è°ƒç”¨ï¼ˆLLMã€Embedding APIï¼‰
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆä½¿ç”¨ `tmp_path` fixtureï¼‰
- ç½‘ç»œè¯·æ±‚ï¼ˆä½¿ç”¨ `responses` åº“æˆ– `unittest.mock`ï¼‰

### 2. ä¿ç•™æ ¸å¿ƒé€»è¾‘æµ‹è¯•
- ä¸è¦è¿‡åº¦ Mockï¼Œä¿ç•™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- Mock è¾¹ç•Œï¼šå¤–éƒ¨ä¾èµ–ï¼Œè€Œéå†…éƒ¨é€»è¾‘

```python
from unittest.mock import Mock, patch

@patch('src.embeddings.local_embedding.load_model')
def test_embedding_initialization(mock_load):
    """æµ‹è¯•Embeddingåˆå§‹åŒ–"""
    mock_load.return_value = MockModel()
    embedding = LocalEmbedding(model_name="test")
    
    assert embedding is not None
    mock_load.assert_called_once()
```

---

## æµ‹è¯•è¦†ç›–ç‡

### ç›®æ ‡
- **æ•´ä½“è¦†ç›–ç‡**ï¼šâ‰¥ 90%
- **æ ¸å¿ƒæ¨¡å—**ï¼šâ‰¥ 95%ï¼ˆ`src/business/`, `src/query/`ï¼‰
- **åŸºç¡€è®¾æ–½**ï¼šâ‰¥ 85%ï¼ˆ`src/config/`, `src/logger/`ï¼‰

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
pytest --cov=src --cov-report=html
pytest --cov=src --cov-report=term-missing
```

---

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å
- å‡½æ•°åï¼š`test_åŠŸèƒ½æè¿°`
- æ¸…æ™°æè¿°æµ‹è¯•å†…å®¹

```python
def test_retriever_returns_top_k_results():
    """æµ‹è¯•æ£€ç´¢å™¨è¿”å›top-kç»“æœ"""
    pass

def test_embedding_handles_empty_input():
    """æµ‹è¯•Embeddingå¤„ç†ç©ºè¾“å…¥"""
    pass
```

### 2. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ï¼Œä¸ä¾èµ–æ‰§è¡Œé¡ºåº
- ä½¿ç”¨ fixtures å‡†å¤‡æµ‹è¯•æ•°æ®
- æµ‹è¯•åæ¸…ç†èµ„æº

### 3. æ–­è¨€æ¸…æ™°
- ä½¿ç”¨å…·ä½“çš„æ–­è¨€æ–¹æ³•
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

```python
assert result is not None, "ç»“æœä¸åº”ä¸ºNone"
assert len(results) == expected_count, f"åº”è¿”å›{expected_count}ä¸ªç»“æœ"
```

### 4. æµ‹è¯•è¾¹ç•Œæ¡ä»¶
- ç©ºè¾“å…¥ã€Noneå€¼
- æç«¯å€¼ã€è¾¹ç•Œå€¼
- å¼‚å¸¸æƒ…å†µ

---

## æµ‹è¯•è¿è¡Œ

### å¸¸ç”¨å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit -v

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration -v

# è·³è¿‡æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"

# ç”Ÿæˆè¦†ç›–ç‡
pytest --cov=src --cov-report=html
```

### Makefile å¿«æ·å‘½ä»¤
```bash
make test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test-unit         # å•å…ƒæµ‹è¯•
make test-integration  # é›†æˆæµ‹è¯•
make test-cov          # è¦†ç›–ç‡æŠ¥å‘Š
```

---

## æµ‹è¯•å‘½åè§„èŒƒ

### æ–‡ä»¶å‘½å

- **å•å…ƒæµ‹è¯•**: `test_<æ¨¡å—å>.py` (å¦‚ `test_indexer.py`)
- **é›†æˆæµ‹è¯•**: `test_<åŠŸèƒ½>_integration.py` (å¦‚ `test_rag_service_integration.py`)
- **E2Eæµ‹è¯•**: `test_<å·¥ä½œæµ>_e2e.py` æˆ– `test_<åŠŸèƒ½>_workflow.py`
- **æ€§èƒ½æµ‹è¯•**: `test_<åŠŸèƒ½>_performance.py`
- **å›å½’æµ‹è¯•**: `test_<åŠŸèƒ½>_regression.py`

### æµ‹è¯•ç±»å‘½å

- **æ ¼å¼**: `Test<ç±»å>` æˆ– `Test<åŠŸèƒ½æè¿°>`
- **ç¤ºä¾‹**: 
  - `TestIndexManager` (æµ‹è¯• `IndexManager` ç±»)
  - `TestDataPipeline` (æµ‹è¯•æ•°æ®å¤„ç†æµæ°´çº¿)

### æµ‹è¯•å‡½æ•°å‘½å

- **æ ¼å¼**: `test_<åŠŸèƒ½>_<åœºæ™¯>`
- **ç¤ºä¾‹**:
  - `test_build_index_with_valid_documents` (æµ‹è¯•ä½¿ç”¨æœ‰æ•ˆæ–‡æ¡£æ„å»ºç´¢å¼•)
  - `test_query_engine_handles_empty_query` (æµ‹è¯•æŸ¥è¯¢å¼•æ“å¤„ç†ç©ºæŸ¥è¯¢)

**å‘½åæ¨¡å¼**:
- `test_<åŠŸèƒ½>_normal` - æ­£å¸¸æµç¨‹
- `test_<åŠŸèƒ½>_edge_cases` - è¾¹ç•Œæ¡ä»¶
- `test_<åŠŸèƒ½>_errors` - å¼‚å¸¸æƒ…å†µ
- `test_<åŠŸèƒ½>_with_<æ¡ä»¶>` - ç‰¹å®šæ¡ä»¶

### æµ‹è¯•æ³¨é‡Šè§„èŒƒ

#### æ¨¡å—çº§ Docstring

æ¯ä¸ªæµ‹è¯•æ–‡ä»¶åº”åŒ…å«æ¨¡å—çº§ docstringï¼Œè¯´æ˜ï¼š
- æµ‹è¯•çš„ç›®æ ‡æ¨¡å—æˆ–åŠŸèƒ½
- æµ‹è¯•çš„ä¸»è¦è¦†ç›–èŒƒå›´

```python
"""
ç´¢å¼•æ„å»ºæ¨¡å—å•å…ƒæµ‹è¯•

æµ‹è¯• IndexManager çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- ç´¢å¼•æ„å»º
- ç´¢å¼•æŸ¥è¯¢
- ç´¢å¼•æ¸…ç†å’Œç»Ÿè®¡
"""
```

#### æµ‹è¯•å‡½æ•° Docstring

æ¯ä¸ªæµ‹è¯•å‡½æ•°åº”åŒ…å« docstringï¼Œç®€è¦è¯´æ˜æµ‹è¯•çš„åœºæ™¯ï¼š

```python
def test_build_index_with_valid_documents(temp_index_manager, sample_documents):
    """æµ‹è¯•ä½¿ç”¨æœ‰æ•ˆæ–‡æ¡£æ„å»ºç´¢å¼•
    
    éªŒè¯ IndexManager èƒ½å¤Ÿæ­£ç¡®å¤„ç†æ–‡æ¡£åˆ—è¡¨å¹¶æ„å»ºç´¢å¼•ã€‚
    """
    pass
```

---

## ğŸ¤– Agent ä½¿ç”¨æŒ‡å—

### Agent å¦‚ä½•ç†è§£æµ‹è¯•ä½“ç³»

Agent åº”ä¼˜å…ˆæŸ¥é˜…ä»¥ä¸‹æ–‡æ¡£ï¼š
- **ä¸»ç´¢å¼•**: `tests/agent/README.md` - æµ‹è¯•ä½“ç³»ç´¢å¼•å’Œæ˜ å°„è¡¨ï¼ˆæ•´åˆç‰ˆï¼‰
- **å…ƒæ•°æ®ç´¢å¼•**: `tests/test_index.json` - æµ‹è¯•æ–‡ä»¶å…ƒæ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

### Agent å¦‚ä½•é€‰æ‹©ç›¸å…³æµ‹è¯•

**æ­¥éª¤**:
1. è¯†åˆ«ä¿®æ”¹çš„æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ `src/indexer.py`ï¼‰
2. ä½¿ç”¨ `tests/tools/agent_test_selector.py` å·¥å…·é€‰æ‹©ç›¸å…³æµ‹è¯•
3. æˆ–æŸ¥é˜… `tests/agent/README.md` ä¸­çš„æ˜ å°„è¡¨

**å‘½ä»¤ç¤ºä¾‹**:
```bash
# ä½¿ç”¨å·¥å…·è‡ªåŠ¨é€‰æ‹©
python tests/tools/agent_test_selector.py src/indexer.py

# æˆ–æ‰‹åŠ¨æŸ¥è¯¢æ˜ å°„è¡¨
# æŸ¥çœ‹ tests/agent/README.md
```

### Agent å¦‚ä½•ç†è§£æµ‹è¯•ä¿¡æ¯

ä½¿ç”¨ `tests/tools/agent_test_info.py` æŸ¥è¯¢æµ‹è¯•è¯¦ç»†ä¿¡æ¯ï¼š

```bash
# æŸ¥è¯¢æµ‹è¯•æ–‡ä»¶ä¿¡æ¯
python tests/tools/agent_test_info.py tests/unit/test_indexer.py

# JSON æ ¼å¼è¾“å‡ºï¼ˆç”¨äºç¨‹åºå¤„ç†ï¼‰
python tests/tools/agent_test_info.py tests/unit/test_indexer.py --format json
```

### Agent å¦‚ä½•ç”Ÿæˆæµ‹è¯•æ‘˜è¦

ä½¿ç”¨ `tests/tools/agent_test_summary.py` ç”Ÿæˆæµ‹è¯•æ‰§è¡Œæ‘˜è¦ï¼š

```bash
# ä» pytest è¾“å‡ºç”Ÿæˆæ‘˜è¦
pytest tests/unit/test_indexer.py -v | python tests/tools/agent_test_summary.py

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆæ‘˜è¦
python tests/tools/agent_test_summary.py tests/unit/test_indexer.py --run
```

### Agent å¦‚ä½•ç”Ÿæˆç¼ºå¤±çš„æµ‹è¯•

å‚è€ƒ `.cursor/agents-expansion/AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md` ä¸­çš„æµ‹è¯•ç”¨ä¾‹ç”ŸæˆæŒ‡å—ã€‚

---

## å‚è€ƒæ–‡æ¡£

- **æµ‹è¯•ä½¿ç”¨æŒ‡å—**: `tests/README.md` (äººç±»å¿«é€Ÿå‚è€ƒ)
- **å•å…ƒæµ‹è¯•æŒ‡å—**: `tests/unit/README.md` (å•å…ƒæµ‹è¯•è¯¦ç»†è¯´æ˜)
- **Agentæµ‹è¯•ç´¢å¼•**: `tests/agent/README.md` (Agentä¸»ç´¢å¼•ï¼Œæ•´åˆäº†æµ‹è¯•ä½“ç³»ç´¢å¼•å’Œå…ƒæ•°æ®è¯´æ˜)
- **Agentæµ‹è¯•æ•´åˆ**: `.cursor/rules/agent-testing-integration.mdc` (Agentæ•´åˆè§„åˆ™)
- **æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ**: `.cursor/agents-expansion/AGENTS-EXPANSION-ERROR_HANDLING-TESTING.md`
- **pytest é…ç½®**: `pytest.ini`
- **æµ‹è¯•è¦†ç›–ç‡**: ç›®æ ‡ 90%+