---
description: 执行任务完成后工作流 - 任务完成后必须执行的工作流 - 任务日志记录、优化分析和规则执行校验（含规则执行监控） - 所有Agent任务完成后必须执行这三个步骤
alwaysApply: true
---
# 任务完成后工作流

> **强制要求**：每个 Agent 任务完成后必须执行以下三个步骤：任务日志记录、优化分析和规则执行校验

**⚠️ 重要**: 这是任务完成后的必需流程，三个步骤缺一不可。

---

## ✅ 任务完成后必须执行（核心要求，前 50 行）

### 完整工作流检查清单

**⚠️ 全局任务（必须执行）**：每个 Agent 任务完成后必须执行以下三个步骤，**即使没有匹配到任何规则也要记录"没有匹配到任何规则"**。

#### 步骤1: 任务日志记录（必须）

- [ ] **确定日志文件位置** - 保存到 `agent-task-log/` 目录（禁止其他目录）
- [ ] **生成文件名称** - 格式：`YYYY-MM-DD-N_任务名称_文档类型.md`
- [ ] **选择文档类型** - 快速摘要/详细过程/实施总结/完成总结/实施方案
- [ ] **记录完整内容** - 任务概述、关键步骤、实施方法、测试情况、执行结果

#### 步骤2: 优化分析（必须）

- [ ] **代码质量分析** - 类型提示、docstring、文件行数、命名规范
- [ ] **架构设计分析** - 三层架构、模块职责、依赖注入
- [ ] **性能分析**（如适用） - 性能瓶颈、内存使用、并发支持
- [ ] **测试分析** - 测试覆盖、测试独立性
- [ ] **可维护性分析** - 文档完整性、日志记录、错误追踪
- [ ] **技术债务识别** - 临时方案、代码异味、重构计划
- [ ] **输出优化建议** - 至少识别2-3个优化点，优先级排序

#### 步骤3: 规则执行校验（必须）

- [ ] **检查任务日志记录** - 是否已创建日志文件？
- [ ] **检查单元测试验证**（代码修改任务必须） - 是否运行了单元测试？
- [ ] **检查任务执行汇报** - 是否在对话框中进行了汇报？
- [ ] **检查优化分析** - 是否完成了优化分析？
- [ ] **检查规则匹配情况** - Always/Auto Attached/Agent Requested/Manual规则
- [ ] **生成规则执行日志** - 即使没有匹配到任何规则也要记录
- [ ] **记录校验统计** - 执行率统计和健康度评估

---

## 📋 详细要求

### 1. 任务日志记录

#### 文件命名规范

格式：`YYYY-MM-DD-N_任务名称_文档类型.md`

- ✅ `agent-task-log/2025-01-27-1_规则合并_完成总结.md`
- ❌ 项目根目录（禁止）
- ❌ 其他目录（禁止）
- ❌ 不符合命名格式（禁止）

#### 文档类型选择

| 文档类型 | 使用场景 | 内容要求 |
|---------|---------|---------|
| **快速摘要** | 任务简要总结 | 1-2段，核心要点 |
| **详细过程** | 完整实施记录 | 时间线、思考过程、修改记录 |
| **实施总结** / **完成总结** | 任务完成后 | 成果、经验教训、后续计划，**必须包含优化分析** |
| **实施方案** | 任务实施前 | 方案设计、技术选型、实施步骤 |

#### 日志内容要求（完成总结类型）

必须包含：
- [ ] 任务概述（任务名称、目标、范围）
- [ ] 关键步骤（按顺序列出）
- [ ] 实施方法（主要技术方案）
- [ ] 测试情况（测试类型、范围、结果）
- [ ] 执行结果（完成状态、核心成果、遗留问题）
- [ ] **优化分析**（必需，见下方）
- [ ] **规则执行校验结果**（必需，见下方）

---

### 2. 优化分析

#### 分析维度（6个维度）

**代码质量分析**: 类型提示、docstring、文件行数（<300行）、命名规范、导入顺序

**架构设计分析**: 三层架构原则、模块职责单一、依赖注入、接口定义清晰

**性能分析**（如适用）: 性能瓶颈、大数据量测试、内存使用、并发支持

**测试分析**: 单元测试覆盖、集成测试、测试覆盖率≥目标值、测试独立性

**可维护性分析**: 文档完整性、日志记录、错误追踪

**技术债务识别**: 临时方案、代码异味、重构计划

#### 优化分析输出要求

- [ ] **识别优化点** - 至少识别2-3个可优化点
- [ ] **优先级排序** - 高/中/低优先级
- [ ] **输出优化建议** - 具体建议，不只是问题描述
- [ ] **记录到任务日志** - 作为完成总结的一部分

#### 优化分析输出模板

```markdown
## 🔍 任务优化分析

**任务名称**: [任务名称]  
**分析日期**: YYYY-MM-DD  
**分析范围**: [本次任务修改的文件/模块]

### 1. 代码质量分析
#### ✅ 做得好的地方
- [优点1]
- [优点2]

#### ⚠️ 可优化的地方
- **问题1**: [问题描述]
  - **影响**: [影响范围]
  - **优化建议**: [具体建议]
  - **优先级**: 🔴高 / 🟡中 / 🟢低

### 2-6. 架构/性能/测试/可维护性/技术债务分析
[类似格式...]

## 🎯 优化优先级排序
### 高优先级（立即处理）🔴
1. [优化项1]
2. [优化项2]

### 中优先级（近期处理）🟡
1. [优化项1]

### 低优先级（长期规划）🟢
1. [优化项1]
```

---

### 3. 规则执行校验（含规则执行监控）

> **核心目的**：基于AI有限的注意力可能导致规则失效，通过持续监控和校验确保规则被正确执行

**⚠️ 强制要求**：每次任务完成后必须进行规则校验和日志输出，防止规则因注意力分散而被忽略

#### 3.1 规则执行监控机制

##### 3.1.1 监控时机

**任务完成后**：
- 识别任务类型（代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等）
- 列出应该匹配的规则（Always/Auto Attached/Agent Requested/Manual）
- 完整校验所有规则执行情况
- 生成规则执行日志
- 记录执行率统计和健康度评估

##### 3.1.2 监控内容

**规则匹配检查**：
- Always 规则（6个）：是否全部加载？
- Auto Attached 规则：是否根据文件路径正确触发？
- Agent Requested 规则：是否根据任务场景正确选择？
- Manual 规则：是否需要@引用？

**规则执行检查**：
- 规则要求的关键步骤是否被执行？
- 规则要求的检查清单是否被完成？
- 规则要求的输出是否被生成？

**规则执行日志**：
- 记录规则匹配情况
- 记录规则执行情况
- 记录未执行规则及原因
- 记录补救措施

#### 3.2 校验检查清单

**检查关键规则执行情况**:
- [ ] **任务日志记录** - 是否在 `agent-task-log/` 创建了日志文件？
- [ ] **单元测试验证**（代码修改任务必须） - 使用 `agent_test_selector.py` 选择相关测试（只选择 `tests/unit/`），执行 `pytest tests/unit/test_xxx.py -v`
- [ ] **任务执行汇报** - 是否在对话框中进行了汇报？（任务概述、关键步骤、实施方法、测试情况、执行结果）
- [ ] **优化分析** - 是否进行了优化分析？（6个维度：代码质量、架构、性能、测试、可维护性、技术债务）

**检查规则匹配情况**:
- [ ] **识别任务类型** - 代码修改/方案讨论/测试/Bug修复/架构设计/文档更新等
- [ ] **检查规则匹配情况** - Always规则（6个）/Auto Attached规则/Agent Requested规则/Manual规则
- [ ] **如果没有匹配到任何规则，必须明确记录"没有匹配到任何规则"**

**生成规则执行日志**:
- [ ] **规则执行情况检查** - 检查所有匹配的规则是否被执行
- [ ] **规则执行日志生成** - 生成规则执行日志（即使没有匹配到任何规则也要记录）
- [ ] **执行率统计** - 计算规则执行率
- [ ] **健康度评估** - 评估规则系统健康度
- [ ] **未执行规则补救** - 如果规则未执行，立即分析原因并补救

#### 3.3 未执行规则补救机制

##### 3.3.1 补救流程

1. **检测未执行规则** - 通过检查清单发现规则未执行
2. **分析根本原因** - 为什么规则未执行？（注意力分散/规则描述不清/规则冲突等）
3. **立即补救** - 补充执行缺失的规则要求
4. **记录补救过程** - 在规则执行日志中记录补救措施
5. **更新执行状态** - 将未执行规则标记为"已补救"

##### 3.3.2 补救示例

**示例1：任务日志记录未执行**
- **检测**：任务完成后未生成日志文件
- **原因**：注意力分散，忽略了规则要求
- **补救**：立即创建日志文件，记录任务信息
- **记录**：在规则执行日志中记录补救过程

**示例2：单元测试验证未执行**
- **检测**：代码修改后未运行单元测试
- **原因**：忘记执行测试步骤
- **补救**：立即运行相关单元测试
- **记录**：在规则执行日志中记录测试结果

#### 3.4 规则系统健康度评估

##### 3.4.1 评估指标

**执行率**：
- 目标：100%
- 计算：已执行规则数 / 总规则数

**补救率**：
- 目标：0%（理想情况）
- 计算：已补救规则数 / 总规则数

**规则有效性**：
- 高：规则清晰，易于执行
- 中：规则基本清晰，偶有忽略
- 低：规则描述不清，经常被忽略

##### 3.4.2 健康度等级

- **优秀**：执行率100%，补救率0%，规则有效性高
- **良好**：执行率≥90%，补救率≤10%，规则有效性中高
- **一般**：执行率≥75%，补救率≤25%，规则有效性中
- **需改进**：执行率<75%，补救率>25%，规则有效性低

#### 3.5 规则执行日志格式

```markdown
# 规则执行日志

> **任务名称**: [任务名称]  
> **任务类型**: [代码修改/方案讨论/测试/Bug修复/架构设计/文档更新]  
> **校验日期**: YYYY-MM-DD HH:MM:SS  
> **校验结果**: ✅ 全部通过 / ⚠️ 部分失败（已补救） / ❌ 失败 / ⚠️ 未匹配到任何规则

---

## 📋 规则匹配情况

### Always 规则（6个核心规则）
- [x] 前置-方案讨论-1.mdc - 方案讨论工作流
- [x] 任务中-代码规范-1.mdc - 代码风格
- [x] 任务中-文档规范-2.mdc - 文档规范
- [x] 任务中-协作规范-4.mdc - 协作要点
- [x] 任务中-测试工作流-9.mdc - Agent测试工作流
- [x] 后置-工作流-1.mdc - 任务完成后工作流（任务完成后自动应用，已合并规则执行监控）

### Auto Attached 规则（根据文件路径自动附加）
- [x] 任务中-架构规范-7.mdc - RAG架构规范（编辑 src/business/ 或 src/query/ 时自动附加）

### Agent Requested 规则（由 Cursor 根据 description 自动选择）
- [x] 任务中-规则设计-6.mdc - 规则设计原则（规则设计或优化任务时使用）

**⚠️ 特殊情况**：如果没有匹配到任何规则，必须明确记录：
```
⚠️ **未匹配到任何规则** - 当前任务类型为 [任务类型]，Cursor 未识别到需要应用的规则
- **原因分析**: [分析为什么没有匹配到规则]
- **建议**: [建议是否需要添加新规则或改进规则配置]
```

---

## 📋 规则执行情况

### ✅ 已执行的规则

| 规则名称 | 执行状态 | 执行时间 | 备注 |
|---------|---------|---------|------|
| 任务日志记录 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | agent-task-log/xxx.md |
| 单元测试验证 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | pytest ✅ 通过 |
| 任务执行汇报 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 已在对话框中汇报 |
| 优化分析 | ✅ 已执行 | YYYY-MM-DD HH:MM:SS | 识别X个优化点 |

### ❌ 未执行的规则（已补救）

| 规则名称 | 初始状态 | 原因分析 | 补救措施 | 补救时间 | 最终状态 |
|---------|---------|---------|---------|---------|---------|
| 任务日志记录 | ❌ 未执行 | 忘记执行日志记录步骤 | 已创建日志文件 | YYYY-MM-DD HH:MM:SS | ✅ 已补救 |

---

## 📊 校验统计

- **总规则数**: 4
- **已执行**: 3
- **未执行**: 1（已补救）
- **执行率（补救前）**: 75%
- **执行率（补救后）**: 100%

---

## 🔍 原因分析

### 规则未执行的原因

1. **任务日志记录** - 忘记执行日志记录步骤
   - **根本原因**: Agent注意力分散，忽略了规则要求
   - **改进建议**: 增强规则可见性，使用更强烈的视觉标记

---

## 💡 规则系统健康度评估

- **规则执行率**: 100%（补救后）✅
- **规则有效性**: 高 ✅
- **规则系统状态**: 良好运行 ✅
- **需要改进**: 增强规则可见性

---

**日志生成时间**: YYYY-MM-DD HH:MM:SS
```

---

## 🎯 执行顺序说明

**⚠️ 三个步骤必须顺序执行**：

1. **第一步：任务执行汇报**（见 AGENTS.md）
   - 在对话框中即时汇报，用于用户快速了解进度
   - **不保存文件**，仅在对话中显示
   - 完成后**必须继续执行第二步**

2. **第二步：保存任务日志**（包含优化分析和规则执行校验）
   - 保存到 `agent-task-log/` 目录的详细文档
   - **必须保存文件**，提供完整记录和存档
   - 包含：任务概述、实施过程、优化分析、规则执行校验结果

3. **第三步：规则执行校验**（可选，已在第二步中完成）
   - 校验规则执行情况
   - 生成规则执行日志（可包含在任务日志中）

**三者关系**：
- 汇报提供快速概览（即时反馈）
- 日志提供详细记录（永久存档，包含优化分析和规则校验）
- **三者缺一不可，顺序执行**

---

## ⚠️ 禁止行为

- ❌ 禁止在项目根目录创建任务总结文档
- ❌ 禁止在其他目录创建任务日志
- ❌ 禁止使用其他文件命名格式
- ❌ 禁止跳过优化分析（完成总结类型必须包含）
- ❌ 禁止跳过规则执行校验（必须执行）
- ❌ 禁止跳过规则执行日志记录（即使没有匹配到任何规则也要记录）

---

## 📚 相关规则

- 任务执行汇报：`AGENTS.md`（第一步）
- 代码风格规范：`任务中-代码规范-1.mdc`
- 规则系统设计：`.cursor/rules/README.md`
- 任务日志规范：`任务中-文档规范-2.mdc`

**注意**：规则执行监控内容已合并到本规则文件中（原 `后置-规则监控-3.mdc` 已合并）

---

**最后更新**: 2025-01-27  
**版本**: v4.0（合并规则执行监控内容）  
**目的**: 统一任务完成后工作流，确保任务日志记录、优化分析和规则执行校验（含规则执行监控）完整执行
