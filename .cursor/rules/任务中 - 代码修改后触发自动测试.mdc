---
description: 执行测试工作流 - Agent测试工作流 - 包含测试工作流、Bug修复策略、自纠错机制 - 代码修改后必须运行单元测试验证
alwaysApply: true
---

# 任务中 - 代码修改后触发自动测试

> 任何代码实现、Bug 修复或重构完成后必须执行的单元测试流程，覆盖测试选择、运行、补救与记录。

---

## 1. 适用范围
- 修改 `src/`、`tests/` 或工具脚本后立即生效。
- 包括新功能、Bug 修复、重构、依赖升级导致的变更。

---

## 2. 基础原则
- [ ] 优先运行单元测试与 Mock 测试；集成 / E2E 测试由人工手动处理。
- [ ] 代码完成后立刻测试，禁止以“稍后补测”为由跳过。
- [ ] 测试失败时停止交付，先分析并修复再继续。

---

## 3. 执行清单

### 3.1 准备阶段
- [ ] 列出所有修改过的源文件路径。
- [ ] 使用 `python tests/tools/agent_test_selector.py <files...>` 获取候选测试，保留 `tests/unit/` 目录的结果。
- [ ] 如需更多上下文，查阅 `tests/agent/README.md` 或 `tests/test_index.json`。

### 3.2 测试运行
- [ ] 逐条执行 `pytest tests/unit/test_xxx.py -v`（必要时指定测试类/函数）。
- [ ] 记录命令、输出摘要、通过/失败结论。
- [ ] 如需汇总报告，可管道至 `tests/tools/agent_test_summary.py`。

### 3.3 失败处理
- [ ] 判断失败归因：本次改动引入 vs. 既有失败。
- [ ] 针对当前改动导致的失败最多尝试 3 次修复，每次前记录思路。
- [ ] 调整代码或测试后重新运行对应用例。
- [ ] 超过 3 次仍失败或出现环境问题时立即上报用户，等待指示。

### 3.4 记录与交付
- [ ] 在 `agent-task-log/` 日志中写入：测试范围、命令、结果、失败补救情况。
- [ ] 若因特殊原因无法执行测试，必须说明理由并提出风险提示。

---

## 4. 工具与参考
- `tests/tools/agent_test_selector.py`（测试筛选）
- `tests/tools/agent_test_info.py`（查看单测说明）
- `tests/tools/agent_test_summary.py`（结果摘要）
- `tests/tools/generate_test_index.py`（更新元数据）
- 参考案例：`agent-task-log/2025-11-09-1_【documentation】Cursor规则统一-完成总结.md`

---

## 5. 自纠错与升级策略
- [ ] 语法/静态检查：必要时运行 `pylint`、`mypy`。
- [ ] 运行异常：捕获具体异常并记录日志，避免裸 `except`。
- [ ] 网络或资源类瞬时错误可按 1s → 2s → 4s 退避重试，最多 3 次。
- [ ] 数据、参数、配置错误不可重试，需立即修复或求助。
- [ ] 所有失败与补救过程同步记录，便于复盘。

---

## 6. 禁止事项
- ❌ 跳过或延迟单元测试。
- ❌ 在集成/E2E 测试环境执行高成本用例。
- ❌ 测试失败仍继续提交或进入后置流程。

---

## 7. 版本信息

- **最后更新**：2025-11-09
- **版本**：v2.0（清单化测试流程与补救策略）
