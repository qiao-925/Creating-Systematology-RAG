# Cursor Rules 规则索引与使用指南

> 本目录用于指导 Cursor AI 在不同任务阶段（前置 → 任务中 → 后置）准确加载与执行项目专用规则。

---

## 1. 规则执行总览

- 明确当前任务类型（方案讨论、代码实现、文档撰写、规则优化等）。
- 根据下方推荐组合加载对应的前置 / 任务中 / 后置规则文件。
- 执行完主要交付后，遵循后置流程生成日志、优化分析与规则校验。

### 1.1 快速执行流程
- 确认任务类型 → 查阅本文件获取推荐规则组合。
- 按顺序读取并遵循前置 → 任务中 → 后置规则。
- 若任务类型特殊或出现争议，先加载 `前置规则 - 需求 - 方案 - 决策.mdc` 进行方案确认。
- 完成任务产出后，按后置规则执行日志、优化分析与规则执行校验。

### 1.2 触发方式约定

| 触发方式 | 说明 | 示例 |
|-----------|------|------|
| **Always** | 无条件加载，全局适用的基础规范。 | 方案讨论、代码/文档规范、后置日志/校验等 |
| **Auto Attached** | Cursor 根据上下文（如命中目录 glob）自动附加，仅在相关场景激活。 | 架构设计规范命中 `src/business/**` 时加载 |
| **Agent Requested** | 需用户显式指令才加载，适合临时或专用规则。 | 规则设计生成规范（当请求“设计/优化规则”时触发） |

**后置流程协作约定**
- 当主要交付完成且你未提出新的修改请求时，我会主动提示“是否进入后置流程？”——你确认后即自动执行全部后置规则。
- 如果你输入“收尾”“进入后置流程”“执行后置流程”等关键字，我会立即进入后置阶段，无需再次确认。
- 如需暂缓执行，明确告知即可；我会等待下一次触发指令，确保持有人类兜底。

---

## 2. 任务类型与推荐规则组合

| 任务类型 | 前置阶段 | 任务中阶段 | 后置阶段 | 额外说明 |
|---------|---------|-----------|---------|---------|
| 方案讨论 / 架构评审 | `前置规则 - 需求 - 方案 - 决策.mdc` | `任务中 - 架构设计生成规范.mdc`（若命中业务目录） | `后置规则 - agent任务日志生成.mdc` + `后置规则 - 任务优化分析生成.mdc` | 架构讨论完成后若有实现任务，再切换到代码实现组合 |
| 代码实现 / Bug 修复 | `前置规则 - 需求 - 方案 - 决策.mdc` | `任务中 - 代码约束.mdc` + `任务中 - 代码修改后触发自动测试.mdc` + `任务中 - Agent自动诊断.mdc` | 全部后置规则 | 若涉及文档更新，追加 `任务中 - 文档规范.mdc` |
| 文档撰写 / 规则整理 | `前置规则 - 需求 - 方案 - 决策.mdc`（可选，需求明确时可跳过） | `任务中 - 文档规范.mdc` | `后置规则 - agent任务日志生成.mdc` | 如需产出新规则，联动规则设计组合 |
| 规则设计 / 优化 | `前置规则 - 需求 - 方案 - 决策.mdc` | `任务中 - 规则设计生成规范.mdc` | `后置规则 - 规则执行校验报告.mdc` | 产出规则成品后需运行规则校验并更新本 README |

---

## 3. 阶段规则索引

### 3.1 前置阶段（任务开始前执行）

| 规则文件 | 触发方式 | 功能分类 | 要点概要 |
|---------|---------|---------|---------|
| `前置规则 - 需求 - 方案 - 决策.mdc` | Always | 工作流规范 | 阐明需求分析 → 方案设计 → 决策确认的闭环，禁止方案未定直接动手编码 |

### 3.2 任务中阶段（执行过程中应用）

| 规则文件 | 触发方式 | 功能分类 | 要点概要 |
|---------|---------|---------|---------|
| `任务中 - 代码约束.mdc` | Always | 代码规范 | Python 风格基线：类型提示、Docstring、文件长度、日志、异常处理等 |
| `任务中 - 文档规范.mdc` | Always | 文档规范 | Markdown/规则文档要求：标题序号、日期格式、篇幅限制、引用参考等 |
| `任务中 - 代码修改后触发自动测试.mdc` | Always | 测试规范 | 代码修改后必须执行相关单元测试，包含选择工具、执行命令、补救流程 |
| `任务中 - Agent自动诊断.mdc` | Always | 诊断规范 | 多次尝试、自纠错与日志记录策略，包含失败重试与升级流程 |
| `任务中 - 架构设计生成规范.mdc` | Auto Attached | 架构规范 | RAG 系统分层模块设计指南，当命中架构相关目录自动生效 |
| `任务中 - 规则设计生成规范.mdc` | Agent Requested | 元规则设计 | 规则设计/优化方法论：输出结构、评审流程、验收标准 |

### 3.3 后置阶段（任务完成后执行）

| 规则文件 | 触发方式 | 功能分类 | 要点概要 |
|---------|---------|---------|---------|
| `后置规则 - agent任务日志生成.mdc` | Always | 工作流规范 | 在 `agent-task-log/` 中生成任务日志，包含命名、内容模板与协作约定 |
| `后置规则 - 任务优化分析生成.mdc` | Always | 工作流规范 | 日志完成后补充六维分析与优先级建议，巩固经验复盘 |
| `后置规则 - 规则执行校验报告.mdc` | Always | 工作流规范 | 审核规则执行情况，记录执行率、补救措施与健康度评估 |

---

## 4. 关联资料与引用

- 项目测试索引：`tests/agent/README.md`
- 规则设计案例：`agent-task-log/2025-11-09-1_【analysis】Agent任务日志结构重组-任务优化分析.md`
- 规则执行日志示例：`agent-task-log/2025-11-09-1_【documentation】Agent任务日志结构重组-规则执行日志.md`

---

## 5. 规则编写指南（基于 Cursor 官方建议）

- **控制长度**：每条规则文件建议不超过 500 行，必要时拆分为多条可组合的小规则。
- **聚焦可执行**：采用 Checklist 或步骤式语句，描述明确的行动要求，避免冗长叙述。
- **范围清晰**：指出适用场景、触发条件与输出要求，减少含糊地带。
- **引用示例**：当规则涉及复杂流程时，在规则内引用示例文件或补充文档，正文只保留核心要求。
- **一致复用**：在聊天中重复使用同样的精简规则，避免在上下文中夹带过多一次性提示。
- **持续更新**：规则演进时同步更新本 README，保持入口文档与实际规则的一致性。

---

## 6. 规则维护流程与行数审计

### 6.1 维护流程
- 触发条件：新增任务类型、优化现有规则、官方规范更新或发现执行痛点。
- 步骤：收集需求 → 在 `README.md` 中更新规则组合 → 在对应 `.mdc` 文件中落地修改 → 运行后置规则生成日志、优化分析与规则执行校验。
- 验收：确认相关任务成功执行并通过规则校验，记录在 `agent-task-log/` 中。

### 6.2 行数审计清单
- [ ] 审查修改或新增的每条规则文件，确认行数 ≤ 500。
- [ ] 检查是否存在重复内容，可否合并或通过引用统一。
- [ ] 核对标题、触发方式、适用场景是否清晰。
- [ ] 在规则开头注明版本与最后更新时间，保持可追溯性。
- [ ] 更新本 README 的规则索引与版本信息。

---

## 7. 版本信息

- **最后更新**：2025-11-09
- **版本**：v4.0（重构规则执行总览并补充官方指南、维护流程）
