# 诊断流程详细说明

## 1. 触发条件

- 测试失败
- 出现异常
- 用户要求复盘诊断

## 2. 诊断流程

### 2.1 三轮排查机制

```
第一轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决]
    ↓
第二轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决]
    ↓
第三轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决] → 升级给用户
```

### 2.2 单轮结构

| 步骤 | 内容 | 示例 |
|------|------|------|
| 观察 | 收集错误信息 | 堆栈、日志、截图 |
| 推断 | 分析可能原因 | 依赖问题、配置错误 |
| 操作 | 执行修复尝试 | 修改代码、更新配置 |
| 结果 | 验证是否解决 | 重新运行测试 |

## 3. 诊断记录模板

```markdown
## 诊断记录

### 第一轮

**观察**：
- 错误信息：`AttributeError: 'NoneType' has no attribute 'query'`
- 发生位置：`src/query/engine.py:42`

**推断**：
- 可能原因：IndexManager 未正确初始化

**操作**：
- 检查 IndexManager 初始化代码
- 添加空值检查

**结果**：
- ❌ 问题仍存在

### 第二轮

**观察**：
- 发现配置文件缺少必需字段

**推断**：
- 配置加载顺序问题

**操作**：
- 修复配置加载逻辑

**结果**：
- ✅ 问题解决
```

## 4. 升级条件

以下情况必须升级给用户：

| 条件 | 说明 |
|------|------|
| 三轮排查无果 | 已尝试三次仍未解决 |
| 高风险操作 | 涉及数据库、生产环境 |
| 架构决策 | 需要重大设计变更 |
| 安全问题 | 涉及安全漏洞 |

## 5. 升级模板

```markdown
## 需要用户决策

### 问题描述
测试失败：test_query_engine

### 已尝试方案
1. 检查初始化逻辑 - 无效
2. 修复配置加载 - 无效
3. 重建索引 - 无效

### 风险评估
- 可能涉及数据一致性问题

### 后续选项
1. 方案 A：重构 QueryEngine（预估工作量大）
2. 方案 B：添加临时 workaround（技术债务）
3. 方案 C：暂时跳过该测试（风险：功能不稳定）

请选择后续方案。
```

## 6. 脚本使用

```bash
# 启动自动诊断
python scripts/auto_diagnose.py --error "test_query_engine failed"

# 参数说明
# --error: 错误描述
# --max-rounds: 最大排查轮数（默认 3）
# --verbose: 详细输出
```
