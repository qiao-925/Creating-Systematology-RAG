# Embedding维度不匹配修复 - 快速摘要

**日期**: 2025-10-30  
**任务**: 修复embedding模型切换后的维度不匹配问题（768维 vs 1024维）

## 问题描述

- **错误信息**: `Collection expecting embedding with dimension of 768, got 1024`
- **原因**: 
  1. 从768维的旧模型切换到1024维的新模型后，Chroma collection仍然期望768维
  2. 维度检测逻辑在某些情况下失败，导致没有正确删除和重建collection
  3. 全局模型缓存可能还保存着旧模型

## 修复内容

### 1. 改进维度检测逻辑 (`_ensure_collection_dimension_match()`)

- ✅ **强制获取模型维度**: 必须成功获取模型维度，否则抛出错误
- ✅ **多种检测方法**: 
  - 从模型属性获取 (`embed_dim`)
  - 从transformers模型config获取 (`hidden_size`)
  - 通过实际计算测试向量获取（最可靠）
- ✅ **保守策略**: 如果collection有数据但无法检测维度，自动删除并重建
- ✅ **详细日志**: 添加详细的日志输出，记录检测方法和结果

### 2. 改进模型加载逻辑 (`IndexManager.__init__()`)

- ✅ **缓存检查**: 在初始化时检查全局缓存中的模型是否匹配当前配置
- ✅ **自动清理**: 如果模型名称不匹配，自动清理缓存
- ✅ **使用统一加载函数**: 优先使用`load_embedding_model()`函数，确保缓存管理正确
- ✅ **维度验证**: 在使用缓存模型前，通过实际计算验证维度是否正确

## 修改文件

- `src/indexer.py`: 
  - 改进`_ensure_collection_dimension_match()`方法
  - 改进`IndexManager.__init__()`方法

## 测试要点

1. ✅ 从768维模型切换到1024维模型时，应该自动删除旧collection
2. ✅ 维度检测失败时，应该采用保守策略删除并重建
3. ✅ 模型缓存应该正确清理和更新
4. ✅ 日志输出应该清晰显示维度检测过程

## 结果

现在系统能够：
- ✅ 自动检测embedding模型维度
- ✅ 自动检测collection维度
- ✅ 在维度不匹配时自动删除并重建collection
- ✅ 正确处理模型切换时的缓存清理

下次切换模型时，应该不会再出现维度不匹配的错误。

