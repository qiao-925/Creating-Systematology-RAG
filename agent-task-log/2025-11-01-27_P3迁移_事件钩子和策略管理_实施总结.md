# P3è¿ç§»å®æ–½æ€»ç»“

> **åˆ›å»ºæ—¶é—´**: 2025-11-01  
> **æ–‡æ¡£ç±»å‹**: å®æ–½æ€»ç»“  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ä¸€ã€å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½å®Œæˆäº†**P3è¿ç§»ï¼šäº‹ä»¶é’©å­ + StrategyManager + A/Bæµ‹è¯•æ”¯æŒ**ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰ã€‚

---

## äºŒã€å®æ–½å†…å®¹

### 2.1 äº‹ä»¶é’©å­ï¼ˆå·²å­˜åœ¨ï¼‰

**æ–‡ä»¶**ï¼š
- `src/business/pipeline/modules/hooks.py` - HookManagerå®ç°ï¼ˆå·²å­˜åœ¨ï¼‰

**åŠŸèƒ½**ï¼š
- âœ… æµæ°´çº¿æ‰§è¡Œå‰/åé’©å­
- âœ… æ¨¡å—æ‰§è¡Œå‰/åé’©å­
- âœ… é”™è¯¯é’©å­

### 2.2 StrategyManagerå®ç°ï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶**ï¼š
- `src/business/strategy_manager.py` - ç­–ç•¥ç®¡ç†å™¨å®ç°

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… ç­–ç•¥æ³¨å†Œå’Œç®¡ç†
- âœ… ç­–ç•¥åˆ‡æ¢
- âœ… A/Bæµ‹è¯•æ”¯æŒ
- âœ… æ€§èƒ½ç›‘æ§

### 2.3 A/Bæµ‹è¯•æ”¯æŒ

**åŠŸèƒ½**ï¼š
- âœ… æŒ‰æƒé‡éšæœºé€‰æ‹©ç­–ç•¥
- âœ… ç­–ç•¥æŒ‡æ ‡è®°å½•
- âœ… æˆåŠŸç‡ç»Ÿè®¡

---

## ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½

### 3.1 StrategyManager

**ç‰¹ç‚¹**ï¼š
- âœ… å¤šç­–ç•¥å˜ä½“ç®¡ç†
- âœ… æƒé‡åˆ†é…
- âœ… æ€§èƒ½æŒ‡æ ‡è·Ÿè¸ª
- âœ… è¿è¡Œæ—¶åˆ‡æ¢

### 3.2 A/Bæµ‹è¯•

**å·¥ä½œåŸç†**ï¼š
1. æ³¨å†Œå¤šä¸ªç­–ç•¥å˜ä½“ï¼Œè®¾ç½®æƒé‡
2. å¯ç”¨A/Bæµ‹è¯•æ¨¡å¼
3. æŒ‰æƒé‡éšæœºé€‰æ‹©ç­–ç•¥
4. è®°å½•æ€§èƒ½æŒ‡æ ‡
5. åˆ†æç»“æœ

### 3.3 æ€§èƒ½ç›‘æ§

**æŒ‡æ ‡**ï¼š
- `total_requests` - æ€»è¯·æ±‚æ•°
- `success_count` - æˆåŠŸæ¬¡æ•°
- `error_count` - é”™è¯¯æ¬¡æ•°
- `avg_response_time` - å¹³å‡å“åº”æ—¶é—´
- `success_rate` - æˆåŠŸç‡

---

## å››ã€ä½¿ç”¨ç¤ºä¾‹

### 4.1 æ³¨å†Œç­–ç•¥

```python
from src.business.strategy_manager import (
    get_strategy_manager,
    StrategyType,
)

manager = get_strategy_manager()

# æ³¨å†Œæ£€ç´¢ç­–ç•¥
manager.register_strategy(
    name="vector",
    strategy_type=StrategyType.RETRIEVAL,
    config={"retrieval_strategy": "vector"},
    weight=1.0,
    is_default=True,
)

manager.register_strategy(
    name="multi",
    strategy_type=StrategyType.RETRIEVAL,
    config={"retrieval_strategy": "multi"},
    weight=0.5,
)
```

### 4.2 å¯ç”¨A/Bæµ‹è¯•

```python
# å¯ç”¨A/Bæµ‹è¯•
manager.enable_ab_test(StrategyType.RETRIEVAL, enabled=True)

# è·å–ç­–ç•¥ï¼ˆä¼šè‡ªåŠ¨æŒ‰æƒé‡é€‰æ‹©ï¼‰
strategy = manager.get_strategy(
    StrategyType.RETRIEVAL,
    enable_ab_test=True,
)
```

### 4.3 è®°å½•æŒ‡æ ‡

```python
import time

start_time = time.time()
try:
    # æ‰§è¡ŒæŸ¥è¯¢
    result = query_engine.query(question)
    success = True
except Exception as e:
    success = False
    
response_time = time.time() - start_time

# è®°å½•æŒ‡æ ‡
manager.record_strategy_metrics(
    StrategyType.RETRIEVAL,
    strategy.name,
    success,
    response_time,
)
```

### 4.4 è·å–æŒ‡æ ‡

```python
# è·å–ç‰¹å®šç­–ç•¥çš„æŒ‡æ ‡
metrics = manager.get_strategy_metrics(
    StrategyType.RETRIEVAL,
    variant_name="vector",
)

# è·å–æ‰€æœ‰ç­–ç•¥çš„æŒ‡æ ‡
all_metrics = manager.get_strategy_metrics()
```

---

## äº”ã€æŠ€æœ¯äº®ç‚¹

1. **ç­–ç•¥ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç­–ç•¥å˜ä½“
2. **A/Bæµ‹è¯•**ï¼šæ”¯æŒæƒé‡åˆ†é…å’Œéšæœºé€‰æ‹©
3. **æ€§èƒ½ç›‘æ§**ï¼šè‡ªåŠ¨è®°å½•å’Œç»Ÿè®¡æŒ‡æ ‡
4. **è¿è¡Œæ—¶åˆ‡æ¢**ï¼šæ”¯æŒåŠ¨æ€å¯ç”¨/ç¦ç”¨ç­–ç•¥

---

## å…­ã€åç»­å·¥ä½œ

### å·²å®Œæˆ âœ…
- [x] äº‹ä»¶é’©å­ï¼ˆå·²å­˜åœ¨ï¼‰
- [x] StrategyManagerå®ç°
- [x] A/Bæµ‹è¯•æ”¯æŒ
- [x] æ€§èƒ½ç›‘æ§

### å¾…å®æ–½ ğŸ“‹
- [ ] å•å…ƒæµ‹è¯•è¡¥å……
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å‰ç«¯å±‚è¿ç§»ï¼ˆç­‰å¾…ä»£ç æ‹†åˆ†ï¼‰

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

1. **æƒé‡åˆ†é…**ï¼šæƒé‡æ€»å’Œä¸éœ€è¦ä¸º1ï¼Œä¼šè‡ªåŠ¨å½’ä¸€åŒ–
2. **æŒ‡æ ‡ç»Ÿè®¡**ï¼šæŒ‡æ ‡åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åä¸¢å¤±
3. **æ€§èƒ½å¼€é”€**ï¼šA/Bæµ‹è¯•ä¼šå¢åŠ å°‘é‡éšæœºé€‰æ‹©å¼€é”€

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-01  
**çŠ¶æ€**: âœ… P3è¿ç§»å®Œæˆï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

