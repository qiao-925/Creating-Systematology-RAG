# 2025-11-02 ã€bugfixã€‘ä¿®å¤æµ‹è¯•å¯¼å…¥é”™è¯¯ - å®Œæˆæ€»ç»“

**ã€Task Typeã€‘**: bugfix
**æ—¥æœŸ**: 2025-11-02  
**ä»»åŠ¡**: ä¿®å¤ `make test` ä¸­çš„å¯¼å…¥é”™è¯¯å’Œè¯­æ³•é”™è¯¯  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

è¿è¡Œ `make test` æ—¶é‡åˆ° 8 ä¸ªæµ‹è¯•æ”¶é›†é”™è¯¯ï¼Œä»¥åŠ 1 ä¸ªè¿è¡Œæ—¶é”™è¯¯ï¼š

**æµ‹è¯•æ”¶é›†é”™è¯¯**:
1. **è¯­æ³•é”™è¯¯**: `test_observability_integration.py` ç¼©è¿›é”™è¯¯
2. **è¯­æ³•é”™è¯¯**: `few_shot.py` å¼•å·åµŒå¥—å¯¼è‡´è¯­æ³•é”™è¯¯
3. **å¯¼å…¥é”™è¯¯**: `Pipeline` ç±»å¯¼å…¥å¾ªç¯ä¾èµ–
4. **å¯¼å…¥é”™è¯¯**: `reset_strategy_manager` å‡½æ•°ä¸å­˜åœ¨
5. **å¯¼å…¥é”™è¯¯**: `_handle_github_error` å‡½æ•°å¯¼å…¥é”™è¯¯
6. **å¯¼å…¥é”™è¯¯**: `load_documents_from_wikipedia` å‡½æ•°ä¸å­˜åœ¨

**è¿è¡Œæ—¶é”™è¯¯**:
7. **è§£åŒ…é”™è¯¯**: `index_manager.py` ä¸­ `init_index_manager` è¿”å›å€¼æ•°é‡ä¸åŒ¹é…

---

## ğŸ”§ ä¿®å¤è¿‡ç¨‹

### 1. ä¿®å¤ç¼©è¿›é”™è¯¯

**æ–‡ä»¶**: `tests/integration/test_observability_integration.py`

**é—®é¢˜**: ç¬¬183è¡Œçš„ `if` è¯­å¥ååªæœ‰æ³¨é‡Šï¼Œç¼ºå°‘å¯æ‰§è¡Œä»£ç å—

**ä¿®å¤**:
```python
# RAGASåº”è¯¥æ”¶é›†è¯„ä¼°æ•°æ®
if ragas_evaluator.enabled:
    # éªŒè¯è¯„ä¼°æ•°æ®å·²æ”¶é›†
    # æ³¨æ„ï¼šå¯èƒ½éœ€è¦æ‰‹åŠ¨è§¦å‘è¯„ä¼°
    pass  # æ·»åŠ  pass å ä½ç¬¦
```

### 2. ä¿®å¤è¯­æ³•é”™è¯¯

**æ–‡ä»¶**: `src/business/prompts/few_shot.py`

**é—®é¢˜**: ç¬¬80è¡ŒåŒå¼•å·å†…åµŒå¥—åŒå¼•å·å¯¼è‡´è¯­æ³•é”™è¯¯

**ä¿®å¤**:
```python
# ä¿®å¤å‰
answer="ç³»ç»Ÿæ€ç»´æœ‰å››ä¸ªä¸»è¦ç‰¹ç‚¹ï¼š\n1. æ•´ä½“æ€§ï¼šå…³æ³¨æ•´ä½“è€Œéå±€éƒ¨\n2. åŠ¨æ€æ€§ï¼šç†è§£ç³»ç»Ÿçš„å˜åŒ–è¿‡ç¨‹\n3. å±‚æ¬¡æ€§ï¼šè®¤è¯†ç³»ç»Ÿçš„å¤šå±‚æ¬¡ç»“æ„\n4. ç›®çš„æ€§ï¼šæ˜ç¡®ç³»ç»Ÿçš„ç›®æ ‡å’ŒåŠŸèƒ½\n\næ ¸å¿ƒç†å¿µæ˜¯"æ•´ä½“å¤§äºéƒ¨åˆ†ä¹‹å’Œ"ã€‚"

# ä¿®å¤å
answer="ç³»ç»Ÿæ€ç»´æœ‰å››ä¸ªä¸»è¦ç‰¹ç‚¹ï¼š\n1. æ•´ä½“æ€§ï¼šå…³æ³¨æ•´ä½“è€Œéå±€éƒ¨\n2. åŠ¨æ€æ€§ï¼šç†è§£ç³»ç»Ÿçš„å˜åŒ–è¿‡ç¨‹\n3. å±‚æ¬¡æ€§ï¼šè®¤è¯†ç³»ç»Ÿçš„å¤šå±‚æ¬¡ç»“æ„\n4. ç›®çš„æ€§ï¼šæ˜ç¡®ç³»ç»Ÿçš„ç›®æ ‡å’ŒåŠŸèƒ½\n\næ ¸å¿ƒç†å¿µæ˜¯'æ•´ä½“å¤§äºéƒ¨åˆ†ä¹‹å’Œ'ã€‚"
```

### 3. ä¿®å¤å¾ªç¯å¯¼å…¥é—®é¢˜

**é—®é¢˜**: `Pipeline` ç±»å®šä¹‰åœ¨ `executor.py`ï¼Œä½†è¢« `execution.py` å¯¼å…¥ï¼Œå¯¼è‡´å¾ªç¯ä¾èµ–

**è§£å†³æ–¹æ¡ˆ**: å°† `Pipeline` ç±»ç§»åˆ° `protocols.py`ï¼ˆé€šç”¨åè®®æ–‡ä»¶ï¼‰

**ä¿®æ”¹æ–‡ä»¶**:
- `src/business/protocols.py`: æ·»åŠ  `Pipeline` ç±»å®šä¹‰
- `src/business/pipeline/executor.py`: ä» `protocols` å¯¼å…¥ `Pipeline` å¹¶åˆ é™¤æœ¬åœ°å®šä¹‰

### 4. æ·»åŠ ç¼ºå¤±å‡½æ•°

**æ–‡ä»¶**: `src/business/strategy_manager.py`

**é—®é¢˜**: æµ‹è¯•éœ€è¦ `reset_strategy_manager` å‡½æ•°ä½†ä»£ç ä¸­ä¸å­˜åœ¨

**ä¿®å¤**:
```python
def reset_strategy_manager():
    """é‡ç½®å…¨å±€ç­–ç•¥ç®¡ç†å™¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰"""
    global _global_strategy_manager
    _global_strategy_manager = None
    logger.info("ç­–ç•¥ç®¡ç†å™¨å·²é‡ç½®")
```

### 5. å¯¼å‡ºå‡½æ•°åˆ«å

**æ–‡ä»¶**: `src/data_loader/__init__.py`

**é—®é¢˜**: æµ‹è¯•å¯¼å…¥ `_handle_github_error`ï¼Œä½†å®é™…å‡½æ•°åæ˜¯ `handle_github_error`

**ä¿®å¤**:
```python
from src.data_loader.github_utils import handle_github_error

# å‘åå…¼å®¹ï¼šå¯¼å‡ºä¸º _handle_github_error
_handle_github_error = handle_github_error
```

### 6. åˆ›å»º Wikipedia åŠ è½½å™¨

**é—®é¢˜**: æµ‹è¯•éœ€è¦ `load_documents_from_wikipedia` å‡½æ•°ä½†ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**: åˆ›å»ºæ–°æ–‡ä»¶ `src/data_loader/wikipedia_loader.py`

**å®ç°è¦ç‚¹**:
- ä½¿ç”¨ LlamaIndex çš„ `WikipediaReader`
- æ”¯æŒå¤šè¯­è¨€ï¼ˆen/zhï¼‰
- è‡ªåŠ¨å»ºè®®æ­£ç¡®çš„é¡µé¢æ ‡é¢˜
- æ¸…ç†æ–‡æœ¬å’Œå¢å¼ºå…ƒæ•°æ®

### 7. ä¿®å¤è§£åŒ…é”™è¯¯

**æ–‡ä»¶**: `src/indexer/index_manager.py`

**é—®é¢˜**: `init_index_manager` å‡½æ•°è¿”å› 3 ä¸ªå€¼ï¼Œä½†ä»£ç å°è¯•è§£åŒ… 4 ä¸ªå€¼

**é”™è¯¯**: `ValueError: not enough values to unpack (expected 4, got 3)`

**ä¿®å¤**:
```python
# ä¿®å¤å‰
self.embed_model, self.chroma_client, self.chroma_collection, _ = init_index_manager(...)

# ä¿®å¤å
self.embed_model, self.chroma_client, self.chroma_collection = init_index_manager(...)
```

---

## âœ… ä¿®å¤ç»“æœ

### æµ‹è¯•æ”¶é›†çŠ¶æ€

**ä¿®å¤å‰**:
```
collected 508 items / 8 errors
ERROR tests/integration/test_observability_integration.py
ERROR tests/performance/test_modular_rag_performance.py
ERROR tests/test_pipeline.py
ERROR tests/test_prompts.py
ERROR tests/unit/test_data_loader.py
ERROR tests/unit/test_pipeline_executor.py
ERROR tests/unit/test_strategy_manager.py
ERROR tests/unit/test_wikipedia_loader.py
```

**ä¿®å¤å**:
```
collected 649 items
âœ… æ‰€æœ‰æµ‹è¯•æ–‡ä»¶æˆåŠŸæ”¶é›†ï¼Œæ— æ”¶é›†é”™è¯¯
```

### éªŒè¯æµ‹è¯•

```bash
# éªŒè¯æ‰€æœ‰å¯¼å…¥æˆåŠŸ
uv run python -c "from src.data_loader import _handle_github_error, load_documents_from_wikipedia; from src.business.protocols import Pipeline; from src.business.strategy_manager import reset_strategy_manager; print('All imports successful!')"
# è¾“å‡º: All imports successful!

# éªŒè¯æµ‹è¯•æ–‡ä»¶
uv run pytest tests/test_prompts.py -v
# è¾“å‡º: 18 passed in 4.27s

# éªŒè¯æµ‹è¯•æ”¶é›†
uv run pytest tests/ --collect-only
# è¾“å‡º: 649 tests collected in 10.01s
```

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 1. Python ç¼“å­˜é—®é¢˜

**ç°è±¡**: ä¿®å¤ä»£ç åæµ‹è¯•ä»ç„¶å¤±è´¥

**åŸå› **: Python çš„ `__pycache__` ç¼“å­˜å¯¼è‡´ä½¿ç”¨äº†æ—§çš„ç¼–è¯‘æ–‡ä»¶

**è§£å†³**: æ¸…ç†æ‰€æœ‰ `__pycache__` ç›®å½•
```bash
find . -type d -name __pycache__ -exec rm -rf {} +
find . -type f -name "*.pyc" -delete
```

### 2. å¾ªç¯å¯¼å…¥å¤„ç†

**é—®é¢˜**: æ¨¡å— A å¯¼å…¥ Bï¼Œæ¨¡å— B å¯¼å…¥ A

**è§£å†³**: å°†å…±äº«çš„å®šä¹‰ç§»åˆ°ç‹¬ç«‹çš„åè®®/åŸºç¡€æ¨¡å—

**åŸåˆ™**: 
- æŠ½è±¡åè®®æ”¾åœ¨ `protocols.py`
- å…·ä½“å®ç°æ”¾åœ¨å„è‡ªæ¨¡å—
- é¿å…åŒçº§æ¨¡å—é—´å¾ªç¯å¯¼å…¥

### 3. å‘åå…¼å®¹æ€§

**åœºæ™¯**: æµ‹è¯•ä½¿ç”¨æ—§çš„å‡½æ•°å `_handle_github_error`

**è§£å†³**: åœ¨ `__init__.py` ä¸­æä¾›åˆ«åå¯¼å‡º

**å¥½å¤„**: ä¿æŒ API å…¼å®¹æ€§ï¼Œé¿å…ç ´åç°æœ‰æµ‹è¯•

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

```
src/business/prompts/few_shot.py                          (è¯­æ³•ä¿®å¤)
src/business/protocols.py                                 (æ·»åŠ  Pipeline ç±»)
src/business/pipeline/executor.py                         (ç§»é™¤ Pipeline ç±»)
src/business/strategy_manager.py                          (æ·»åŠ  reset_strategy_manager)
src/data_loader/__init__.py                               (å¯¼å‡ºåˆ«å)
src/data_loader/wikipedia_loader.py                       (æ–°å»ºæ–‡ä»¶)
src/indexer/index_manager.py                              (ä¿®å¤è§£åŒ…é”™è¯¯)
tests/integration/test_observability_integration.py      (ç¼©è¿›ä¿®å¤)
```

### æ–°å¢åŠŸèƒ½

1. **Wikipedia åŠ è½½å™¨**: æ”¯æŒä»ç»´åŸºç™¾ç§‘åŠ è½½æ–‡æ¡£
   - å¤šè¯­è¨€æ”¯æŒ
   - è‡ªåŠ¨æ ‡é¢˜å»ºè®®
   - å…ƒæ•°æ®å¢å¼º

---

## ğŸ¯ åç»­å·¥ä½œ

è™½ç„¶æµ‹è¯•å¯ä»¥æˆåŠŸæ”¶é›†å’Œè¿è¡Œï¼Œä½†ä»å­˜åœ¨ä¸€äº›æµ‹è¯•å¤±è´¥ï¼ˆéå¯¼å…¥é—®é¢˜ï¼‰ï¼š

1. **ä¸šåŠ¡é€»è¾‘æµ‹è¯•å¤±è´¥**: éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•
2. **è·¨å¹³å°æµ‹è¯•**: Linux ç‰¹å®šé—®é¢˜éœ€è¦ä¿®å¤
3. **é›†æˆæµ‹è¯•**: ä¾èµ–ç¯å¢ƒé…ç½®é—®é¢˜

**å»ºè®®ä¼˜å…ˆçº§**:
- P0: æ ¸å¿ƒä¸šåŠ¡æµç¨‹æµ‹è¯•ä¿®å¤
- P1: é›†æˆæµ‹è¯•ç¯å¢ƒé…ç½®
- P2: è·¨å¹³å°å…¼å®¹æ€§ä¼˜åŒ–

---

## ğŸ’¡ ç»éªŒæ€»ç»“

1. **è¯­æ³•é”™è¯¯**: å¼•å·åµŒå¥—è¦ç‰¹åˆ«æ³¨æ„ï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨å•å¼•å·æˆ–è½¬ä¹‰
2. **å¾ªç¯å¯¼å…¥**: è®¾è®¡æ¨¡å—æ—¶é¿å…åŒçº§å¾ªç¯ï¼Œæå–åˆ°åè®®å±‚
3. **ç¼“å­˜æ¸…ç†**: ä¿®æ”¹ä»£ç åé‡åˆ°å¥‡æ€ªé—®é¢˜ï¼Œå…ˆæ¸…ç†ç¼“å­˜
4. **å‘åå…¼å®¹**: é‡æ„æ—¶è€ƒè™‘ä¿æŒ API å…¼å®¹æ€§
5. **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•æ–‡ä»¶åº”è¯¥ç‹¬ç«‹ï¼Œé¿å…ä¾èµ–é¡ºåº
6. **è§£åŒ…åŒ¹é…**: å‡½æ•°è¿”å›å€¼æ•°é‡å¿…é¡»ä¸è§£åŒ…å˜é‡æ•°é‡ä¸€è‡´

---

**ä¿®å¤äººå‘˜**: AI Agent  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸  
**å®Œæˆæ—¶é—´**: 2025-11-02

