# 2025-11-01 ã€planã€‘é‡æ’åºæ¨¡å—çº³å…¥æ¨¡å—åŒ– RAG - è®¾è®¡æ–¹æ¡ˆ

**ã€Task Typeã€‘**: plan
> **ä»»åŠ¡æ¥æº**: TRACKER.md ä»»åŠ¡9 - é‡æ’åºç­–ç•¥ä¼˜åŒ–ä¸æ£€ç´¢è¯„ä¼°  
> **åˆ›å»ºæ—¶é—´**: 2025-11-01  
> **æ–‡æ¡£ç±»å‹**: è®¾è®¡æ–¹æ¡ˆ

---

## ğŸ“‹ ç°çŠ¶åˆ†æ

### å½“å‰å®ç°ï¼ˆåŸºç¡€ç‰ˆï¼‰

**æ–‡ä»¶**: `src/modular_query_engine.py`

**å½“å‰çŠ¶æ€**ï¼š
```python
# å½“å‰å®ç°ï¼ˆç¡¬ç¼–ç ï¼‰
postprocessors.append(
    SentenceTransformerRerank(
        model=rerank_model,
        top_n=self.rerank_top_n,
    )
)
```

**é—®é¢˜**ï¼š
- âŒ åªæ”¯æŒ `SentenceTransformerRerank` ä¸€ç§é‡æ’åºå™¨
- âŒ ç¡¬ç¼–ç åœ¨ `ModularQueryEngine` ä¸­
- âŒ æ— æ³•çµæ´»åˆ‡æ¢ä¸åŒé‡æ’åºç­–ç•¥
- âŒ ç¼ºå°‘é‡æ’åºå™¨çš„æŠ½è±¡å±‚
- âŒ æ— æ³•æ–¹ä¾¿åœ°å¯¹æ¯”ä¸åŒé‡æ’åºå™¨æ•ˆæœ

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### 1. å¯æ’æ‹”è®¾è®¡

**ç›®æ ‡**ï¼šé‡æ’åºå™¨åº”è¯¥åƒ Embedding ä¸€æ ·å¯æ’æ‹”
```python
# æœŸæœ›ä½¿ç”¨æ–¹å¼
reranker = create_reranker(reranker_type="sentence-transformer")
query_engine = ModularQueryEngine(
    index_manager,
    reranker=reranker,  # å¯æ’æ‹”çš„é‡æ’åºå™¨
)
```

### 2. æ”¯æŒå¤šç§é‡æ’åºç­–ç•¥

**LlamaIndex æ”¯æŒçš„é‡æ’åºå™¨**ï¼š
- `SentenceTransformerRerank` - å¥å­åµŒå…¥é‡æ’åº âœ… å½“å‰ä½¿ç”¨
- `CohereRerank` - Cohere API é‡æ’åº
- `FlagEmbeddingReranker` - BGE é‡æ’åºæ¨¡å‹
- `LLMRerank` - ä½¿ç”¨ LLM è¿›è¡Œé‡æ’åº
- è‡ªå®šä¹‰é‡æ’åºå™¨

### 3. ç»Ÿä¸€æ¥å£

**ä¸ç°æœ‰æ¶æ„ä¸€è‡´**ï¼š
```
BaseEmbeddingï¼ˆå·²æœ‰ï¼‰
BaseRerankerï¼ˆæ–°å¢ï¼‰âœ¨
    â”œâ”€ SentenceTransformerReranker
    â”œâ”€ CohereReranker
    â”œâ”€ BGEReranker
    â””â”€ LLMReranker
```

### 4. é…ç½®é©±åŠ¨

**é…ç½®é¡¹**ï¼š
```python
RERANKER_TYPE = "sentence-transformer" | "cohere" | "bge" | "llm" | "none"
RERANKER_MODEL = "BAAI/bge-reranker-base"
RERANKER_TOP_N = 3
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ¨¡å—åŒ– RAG æ¶æ„ï¼ˆå«é‡æ’åºæ¨¡å—ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  [1] Embedding å±‚ âœ…                                 â”‚
â”‚      â””â”€ BaseEmbedding â†’ LocalEmbedding / API        â”‚
â”‚           â†“                                          â”‚
â”‚  [2] Retriever å±‚ âœ…                                 â”‚
â”‚      â””â”€ Vector / BM25 / Hybrid                      â”‚
â”‚           â†“                                          â”‚
â”‚  [3] Postprocessor å±‚ï¼ˆæ‰©å±•ï¼‰âœ¨                      â”‚
â”‚      â”œâ”€ SimilarityPostprocessor âœ…                  â”‚
â”‚      â””â”€ Rerankerï¼ˆæ–°å¢æ¨¡å—åŒ–è®¾è®¡ï¼‰âœ¨                 â”‚
â”‚          â”œâ”€ BaseRerankerï¼ˆæŠ½è±¡ï¼‰                    â”‚
â”‚          â”œâ”€ SentenceTransformerReranker             â”‚
â”‚          â”œâ”€ CohereReranker                          â”‚
â”‚          â”œâ”€ BGEReranker                             â”‚
â”‚          â””â”€ LLMReranker                             â”‚
â”‚           â†“                                          â”‚
â”‚  [4] ModularQueryEngine âœ…                           â”‚
â”‚      â””â”€ æ¥å—å¯æ’æ‹”çš„ reranker                        â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ è¯¦ç»†è®¾è®¡

### 1. æŠ½è±¡åŸºç±»

**æ–°æ–‡ä»¶**: `src/rerankers/base.py`

```python
from abc import ABC, abstractmethod
from typing import List, Optional
from llama_index.core.schema import NodeWithScore, QueryBundle

class BaseReranker(ABC):
    """é‡æ’åºå™¨åŸºç±»
    
    æ‰€æœ‰é‡æ’åºå™¨å®ç°éƒ½åº”ç»§æ‰¿æ­¤ç±»ï¼Œå®ç°ç»Ÿä¸€æ¥å£
    """
    
    @abstractmethod
    def rerank(
        self,
        nodes: List[NodeWithScore],
        query: QueryBundle,
    ) -> List[NodeWithScore]:
        """å¯¹æ£€ç´¢åˆ°çš„èŠ‚ç‚¹è¿›è¡Œé‡æ’åº
        
        Args:
            nodes: æ£€ç´¢åˆ°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼ˆå¸¦åˆ†æ•°ï¼‰
            query: æŸ¥è¯¢ä¿¡æ¯
            
        Returns:
            é‡æ’åºåçš„èŠ‚ç‚¹åˆ—è¡¨
        """
        pass
    
    @abstractmethod
    def get_reranker_name(self) -> str:
        """è·å–é‡æ’åºå™¨åç§°"""
        pass
    
    @abstractmethod
    def get_top_n(self) -> int:
        """è·å–è¿”å›çš„Top-Næ•°é‡"""
        pass
    
    def get_llama_index_postprocessor(self):
        """è·å–LlamaIndexå…¼å®¹çš„Postprocessorï¼ˆå¯é€‰ï¼‰
        
        å¦‚æœé‡æ’åºå™¨ç›´æ¥åŸºäºLlamaIndexçš„Postprocessorï¼Œ
        å¯ä»¥å®ç°æ­¤æ–¹æ³•è¿”å›åº•å±‚å®ä¾‹ï¼Œä¾¿äºé›†æˆ
        """
        return None
    
    def __repr__(self) -> str:
        return f"{self.__class__.__name__}(name={self.get_reranker_name()}, top_n={self.get_top_n()})"
```

---

### 2. SentenceTransformer é€‚é…å™¨

**æ–°æ–‡ä»¶**: `src/rerankers/sentence_transformer_reranker.py`

```python
from typing import List, Optional
from llama_index.core.schema import NodeWithScore, QueryBundle
from llama_index.core.postprocessor import SentenceTransformerRerank

from src.rerankers.base import BaseReranker
from src.config import config
from src.logger import setup_logger

logger = setup_logger('sentence_transformer_reranker')


class SentenceTransformerReranker(BaseReranker):
    """SentenceTransformeré‡æ’åºå™¨é€‚é…å™¨
    
    åŸºäºå¥å­åµŒå…¥çš„é‡æ’åºï¼Œä½¿ç”¨äº¤å‰ç¼–ç å™¨ï¼ˆCross-Encoderï¼‰
    æ¨èæ¨¡å‹ï¼š
    - BAAI/bge-reranker-base
    - BAAI/bge-reranker-large
    - cross-encoder/ms-marco-MiniLM-L-12-v2
    """
    
    def __init__(
        self,
        model: Optional[str] = None,
        top_n: Optional[int] = None,
        device: Optional[str] = None,
    ):
        """åˆå§‹åŒ–SentenceTransformeré‡æ’åºå™¨
        
        Args:
            model: æ¨¡å‹åç§°ï¼ˆé»˜è®¤ä½¿ç”¨é…ç½®ï¼‰
            top_n: è¿”å›Top-Næ•°é‡ï¼ˆé»˜è®¤ä½¿ç”¨é…ç½®ï¼‰
            device: è®¾å¤‡ï¼ˆcuda/cpuï¼Œé»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼‰
        """
        self.model_name = model or config.RERANKER_MODEL or config.EMBEDDING_MODEL
        self.top_n = top_n or config.RERANK_TOP_N
        self.device = device
        
        logger.info(f"ğŸ“¦ åˆå§‹åŒ–SentenceTransformeré‡æ’åºå™¨")
        logger.info(f"   æ¨¡å‹: {self.model_name}")
        logger.info(f"   Top-N: {self.top_n}")
        
        # åˆ›å»ºLlamaIndexçš„SentenceTransformerRerankå®ä¾‹
        self._reranker = SentenceTransformerRerank(
            model=self.model_name,
            top_n=self.top_n,
        )
        
        logger.info(f"âœ… é‡æ’åºå™¨åŠ è½½å®Œæˆ")
    
    def rerank(
        self,
        nodes: List[NodeWithScore],
        query: QueryBundle,
    ) -> List[NodeWithScore]:
        """é‡æ’åºèŠ‚ç‚¹"""
        logger.debug(f"é‡æ’åº: {len(nodes)} ä¸ªèŠ‚ç‚¹")
        return self._reranker.postprocess_nodes(nodes, query)
    
    def get_reranker_name(self) -> str:
        return self.model_name
    
    def get_top_n(self) -> int:
        return self.top_n
    
    def get_llama_index_postprocessor(self):
        """è¿”å›LlamaIndexå…¼å®¹çš„Postprocessor"""
        return self._reranker
```

---

### 3. BGE Reranker é€‚é…å™¨

**æ–°æ–‡ä»¶**: `src/rerankers/bge_reranker.py`

```python
from typing import List, Optional
from llama_index.core.schema import NodeWithScore, QueryBundle
from llama_index.postprocessor.flag_embedding_reranker import FlagEmbeddingReranker

from src.rerankers.base import BaseReranker
from src.config import config
from src.logger import setup_logger

logger = setup_logger('bge_reranker')


class BGEReranker(BaseReranker):
    """BGEé‡æ’åºå™¨é€‚é…å™¨
    
    BGEï¼ˆBAAI General Embeddingï¼‰é‡æ’åºå™¨
    æ¨èæ¨¡å‹ï¼š
    - BAAI/bge-reranker-base
    - BAAI/bge-reranker-large
    - BAAI/bge-reranker-v2-m3
    """
    
    def __init__(
        self,
        model: Optional[str] = None,
        top_n: Optional[int] = None,
        use_fp16: bool = True,
    ):
        """åˆå§‹åŒ–BGEé‡æ’åºå™¨
        
        Args:
            model: æ¨¡å‹åç§°ï¼ˆé»˜è®¤BAAI/bge-reranker-baseï¼‰
            top_n: è¿”å›Top-Næ•°é‡
            use_fp16: æ˜¯å¦ä½¿ç”¨FP16ç²¾åº¦ï¼ˆåŠ é€Ÿæ¨ç†ï¼‰
        """
        self.model_name = model or "BAAI/bge-reranker-base"
        self.top_n = top_n or config.RERANK_TOP_N
        self.use_fp16 = use_fp16
        
        logger.info(f"ğŸ“¦ åˆå§‹åŒ–BGEé‡æ’åºå™¨")
        logger.info(f"   æ¨¡å‹: {self.model_name}")
        logger.info(f"   Top-N: {self.top_n}")
        logger.info(f"   FP16: {self.use_fp16}")
        
        # åˆ›å»ºFlagEmbeddingRerankerå®ä¾‹
        self._reranker = FlagEmbeddingReranker(
            model=self.model_name,
            top_n=self.top_n,
            use_fp16=self.use_fp16,
        )
        
        logger.info(f"âœ… BGEé‡æ’åºå™¨åŠ è½½å®Œæˆ")
    
    def rerank(
        self,
        nodes: List[NodeWithScore],
        query: QueryBundle,
    ) -> List[NodeWithScore]:
        """é‡æ’åºèŠ‚ç‚¹"""
        return self._reranker.postprocess_nodes(nodes, query)
    
    def get_reranker_name(self) -> str:
        return self.model_name
    
    def get_top_n(self) -> int:
        return self.top_n
    
    def get_llama_index_postprocessor(self):
        return self._reranker
```

---

### 4. Cohere Reranker é€‚é…å™¨ï¼ˆé¢„ç•™ï¼‰

**æ–°æ–‡ä»¶**: `src/rerankers/cohere_reranker.py`

```python
from typing import List, Optional
from llama_index.core.schema import NodeWithScore, QueryBundle
from llama_index.postprocessor.cohere_rerank import CohereRerank

from src.rerankers.base import BaseReranker
from src.config import config
from src.logger import setup_logger

logger = setup_logger('cohere_reranker')


class CohereReranker(BaseReranker):
    """Cohereé‡æ’åºå™¨é€‚é…å™¨ï¼ˆé¢„ç•™ï¼‰
    
    ä½¿ç”¨Cohere APIè¿›è¡Œé‡æ’åº
    æ¨¡å‹ï¼šrerank-english-v2.0, rerank-multilingual-v2.0
    """
    
    def __init__(
        self,
        api_key: Optional[str] = None,
        model: str = "rerank-english-v2.0",
        top_n: Optional[int] = None,
    ):
        """åˆå§‹åŒ–Cohereé‡æ’åºå™¨
        
        Args:
            api_key: Cohere APIå¯†é’¥
            model: æ¨¡å‹åç§°
            top_n: è¿”å›Top-Næ•°é‡
        """
        self.api_key = api_key or getattr(config, 'COHERE_API_KEY', None)
        self.model_name = model
        self.top_n = top_n or config.RERANK_TOP_N
        
        if not self.api_key:
            raise ValueError("Cohere APIå¯†é’¥æœªé…ç½®")
        
        logger.info(f"ğŸ“¡ åˆå§‹åŒ–Cohereé‡æ’åºå™¨")
        logger.info(f"   æ¨¡å‹: {self.model_name}")
        logger.info(f"   Top-N: {self.top_n}")
        
        # åˆ›å»ºCohereRerankå®ä¾‹
        self._reranker = CohereRerank(
            api_key=self.api_key,
            model=self.model_name,
            top_n=self.top_n,
        )
        
        logger.info(f"âœ… Cohereé‡æ’åºå™¨åˆå§‹åŒ–å®Œæˆ")
    
    def rerank(
        self,
        nodes: List[NodeWithScore],
        query: QueryBundle,
    ) -> List[NodeWithScore]:
        """é‡æ’åºèŠ‚ç‚¹"""
        return self._reranker.postprocess_nodes(nodes, query)
    
    def get_reranker_name(self) -> str:
        return self.model_name
    
    def get_top_n(self) -> int:
        return self.top_n
    
    def get_llama_index_postprocessor(self):
        return self._reranker
```

---

### 5. LLM Reranker é€‚é…å™¨ï¼ˆé¢„ç•™ï¼‰

**æ–°æ–‡ä»¶**: `src/rerankers/llm_reranker.py`

```python
from typing import List, Optional
from llama_index.core.schema import NodeWithScore, QueryBundle
from llama_index.core.postprocessor import LLMRerank

from src.rerankers.base import BaseReranker
from src.config import config
from src.logger import setup_logger

logger = setup_logger('llm_reranker')


class LLMReranker(BaseReranker):
    """LLMé‡æ’åºå™¨é€‚é…å™¨ï¼ˆé¢„ç•™ï¼‰
    
    ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œé‡æ’åº
    å¯ä»¥ä½¿ç”¨ä»»ä½•LLMï¼ˆå¦‚DeepSeekã€GPTç­‰ï¼‰
    """
    
    def __init__(
        self,
        llm=None,
        top_n: Optional[int] = None,
        choice_batch_size: int = 10,
    ):
        """åˆå§‹åŒ–LLMé‡æ’åºå™¨
        
        Args:
            llm: LLMå®ä¾‹ï¼ˆå¦‚DeepSeekï¼‰
            top_n: è¿”å›Top-Næ•°é‡
            choice_batch_size: æ‰¹å¤„ç†å¤§å°
        """
        self.llm = llm
        self.top_n = top_n or config.RERANK_TOP_N
        self.choice_batch_size = choice_batch_size
        
        logger.info(f"ğŸ¤– åˆå§‹åŒ–LLMé‡æ’åºå™¨")
        logger.info(f"   LLM: {llm}")
        logger.info(f"   Top-N: {self.top_n}")
        
        # åˆ›å»ºLLMRerankå®ä¾‹
        self._reranker = LLMRerank(
            llm=llm,
            top_n=self.top_n,
            choice_batch_size=self.choice_batch_size,
        )
        
        logger.info(f"âœ… LLMé‡æ’åºå™¨åˆå§‹åŒ–å®Œæˆ")
    
    def rerank(
        self,
        nodes: List[NodeWithScore],
        query: QueryBundle,
    ) -> List[NodeWithScore]:
        """é‡æ’åºèŠ‚ç‚¹"""
        return self._reranker.postprocess_nodes(nodes, query)
    
    def get_reranker_name(self) -> str:
        return f"LLM ({type(self.llm).__name__})"
    
    def get_top_n(self) -> int:
        return self.top_n
    
    def get_llama_index_postprocessor(self):
        return self._reranker
```

---

### 6. å·¥å‚å‡½æ•°

**æ–°æ–‡ä»¶**: `src/rerankers/factory.py`

```python
from typing import Optional
from src.rerankers.base import BaseReranker
from src.rerankers.sentence_transformer_reranker import SentenceTransformerReranker
from src.rerankers.bge_reranker import BGEReranker
from src.rerankers.cohere_reranker import CohereReranker
from src.rerankers.llm_reranker import LLMReranker
from src.config import config
from src.logger import setup_logger

logger = setup_logger('reranker_factory')

# å…¨å±€Rerankerå®ä¾‹ç¼“å­˜
_global_reranker_instance: Optional[BaseReranker] = None


def create_reranker(
    reranker_type: Optional[str] = None,
    model: Optional[str] = None,
    top_n: Optional[int] = None,
    force_reload: bool = False,
    **kwargs
) -> Optional[BaseReranker]:
    """åˆ›å»ºRerankerå®ä¾‹ï¼ˆå·¥å‚å‡½æ•°ï¼‰
    
    Args:
        reranker_type: é‡æ’åºå™¨ç±»å‹ï¼ˆ"sentence-transformer"|"bge"|"cohere"|"llm"|"none"ï¼‰
        model: æ¨¡å‹åç§°
        top_n: Top-Næ•°é‡
        force_reload: æ˜¯å¦å¼ºåˆ¶é‡æ–°åˆ›å»º
        **kwargs: å…¶ä»–å‚æ•°
        
    Returns:
        BaseRerankerå®ä¾‹ï¼Œå¦‚æœreranker_type="none"åˆ™è¿”å›None
    """
    global _global_reranker_instance
    
    # ä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤å€¼
    reranker_type = reranker_type or getattr(config, 'RERANKER_TYPE', 'none')
    
    # å¦‚æœç±»å‹æ˜¯"none"ï¼Œè¿”å›Noneï¼ˆä¸ä½¿ç”¨é‡æ’åºï¼‰
    if reranker_type == "none":
        logger.info("âšª é‡æ’åºå·²ç¦ç”¨ï¼ˆtype=noneï¼‰")
        return None
    
    # å¦‚æœå·²æœ‰ç¼“å­˜ä¸”ä¸å¼ºåˆ¶é‡è½½ï¼Œè¿”å›ç¼“å­˜
    if _global_reranker_instance is not None and not force_reload:
        logger.info(f"âœ… ä½¿ç”¨ç¼“å­˜çš„Rerankerå®ä¾‹: {_global_reranker_instance}")
        return _global_reranker_instance
    
    # åˆ›å»ºæ–°å®ä¾‹
    logger.info(f"ğŸ“¦ åˆ›å»ºæ–°çš„Rerankerå®ä¾‹")
    logger.info(f"   ç±»å‹: {reranker_type}")
    logger.info(f"   æ¨¡å‹: {model or '(ä½¿ç”¨é…ç½®)'}")
    
    if reranker_type == "sentence-transformer":
        _global_reranker_instance = SentenceTransformerReranker(
            model=model,
            top_n=top_n,
            **kwargs
        )
    elif reranker_type == "bge":
        _global_reranker_instance = BGEReranker(
            model=model,
            top_n=top_n,
            **kwargs
        )
    elif reranker_type == "cohere":
        _global_reranker_instance = CohereReranker(
            model=model or "rerank-english-v2.0",
            top_n=top_n,
            **kwargs
        )
    elif reranker_type == "llm":
        _global_reranker_instance = LLMReranker(
            top_n=top_n,
            **kwargs
        )
    else:
        raise ValueError(
            f"ä¸æ”¯æŒçš„Rerankerç±»å‹: {reranker_type}. "
            f"æ”¯æŒçš„ç±»å‹: sentence-transformer, bge, cohere, llm, none"
        )
    
    logger.info(f"âœ… Rerankerå®ä¾‹åˆ›å»ºå®Œæˆ: {_global_reranker_instance}")
    
    return _global_reranker_instance


def get_reranker_instance() -> Optional[BaseReranker]:
    """è·å–å½“å‰ç¼“å­˜çš„Rerankerå®ä¾‹"""
    return _global_reranker_instance


def clear_reranker_cache():
    """æ¸…é™¤Rerankerç¼“å­˜"""
    global _global_reranker_instance
    
    if _global_reranker_instance is not None:
        logger.info("ğŸ§¹ æ¸…é™¤Rerankerç¼“å­˜")
        _global_reranker_instance = None


def reload_reranker(**kwargs) -> Optional[BaseReranker]:
    """é‡æ–°åŠ è½½Reranker"""
    logger.info("ğŸ”„ é‡æ–°åŠ è½½Reranker")
    clear_reranker_cache()
    return create_reranker(force_reload=True, **kwargs)
```

---

### 7. é…ç½®æ›´æ–°

**æ–‡ä»¶**: `src/config.py`

```python
# ===== é‡æ’åºé…ç½®ï¼ˆæ‰©å±•ï¼‰=====

# é‡æ’åºå™¨ç±»å‹: "sentence-transformer" | "bge" | "cohere" | "llm" | "none"
RERANKER_TYPE = os.getenv("RERANKER_TYPE", "none")

# é‡æ’åºæ¨¡å‹ï¼ˆä¸åŒç±»å‹ä½¿ç”¨ä¸åŒé»˜è®¤å€¼ï¼‰
RERANKER_MODEL = os.getenv("RERANKER_MODEL", None) or None

# é‡æ’åº Top-N
RERANK_TOP_N = int(os.getenv("RERANK_TOP_N", "3"))

# Cohere APIå¯†é’¥ï¼ˆä»…cohereç±»å‹éœ€è¦ï¼‰
COHERE_API_KEY = os.getenv("COHERE_API_KEY", None) or None
```

---

### 8. ModularQueryEngine é›†æˆ

**æ–‡ä»¶**: `src/modular_query_engine.py`

**ä¿®æ”¹å†…å®¹**ï¼š

```python
from src.rerankers.factory import create_reranker

class ModularQueryEngine:
    def __init__(
        self,
        index_manager: IndexManager,
        # ... ç°æœ‰å‚æ•° ...
        reranker: Optional[BaseReranker] = None,  # æ–°å¢ï¼šå¯æ’æ‹”çš„é‡æ’åºå™¨
        reranker_type: Optional[str] = None,      # æ–°å¢ï¼šé‡æ’åºå™¨ç±»å‹
    ):
        # ...
        
        # é‡æ’åºå™¨ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å®ä¾‹ï¼‰
        if reranker is not None:
            self.reranker = reranker
            logger.info(f"âœ… ä½¿ç”¨æä¾›çš„Rerankerå®ä¾‹: {reranker}")
        else:
            # ä½¿ç”¨å·¥å‚åˆ›å»º
            self.reranker = create_reranker(
                reranker_type=reranker_type,
            )
            if self.reranker:
                logger.info(f"âœ… åˆ›å»ºRerankerå®ä¾‹: {self.reranker}")
            else:
                logger.info(f"âšª é‡æ’åºå·²ç¦ç”¨")
    
    def _create_postprocessors(self) -> List:
        """åˆ›å»ºåå¤„ç†å™¨"""
        postprocessors = []
        
        # 1. ç›¸ä¼¼åº¦è¿‡æ»¤
        postprocessors.append(
            SimilarityPostprocessor(similarity_cutoff=self.similarity_cutoff)
        )
        
        # 2. é‡æ’åºï¼ˆä½¿ç”¨å¯æ’æ‹”çš„rerankerï¼‰
        if self.reranker is not None:
            # è·å–LlamaIndexå…¼å®¹çš„Postprocessor
            reranker_postprocessor = self.reranker.get_llama_index_postprocessor()
            if reranker_postprocessor:
                postprocessors.append(reranker_postprocessor)
                logger.info(f"âœ… æ·»åŠ é‡æ’åºæ¨¡å—: {self.reranker}")
            else:
                logger.warning(f"âš ï¸  Rerankerä¸æ”¯æŒLlamaIndex Postprocessoræ¥å£")
        
        return postprocessors
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šé»˜è®¤é…ç½®ï¼ˆæ— é‡æ’åºï¼‰

```python
from src.modular_query_engine import ModularQueryEngine

# é»˜è®¤ä¸å¯ç”¨é‡æ’åº
query_engine = ModularQueryEngine(index_manager)
```

### ç¤ºä¾‹2ï¼šä½¿ç”¨SentenceTransformeré‡æ’åº

```python
from src.modular_query_engine import ModularQueryEngine

# é…ç½®æ–¹å¼
query_engine = ModularQueryEngine(
    index_manager,
    reranker_type="sentence-transformer",
)

# æˆ–ä½¿ç”¨å·¥å‚å‡½æ•°
from src.rerankers import create_reranker
reranker = create_reranker(
    reranker_type="sentence-transformer",
    model="BAAI/bge-reranker-base",
    top_n=3,
)
query_engine = ModularQueryEngine(index_manager, reranker=reranker)
```

### ç¤ºä¾‹3ï¼šä½¿ç”¨BGEé‡æ’åº

```python
from src.rerankers import BGEReranker
from src.modular_query_engine import ModularQueryEngine

# æ˜¾å¼åˆ›å»º
reranker = BGEReranker(
    model="BAAI/bge-reranker-large",
    top_n=5,
    use_fp16=True,
)

query_engine = ModularQueryEngine(index_manager, reranker=reranker)
```

### ç¤ºä¾‹4ï¼šç¯å¢ƒå˜é‡é…ç½®

```bash
# .env
RERANKER_TYPE=bge
RERANKER_MODEL=BAAI/bge-reranker-base
RERANK_TOP_N=3
```

```python
# è‡ªåŠ¨è¯»å–é…ç½®
query_engine = ModularQueryEngine(index_manager)  # è‡ªåŠ¨åˆ›å»ºBGEé‡æ’åºå™¨
```

---

## ğŸ“Š é‡æ’åºå™¨å¯¹æ¯”

| é‡æ’åºå™¨ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **SentenceTransformer** | æœ¬åœ°éƒ¨ç½²ã€é€Ÿåº¦å¿« | æ¨¡å‹è¾ƒå°ï¼Œç²¾åº¦ä¸€èˆ¬ | é€šç”¨åœºæ™¯ |
| **BGE** | ç²¾åº¦é«˜ã€ä¸­æ–‡å‹å¥½ | éœ€è¦ä¸‹è½½æ¨¡å‹ | ä¸­æ–‡å‚ç›´é¢†åŸŸ |
| **Cohere** | ç²¾åº¦é«˜ã€æ˜“ç”¨ | éœ€è¦APIå¯†é’¥ã€æœ‰æˆæœ¬ | ç”Ÿäº§ç¯å¢ƒ |
| **LLM** | æœ€é«˜ç²¾åº¦ã€å¯è§£é‡Š | é€Ÿåº¦æ…¢ã€æˆæœ¬é«˜ | é«˜ç²¾åº¦éœ€æ±‚ |

---

## ğŸ¯ å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šæ ¸å¿ƒå®ç°ï¼ˆä¼˜å…ˆï¼‰

- [ ] åˆ›å»º `BaseReranker` æŠ½è±¡åŸºç±»
- [ ] å®ç° `SentenceTransformerReranker`
- [ ] å®ç° `BGEReranker`
- [ ] å®ç°å·¥å‚å‡½æ•° `create_reranker`
- [ ] æ›´æ–° `ModularQueryEngine` é›†æˆ
- [ ] æ›´æ–°é…ç½®ç®¡ç†

**å·¥ä½œé‡**ï¼š~3å°æ—¶

### é˜¶æ®µ2ï¼šæ‰©å±•å®ç°ï¼ˆå¯é€‰ï¼‰

- [ ] å®ç° `CohereReranker`ï¼ˆéœ€è¦APIå¯†é’¥ï¼‰
- [ ] å®ç° `LLMReranker`ï¼ˆéœ€è¦LLMå®ä¾‹ï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

**å·¥ä½œé‡**ï¼š~2å°æ—¶

### é˜¶æ®µ3ï¼šè¯„ä¼°ä¸ä¼˜åŒ–ï¼ˆåç»­ï¼‰

- [ ] æ£€ç´¢è¯„ä¼°å·¥å…·é›†æˆ
- [ ] ä¸åŒé‡æ’åºå™¨æ•ˆæœå¯¹æ¯”
- [ ] é’ˆå¯¹ç³»ç»Ÿç§‘å­¦é¢†åŸŸä¼˜åŒ–
- [ ] è®¡ç®—æˆæœ¬ä¼˜åŒ–

**å·¥ä½œé‡**ï¼š~4å°æ—¶

---

## â“ éœ€è¦æ‚¨å†³ç­–çš„é—®é¢˜

### é—®é¢˜1ï¼šå®æ–½ä¼˜å…ˆçº§ï¼Ÿ

**é€‰é¡¹ A**ï¼šç«‹å³å®æ–½é˜¶æ®µ1ï¼ˆæ ¸å¿ƒå®ç°ï¼‰  
**é€‰é¡¹ B**ï¼šå…ˆè¯„ä¼°å¿…è¦æ€§ï¼Œå†å†³å®šæ˜¯å¦å®æ–½  
**é€‰é¡¹ C**ï¼šä»…æ›´æ–°è®¾è®¡æ–‡æ¡£ï¼Œæš‚ä¸å®æ–½

### é—®é¢˜2ï¼šé‡æ’åºå™¨é€‰æ‹©ï¼Ÿ

éœ€è¦æ”¯æŒå“ªäº›é‡æ’åºå™¨ï¼Ÿ
- [ ] SentenceTransformerï¼ˆåŸºç¡€ï¼‰
- [ ] BGEï¼ˆæ¨èï¼Œä¸­æ–‡å‹å¥½ï¼‰
- [ ] Cohereï¼ˆéœ€è¦APIå¯†é’¥ï¼‰
- [ ] LLMï¼ˆé«˜ç²¾åº¦ï¼Œé«˜æˆæœ¬ï¼‰

### é—®é¢˜3ï¼šé»˜è®¤é…ç½®ï¼Ÿ

**é€‰é¡¹ A**ï¼šé»˜è®¤ç¦ç”¨é‡æ’åºï¼ˆ`RERANKER_TYPE=none`ï¼‰  
**é€‰é¡¹ B**ï¼šé»˜è®¤å¯ç”¨SentenceTransformer  
**é€‰é¡¹ C**ï¼šé»˜è®¤å¯ç”¨BGE

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- ğŸ“„ [LlamaIndex Rerankeræ–‡æ¡£](https://docs.llamaindex.ai/en/stable/module_guides/models/rerankers/)
- ğŸ“„ [BGE Rerankeræ¨¡å‹](https://huggingface.co/BAAI/bge-reranker-base)
- ğŸ“„ [Cohere Rerank API](https://docs.cohere.com/docs/reranking)

---

**åˆ›å»ºæ—¶é—´**: 2025-11-01  
**çŠ¶æ€**: â¸ï¸ å¾…å†³ç­–  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…å†³ç­–åå¼€å§‹å®æ–½

