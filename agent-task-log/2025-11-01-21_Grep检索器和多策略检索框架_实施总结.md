# Grep检索器和多策略检索框架实施总结

> **创建时间**: 2025-11-01  
> **文档类型**: 实施总结  
> **状态**: ✅ 已完成

---

## 一、实施概述

本次实施完成了以下核心功能：

1. **Grep检索器**：基于文本搜索的检索方式，类似Cursor Cloud方案
2. **多策略检索框架**：支持并行执行多种检索策略并合并结果
3. **结果合并器**：支持RRF、加权融合等多种合并策略
4. **适配器模式**：将新检索器适配到LlamaIndex接口

---

## 二、实施内容

### 2.1 新增文件

#### Grep检索器
- `src/retrievers/grep_retriever.py` - Grep检索器实现
  - 支持跨平台（Windows/Linux/Mac）
  - 支持正则表达式搜索
  - 支持文件系统直接访问

#### 多策略检索框架
- `src/retrievers/multi_strategy_retriever.py` - 多策略检索器
  - 并行执行多种检索策略
  - 支持自定义权重
  - 线程池并发执行

- `src/retrievers/result_merger.py` - 结果合并器
  - Reciprocal Rank Fusion (RRF)
  - 加权分数融合
  - 简单拼接
  - 去重功能

#### 适配器
- `src/retrievers/adapter.py` - LlamaIndex检索器适配器
  - 将LlamaIndex检索器适配到BaseRetriever接口

#### 模块初始化
- `src/retrievers/__init__.py` - 模块导出

### 2.2 修改文件

#### 配置更新
- `src/config/settings.py`
  - 新增多策略检索配置
  - 新增Grep检索配置
  - 支持JSON格式的权重配置

#### 检索器工厂更新
- `src/query/modular/retriever_factory.py`
  - 支持"grep"检索策略
  - 支持"multi"多策略检索
  - 新增GrepRetrieverAdapter和MultiStrategyRetrieverAdapter

#### 查询引擎更新
- `src/query/modular/engine.py`
  - 更新SUPPORTED_STRATEGIES，添加"grep"和"multi"

---

## 三、核心功能

### 3.1 Grep检索器

**特点**：
- ✅ 实时搜索：无需预处理和索引
- ✅ 跨平台支持：Windows使用Python实现，Linux/Mac使用grep命令
- ✅ 正则表达式：支持复杂的搜索模式
- ✅ 精确匹配：适合关键词、函数名、术语搜索

**使用示例**：
```python
from src.retrievers.grep_retriever import GrepRetriever

retriever = GrepRetriever(data_source_path="data/")
results = retriever.retrieve("系统科学", top_k=5)
```

### 3.2 多策略检索框架

**特点**：
- ✅ 并行执行：多种检索策略同时执行
- ✅ 结果融合：支持RRF、加权融合等
- ✅ 可配置：通过环境变量配置策略和权重
- ✅ 去重：自动去除重复结果

**使用示例**：
```python
# 通过配置启用多策略检索
# .env
RETRIEVAL_STRATEGY=multi
ENABLED_RETRIEVAL_STRATEGIES=vector,bm25,grep
RETRIEVER_WEIGHTS='{"vector": 1.0, "bm25": 0.8, "grep": 0.6}'
MERGE_STRATEGY=reciprocal_rank_fusion
```

### 3.3 结果合并算法

**Reciprocal Rank Fusion (RRF)**：
- 公式：`RRF_score = Σ(weight / (k + rank))`
- k = 60（常数）
- 无需调优权重，业界标准算法

**加权分数融合**：
- 可自定义各检索器权重
- 适合需要精确控制的场景

---

## 四、配置项

### 多策略检索配置

```bash
# 启用的检索策略（逗号分隔）
ENABLED_RETRIEVAL_STRATEGIES=vector,bm25,grep

# 合并策略
MERGE_STRATEGY=reciprocal_rank_fusion  # 或 weighted_score, simple

# 各检索器权重（JSON格式）
RETRIEVER_WEIGHTS='{"vector": 1.0, "bm25": 0.8, "grep": 0.6}'

# 是否启用去重
ENABLE_DEDUPLICATION=true
```

### Grep检索配置

```bash
# 是否启用Grep检索
ENABLE_GREP_RETRIEVAL=false

# Grep检索的数据源路径
GREP_DATA_SOURCE_PATH=data/

# Grep是否启用正则表达式
GREP_ENABLE_REGEX=true

# Grep最大结果数
GREP_MAX_RESULTS=10
```

---

## 五、架构设计

### 5.1 检索器层次结构

```
BaseRetriever（抽象接口）
    ├─ GrepRetriever（文本搜索）
    ├─ LlamaIndexRetrieverAdapter（适配器）
    │   ├─ VectorRetriever（向量检索）
    │   ├─ BM25Retriever（关键词检索）
    │   └─ HybridRetriever（混合检索）
    └─ MultiStrategyRetriever（多策略检索）
        └─ 组合多个BaseRetriever
```

### 5.2 适配器模式

```
LlamaIndex检索器接口
    ↓
LlamaIndexRetrieverAdapter
    ↓
BaseRetriever接口
    ↓
MultiStrategyRetriever
    ↓
MultiStrategyRetrieverAdapter
    ↓
LlamaIndex检索器接口（循环）
```

---

## 六、使用方式

### 6.1 启用Grep检索

```python
from src.query.modular.engine import ModularQueryEngine
from src.indexer import IndexManager

index_manager = IndexManager()
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="grep",
)
```

### 6.2 启用多策略检索

```python
# 方式1：通过配置
# .env
RETRIEVAL_STRATEGY=multi
ENABLED_RETRIEVAL_STRATEGIES=vector,bm25,grep

# 方式2：代码中指定
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="multi",
)
```

---

## 七、技术亮点

1. **跨平台兼容**：Windows使用Python实现grep功能，Linux/Mac使用系统grep命令
2. **并行执行**：使用线程池并发执行多种检索策略，提升性能
3. **统一接口**：所有检索器实现BaseRetriever接口，易于扩展
4. **适配器模式**：将新检索器无缝集成到现有LlamaIndex架构
5. **配置驱动**：通过环境变量灵活配置策略和权重

---

## 八、后续工作

### 已完成 ✅
- [x] Grep检索器实现
- [x] 多策略检索框架
- [x] 结果合并器
- [x] 配置更新
- [x] 检索器工厂集成

### 待实施 📋
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能基准测试
- [ ] 文档完善
- [ ] 使用示例

---

## 九、注意事项

1. **Grep检索路径**：默认使用`config.RAW_DATA_PATH`，确保路径存在
2. **跨平台**：Windows系统自动使用Python实现，无需grep命令
3. **性能**：多策略检索会增加延迟，建议根据场景选择策略
4. **权重配置**：RRF策略无需权重，加权融合需要调优权重

---

**实施完成时间**: 2025-11-01  
**下一步**: 单元测试和性能评估

