# 2026-01-24 【plan】UI 交互体验优化 - 实施计划

**任务类型**: optimization  
**日期**: 2026-01-24  
**任务编号**: #12  
**Agent**: Claude Opus 4.5

---

## Checkpoint 状态表

| CP | 阶段 | 状态 | 完成日期 |
|----|------|------|----------|
| CP1 | 简化配置面板 | ✅ 已完成 | 2026-01-24 |
| CP2 | 输入体验优化 | ✅ 已完成 | 2026-01-24 |
| CP3 | 观察器信息 UI 美化 | ✅ 已完成 | 2026-01-24 |
| CP4 | 引用来源 UI 美化 | ✅ 已完成 | 2026-01-24 |
| CP5 | 等待体验 - 进度展示 | ✅ 已完成 | 2026-01-24 |
| CP6 | 等待体验 - 侧边面板 UI | 🔄 简化实现 | 2026-01-24 |
| CP7 | 历史会话列表美化 | ✅ 已完成 | 2026-01-24 |

> **CP5/CP6 实施说明**：采用 `st.status` 组件简化实现（符合项目聚焦原则）。
> 原计划的进度收集+侧边面板需要大改后端架构，且 Streamlit 不支持实时更新，故简化为状态组件显示。

---

## 背景与目标

### 背景

当前 UI 存在以下交互体验问题：
- 侧边栏配置项过多，普通用户感到困惑
- 输入框需点击发送按钮，无快捷键
- 观察器信息、引用来源样式粗糙
- 等待反馈单一，只有 spinner
- 历史会话列表样式不够精致

### 目标

- 配置面板移到输入框下方，符合主流产品习惯
- 添加 Ctrl+Enter 快捷键发送
- 美化各组件样式，去掉粗糙框框
- 实现 L3 级别的查询进度展示
- 整体 UI 更简洁、现代

---

## 决策记录

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 配置面板位置 | 输入框下方 | 主流产品习惯 |
| 输入方式 | 保持 text_area | 便于在下方放置配置按钮 |
| 等待体验 | 侧边面板 + L3 详情 | 用户要求详细展示 |
| 观察器/引用样式 | 无边框轻量 | 用户要求去掉框框 |

---

## 实施步骤

### CP1: 简化配置面板

**目标**：配置移到输入框下方，侧边栏只保留新对话+历史

**任务**：
1. 修改 `sidebar.py`
   - 移除模型选择、LLM 预设、检索策略
   - 只保留：新对话按钮、历史会话列表、底部工具栏
2. 修改 `chat_input_with_mode.py`
   - 添加模型选择下拉框
   - 添加 ⚙️ 参数配置按钮
   - 布局：`[模型选择 ▼] [🤖 Agentic] [⚙️] ─── [发送]`
3. 新建/修改参数配置弹窗
   - 包含：LLM 预设、检索策略、Top-K、相似度阈值、显示设置

**效果**：
```
输入框
[deepseek-chat ▼]  [🤖 Agentic]  [⚙️]  ───  [发送]
```

**验收标准**：
- [ ] 侧边栏简洁，只有新对话+历史
- [ ] 输入框下方显示配置按钮
- [ ] ⚙️ 点击弹出参数配置弹窗
- [ ] 配置变更生效

**预计文件改动**：
- 修改：`frontend/components/sidebar.py`
- 修改：`frontend/components/chat_input_with_mode.py`
- 修改：`frontend/components/settings_dialog.py`（复用或新建参数弹窗）

---

### CP2: 输入体验优化

**目标**：添加 Ctrl+Enter 快捷键发送

**任务**：
1. 在 `chat_input_with_mode.py` 添加 JavaScript 监听
   - 监听 Ctrl+Enter（Windows/Linux）和 Cmd+Enter（Mac）
   - 触发发送按钮点击
2. 更新输入框 help 提示

**代码示例**：
```javascript
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        document.querySelector('[data-testid="send_button"]').click();
    }
});
```

**验收标准**：
- [ ] Ctrl+Enter 可发送消息
- [ ] Cmd+Enter（Mac）可发送消息
- [ ] 提示文字更新

**预计文件改动**：
- 修改：`frontend/components/chat_input_with_mode.py`

---

### CP3: 观察器信息 UI 美化

**目标**：无边框轻量样式，一行摘要

**当前**：
```
┌─────────────────────────────────────┐
│ 📊 检索: 0.8s | 📄 5篇 | 🎯 相关度 0.85 │
└─────────────────────────────────────┘
```

**优化后**：
```
📊 检索 0.8s · 📄 5篇 · 🎯 相关度 0.85

▶ 🔬 完整链路详情
▶ 🧠 推理过程
```

**任务**：
1. 修改 `observability_summary.py`
   - 移除边框容器
   - 改为一行文字，用 `·` 分隔
2. 调整 CSS 样式

**验收标准**：
- [ ] 摘要无边框，一行展示
- [ ] 视觉简洁轻量
- [ ] 折叠面板保持正常

**预计文件改动**：
- 修改：`frontend/components/observability_summary.py`
- 修改：`frontend/main.py`（CSS 样式）

---

### CP4: 引用来源 UI 美化

**目标**：去框框 + 按钮改小

**当前问题**：
- "查看完整内容" 折叠框样式粗糙
- 查看按钮太大

**优化后**：
```
[1] 文档标题.md                         📖
    预览内容前200字...
```

**任务**：
1. 修改 `sources_panel.py`
   - 移除粗糙边框
   - 查看按钮改为小图标或链接样式
   - 用缩进+浅色背景区分层级
2. 调整 CSS 样式

**验收标准**：
- [ ] 无粗糙框框
- [ ] 按钮小巧不突兀
- [ ] 整体样式精致

**预计文件改动**：
- 修改：`frontend/components/sources_panel.py`
- 修改：`frontend/main.py`（CSS 样式）

---

### CP5: 等待体验 - 进度收集

**目标**：在各处理阶段收集进度信息

**任务**：
1. 定义进度事件结构
   ```python
   @dataclass
   class ProgressEvent:
       stage: str        # 阶段名称
       status: str       # pending/running/completed
       detail: str       # 详细信息
       duration: float   # 耗时（秒）
   ```
2. 在 RAG 引擎各阶段发送进度事件
   - 查询改写
   - 向量检索
   - 关键词匹配
   - 合并去重
   - 重排序
   - LLM 生成
3. Agentic RAG 额外阶段
   - 问题分析
   - 规划步骤
   - 各步骤执行

**验收标准**：
- [ ] 各阶段能发送进度事件
- [ ] 事件包含阶段名、状态、耗时
- [ ] Agentic RAG 有额外阶段信息

**预计文件改动**：
- 新增：`backend/business/rag_engine/utils/progress.py`
- 修改：`backend/business/rag_engine/core/engine.py`
- 修改：`backend/business/rag_engine/retrieval/` 相关文件
- 修改：`backend/business/rag_engine/agentic/` 相关文件

---

### CP6: 等待体验 - 侧边面板 UI

**目标**：实现侧边进度面板 + loading 动效

**效果**：
```
┌─ 查询进度 ─────────────────┐
│ ✅ 理解问题: "RAG架构..."   │
│ ✅ 查询改写 (0.2s)          │
│ ✅ 向量检索: 8篇 (0.3s)     │
│ ✅ 关键词匹配: 3篇 (0.1s)   │
│ ✅ 重排序: 9→3篇 (0.2s)     │
│ ⏳ 生成回答... [闪烁动效]    │
└─────────────────────────────┘
```

**任务**：
1. 新建 `progress_panel.py` 组件
   - 侧边弹出面板
   - 实时显示各阶段进度
   - 当前执行阶段 loading 动效（CSS animation）
2. 集成到查询流程
   - 查询开始时显示面板
   - 接收进度事件更新 UI
   - 查询结束后保持显示

**CSS 动效示例**：
```css
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.loading-text {
    animation: pulse 1.5s ease-in-out infinite;
}
```

**验收标准**：
- [ ] 查询时显示侧边进度面板
- [ ] 各阶段实时更新
- [ ] 当前阶段有 loading 动效
- [ ] 完成后保持显示

**预计文件改动**：
- 新增：`frontend/components/progress_panel.py`
- 修改：`frontend/components/query_handler/non_streaming.py`
- 修改：`frontend/main.py`（CSS 动效）

---

### CP7: 历史会话列表美化

**目标**：字体缩小一半 + 去框框

**任务**：
1. 修改 `history.py`
   - 移除按钮边框样式
   - 添加小字体 CSS class
2. 调整 CSS 样式
   ```css
   .history-item {
       font-size: 0.75rem;
       border: none;
       background: transparent;
   }
   ```

**验收标准**：
- [ ] 历史会话字体缩小
- [ ] 无边框，简洁
- [ ] 点击功能正常

**预计文件改动**：
- 修改：`frontend/components/history.py`
- 修改：`frontend/main.py`（CSS 样式）

---

## 文件改动清单

| 操作 | 文件 | 说明 |
|------|------|------|
| 修改 | `frontend/components/sidebar.py` | 移除配置面板 |
| 修改 | `frontend/components/chat_input_with_mode.py` | 添加配置按钮、快捷键 |
| 修改 | `frontend/components/settings_dialog.py` | 参数配置弹窗 |
| 修改 | `frontend/components/observability_summary.py` | 无边框样式 |
| 修改 | `frontend/components/sources_panel.py` | 美化样式 |
| 修改 | `frontend/components/history.py` | 小字体无边框 |
| 修改 | `frontend/components/query_handler/non_streaming.py` | 集成进度面板 |
| 修改 | `frontend/main.py` | CSS 样式 |
| 新增 | `frontend/components/progress_panel.py` | 侧边进度面板 |
| 新增 | `backend/business/rag_engine/utils/progress.py` | 进度事件 |
| 修改 | `backend/business/rag_engine/core/engine.py` | 发送进度事件 |
| 修改 | `backend/business/rag_engine/retrieval/` | 发送进度事件 |
| 修改 | `backend/business/rag_engine/agentic/` | 发送进度事件 |

---

## 执行顺序建议

1. **CP1 + CP2**：配置面板 + 输入优化（可并行）
2. **CP3 + CP4 + CP7**：样式美化（可并行，纯前端）
3. **CP5 → CP6**：等待体验（有依赖，CP5 后端先行，CP6 前端跟进）

---

## 风险与注意事项

1. **CP1 配置迁移**：确保配置变更回调正确绑定
2. **CP5 进度收集**：注意线程安全，避免阻塞主流程
3. **CSS 兼容性**：测试不同浏览器的动效表现
4. **回归测试**：每个 CP 完成后验证核心功能正常

---

## 下一步

确认计划后，从 **CP1（简化配置面板）** 开始执行。
