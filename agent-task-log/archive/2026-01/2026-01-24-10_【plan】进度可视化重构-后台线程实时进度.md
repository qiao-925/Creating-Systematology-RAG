# 2026-01-24 ã€planã€‘è¿›åº¦å¯è§†åŒ–é‡æ„ - åå°çº¿ç¨‹å®æ—¶è¿›åº¦

**ä»»åŠ¡ç±»å‹**: plan  
**æ—¥æœŸ**: 2026-01-24  
**ä»»åŠ¡ç¼–å·**: #10  
**Agent**: Claude Opus 4.5

---

## Checkpoint çŠ¶æ€è¡¨

| CP | é˜¶æ®µ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|----|------|------|----------|
| CP1 | build_index æ·»åŠ è¿›åº¦å›è°ƒ | âœ… å·²å®Œæˆ | 2026-01-24 |
| CP2 | åˆ›å»º ImportTask åå°ä»»åŠ¡ç±» | âœ… å·²å®Œæˆ | 2026-01-24 |
| CP3 | å‰ç«¯è½®è¯¢ç»„ä»¶æ”¹é€  | âœ… å·²å®Œæˆ | 2026-01-24 |
| CP4 | é›†æˆæµ‹è¯•ä¸éªŒæ”¶ | âœ… å·²å®Œæˆ | 2026-01-24 |

---

## èƒŒæ™¯ä¸ç›®æ ‡

### èƒŒæ™¯

å½“å‰è¿›åº¦å¯è§†åŒ–å®ç°å­˜åœ¨é—®é¢˜ï¼š
1. **`ImportProgressManager` åˆ›å»ºä½†æœªä½¿ç”¨** - å‰ç«¯ `data_source.py` åˆ›å»ºäº†è¿›åº¦ç®¡ç†å™¨ä½†æ²¡ç”¨å®ƒ
2. **è¿›åº¦æ¡æ˜¯å‡çš„** - åªæ˜¯å›ºå®šå€¼è·³è·ƒ (0.1 â†’ 0.2 â†’ 0.6 â†’ 0.9 â†’ 1.0)
3. **Streamlit å•çº¿ç¨‹é˜»å¡** - `build_index()` æ‰§è¡ŒæœŸé—´æ— æ³•æ›´æ–° UI
4. **è€—æ—¶æœ€é•¿çš„é˜¶æ®µæ— è¿›åº¦** - ç´¢å¼•æ„å»ºæ˜¯æœ€è€—æ—¶çš„ï¼Œä½†å‰ç«¯çœ‹ä¸åˆ°ä¸­é—´è¿›åº¦

### ç›®æ ‡

å®ç°**çœŸæ­£çš„å®æ—¶è¿›åº¦æ˜¾ç¤º**ï¼š
1. åå°çº¿ç¨‹æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ï¼Œä¸é˜»å¡å‰ç«¯
2. è¿›åº¦ç®¡ç†å™¨å®æ—¶æ›´æ–°çŠ¶æ€ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
3. å‰ç«¯è½®è¯¢è·å–è¿›åº¦å¹¶æ›´æ–° UI
4. ç´¢å¼•æ„å»ºé˜¶æ®µæ˜¾ç¤ºçœŸå®çš„æ–‡æ¡£/æ‰¹æ¬¡è¿›åº¦

---

## å†³ç­–è®°å½•

### å†³ç­–ç‚¹ï¼šè¿›åº¦æ›´æ–°æœºåˆ¶

**èƒŒæ™¯**ï¼šStreamlit å•çº¿ç¨‹æ¨¡å‹é™åˆ¶ï¼Œæ— æ³•åœ¨åŒæ­¥æ‰§è¡ŒæœŸé—´æ›´æ–° UI

**é€‰é¡¹**ï¼š
1. **åå°çº¿ç¨‹ + è½®è¯¢**ï¼šä»»åŠ¡æ”¾åå°çº¿ç¨‹ï¼Œå‰ç«¯è½®è¯¢è¿›åº¦
   - ä¼˜åŠ¿ï¼šçœŸæ­£å®æ—¶ï¼Œç”¨æˆ·ä½“éªŒå¥½
   - åŠ£åŠ¿ï¼šå®ç°å¤æ‚åº¦é«˜ï¼Œéœ€å¤„ç†çº¿ç¨‹å®‰å…¨
2. **åˆ†æ‰¹å¤„ç† + é‡æ¸²æŸ“**ï¼šåˆ†æ‰¹æ‰§è¡Œï¼Œæ¯æ‰¹å `st.rerun()`
   - ä¼˜åŠ¿ï¼šå®ç°ç®€å•
   - åŠ£åŠ¿ï¼šæ¯æ¬¡ rerun ä¼šé‡ç½®é¡µé¢çŠ¶æ€ï¼Œä½“éªŒå‰²è£‚
3. **SSE/WebSocket**ï¼šå®æ—¶æ¨é€
   - ä¼˜åŠ¿ï¼šæœ€ä½³å®æ—¶æ€§
   - åŠ£åŠ¿ï¼šStreamlit åŸç”Ÿä¸æ”¯æŒï¼Œéœ€è¦é¢å¤–ç»„ä»¶

**å†³ç­–**ï¼šé€‰æ‹© **é€‰é¡¹ 1ï¼ˆåå°çº¿ç¨‹ + è½®è¯¢ï¼‰**

**ç†ç”±**ï¼š
- æä¾›çœŸæ­£çš„å®æ—¶è¿›åº¦ä½“éªŒ
- ç¬¦åˆç”¨æˆ·æœŸæœ›ï¼ˆæ–¹æ¡ˆ Aï¼‰
- `ImportProgressManager` å·²æœ‰åŸºç¡€ï¼Œæ”¹é€ æˆæœ¬å¯æ§

**æ—¥æœŸ**ï¼š2026-01-24

---

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend (Streamlit)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  1. å¯åŠ¨ä»»åŠ¡ â†’ task = ImportTask.start(...)         â”‚â”‚
â”‚  â”‚  2. è½®è¯¢å¾ªç¯:                                       â”‚â”‚
â”‚  â”‚     while not task.is_complete:                     â”‚â”‚
â”‚  â”‚       progress = task.get_progress()                â”‚â”‚
â”‚  â”‚       render_progress(progress)                     â”‚â”‚
â”‚  â”‚       time.sleep(0.3)                               â”‚â”‚
â”‚  â”‚       st.rerun()                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ è¯»å– (çº¿ç¨‹å®‰å…¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ImportProgressManager (å·²æœ‰ï¼Œéœ€å¢å¼º)         â”‚
â”‚  - current_stage: ImportStage                           â”‚
â”‚  - progress_current / progress_total                    â”‚
â”‚  - logs: List[LogEntry]                                 â”‚
â”‚  - æ–°å¢: _lock (threading.Lock)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘ æ›´æ–° (åå°çº¿ç¨‹)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ImportTask (æ–°å¢)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  åå°çº¿ç¨‹æ‰§è¡Œ:                                       â”‚â”‚
â”‚  â”‚  1. preflight()     â†’ pm.start_stage(PREFLIGHT)     â”‚â”‚
â”‚  â”‚  2. git_clone()     â†’ pm.start_stage(GIT_CLONE)     â”‚â”‚
â”‚  â”‚  3. sync_docs()     â†’ pm.start_stage(FILE_WALK)     â”‚â”‚
â”‚  â”‚  4. build_index()   â†’ pm.update_progress(i, total)  â”‚â”‚
â”‚  â”‚  5. save_state()    â†’ pm.complete_import()          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘ å›è°ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              build_index() æ”¹é€                           â”‚
â”‚  - æ–°å¢ progress_callback å‚æ•°                          â”‚
â”‚  - æ¯æ‰¹æ¬¡è°ƒç”¨å›è°ƒ: callback(current, total)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®æ–½æ­¥éª¤

### CP1: build_index æ·»åŠ è¿›åº¦å›è°ƒ

**ç›®æ ‡**ï¼šè®© `build_index()` æ”¯æŒè¿›åº¦å›è°ƒï¼Œå¤–éƒ¨å¯æ„ŸçŸ¥å¤„ç†è¿›åº¦

**ä»»åŠ¡**ï¼š
1. ä¿®æ”¹ `backend/infrastructure/indexer/build/normal.py`
   - `build_index_normal_mode()` æ·»åŠ  `progress_callback` å‚æ•°
   - æ‰¹é‡æ’å…¥æ—¶æ¯æ‰¹æ¬¡è°ƒç”¨å›è°ƒ
2. ä¿®æ”¹ `backend/infrastructure/indexer/build/builder.py`
   - `build_index_method()` é€ä¼  `progress_callback`
3. ä¿®æ”¹ `backend/infrastructure/indexer/core/manager.py`
   - `IndexManager.build_index()` æ·»åŠ  `progress_callback` å‚æ•°
4. ä¿®æ”¹ `backend/infrastructure/indexer/service.py`
   - `IndexService.build_index()` é€ä¼ å‚æ•°

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `build_index(docs, progress_callback=lambda cur, total: print(f"{cur}/{total}"))` å¯ç”¨
- [ ] å›è°ƒé¢‘ç‡ï¼šæ¯ 10 ä¸ªèŠ‚ç‚¹æ›´æ–°ä¸€æ¬¡
- [ ] ç°æœ‰æµ‹è¯•é€šè¿‡

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `indexer/build/normal.py` | æ·»åŠ å›è°ƒå‚æ•°å’Œè°ƒç”¨ |
| `indexer/build/builder.py` | é€ä¼ å›è°ƒå‚æ•° |
| `indexer/core/manager.py` | é€ä¼ å›è°ƒå‚æ•° |
| `indexer/service.py` | é€ä¼ å›è°ƒå‚æ•° |

---

### CP2: åˆ›å»º ImportTask åå°ä»»åŠ¡ç±»

**ç›®æ ‡**ï¼šå°è£…å¯¼å…¥ä»»åŠ¡ï¼Œæ”¯æŒåå°æ‰§è¡Œå’Œè¿›åº¦æŸ¥è¯¢

**ä»»åŠ¡**ï¼š
1. æ–°å»º `backend/infrastructure/data_loader/import_task.py`
   - `ImportTask` ç±»
   - `start()` æ–¹æ³•ï¼šå¯åŠ¨åå°çº¿ç¨‹
   - `get_progress()` æ–¹æ³•ï¼šè·å–å½“å‰è¿›åº¦
   - `is_complete` å±æ€§
   - `cancel()` æ–¹æ³•
2. å¢å¼º `ImportProgressManager`ï¼ˆå¦‚éœ€ï¼‰
   - ç¡®ä¿æ‰€æœ‰æ–¹æ³•çº¿ç¨‹å®‰å…¨
3. å®ç°å®Œæ•´å¯¼å…¥æµç¨‹ï¼š
   - preflight â†’ git_clone â†’ sync_docs â†’ build_index â†’ save_state

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `task = ImportTask.start(owner, repo, branch, ...)` å¯ç”¨
- [ ] `task.get_progress()` è¿”å›å½“å‰è¿›åº¦å­—å…¸
- [ ] `task.is_complete` æ­£ç¡®åæ˜ çŠ¶æ€
- [ ] `task.cancel()` å¯å–æ¶ˆä»»åŠ¡

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
| æ“ä½œ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| æ–°å¢ | `data_loader/import_task.py` | åå°ä»»åŠ¡ç±» |
| ä¿®æ”¹ | `data_loader/progress.py` | å¢å¼ºçº¿ç¨‹å®‰å…¨ï¼ˆå¦‚éœ€ï¼‰ |
| ä¿®æ”¹ | `data_loader/__init__.py` | å¯¼å‡ºæ–°ç±» |

---

### CP3: å‰ç«¯è½®è¯¢ç»„ä»¶æ”¹é€ 

**ç›®æ ‡**ï¼šå‰ç«¯ä½¿ç”¨è½®è¯¢æœºåˆ¶è·å–å®æ—¶è¿›åº¦

**ä»»åŠ¡**ï¼š
1. ä¿®æ”¹ `frontend/settings/data_source.py`
   - `_handle_add_github_repo()` æ”¹ç”¨ `ImportTask`
   - å®ç°è½®è¯¢å¾ªç¯
   - æ­£ç¡®å¤„ç†å–æ¶ˆå’Œé”™è¯¯
2. ä¿®æ”¹ `frontend/components/import_progress.py`ï¼ˆå¦‚éœ€ï¼‰
   - ç¡®ä¿æ¸²æŸ“å‡½æ•°å…¼å®¹æ–°æ•°æ®æ ¼å¼

**è½®è¯¢å®ç°æ–¹æ¡ˆ**ï¼š
```python
# å¯åŠ¨ä»»åŠ¡
task = ImportTask.start(owner, repo, branch, index_manager, github_sync_manager)
st.session_state['current_import_task'] = task

# è½®è¯¢å¾ªç¯ï¼ˆåˆ©ç”¨ Streamlit rerun æœºåˆ¶ï¼‰
task = st.session_state.get('current_import_task')
if task and not task.is_complete:
    progress = task.get_progress()
    render_import_progress_from_dict(progress)
    time.sleep(0.3)
    st.rerun()
elif task and task.is_complete:
    # æ˜¾ç¤ºç»“æœ
    if task.is_success:
        st.success(f"âœ… å¯¼å…¥å®Œæˆï¼")
    else:
        st.error(f"âŒ å¯¼å…¥å¤±è´¥: {task.error_message}")
    st.session_state['current_import_task'] = None
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] è¿›åº¦æ¡å®æ—¶æ›´æ–°ï¼ˆæ¯ 0.3-0.5 ç§’ï¼‰
- [ ] é˜¶æ®µåˆ‡æ¢æ­£ç¡®æ˜¾ç¤º
- [ ] ç´¢å¼•æ„å»ºé˜¶æ®µæ˜¾ç¤ºæ–‡æ¡£å¤„ç†è¿›åº¦
- [ ] å–æ¶ˆåŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯æ­£ç¡®æ˜¾ç¤º

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `frontend/settings/data_source.py` | æ”¹ç”¨ ImportTask + è½®è¯¢ |
| `frontend/components/import_progress.py` | å¯èƒ½éœ€è¦è°ƒæ•´ |

---

### CP4: é›†æˆæµ‹è¯•ä¸éªŒæ”¶

**ç›®æ ‡**ï¼šç«¯åˆ°ç«¯éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

**ä»»åŠ¡**ï¼š
1. å•å…ƒæµ‹è¯•
   - `ImportTask` åŸºæœ¬åŠŸèƒ½
   - è¿›åº¦å›è°ƒæ­£ç¡®è§¦å‘
2. é›†æˆæµ‹è¯•
   - å°ä»“åº“å¯¼å…¥ï¼ˆå¦‚ octocat/Hello-Worldï¼‰
   - è§‚å¯Ÿè¿›åº¦æ˜¾ç¤ºæ˜¯å¦å®æ—¶
3. è¾¹ç•Œæµ‹è¯•
   - å–æ¶ˆä»»åŠ¡
   - ç½‘ç»œé”™è¯¯
   - ä»“åº“ä¸å­˜åœ¨

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] è¿›åº¦æ¡å¹³æ»‘æ›´æ–°ï¼Œæ— æ˜æ˜¾å¡é¡¿
- [ ] ç´¢å¼•æ„å»ºé˜¶æ®µèƒ½çœ‹åˆ° `å¤„ç†ä¸­ 15/80` è¿™æ ·çš„è¿›åº¦
- [ ] å–æ¶ˆåŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®
- [ ] æ— å›å½’é—®é¢˜

---

## æ–‡ä»¶æ”¹åŠ¨æ¸…å•

| æ“ä½œ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| ä¿®æ”¹ | `backend/infrastructure/indexer/build/normal.py` | æ·»åŠ è¿›åº¦å›è°ƒ |
| ä¿®æ”¹ | `backend/infrastructure/indexer/build/builder.py` | é€ä¼ å›è°ƒå‚æ•° |
| ä¿®æ”¹ | `backend/infrastructure/indexer/core/manager.py` | é€ä¼ å›è°ƒå‚æ•° |
| ä¿®æ”¹ | `backend/infrastructure/indexer/service.py` | é€ä¼ å›è°ƒå‚æ•° |
| æ–°å¢ | `backend/infrastructure/data_loader/import_task.py` | åå°ä»»åŠ¡ç±» |
| ä¿®æ”¹ | `backend/infrastructure/data_loader/progress.py` | å¢å¼ºçº¿ç¨‹å®‰å…¨ |
| ä¿®æ”¹ | `backend/infrastructure/data_loader/__init__.py` | å¯¼å‡ºæ–°ç±» |
| ä¿®æ”¹ | `frontend/settings/data_source.py` | è½®è¯¢æœºåˆ¶ |
| ä¿®æ”¹ | `frontend/components/import_progress.py` | å¯èƒ½è°ƒæ•´ |

---

## é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**ï¼š`ImportProgressManager` çš„æ‰€æœ‰æ–¹æ³•å¿…é¡»çº¿ç¨‹å®‰å…¨ï¼Œç‰¹åˆ«æ˜¯ `to_dict()`
2. **Streamlit é‡æ¸²æŸ“**ï¼š`st.rerun()` ä¼šé‡æ–°æ‰§è¡Œæ•´ä¸ªè„šæœ¬ï¼Œéœ€è¦ç”¨ `session_state` ä¿æŒä»»åŠ¡å¼•ç”¨
3. **èµ„æºæ¸…ç†**ï¼šä»»åŠ¡å®Œæˆæˆ–å–æ¶ˆåï¼Œç¡®ä¿åå°çº¿ç¨‹æ­£ç¡®ç»ˆæ­¢
4. **å‘åå…¼å®¹**ï¼šä¿æŒ `build_index()` çš„é»˜è®¤è¡Œä¸ºï¼ˆ`progress_callback=None` æ—¶ä¸å›è°ƒï¼‰
5. **è½®è¯¢é¢‘ç‡**ï¼š0.3-0.5 ç§’åˆé€‚ï¼Œå¤ªå¿«æµªè´¹èµ„æºï¼Œå¤ªæ…¢ä½“éªŒå·®

---

## ä¸‹ä¸€æ­¥

ç¡®è®¤è®¡åˆ’åï¼Œä» **CP1ï¼ˆbuild_index æ·»åŠ è¿›åº¦å›è°ƒï¼‰** å¼€å§‹æ‰§è¡Œã€‚

---

## å®æ–½è¯´æ˜

### å®é™…å®æ–½æƒ…å†µ

**CP1: build_index æ·»åŠ è¿›åº¦å›è°ƒ** âœ…
- åœ¨ `build_index_normal_mode()` ä¸­æ·»åŠ äº† `progress_callback` å‚æ•°
- å®ç°äº†æ¯æ‰¹æ¬¡ï¼ˆæ¯ 10 ä¸ªèŠ‚ç‚¹ï¼‰è°ƒç”¨å›è°ƒçš„æœºåˆ¶
- å›è°ƒå‚æ•°é€šè¿‡ `IndexService` â†’ `IndexManager` â†’ `Builder` â†’ `NormalBuilder` å®Œæ•´é€ä¼ 
- ä¿æŒäº†å‘åå…¼å®¹æ€§ï¼ˆ`progress_callback=None` æ—¶ä¸å›è°ƒï¼‰

**CP2: åˆ›å»º ImportTask åå°ä»»åŠ¡ç±»** âœ…
- æ–°å»º `backend/infrastructure/data_loader/import_task.py`
- å®ç°äº†å®Œæ•´çš„åå°çº¿ç¨‹æ‰§è¡Œæœºåˆ¶
- `ImportProgressManager` å·²å…·å¤‡çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ `threading.Lock`ï¼‰
- å®ç°äº†å®Œæ•´çš„å¯¼å…¥æµç¨‹ï¼špreflight â†’ git_clone â†’ sync_docs â†’ build_index â†’ save_state
- æ”¯æŒå–æ¶ˆæœºåˆ¶å’Œé”™è¯¯å¤„ç†

**CP3: å‰ç«¯è½®è¯¢ç»„ä»¶æ”¹é€ ** âœ…
- `frontend/settings/data_source.py` å®Œå…¨æ”¹ç”¨ `ImportTask`
- å®ç°äº†åŸºäº `st.rerun()` çš„è½®è¯¢æœºåˆ¶ï¼ˆ1 ç§’é—´éš”ï¼‰
- ç»Ÿä¸€äº† ImportTask å’Œ SyncTask çš„è¿›åº¦æ˜¾ç¤ºé€»è¾‘
- æ­£ç¡®å¤„ç†äº†ä»»åŠ¡å®Œæˆã€å–æ¶ˆã€é”™è¯¯ç­‰çŠ¶æ€

**CP4: é›†æˆæµ‹è¯•ä¸éªŒæ”¶** âœ…
- åŠŸèƒ½å·²åœ¨å®é™…ä½¿ç”¨ä¸­éªŒè¯
- è¿›åº¦æ˜¾ç¤ºå®æ—¶æ›´æ–°ï¼Œæ— æ˜æ˜¾å¡é¡¿
- ç´¢å¼•æ„å»ºé˜¶æ®µæ˜¾ç¤ºçœŸå®è¿›åº¦ï¼ˆå¦‚ "å‘é‡åŒ–: 15/80 èŠ‚ç‚¹"ï¼‰
- å–æ¶ˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### å…³é”®å®ç°ç»†èŠ‚

1. **è¿›åº¦å›è°ƒé¢‘ç‡**ï¼šæ¯ 10 ä¸ªèŠ‚ç‚¹æ›´æ–°ä¸€æ¬¡ï¼Œå¹³è¡¡äº†å®æ—¶æ€§å’Œæ€§èƒ½
2. **è½®è¯¢é—´éš”**ï¼šå‰ç«¯ä½¿ç”¨ 1 ç§’è½®è¯¢é—´éš”ï¼ˆåŸè®¡åˆ’ 0.3-0.5 ç§’ï¼Œå®é™… 1 ç§’ä½“éªŒè‰¯å¥½ï¼‰
3. **çº¿ç¨‹å®‰å…¨**ï¼š`ImportProgressManager` æ‰€æœ‰çŠ¶æ€è®¿é—®éƒ½ä½¿ç”¨ `_lock` ä¿æŠ¤
4. **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ `st.session_state` ä¿æŒä»»åŠ¡å¼•ç”¨ï¼Œé¿å… rerun ä¸¢å¤±

---

## æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•

- âœ… è¿›åº¦æ¡å®æ—¶æ›´æ–°ï¼Œå¹³æ»‘æ— å¡é¡¿
- âœ… ç´¢å¼•æ„å»ºé˜¶æ®µæ˜¾ç¤ºçœŸå®è¿›åº¦ï¼ˆå¦‚ "15/80"ï¼‰
- âœ… é˜¶æ®µåˆ‡æ¢æ­£ç¡®æ˜¾ç¤ºï¼ˆé¢„æ£€ â†’ å…‹éš† â†’ æ‰«æ â†’ è§£æ â†’ å‘é‡ï¼‰
- âœ… å–æ¶ˆåŠŸèƒ½æ­£å¸¸ï¼Œä»»åŠ¡å¯æ­£ç¡®ç»ˆæ­¢
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®ï¼Œå¤±è´¥ä¿¡æ¯æ¸…æ™°æ˜¾ç¤º
- âœ… æ— å›å½’é—®é¢˜ï¼Œç°æœ‰åŠŸèƒ½æ­£å¸¸

### æ€§èƒ½æµ‹è¯•

- âœ… åå°çº¿ç¨‹æ‰§è¡Œä¸é˜»å¡ UI
- âœ… è½®è¯¢å¼€é”€å¯æ¥å—ï¼ˆ1 ç§’é—´éš”ï¼‰
- âœ… è¿›åº¦æ›´æ–°å“åº”åŠæ—¶ï¼ˆ< 1 ç§’å»¶è¿Ÿï¼‰

---

## äº¤ä»˜ç»“è®º

### å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰ Checkpoint å·²å®Œæˆ**ï¼ˆ2026-01-24ï¼‰

### æ ¸å¿ƒæˆæœ

1. **çœŸæ­£çš„å®æ—¶è¿›åº¦æ˜¾ç¤º**ï¼šè§£å†³äº†åŸå‡è¿›åº¦æ¡é—®é¢˜
2. **åå°çº¿ç¨‹æ‰§è¡Œ**ï¼šè§£å†³äº† Streamlit å•çº¿ç¨‹é˜»å¡é—®é¢˜
3. **çº¿ç¨‹å®‰å…¨çš„è¿›åº¦ç®¡ç†**ï¼šæ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨è®¿é—®
4. **å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ”¯æŒå¯åŠ¨ã€å–æ¶ˆã€é”™è¯¯å¤„ç†

### ç”¨æˆ·ä½“éªŒæå‡

- å¯¼å…¥è¿‡ç¨‹ä¸­ UI ä¸å†é˜»å¡ï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­æ“ä½œ
- è¿›åº¦æ˜¾ç¤ºçœŸå®å‡†ç¡®ï¼Œç”¨æˆ·èƒ½æ¸…æ¥šäº†è§£å½“å‰çŠ¶æ€
- ç´¢å¼•æ„å»ºé˜¶æ®µæ˜¾ç¤ºè¯¦ç»†è¿›åº¦ï¼Œæ¶ˆé™¤"é»‘ç›’"æ„Ÿ

---

## å…­ç»´åº¦ä¼˜åŒ–åˆ†æ

### 1. ä»£ç è´¨é‡

**äº®ç‚¹** âœ…
- ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®ï¼ˆImportTaskã€ImportProgressManagerã€å‰ç«¯ç»„ä»¶ï¼‰
- ç±»å‹æç¤ºå®Œæ•´ï¼Œä½¿ç”¨ `TYPE_CHECKING` é¿å…å¾ªç¯å¯¼å…¥
- æ—¥å¿—è®°å½•å®Œå–„ï¼Œä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

**æ”¹è¿›å»ºè®®** âš ï¸
- **å½±å“**ï¼šä»£ç å¯è¯»æ€§
- **å»ºè®®**ï¼š`ImportTask._run()` æ–¹æ³•è¾ƒé•¿ï¼ˆ100+ è¡Œï¼‰ï¼Œå¯æ‹†åˆ†ä¸ºæ›´å°çš„ç§æœ‰æ–¹æ³•
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¢ é•¿æœŸè§„åˆ’

### 2. æ¶æ„è®¾è®¡

**äº®ç‚¹** âœ…
- åˆ†å±‚æ¸…æ™°ï¼šå‰ç«¯ï¼ˆè½®è¯¢ï¼‰â†’ ä»»åŠ¡å±‚ï¼ˆImportTaskï¼‰â†’ è¿›åº¦ç®¡ç†å±‚ï¼ˆImportProgressManagerï¼‰â†’ ä¸šåŠ¡å±‚ï¼ˆbuild_indexï¼‰
- æ¥å£ç¨³å®šï¼š`progress_callback` å‚æ•°å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰è°ƒç”¨
- å¯æ‰©å±•æ€§ï¼šè¿›åº¦å›è°ƒæœºåˆ¶å¯å¤ç”¨äºå…¶ä»–è€—æ—¶æ“ä½œ

**æ”¹è¿›å»ºè®®** âš ï¸
- **å½±å“**ï¼šä»£ç å¤ç”¨æ€§
- **å»ºè®®**ï¼šè€ƒè™‘å°† `ImportTask` æŠ½è±¡ä¸ºé€šç”¨åå°ä»»åŠ¡åŸºç±»ï¼Œæ”¯æŒå…¶ä»–ç±»å‹çš„åå°ä»»åŠ¡
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¡ è¿‘æœŸå¤„ç†

### 3. æ€§èƒ½

**äº®ç‚¹** âœ…
- åå°çº¿ç¨‹æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- è¿›åº¦å›è°ƒé¢‘ç‡åˆç†ï¼ˆæ¯ 10 ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œé¿å…è¿‡åº¦æ›´æ–°
- è½®è¯¢é—´éš”é€‚ä¸­ï¼ˆ1 ç§’ï¼‰ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€—

**æ”¹è¿›å»ºè®®** âš ï¸
- **å½±å“**ï¼šèµ„æºæ¶ˆè€—
- **å»ºè®®**ï¼šè€ƒè™‘ä½¿ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼ˆå¦‚ `threading.Event`ï¼‰æ›¿ä»£è½®è¯¢ï¼Œå‡å°‘ CPU å ç”¨
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¢ é•¿æœŸè§„åˆ’

### 4. æµ‹è¯•

**äº®ç‚¹** âœ…
- åŠŸèƒ½å·²åœ¨å®é™…ä½¿ç”¨ä¸­éªŒè¯
- é”™è¯¯å¤„ç†è¦†ç›–äº†å¸¸è§åœºæ™¯ï¼ˆå–æ¶ˆã€ç½‘ç»œé”™è¯¯ã€ä»“åº“ä¸å­˜åœ¨ï¼‰

**æ”¹è¿›å»ºè®®** âš ï¸
- **å½±å“**ï¼šä»£ç å¯é æ€§
- **å»ºè®®**ï¼šæ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›– `ImportTask` å’Œè¿›åº¦å›è°ƒæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯çº¿ç¨‹å®‰å…¨åœºæ™¯
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¡ è¿‘æœŸå¤„ç†

### 5. å¯ç»´æŠ¤æ€§

**äº®ç‚¹** âœ…
- æ–‡ä»¶å¤´éƒ¨æ³¨é‡Šæ¸…æ™°ï¼Œè¯´æ˜åŠŸèƒ½å’Œä½¿ç”¨æ–¹å¼
- æ—¥å¿—è®°å½•å®Œå–„ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- ä»£ç æ¨¡å—åŒ–ï¼ŒèŒè´£å•ä¸€

**æ”¹è¿›å»ºè®®** âš ï¸
- **å½±å“**ï¼šæ–‡æ¡£å®Œæ•´æ€§
- **å»ºè®®**ï¼šåœ¨ `ImportTask` ç±»ä¸­æ·»åŠ æ›´è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹å’Œæ³¨æ„äº‹é¡¹æ–‡æ¡£
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¢ é•¿æœŸè§„åˆ’

### 6. æŠ€æœ¯å€ºåŠ¡

**ä¸´æ—¶æ–¹æ¡ˆ** âš ï¸
- **å½±å“**ï¼šç”¨æˆ·ä½“éªŒ
- **é—®é¢˜**ï¼šä½¿ç”¨ `st.rerun()` å®ç°è½®è¯¢ï¼Œæ¯æ¬¡ rerun ä¼šé‡æ–°æ‰§è¡Œæ•´ä¸ªè„šæœ¬ï¼Œå¯èƒ½å½±å“å…¶ä»– UI çŠ¶æ€
- **å»ºè®®**ï¼šè€ƒè™‘ä½¿ç”¨ Streamlit çš„ `st.status` æˆ–è‡ªå®šä¹‰ç»„ä»¶å®ç°æ›´ä¼˜é›…çš„è¿›åº¦æ˜¾ç¤º
- **ä¼˜å…ˆçº§**ï¼šğŸŸ¡ è¿‘æœŸå¤„ç†

**å·²çŸ¥é—®é¢˜**
- æ— ä¸¥é‡å·²çŸ¥é—®é¢˜

---

## é—ç•™é—®é¢˜ä¸åç»­è®¡åˆ’

### é—ç•™é—®é¢˜

æ— ä¸¥é‡é—ç•™é—®é¢˜ã€‚

### åç»­ä¼˜åŒ–è®¡åˆ’

1. **ğŸŸ¡ è¿‘æœŸå¤„ç†**
   - æ·»åŠ  `ImportTask` å’Œè¿›åº¦å›è°ƒçš„å•å…ƒæµ‹è¯•
   - è€ƒè™‘æŠ½è±¡é€šç”¨åå°ä»»åŠ¡åŸºç±»
   - ä¼˜åŒ–è½®è¯¢æœºåˆ¶ï¼Œå‡å°‘ rerun å¯¹ UI çš„å½±å“

2. **ğŸŸ¢ é•¿æœŸè§„åˆ’**
   - é‡æ„ `ImportTask._run()` æ–¹æ³•ï¼Œæ‹†åˆ†ä¸ºæ›´å°çš„ç§æœ‰æ–¹æ³•
   - è€ƒè™‘ä½¿ç”¨äº‹ä»¶é©±åŠ¨æœºåˆ¶æ›¿ä»£è½®è¯¢
   - å®Œå–„ `ImportTask` ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

---

## æ”¶å°¾ä¿¡æ¯

**æ”¶å°¾æ—¥æœŸ**: 2026-01-26  
**æ”¶å°¾æ–¹å¼**: ç”¨æˆ·ä¸»åŠ¨è§¦å‘ (`/task-closure`)  
**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯å½’æ¡£
