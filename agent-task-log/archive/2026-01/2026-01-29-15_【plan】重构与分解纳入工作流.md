# 2026-01-29 【plan】重构与分解纳入工作流

**任务类型**: workflow  
**日期**: 2026-01-29  
**任务编号**: #15  
**Agent**: -

---

## Checkpoint 状态表

| CP | 阶段 | 状态 | 完成日期 |
|----|------|------|----------|
| CP1 | 规划阶段-文件清单升级 | ✅ 已完成 | 2026-01-29 |
| CP2 | 收尾阶段-结构检查 | ✅ 已完成 | 2026-01-29 |
| CP3 | 可选-refactor-and-decompose skill | ✅ 已完成 | 2026-01-29 |

**当前状态**：全部完成  
**下一步**：可归档至 `agent-task-log/archive/2026-01/`。

---

## 背景与目标

### 背景

- 编码代理在单模块超过约 5 万行时难以一次性解决问题；低于该阈值时，好的初始提示可让很多任务一次完成。
- 代理不会主动管理项目结构或模块边界，易将功能塞进少数大文件，形成技术债务。
- 项目已有：file-size-limit（≤300 行）、single-responsibility、多次重构；需将「重构与分解」**纳入工作流**而非事后补救。

### 目标

1. **规划阶段**：事前约定模块边界，计划书中的「文件改动清单」含每文件职责 + 行数预算（≤300）。
2. **收尾阶段**：收尾前强制结构检查（行数 + 职责），通过后再生成日志与六维分析。
3. **可选**：独立 skill「refactor-and-decompose」串起上述两点与 file-size-limit / single-responsibility，便于 Agent 在规划/收尾时自动引用。

---

## 实施步骤

### CP1: 规划阶段-文件清单升级

**目标**：计划书产出时即约定文件职责与行数边界，写代码前有明确约束。

**任务**：

1. 修改 `task-planning/references/planning-workflow.md`：
   - 在「3. 计划书内容」的「文件改动清单」中明确要求：
     - 每个拟新增/修改文件须写**一句话职责**与**行数预算（≤300）**。
   - 在「实施步骤」或模板说明中补充：每个 CP 的「预计文件改动」须遵循上述格式。

2. 若存在计划书模板或 generate_task_plan 的占位说明，同步补充「文件清单格式」说明。

**验收标准**：

- [ ] planning-workflow.md 中「文件改动清单」包含「职责 + 行数预算 ≤300」的明确要求。
- [ ] 后续新建计划书时，Agent 能按该格式填写文件清单。

**预计文件改动**：

| 文件 | 职责 | 行数预算 |
|------|------|----------|
| `.cursor/skills/task-planning/references/planning-workflow.md` | 规划工作流说明；补充文件清单格式与检查点 | ≤300 |

---

### CP2: 收尾阶段-结构检查

**目标**：收尾前强制做结构检查，未通过则先拆分/重构再收尾，或记录遗留。

**任务**：

1. 修改 `task-closure/SKILL.md`：
   - 在「必须执行的流程」中增加一步：**结构检查（再收尾）**，顺序为：结构检查 → 生成任务日志 → 六维分析。
   - 说明检查内容：本任务涉及的所有代码文件 ≤300 行（file-size-limit）、职责清晰且无循环依赖（single-responsibility）。
   - 若超限或职责不清：先拆分/重构再继续收尾；若用户选择暂不处理，在日志中记录「遗留：结构问题」及建议。

2. 修改 `task-closure/references/closure-workflow.md`：
   - 在「2. 执行流程」中插入「2.0 或 2.1 结构检查」步骤，与 SKILL 描述一致，并引用 file-size-limit、single-responsibility。

**验收标准**：

- [ ] task-closure 的必须流程包含「结构检查」且顺序正确。
- [ ] 收尾时 Agent 会先执行/提示结构检查，再生成日志与六维分析。

**预计文件改动**：

| 文件 | 职责 | 行数预算 |
|------|------|----------|
| `.cursor/skills/task-closure/SKILL.md` | 收尾规范入口；增加结构检查步骤与引用 | ≤300 |
| `.cursor/skills/task-closure/references/closure-workflow.md` | 收尾流程说明；插入结构检查步骤 | ≤300 |

---

### CP3: 可选-refactor-and-decompose skill

**目标**：独立 skill 明确「何时做、和规划/收尾的关系」，便于 Agent 在规划与收尾时自动应用结构约束。

**任务**：

1. 新建 `.cursor/skills/refactor-and-decompose/SKILL.md`：
   - **何时使用**：规划时（编写/审核文件清单）、收尾时（执行结构检查）。
   - **依赖**：file-size-limit、single-responsibility、architecture-design（按需引用）。
   - **检查清单**：行数 ≤300、职责清晰、模块边界明确、无循环依赖。
   - 不新增阶段，仅作为「结构约束」的汇聚入口。

2. 可选：在 `task-planning/SKILL.md`、`task-closure/SKILL.md` 的「参考资料」中增加对 refactor-and-decompose 的引用，便于 Agent 自动加载。

**验收标准**：

- [ ] refactor-and-decompose/SKILL.md 存在且描述清晰。
- [ ] 规划/收尾相关 skill 中可选的引用已添加（若采用）。

**预计文件改动**：

| 文件 | 职责 | 行数预算 |
|------|------|----------|
| `.cursor/skills/refactor-and-decompose/SKILL.md` | 重构与分解工作流入口；触发时机与检查清单 | ≤150 |
| `.cursor/skills/task-planning/SKILL.md` | 任务规划规范；参考资料中可选增加 refactor-and-decompose | ≤300 |
| `.cursor/skills/task-closure/SKILL.md` | 任务收尾规范；参考资料中可选增加 refactor-and-decompose | ≤300 |

---

## 文件改动清单（汇总）

| 文件 | 职责 | 行数预算 | 所属 CP |
|------|------|----------|---------|
| `.cursor/skills/task-planning/references/planning-workflow.md` | 规划工作流；文件清单格式 | ≤300 | CP1 |
| `.cursor/skills/task-closure/SKILL.md` | 收尾规范；结构检查步骤 | ≤300 | CP2 |
| `.cursor/skills/task-closure/references/closure-workflow.md` | 收尾流程；结构检查步骤 | ≤300 | CP2 |
| `.cursor/skills/refactor-and-decompose/SKILL.md` | 重构与分解入口 | ≤150 | CP3 |
| `.cursor/skills/task-planning/SKILL.md` | 规划规范；可选引用 | ≤300 | CP3 |
| `.cursor/skills/task-closure/SKILL.md` | 收尾规范；可选引用 | ≤300 | CP3 |

---

## 参考

- 用户结论：第五阶段为重构与分解；项目已在单文件 ≤300 行与重构上做得较好，需将约束纳入规划与收尾工作流。
- 现有 skill：file-size-limit、single-responsibility、task-planning、task-closure、architecture-design。
