# 2026-01-24 【bugfix】同步进度显示与导入逻辑统一

**任务类型**: bugfix  
**日期**: 2026-01-24  
**任务编号**: #10-bugfix  
**Agent**: Claude Opus 4.5

---

## 任务背景

用户发现同步功能的进度显示与导入功能不一致：
- 导入：后台线程 + 轮询 + ImportProgressManager
- 同步：同步阻塞 + 手动硬编码进度 (0.2→0.5→0.7→1.0)

需要统一两者的进度和日志逻辑。

---

## 完成内容

### 1. 创建 SyncTask 后台任务类

**新增文件**: `backend/infrastructure/data_loader/sync_task.py`

- 与 ImportTask 保持一致的接口（start/cancel/get_progress/is_complete）
- 复用 ImportProgressManager 进度管理器
- 支持进度回调、日志、取消

### 2. 修改前端统一使用轮询机制

**修改文件**: `frontend/settings/data_source.py`

- `_handle_sync_repo()` 改用 SyncTask 后台任务
- `_render_import_progress()` 统一支持导入和同步任务
- 添加 `import_task_type` 区分任务类型，显示不同标题和消息

### 3. 修复索引管理器延迟初始化

- 同步功能添加与导入一致的 `index_manager` 按需初始化逻辑
- 解决"索引管理器未初始化"错误

---

## 文件改动清单

| 操作 | 文件 | 说明 |
|------|------|------|
| 新增 | `backend/infrastructure/data_loader/sync_task.py` | 后台同步任务类 |
| 修改 | `backend/infrastructure/data_loader/__init__.py` | 导出 SyncTask |
| 修改 | `frontend/settings/data_source.py` | 统一进度逻辑 |

---

## 统一后的行为对比

| 特性 | 导入 | 同步 |
|------|------|------|
| 执行方式 | 后台线程 + 轮询 | 后台线程 + 轮询 |
| 进度管理 | ImportProgressManager | ImportProgressManager |
| 阶段显示 | 预检→克隆→向量 | 克隆→向量 |
| 日志格式 | 统一时间戳 + 图标 | 统一时间戳 + 图标 |
| 取消支持 | ✅ | ✅ |
| 进度回调 | ✅ | ✅ |
| 延迟初始化 | ✅ | ✅ |

---

## 六维度优化分析

### 1. 代码质量 ⭐⭐⭐⭐

- **优势**: SyncTask 与 ImportTask 接口一致，代码复用性好
- **改进空间**: 可考虑提取公共基类 `BackgroundTask`

### 2. 架构设计 ⭐⭐⭐⭐

- **优势**: 职责分离清晰，SyncTask 专注同步，ImportTask 专注导入
- **改进空间**: 可统一为单一 `TaskType` 枚举 + 通用 `BackgroundTask`

### 3. 性能 ⭐⭐⭐⭐⭐

- **优势**: 后台线程执行，不阻塞 UI
- **无明显问题**

### 4. 测试覆盖 ⭐⭐⭐

- **已验证**: 模块导入成功，83 个相关测试通过
- **改进空间**: 可添加 SyncTask 单元测试

### 5. 可维护性 ⭐⭐⭐⭐

- **优势**: 导入和同步逻辑统一，降低维护成本
- **优势**: 代码注释清晰

### 6. 技术债务 ⭐⭐⭐

- **新增**: 两个相似的 Task 类（ImportTask/SyncTask）
- **建议**: 未来可重构为统一的 BackgroundTask 基类

---

## 验收状态

- [x] 同步功能使用后台线程
- [x] 进度显示与导入一致
- [x] 日志格式统一
- [x] 支持取消
- [x] 延迟初始化 index_manager
- [ ] 浏览器端验证（用户反馈 Streamlit 缓存问题，需重启服务）
