# 2026-01-22 【implementation】Plan+Checkpoint 工作流机制-完成总结

> 建立基于 Cursor IDE 的 Plan + Checkpoint 工作流机制，弥补 Cursor 会话级 TodoWrite 不持久化的限制。

---

## 1. 背景与动机

### 1.1 问题识别

**Cursor Plan 模式的限制**：
- TodoWrite 是**会话级别**的，关闭对话后丢失，不持久化
- 没有内置的 Checkpoint 机制，需要自己实现
- 计划书不会自动持久化，需要手动写入文件

**用户痛点**：
- 长程任务执行中断后，难以恢复上下文
- 缺乏系统化的任务进度追踪
- "事前规划"与"事后存档"割裂

### 1.2 设计洞察

**核心观点**：事前规划和事后存档不是对立的，而是一个完整流程的两端。

```
┌─────────────────────────────────────────────────────────────────┐
│                      长程任务生命周期                             │
├─────────────────┬─────────────────────┬─────────────────────────┤
│   Plan 阶段      │   Execution 阶段     │   Closure 阶段          │
│                 │                     │                         │
│ • 创建计划书     │ • 按 CP 执行         │ • 生成完成总结          │
│ • 定义 CP       │ • 更新 CP 状态       │ • 归档到 archive/       │
│ • 明确验收标准   │ • 记录关键决策       │ • 复盘优化点            │
│                 │                     │                         │
│ ongoing/xxx.md  │ 更新同一文件         │ 移动到 archive/         │
└─────────────────┴─────────────────────┴─────────────────────────┘
```

---

## 2. 设计思想

### 2.1 工作流分层

| 复杂度 | 特征 | 处理方式 |
|--------|------|----------|
| 简单 | 1-2 步，单文件 | 直接执行 → `/generate-task-log` |
| 中等 | 3-5 步，2-3 文件 | 建议创建计划书 |
| 复杂 | >5 步，多文件/架构变更 | **必须**创建计划书 |

### 2.2 文档分工

| 场景 | 文档类型 | 命名示例 |
|------|----------|----------|
| 长程任务（≥3 CP） | 实施计划 | `【plan】xxx-实施计划.md` |
| 简单任务（1-2 步） | 完成总结 | `【implementation】xxx-完成总结.md` |

### 2.3 命令体系

```
事前规划                          事后存档
/generate-task-plan        →     /generate-task-log
     │                                │
     ▼                                ▼
创建计划书到 ongoing/           生成总结，归档到 archive/
```

### 2.4 规则引导原则

> 对于预估需要 ≥3 个明确步骤的任务，Agent 应**主动提议**先创建计划书，获得用户确认后再执行。

### 2.5 `/generate-task-log` 的演进方向

1. **增加"从计划书生成"模式**：如果 `ongoing/` 已有对应计划书，自动读取 CP 状态，合并生成完成总结
2. **计划书和总结可以是同一个文件**：完成后在计划书末尾追加"实施总结"章节，然后归档

---

## 3. 交付物

| 文件 | 类型 | 说明 |
|------|------|------|
| `agent-task-log/PLAN_TEMPLATE.md` | 模板 | 计划书标准模板，含 CP 状态表、状态标记说明 |
| `.cursor/rules/task_planning_guidelines.mdc` | 规则 | 任务规划规范，定义触发条件和 Agent 行为 |
| `.cursor/commands/task_planning/generate-task-plan.md` | 命令 | `/generate-task-plan` 命令定义 |
| `agent-task-log/README.md` | 文档 | 更新后的说明，包含完整工作流图 |
| `agent-task-log/TASK_TYPES.md` | 文档 | 补充 `plan` 类型的 Checkpoint 机制说明 |

---

## 4. Checkpoint 状态标记规范

| 标记 | 含义 |
|------|------|
| ⬜ | 待开始 |
| 🔄 | 进行中 |
| ✅ | 已完成 |
| ⏸️ | 暂停 |
| ❌ | 取消 |

---

## 5. 使用指南

### 5.1 长程任务流程

```bash
# 1. Plan 阶段
/generate-task-plan
# → 创建 ongoing/YYYY-MM-DD-N_【plan】xxx-实施计划.md

# 2. Execution 阶段
# → 按 CP 执行，完成后更新状态表

# 3. Closure 阶段
/generate-task-log
# → 归档到 archive/YYYY-MM/
```

### 5.2 简单任务流程

```bash
# 直接执行任务
# → 完成后 /generate-task-log 归档
```

---

## 6. 设计价值

### 6.1 解决的核心问题

- **持久化**：通过文件系统弥补 Cursor 会话级 TodoWrite 的限制
- **可恢复**：任务中断后可通过计划书快速恢复上下文
- **可追踪**：Checkpoint 状态表提供清晰的进度追踪
- **系统化**：规则和命令引导形成一致的工作习惯

### 6.2 与 Cursor IDE 的适配

本机制是**基于模型和工具 IDE 的落地实践层**：
- 利用 Cursor 的规则系统（`.mdc`）引导 Agent 行为
- 利用 Cursor 的命令系统（`.cursor/commands/`）提供快捷操作
- 通过文件系统实现计划书持久化，弥补 IDE 原生不足

---

## 7. 后续演进

- [ ] `/generate-task-log` 支持从计划书自动生成完成总结
- [ ] 考虑计划书状态的自动化更新（如通过脚本）
- [ ] 积累实践案例，优化模板和规则

---

## 8. 版本信息

- **创建日期**：2026-01-22
- **任务类型**：implementation
- **版本**：v1.0
