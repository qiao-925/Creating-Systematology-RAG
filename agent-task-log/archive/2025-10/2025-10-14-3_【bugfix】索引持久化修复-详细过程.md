# 2025-10-14 ã€bugfixã€‘ç´¢å¼•æŒä¹…åŒ–ä¿®å¤ - è¯¦ç»†è¿‡ç¨‹

**ã€Task Typeã€‘**: bugfix
**æ—¥æœŸ**: 2025-10-14  
**ä»»åŠ¡**: ä¿®å¤å‘é‡IDæœªè®°å½•å¯¼è‡´çš„é‡å¤ç´¢å¼•é—®é¢˜  
**çŠ¶æ€**: âœ… ä»£ç ä¿®å¤å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯

---

## ğŸ“‹ é—®é¢˜åˆ†æ

### é—®é¢˜è¡¨ç°
ç”¨æˆ·æ¯æ¬¡å¯åŠ¨åº”ç”¨åéƒ½éœ€è¦é‡æ–°æ›´æ–°GitHubä»“åº“ï¼Œæ— æ³•åˆ©ç”¨å·²æœ‰çš„ç´¢å¼•æ•°æ®ã€‚

### é—®é¢˜æ ¹æº

#### æŒä¹…åŒ–æœºåˆ¶ç°çŠ¶

1. **å‘é‡æ•°æ®æŒä¹…åŒ–** âœ… æ­£å¸¸
   - ä½ç½®: `vector_store/` ç›®å½•
   - ä½¿ç”¨ ChromaDB PersistentClient
   - çŠ¶æ€: å‘é‡æ•°æ®ç¡®å®è¢«ä¿å­˜

2. **å…ƒæ•°æ®æŒä¹…åŒ–** âœ… æ­£å¸¸
   - ä½ç½®: `data/github_metadata.json`
   - æ–‡ä»¶å…ƒæ•°æ®ç¡®å®è¢«ä¿å­˜

3. **å‘é‡IDè®°å½•** âŒ **é—®é¢˜æ‰€åœ¨**
   - é¢„æœŸ: æ¯ä¸ªæ–‡ä»¶åº”è¯¥æœ‰å¯¹åº”çš„ `vector_ids` åˆ—è¡¨
   - å®é™…: æ‰€æœ‰æ–‡ä»¶çš„ `vector_ids` éƒ½æ˜¯ç©ºæ•°ç»„ `[]`

#### é—®é¢˜é“¾è·¯

```
æ–‡æ¡£åŠ è½½ â†’ æ„å»ºç´¢å¼• â†’ ç”Ÿæˆå‘é‡ID
                â†“
            âŒ å‘é‡IDä¸¢å¤±ï¼ˆæœªæ•è·ï¼‰
                â†“
         æ›´æ–°å…ƒæ•°æ®ï¼ˆvector_ids=[]ï¼‰
                â†“
         å…ƒæ•°æ®ä¿å­˜ï¼ˆvector_idsä»ä¸ºç©ºï¼‰
                â†“
         ä¸‹æ¬¡å¯åŠ¨æ—¶æ— æ³•è¯†åˆ«å·²ç´¢å¼•æ–‡ä»¶
                â†“
         æ— æ³•è¿›è¡Œå¢é‡æ›´æ–°
                â†“
         âŒ æ¯æ¬¡éƒ½éœ€è¦é‡æ–°ç´¢å¼•
```

#### ä»£ç å±‚é¢çš„é—®é¢˜

**é—®é¢˜1**: `build_index` æœªè¿”å›å‘é‡ID
```python
# src/indexer.py:254-298
def build_index(self, documents, show_progress=True) -> VectorStoreIndex:
    # ... æ„å»ºç´¢å¼•
    self._index.insert(doc)  # âš ï¸ æ’å…¥åæœªæ•è·è¿”å›çš„èŠ‚ç‚¹ID
    return self._index  # âš ï¸ åªè¿”å›ç´¢å¼•ï¼Œæ²¡æœ‰è¿”å›å‘é‡IDæ˜ å°„
```

**é—®é¢˜2**: è°ƒç”¨æ—¶æœªä¼ é€’å‘é‡ID
```python
# app.py:141-150
index_manager.build_index(documents, show_progress=False)
st.session_state.metadata_manager.update_repository_metadata(
    owner=github_owner,
    repo=github_repo,
    branch=github_branch,
    documents=documents,
    commit_sha=commit_sha
    # âš ï¸ ç¼ºå°‘ vector_ids_map å‚æ•°ï¼
)
```

### æ•°æ®éªŒè¯

**å½“å‰å…ƒæ•°æ®çŠ¶æ€** (`data/github_metadata.json`):
```json
{
  "files": {
    "# ğŸ”¬ ç³»ç»Ÿç§‘å­¦/ç³»ç»Ÿç§‘å­¦ç›¸å…³ä¹¦å•": {
      "hash": "7ec1384ceedf03d2be71902a26f9c182",
      "size": 102,
      "vector_ids": []  // âŒ é—®é¢˜ï¼šç©ºæ•°ç»„
    }
  }
}
```

**å‘é‡å­˜å‚¨çŠ¶æ€** (`vector_store/`):
```
vector_store/
â”œâ”€â”€ 00da3c70.../  // âœ… å­˜åœ¨å‘é‡æ•°æ®
â”œâ”€â”€ 14d23f5a.../  // âœ… å­˜åœ¨å‘é‡æ•°æ®
â””â”€â”€ chroma.sqlite3
```

**ç»“è®º**: å‘é‡æ•°æ®å’Œå…ƒæ•°æ®è„±èŠ‚ - å‘é‡å­˜åœ¨ä½†å…ƒæ•°æ®æ— æ³•å…³è”ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥
**é€šè¿‡ Chroma çš„ metadata æŸ¥è¯¢æœºåˆ¶ï¼Œåœ¨ç´¢å¼•æ„å»ºåæŸ¥è¯¢å¹¶è®°å½•å‘é‡ID**

### æŠ€æœ¯å®ç°

#### 1. æ·»åŠ å‘é‡IDæŸ¥è¯¢æ–¹æ³•

**æ–‡ä»¶**: `src/indexer.py`

```python
def _get_vector_ids_by_metadata(self, file_path: str) -> List[str]:
    """é€šè¿‡æ–‡ä»¶è·¯å¾„æŸ¥è¯¢å¯¹åº”çš„å‘é‡IDåˆ—è¡¨"""
    if not file_path:
        return []
    
    try:
        # æŸ¥è¯¢ Chroma collectionï¼ŒåŒ¹é… file_path
        results = self.chroma_collection.get(
            where={"file_path": file_path}
        )
        return results.get('ids', []) if results else []
    except Exception as e:
        print(f"âš ï¸  æŸ¥è¯¢å‘é‡IDå¤±è´¥ [{file_path}]: {e}")
        return []
```

#### 2. ä¿®æ”¹ build_index è¿”å›å€¼

**æ–‡ä»¶**: `src/indexer.py`

```python
def build_index(
    self,
    documents: List[LlamaDocument],
    show_progress: bool = True
) -> Tuple[VectorStoreIndex, Dict[str, List[str]]]:  # ä¿®æ”¹è¿”å›ç±»å‹
    """æ„å»ºæˆ–æ›´æ–°ç´¢å¼•
    
    Returns:
        (VectorStoreIndexå¯¹è±¡, æ–‡ä»¶è·¯å¾„åˆ°å‘é‡IDçš„æ˜ å°„)
    """
    # ... åŸæœ‰çš„ç´¢å¼•æ„å»ºé€»è¾‘ ...
    
    # æ„å»ºå‘é‡IDæ˜ å°„
    vector_ids_map = {}
    for doc in documents:
        file_path = doc.metadata.get("file_path", "")
        if file_path:
            vector_ids = self._get_vector_ids_by_metadata(file_path)
            vector_ids_map[file_path] = vector_ids
    
    print(f"ğŸ“‹ å·²è®°å½• {len(vector_ids_map)} ä¸ªæ–‡ä»¶çš„å‘é‡IDæ˜ å°„")
    
    return self._index, vector_ids_map
```

#### 3. ä¿®æ”¹ _add_documents è¿”å›å€¼

**æ–‡ä»¶**: `src/indexer.py`

```python
def _add_documents(
    self, 
    documents: List[LlamaDocument]
) -> Tuple[int, Dict[str, List[str]]]:
    """æ‰¹é‡æ·»åŠ æ–‡æ¡£åˆ°ç´¢å¼•
    
    Returns:
        (æˆåŠŸæ·»åŠ çš„æ–‡æ¡£æ•°é‡, æ–‡ä»¶è·¯å¾„åˆ°å‘é‡IDçš„æ˜ å°„)
    """
    # ... æ·»åŠ æ–‡æ¡£é€»è¾‘ ...
    
    # è·å–å‘é‡IDæ˜ å°„
    vector_ids_map = {}
    for doc in documents:
        file_path = doc.metadata.get("file_path", "")
        if file_path:
            vector_ids = self._get_vector_ids_by_metadata(file_path)
            vector_ids_map[file_path] = vector_ids
    
    return count, vector_ids_map
```

#### 4. æ›´æ–° incremental_update æ–¹æ³•

**æ–‡ä»¶**: `src/indexer.py`

åœ¨å¢é‡æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°å…ƒæ•°æ®ä¸­çš„å‘é‡IDï¼š

```python
# å¤„ç†æ–°å¢
if added_docs:
    added_count, added_vector_ids = self._add_documents(added_docs)
    
    # æ›´æ–°å…ƒæ•°æ®çš„å‘é‡ID
    if metadata_manager:
        for doc in added_docs:
            file_path = doc.metadata.get("file_path", "")
            if file_path and file_path in added_vector_ids:
                owner, repo, branch = ...  # æå–ä»“åº“ä¿¡æ¯
                metadata_manager.update_file_vector_ids(
                    owner, repo, branch, file_path,
                    added_vector_ids[file_path]
                )
```

#### 5. ä¿®æ”¹åº”ç”¨å±‚è°ƒç”¨

**app.py - æ·»åŠ ä»“åº“**:
```python
# ä¿®æ”¹å
index, vector_ids_map = index_manager.build_index(documents, show_progress=False)
st.session_state.metadata_manager.update_repository_metadata(
    owner=github_owner,
    repo=github_repo,
    branch=github_branch,
    documents=documents,
    vector_ids_map=vector_ids_map,  # âœ… ä¼ é€’å‘é‡IDæ˜ å°„
    commit_sha=commit_sha
)
```

**app.py - åŒæ­¥ä»“åº“**:
```python
# å¢é‡æ›´æ–°åï¼Œè·å–æ‰€æœ‰æ–‡æ¡£çš„å‘é‡ID
vector_ids_map = {}
for doc in documents:
    file_path = doc.metadata.get("file_path", "")
    if file_path:
        vector_ids = st.session_state.metadata_manager.get_file_vector_ids(
            owner, repo_name, branch, file_path
        )
        vector_ids_map[file_path] = vector_ids

st.session_state.metadata_manager.update_repository_metadata(
    ...,
    vector_ids_map=vector_ids_map
)
```

---

## âœ… å®æ–½å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•°å˜åŒ– |
|------|---------|---------|
| `src/indexer.py` | æ·»åŠ æŸ¥è¯¢æ–¹æ³•ï¼Œä¿®æ”¹3ä¸ªæ–¹æ³•è¿”å›å€¼ | +70è¡Œ |
| `app.py` | ä¿®æ”¹2å¤„è°ƒç”¨ï¼ˆæ·»åŠ ä»“åº“ã€åŒæ­¥ä»“åº“ï¼‰ | +20è¡Œ |
| `pages/1_âš™ï¸_è®¾ç½®.py` | ä¿®æ”¹3å¤„è°ƒç”¨ | +15è¡Œ |
| `main.py` | é€‚é…3å¤„CLIè°ƒç”¨ | +3è¡Œ |

### å…³é”®æ”¹åŠ¨ç‚¹

1. âœ… æ·»åŠ  `_get_vector_ids_by_metadata()` æ–¹æ³•
2. âœ… ä¿®æ”¹ `build_index()` è¿”å› `Tuple[VectorStoreIndex, Dict[str, List[str]]]`
3. âœ… ä¿®æ”¹ `_add_documents()` è¿”å› `Tuple[int, Dict[str, List[str]]]`
4. âœ… æ›´æ–° `incremental_update()` è‡ªåŠ¨è®°å½•å‘é‡ID
5. âœ… ä¿®æ”¹æ‰€æœ‰è°ƒç”¨å¤„ä¼ é€’ `vector_ids_map`
6. âœ… æ·»åŠ ç±»å‹å¯¼å…¥ `from typing import Tuple, Dict`

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### æ­¥éª¤1: æ·»åŠ æµ‹è¯•ä»“åº“

```bash
# 1. å¯åŠ¨åº”ç”¨
streamlit run app.py

# 2. åœ¨ä¾§è¾¹æ è¾“å…¥ GitHub ä»“åº“ URL
# 3. ç‚¹å‡»"â• æ·»åŠ ä»“åº“"
# 4. è§‚å¯Ÿæ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ°"ğŸ“‹ å·²è®°å½• X ä¸ªæ–‡ä»¶çš„å‘é‡IDæ˜ å°„"
```

### æ­¥éª¤2: æ£€æŸ¥å…ƒæ•°æ®

```bash
# æŸ¥çœ‹å…ƒæ•°æ®æ–‡ä»¶
cat data/github_metadata.json | python -m json.tool

# éªŒè¯è¦ç‚¹:
# âœ… vector_ids æ•°ç»„æœ‰å†…å®¹ï¼ˆä¸æ˜¯ç©ºæ•°ç»„ï¼‰
# âœ… last_commit_sha æœ‰å€¼ï¼ˆä¸æ˜¯ç©ºå­—ç¬¦ä¸²ï¼‰
```

**ä¿®å¤å‰**:
```json
{
  "vector_ids": [],  // âŒ
  "last_commit_sha": ""  // âŒ
}
```

**ä¿®å¤å**:
```json
{
  "vector_ids": ["uuid-001", "uuid-002", ...],  // âœ…
  "last_commit_sha": "a1b2c3d4..."  // âœ…
}
```

### æ­¥éª¤3: é‡å¯éªŒè¯ï¼ˆæ ¸å¿ƒï¼‰

```bash
# 1. å…³é—­åº”ç”¨ (Ctrl+C)
# 2. é‡æ–°å¯åŠ¨
streamlit run app.py

# 3. ç‚¹å‡»"ğŸ”„ åŒæ­¥æ‰€æœ‰ä»“åº“"

# âœ… æˆåŠŸæ ‡å¿—:
# - æç¤º"æ— å˜æ›´"æˆ–"éƒ½æ˜¯æœ€æ–°çš„"
# - ä¸ä¼šé‡æ–°ç´¢å¼•æ‰€æœ‰æ–‡ä»¶

# âŒ å¤±è´¥æ ‡å¿—:
# - æç¤ºå¤§é‡æ–‡ä»¶"æ–°å¢"æˆ–"ä¿®æ”¹"
# - é‡æ–°ç´¢å¼•æ‰€æœ‰æ–‡ä»¶
```

### æ­¥éª¤4: å¢é‡æ›´æ–°æµ‹è¯•

1. åœ¨ GitHub ä¸Šä¿®æ”¹æŸä¸ªæ–‡ä»¶
2. åœ¨åº”ç”¨ä¸­ç‚¹å‡»"ğŸ”„ åŒæ­¥æ‰€æœ‰ä»“åº“"
3. éªŒè¯ï¼šåªå¤„ç†å˜åŒ–çš„æ–‡ä»¶ï¼Œæ˜¾ç¤º"ä¿®æ”¹ 1 ä¸ª"

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### åŠŸèƒ½æ”¹è¿›

1. âœ… **å…ƒæ•°æ®å®Œæ•´**: æ‰€æœ‰æ–‡ä»¶çš„å‘é‡IDéƒ½è¢«æ­£ç¡®è®°å½•
2. âœ… **å¢é‡æ›´æ–°æ­£å¸¸**: 
   - æ–°å¢æ–‡ä»¶ï¼šç›´æ¥æ·»åŠ å¹¶è®°å½•å‘é‡ID
   - ä¿®æ”¹æ–‡ä»¶ï¼šåˆ é™¤æ—§å‘é‡ï¼Œæ·»åŠ æ–°å‘é‡ï¼Œæ›´æ–°å‘é‡ID
   - åˆ é™¤æ–‡ä»¶ï¼šæ ¹æ®å‘é‡IDåˆ é™¤å¯¹åº”å‘é‡
3. âœ… **æ— éœ€é‡å¤ç´¢å¼•**: å¯åŠ¨æ—¶æ£€æŸ¥å…ƒæ•°æ®ï¼Œå·²ç´¢å¼•çš„æ–‡ä»¶ä¸å†é‡å¤å¤„ç†
4. âœ… **æ€§èƒ½æå‡**: å¯åŠ¨å’ŒåŒæ­¥é€Ÿåº¦å¤§å¹…æå‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç°æœ‰æ•°æ®å¤„ç†

**é—®é¢˜**: å·²ç»ç´¢å¼•çš„ä»“åº“ï¼Œå…ƒæ•°æ®ä¸­ `vector_ids` ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**:
- **æ–¹æ¡ˆA**: åœ¨è®¾ç½®é¡µé¢åˆ é™¤æ—§ä»“åº“ï¼Œé‡æ–°æ·»åŠ ï¼ˆæ¨èï¼‰
- **æ–¹æ¡ˆB**: ç‚¹å‡»"ğŸ”„ åŒæ­¥æ‰€æœ‰ä»“åº“"ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¡«å……å‘é‡ID
- **æ–¹æ¡ˆC**: æ¸…ç©ºå…ƒæ•°æ®æ–‡ä»¶ï¼Œé‡æ–°ç´¢å¼•

### å‘é‡IDæŸ¥è¯¢æœºåˆ¶

**æŸ¥è¯¢è¯­æ³•**:
```python
results = collection.get(where={"file_path": "æŸä¸ªæ–‡ä»¶è·¯å¾„"})
# è¿”å›: {'ids': ['uuid1', 'uuid2', ...], ...}
```

**æ€§èƒ½è€ƒè™‘**:
- å½“å‰å®ç°ï¼šæ¯ä¸ªæ–‡ä»¶å•ç‹¬æŸ¥è¯¢
- æœªæ¥ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç¼“å­˜ç»“æœ

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### LlamaIndex å‘é‡IDæœºåˆ¶

- **æ–‡æ¡£ (Document)**: åŸå§‹æ–‡æ¡£
- **èŠ‚ç‚¹ (Node)**: æ–‡æ¡£åˆ†å—åçš„ç‰‡æ®µ  
- **èŠ‚ç‚¹ID (Node ID)**: æ¯ä¸ªèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **å‘é‡ID (Vector ID)**: åœ¨ Chroma ä¸­ï¼ŒèŠ‚ç‚¹IDå°±æ˜¯å‘é‡ID

### Python å…ƒç»„è¿”å›å€¼

```python
# å®šä¹‰
def build_index(...) -> Tuple[VectorStoreIndex, Dict[str, List[str]]]:
    return index, vector_ids_map

# ä½¿ç”¨
index, vector_ids_map = build_index(...)  # æ¥æ”¶ä¸¤ä¸ªè¿”å›å€¼
_, _ = build_index(...)  # å¿½ç•¥è¿”å›å€¼
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: vector_ids ä»ç„¶ä¸ºç©º

**å¯èƒ½åŸå› **: Chroma å…ƒæ•°æ®å­—æ®µåä¸åŒ¹é…

**æ’æŸ¥**:
```python
collection = client.get_collection("systematology_docs")
sample = collection.get(limit=1)
print(sample['metadatas'])  # æŸ¥çœ‹å…ƒæ•°æ®å­—æ®µ
```

### é—®é¢˜2: é‡å¯æ—¶ä»ç„¶é‡æ–°ç´¢å¼•

**å¯èƒ½åŸå› **: 
- å…ƒæ•°æ®æœªæ­£ç¡®ä¿å­˜
- `last_commit_sha` ä¸ºç©º

**æ’æŸ¥**:
1. æ£€æŸ¥ `data/github_metadata.json` æ–‡ä»¶æƒé™
2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤å…ƒæ•°æ®ä¿å­˜æˆåŠŸ
3. éªŒè¯ commit SHA æ˜¯å¦è®°å½•

### é—®é¢˜3: Chroma æŸ¥è¯¢å¤±è´¥

**å¯èƒ½åŸå› **: 
- é›†åˆåç§°ä¸åŒ¹é…
- å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶é”™è¯¯

**æ’æŸ¥**:
1. ç¡®è®¤é›†åˆåç§°
2. å°è¯•ä¸å¸¦è¿‡æ»¤çš„æŸ¥è¯¢: `collection.get()`
3. æŸ¥çœ‹ Chroma é”™è¯¯æ—¥å¿—

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-14  
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·è¿›è¡ŒåŠŸèƒ½æµ‹è¯•éªŒè¯

