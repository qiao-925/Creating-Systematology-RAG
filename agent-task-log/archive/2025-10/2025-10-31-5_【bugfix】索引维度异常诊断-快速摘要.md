# 2025-10-31 【bugfix】## 索引维度异常诊断 - 快速摘要（Chroma Collection）

**【Task Type】**: bugfix
- **时间**: 2025-10-31
- **结论**: 项目使用 Chroma 作为向量库，collection 可能因“嵌入维度与当前嵌入模型维度不一致”导致写入异常。`src/indexer.py` 已内置维度自检与不匹配自动重建逻辑，但为避免副作用，建议先用只读方式检查现有 collection 的维度与样本向量维度。

#### 快速只读检查（PowerShell）
- **环境前提**: 已安装项目依赖（包含 chromadb）。
- **命令**：
```bash
python -X utf8 -c "import sys,json,chromadb; sys.path.append('.'); from src.config import config; c=chromadb.PersistentClient(path=str(config.VECTOR_STORE_PATH)); col=c.get_or_create_collection(name=config.CHROMA_COLLECTION_NAME); md=getattr(col,'metadata',None); s=col.peek(limit=1); out={'vector_store_path':str(config.VECTOR_STORE_PATH),'collection':config.CHROMA_COLLECTION_NAME,'count':col.count(),'collection_dim_meta':(md.get('embedding_dimension') if md else None),'collection_dim_sample':(len(s['embeddings'][0]) if s and 'embeddings' in s and s['embeddings'] else None)}; print(json.dumps(out, ensure_ascii=False))"
```
- **观察**：`collection_dim_meta` 与 `collection_dim_sample` 应一致，且应与当前嵌入模型输出维度一致（可临时取一条 embedding 的长度确认）。

#### 可能原因
- 手动重建或迁移后，collection 的维度未与当前 `EMBEDDING_MODEL` 一致。
- 切换了 `EMBEDDING_MODEL`，但沿用了旧的 collection 数据。

#### 修复选项
- 仅当确认维度不匹配时再重建：
```bash
# 强制清空并重建（会删除当前集合）
python .\main.py clear --force --collection systematology_docs

# 重新导入（示例：从本地目录）
python .\main.py import-docs .\data\raw --collection systematology_docs --recursive
```
- 或用只读脚本核对无误后，继续正常增量导入。

#### 代码参考（自动维度校验）
见 `src/indexer.py` 中 `_ensure_collection_dimension_match`，当检测到不匹配时会删除并重建 collection。

#### 风险/注意
- 直接实例化 `IndexManager` 会触发自动维度校验，可能导致在不匹配时自动删除并新建 collection；只读检查时建议直接用 `chromadb.PersistentClient` 读取，以避免副作用。
