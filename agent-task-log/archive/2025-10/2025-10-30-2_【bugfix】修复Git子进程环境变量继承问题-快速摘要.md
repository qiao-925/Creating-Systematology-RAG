# 2025-10-30 【bugfix】修复 Git 子进程环境变量继承问题 - 快速摘要

**【Task Type】**: bugfix
**日期**: 2025-10-30  
**类型**: Bug 修复  
**状态**: ✅ 已完成

## 问题描述

用户反馈：
- 在其他地方手动执行 `git clone` 和 `git pull` 命令**正常**
- 但在应用程序内调用 Git 命令时**失败**，报错："Could not resolve host: github.com"

**错误日志**：
```
fatal: unable to access 'https://github.com/qiao-925/Creating-Systematology-RAG.git/': Could not resolve host: github.com
```

## 问题分析

### 根本原因

在 `src/git_repository_manager.py` 中，使用 `subprocess.run()` 调用 Git 命令时，只设置了 `GIT_TERMINAL_PROMPT` 环境变量：

```python
# 之前的问题代码
result = subprocess.run(
    cmd,
    env={'GIT_TERMINAL_PROMPT': '0'}  # ❌ 只设置了一个变量
)
```

这导致：
1. **未继承当前进程的环境变量**
2. 丢失了系统的 DNS 配置、代理设置等
3. 子进程无法解析域名或使用代理

### 为什么会失败？

- **手动执行命令**：继承了当前 shell 的完整环境变量（包括 DNS、代理等）
- **应用内调用**：只设置了 `GIT_TERMINAL_PROMPT`，丢失了其他环境变量

## 解决方案

修改 `subprocess.run()` 调用，**显式继承当前进程的环境变量**：

```python
# 修复后的代码
env = os.environ.copy()  # ✅ 复制当前进程的所有环境变量
env['GIT_TERMINAL_PROMPT'] = '0'  # 设置 Git 行为

result = subprocess.run(
    cmd,
    env=env  # ✅ 使用完整的环境变量
)
```

### 修改内容

#### `src/git_repository_manager.py`

1. **添加 `os` 模块导入**
   ```python
   import os
   ```

2. **修复 `_clone_repository` 方法**
   - 在克隆仓库时继承环境变量

3. **修复 `_update_repository` 方法**
   - 在更新仓库时继承环境变量

### 修改前后对比

| 项目 | 之前 | 之后 |
|------|------|------|
| 环境变量 | 仅 `GIT_TERMINAL_PROMPT` | 继承所有系统环境变量 |
| DNS 配置 | ❌ 丢失 | ✅ 可用 |
| 代理配置 | ❌ 丢失 | ✅ 可用 |
| 其他网络设置 | ❌ 丢失 | ✅ 可用 |

## 效果

修复后的行为：
- ✅ 子进程继承当前进程的所有环境变量
- ✅ DNS 配置正常工作
- ✅ 代理设置正常工作
- ✅ 应用内的 Git 操作与手动执行一致

## 技术细节

### 为什么需要 `.copy()`？

```python
env = os.environ.copy()  # 必须使用 copy()
```

- `os.environ` 是一个**特殊的字典类型**
- 直接修改会影响当前进程
- 使用 `.copy()` 创建独立的副本，安全修改

## 测试建议

1. **在应用内执行 Git 操作**
   - 克隆仓库
   - 更新仓库
   
2. **验证网络功能**
   - 检查是否能访问 GitHub
   - 检查代理是否生效（如果配置了）

3. **对比手动执行**
   - 确保应用内行为与手动执行一致

## 相关资源

- Python `subprocess.run()` 文档
- 环境变量继承机制
- Git 网络配置

