# 2025-10-10 【plan】维基百科集成 - 实施方案

**【Task Type】**: plan
**日期**: 2025-10-10  
**任务**: 集成维基百科知识增强功能  
**状态**: ✅ 已完成

## 一、需求背景

用户希望在本地知识库的基础上，增加维基百科作为补充知识源：
- **预索引模式**：构建索引时预加载核心概念
- **实时查询模式**：查询时动态检索维基百科
- **混合模式**：同时支持上述两种模式
- **来源溯源**：明确区分本地和维基百科来源
- **语言自适应**：根据查询语言自动选择中英文维基

## 二、技术方案

### 2.1 核心组件

1. **WikipediaLoader** (`src/data_loader.py`)
   - 使用 `llama-index-readers-wikipedia` 官方 Reader
   - 支持中英文维基百科
   - 增强元数据：标识来源、语言、URL

2. **HybridQueryEngine** (`src/query_engine.py`)
   - 混合查询引擎：本地 + 维基百科
   - 智能触发策略（相关度阈值、用户显式请求）
   - LLM 提取关键词
   - 自动语言检测
   - 动态临时索引（不持久化）

3. **IndexManager 扩展** (`src/indexer.py`)
   - `preload_wikipedia_concepts()` 方法
   - 支持批量预索引核心概念

4. **配置扩展** (`src/config.py`)
   - 维基百科相关配置项
   - 阈值、最大结果数、预索引概念列表

5. **UI 集成** (`app.py`)
   - 侧边栏维基百科配置界面
   - 分区展示查询结果（本地 vs 维基百科）
   - 支持预索引操作

### 2.2 关键决策

| 决策点 | 选择方案 | 理由 |
|--------|---------|------|
| 触发策略 | 智能触发 | 平衡性能和效果 |
| 关键词提取 | LLM 提取 | 准确度高，理解上下文 |
| 索引方式 | 动态临时索引 | 保持最新，避免污染主索引 |

## 三、实施步骤

### ✅ 步骤1: 安装依赖
```bash
pip install llama-index-readers-wikipedia wikipedia
```

### ✅ 步骤2: 扩展 data_loader.py
- 添加 `load_documents_from_wikipedia()` 函数
- 支持语言参数（zh/en）
- 增强元数据标识

### ✅ 步骤3: 创建 HybridQueryEngine
- 在 `query_engine.py` 中新增类
- 实现本地 + 维基百科混合检索
- 实现语言检测和关键词提取

### ✅ 步骤4: 扩展 IndexManager
- 添加 `preload_wikipedia_concepts()` 方法
- 支持批量预索引

### ✅ 步骤5: 更新配置
- 在 `config.py` 添加维基百科配置
- 在 `env.template` 添加配置模板

### ✅ 步骤6: 修改 app.py
- 集成 `HybridQueryEngine`
- 实现分区展示逻辑
- 添加维基百科预索引 UI

### ✅ 步骤7: 编写测试
- 单元测试：Wikipedia Loader
- 测试文件：`tests/unit/test_wikipedia_loader.py`

### ✅ 步骤8: 更新文档
- README.md：使用说明
- DECISIONS.md：设计决策（ADR-009）

## 四、文件修改清单

### 新增文件
- `tests/unit/test_wikipedia_loader.py` - 维基百科加载测试
- `agent-task-log/2025-10-10-3_维基百科集成_实施方案.md` - 本文档

### 修改文件
- `src/data_loader.py` - 添加 WikipediaLoader
- `src/query_engine.py` - 添加 HybridQueryEngine
- `src/indexer.py` - 添加预索引方法
- `src/config.py` - 添加维基百科配置
- `env.template` - 添加配置模板
- `app.py` - UI 集成和分区展示
- `README.md` - 添加功能说明
- `docs/DECISIONS.md` - 添加 ADR-009

## 五、配置示例

```env
# 维基百科配置
ENABLE_WIKIPEDIA=true                # 是否启用
WIKIPEDIA_AUTO_LANG=true             # 自动检测语言
WIKIPEDIA_THRESHOLD=0.6              # 触发阈值（0-1）
WIKIPEDIA_MAX_RESULTS=2              # 最多结果数
WIKIPEDIA_PRELOAD_CONCEPTS=系统科学,钱学森,系统工程,控制论,信息论,复杂系统
```

## 六、使用示例

### 预索引模式
```python
from src.indexer import IndexManager

index_manager = IndexManager()
index_manager.preload_wikipedia_concepts(
    concept_keywords=["系统科学", "钱学森", "控制论"],
    lang="zh"
)
```

### 混合查询模式
```python
from src.query_engine import HybridQueryEngine

hybrid_engine = HybridQueryEngine(
    index_manager,
    enable_wikipedia=True,
    wikipedia_threshold=0.6
)

answer, local_sources, wiki_sources = hybrid_engine.query(
    "钱学森对系统科学的贡献是什么？"
)
```

### Web UI
1. 登录系统
2. 加载本地文档
3. 侧边栏找到"🌐 维基百科增强"
4. 启用维基百科查询
5. （可选）预索引核心概念
6. 开始查询，系统自动补充维基百科内容

## 七、查询结果示例

```
💬 回答
钱学森（1911-2009）是中国著名科学家，被誉为"中国航天之父"。他在系统工程和系统科学领域做出了杰出贡献，特别是提出了开放的复杂巨系统理论...

📚 本地知识库来源 (2)
[1] 钱学森生平 | 📁 钱学森生平.md | 相似度: 0.85
    钱学森（1911-2009）是中国著名科学家...
    
[2] 系统工程概述 | 📁 系统工程概述.md | 相似度: 0.72
    钱学森将系统工程引入中国，并结合中国实际进行了创新性发展...

🌐 维基百科补充 (1)
[W1] 钱学森 | 🔗 https://zh.wikipedia.org/wiki/钱学森 | 相似度: 0.68
    钱学森（1911年12月11日－2009年10月31日），浙江杭州人，空气动力学家...
```

## 八、技术亮点

1. **智能触发**：根据本地结果质量自动决定是否查询维基百科
2. **无缝集成**：用户无需手动切换，系统自动处理
3. **来源清晰**：分区展示，一目了然
4. **多语言支持**：自动检测查询语言
5. **可配置**：丰富的配置选项满足不同需求
6. **性能优化**：动态索引，不污染主索引
7. **高可用**：支持关闭功能，不影响基本使用

## 九、性能影响

### 启用维基百科
- **首次查询**：+2-5秒（LLM 提取关键词 + 维基百科 API + 向量化）
- **后续查询**：根据触发频率，平均 +1-3秒
- **存储影响**：无（不持久化）

### 优化建议
- 提高触发阈值（减少触发频率）
- 预索引常用概念（提升速度）
- 关闭功能（禁用维基百科）

## 十、测试覆盖

### 单元测试
- ✅ 基本加载功能
- ✅ 中文维基百科
- ✅ 多页面加载
- ✅ 不存在页面处理
- ✅ 空列表处理

### 集成测试
- 🔄 混合查询流程（待补充）
- 🔄 分区展示（待补充）

## 十一、后续优化

1. **缓存机制**：缓存热门查询的维基百科结果
2. **评分融合**：合并本地和维基百科的相关度评分
3. **多语言支持**：扩展到更多语言
4. **自定义概念库**：允许用户管理预索引概念
5. **性能监控**：添加触发率、命中率等指标

## 十二、已知问题

1. **查询延迟**：触发维基百科时会增加延迟（2-5秒）
   - 应对：可关闭功能或提高阈值

2. **关键词提取**：LLM 提取偶尔不准确
   - 应对：已实现回退机制（简单分词）

3. **维基百科 API 限流**：频繁调用可能被限流
   - 应对：智能触发策略减少调用频率

## 十三、总结

维基百科集成功能成功实现了"专业知识+通识背景"的混合模式，在保持本地知识库权威性的同时，提供了更全面的知识覆盖。

**核心价值**：
- ✅ 知识覆盖更全面
- ✅ 自动化程度高
- ✅ 来源清晰可溯源
- ✅ 用户体验友好

**实施质量**：
- ✅ 代码规范，无 linter 错误
- ✅ 文档完善（README、DECISIONS、测试）
- ✅ 配置灵活，易于调整
- ✅ 错误处理完善

**下一步**：
- 收集用户反馈
- 监控性能指标
- 根据实际使用情况优化

