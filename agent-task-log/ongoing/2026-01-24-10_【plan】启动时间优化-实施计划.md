# 2026-01-24 ã€planã€‘å¯åŠ¨æ—¶é—´ä¼˜åŒ– - å®æ–½è®¡åˆ’

**ä»»åŠ¡ç±»å‹**: optimization  
**æ—¥æœŸ**: 2026-01-24  
**ä»»åŠ¡ç¼–å·**: #10  
**Agent**: Claude Opus 4.5

---

## Checkpoint çŠ¶æ€è¡¨

| CP | é˜¶æ®µ | çŠ¶æ€ | å®Œæˆæ—¥æœŸ |
|----|------|------|----------|
| CP1 | è·³è¿‡éå¿…éœ€æ¨¡å—é¢„åŠ è½½ | ğŸ”„ è¿›è¡Œä¸­ | - |
| CP2 | å¹¶è¡Œåˆå§‹åŒ– | â¬œ å¾…å¼€å§‹ | - |
| CP3 | å»¶è¿ŸéªŒè¯ä¸æŸ¥è¯¢ | â¬œ å¾…å¼€å§‹ | - |
| CP4 | éªŒè¯ä¸å›å½’æµ‹è¯• | â¬œ å¾…å¼€å§‹ | - |

---

## èƒŒæ™¯ä¸ç›®æ ‡

### èƒŒæ™¯

å½“å‰ Streamlit åº”ç”¨å¯åŠ¨æ—¶é—´çº¦ **15-20ç§’**ï¼ˆåå°é¢„åŠ è½½é˜¶æ®µï¼‰ï¼Œä¸»è¦ç“¶é¢ˆï¼š

| æ¨¡å— | è€—æ—¶ | å æ¯” | åŸå›  |
|------|------|------|------|
| `embedding` | 5.33s | 34% | HF Inference API è¿æ¥éªŒè¯ |
| `index_manager` | 7.59s | 48% | Chroma Cloud å®¢æˆ·ç«¯åˆå§‹åŒ– |
| `rag_service` | 1.23s | 8% | - |
| `chat_manager` | 1.05s | 7% | - |

### é—®é¢˜åˆ†æ

1. **"å»¶è¿ŸåŠ è½½"åä¸å‰¯å®**ï¼šè™½ç„¶æ¨¡å—æ ‡è®°ä¸º `is_required=False`ï¼Œä½† `preloader._do_init()` ä»éå†å¹¶åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
2. **é“¾å¼è§¦å‘**ï¼š`init_chat_manager` â†’ `init_index_manager` â†’ `init_embedding`
3. **ä¸²è¡Œæ‰§è¡Œ**ï¼šæ‰€æœ‰åˆå§‹åŒ–æŒ‰æ‹“æ‰‘æ’åºä¸²è¡Œæ‰§è¡Œï¼Œæ— å¹¶è¡Œ
4. **åŒæ­¥éªŒè¯**ï¼šEmbedding åˆå§‹åŒ–æ—¶æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢éªŒè¯è¿æ¥

### ç›®æ ‡

å°†å¯åŠ¨æ—¶é—´ä» **~15s** é™è‡³ **<5s**

| ä¼˜åŒ–é¡¹ | é¢„æœŸæ”¶ç›Š |
|--------|----------|
| è·³è¿‡éå¿…éœ€æ¨¡å—é¢„åŠ è½½ | -8s |
| å¹¶è¡Œåˆå§‹åŒ– | -3s |
| å»¶è¿ŸéªŒè¯ | -2s |

---

## å†³ç­–è®°å½•

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| å“ªäº›æ¨¡å—å¿…é¡»é¢„åŠ è½½ | config, logger, llm_factory, session_state | é¦–æ¬¡æ¸²æŸ“å¿…éœ€ |
| å»¶è¿ŸåŠ è½½æ—¶æœº | é¦–æ¬¡æŸ¥è¯¢æ—¶ | ç”¨æˆ·æ“ä½œè§¦å‘ |
| å¹¶è¡Œç­–ç•¥ | ThreadPoolExecutor | ç®€å•å¯é  |

---

## å®æ–½æ­¥éª¤

### CP1: è·³è¿‡éå¿…éœ€æ¨¡å—é¢„åŠ è½½

**ç›®æ ‡**ï¼š`preloader._do_init()` åªåˆå§‹åŒ–å¿…éœ€æ¨¡å—ï¼Œéå¿…éœ€æ¨¡å—çœŸæ­£å»¶è¿Ÿ

**ä»»åŠ¡**ï¼š
1. ä¿®æ”¹ `frontend/utils/preloader.py`
   - `_do_init()` ä¸­è¿‡æ»¤ `is_required=False` çš„æ¨¡å—
   - åªåˆå§‹åŒ–ï¼šencoding, config, logger, llm_factory, session_state
2. ä¿®æ”¹ `backend/infrastructure/initialization/registry_init.py`
   - `init_rag_service()` å’Œ `init_chat_manager()` æ·»åŠ å»¶è¿ŸåŠ è½½é€»è¾‘
   - é¦–æ¬¡è°ƒç”¨æ—¶æ‰åˆå§‹åŒ– `index_manager`

**ä»£ç æ”¹åŠ¨**ï¼š
```python
# preloader.py _do_init() ä¸­
for module_name in manager._topological_sort():
    module = manager.modules[module_name]
    if not module.is_required:
        self._stage_details.append(f"â­ï¸ {module.description} (å»¶è¿ŸåŠ è½½)")
        continue  # è·³è¿‡éå¿…éœ€æ¨¡å—
    # ... åŸæœ‰åˆå§‹åŒ–é€»è¾‘
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å¯åŠ¨æ—¶åªåˆå§‹åŒ–å¿…éœ€æ¨¡å—
- [ ] é¢„åŠ è½½æ—¶é—´é™è‡³ <3s
- [ ] æ—¥å¿—æ­£ç¡®æ˜¾ç¤ºè·³è¿‡çš„æ¨¡å—

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
- ä¿®æ”¹ï¼š`frontend/utils/preloader.py`

---

### CP2: å¹¶è¡Œåˆå§‹åŒ–

**ç›®æ ‡**ï¼šå¹¶è¡Œåˆå§‹åŒ–æ— ä¾èµ–å…³ç³»çš„æ¨¡å—

**ä»»åŠ¡**ï¼š
1. ä¿®æ”¹ `backend/infrastructure/initialization/manager.py`
   - æ·»åŠ  `execute_parallel()` æ–¹æ³•
   - ä½¿ç”¨ `ThreadPoolExecutor` å¹¶è¡Œæ‰§è¡Œ
2. è¯†åˆ«å¯å¹¶è¡Œçš„æ¨¡å—ç»„ï¼š
   - ç»„1ï¼šencoding, config, loggerï¼ˆä¸²è¡Œï¼Œæœ‰ä¾èµ–ï¼‰
   - ç»„2ï¼šllm_factory, session_stateï¼ˆå¯å¹¶è¡Œï¼‰

**ä»£ç æ”¹åŠ¨**ï¼š
```python
def execute_parallel(self, module_names: List[str]) -> Dict[str, bool]:
    """å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–å…³ç³»çš„æ¨¡å—"""
    from concurrent.futures import ThreadPoolExecutor, as_completed
    
    results = {}
    with ThreadPoolExecutor(max_workers=3) as executor:
        futures = {
            executor.submit(self.execute_init, name): name 
            for name in module_names
        }
        for future in as_completed(futures):
            name = futures[future]
            try:
                results[name] = future.result()
            except Exception as e:
                results[name] = False
                logger.error(f"å¹¶è¡Œåˆå§‹åŒ– {name} å¤±è´¥: {e}")
    return results
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] llm_factory å’Œ session_state å¹¶è¡Œåˆå§‹åŒ–
- [ ] æ— çº¿ç¨‹å®‰å…¨é—®é¢˜
- [ ] å¯åŠ¨æ—¶é—´è¿›ä¸€æ­¥å‡å°‘

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
- ä¿®æ”¹ï¼š`backend/infrastructure/initialization/manager.py`
- ä¿®æ”¹ï¼š`frontend/utils/preloader.py`ï¼ˆè°ƒç”¨å¹¶è¡Œåˆå§‹åŒ–ï¼‰

---

### CP3: å»¶è¿ŸéªŒè¯ä¸æŸ¥è¯¢

**ç›®æ ‡**ï¼šå°†è€—æ—¶çš„éªŒè¯å’ŒæŸ¥è¯¢å»¶è¿Ÿåˆ°é¦–æ¬¡ä½¿ç”¨

**ä»»åŠ¡**ï¼š
1. ä¿®æ”¹ `backend/infrastructure/initialization/registry_init.py`
   - `init_embedding()`ï¼šç§»é™¤ `get_query_embedding("test")` éªŒè¯
   - æ·»åŠ  `_validate_on_first_use` æ ‡å¿—
2. ä¿®æ”¹ `backend/infrastructure/indexer/core/manager.py`
   - `IndexManager.__init__()`ï¼šå»¶è¿Ÿ `count()` å’Œ `peek()` æŸ¥è¯¢
   - é¦–æ¬¡ `build_index()` æˆ– `query()` æ—¶æ‰§è¡Œ

**ä»£ç æ”¹åŠ¨**ï¼š
```python
# registry_init.py init_embedding()
def init_embedding(manager: InitializationManager) -> Any:
    embedding_instance = create_embedding()
    embedding_instance._needs_validation = True  # æ ‡è®°é¦–æ¬¡ä½¿ç”¨æ—¶éªŒè¯
    return embedding_instance
```

```python
# IndexManager.__init__() å»¶è¿ŸæŸ¥è¯¢
self._collection_info_cached = False

def _ensure_collection_info(self):
    if not self._collection_info_cached:
        self._collection_count = self.chroma_collection.count()
        # ... å…¶ä»–åˆå§‹åŒ–
        self._collection_info_cached = True
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] Embedding åˆå§‹åŒ–æ—¶ä¸æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢
- [ ] IndexManager åˆå§‹åŒ–æ—¶ä¸æŸ¥è¯¢æ•°æ®åº“
- [ ] é¦–æ¬¡ä½¿ç”¨æ—¶æ­£å¸¸éªŒè¯å’ŒæŸ¥è¯¢

**é¢„è®¡æ–‡ä»¶æ”¹åŠ¨**ï¼š
- ä¿®æ”¹ï¼š`backend/infrastructure/initialization/registry_init.py`
- ä¿®æ”¹ï¼š`backend/infrastructure/indexer/core/manager.py`
- ä¿®æ”¹ï¼š`backend/infrastructure/embeddings/` ç›¸å…³æ–‡ä»¶

---

### CP4: éªŒè¯ä¸å›å½’æµ‹è¯•

**ç›®æ ‡**ï¼šç¡®ä¿ä¼˜åŒ–ååŠŸèƒ½æ­£å¸¸

**ä»»åŠ¡**ï¼š
1. å¯åŠ¨æ—¶é—´æµ‹è¯•
   - è®°å½•ä¼˜åŒ–å‰åçš„å¯åŠ¨æ—¶é—´
   - ç¡®è®¤è¾¾åˆ° <5s ç›®æ ‡
2. åŠŸèƒ½å›å½’æµ‹è¯•
   - é¦–æ¬¡æŸ¥è¯¢æ­£å¸¸
   - ç´¢å¼•æ„å»ºæ­£å¸¸
   - GitHub å¯¼å…¥æ­£å¸¸
3. é”™è¯¯å¤„ç†æµ‹è¯•
   - Embedding è¿æ¥å¤±è´¥æ—¶çš„å¤„ç†
   - Chroma è¿æ¥å¤±è´¥æ—¶çš„å¤„ç†

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] å¯åŠ¨æ—¶é—´ <5s
- [ ] æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯æç¤ºå‹å¥½

---

## æ–‡ä»¶æ”¹åŠ¨æ¸…å•

| æ“ä½œ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| ä¿®æ”¹ | `frontend/utils/preloader.py` | è·³è¿‡éå¿…éœ€æ¨¡å— |
| ä¿®æ”¹ | `backend/infrastructure/initialization/manager.py` | æ·»åŠ å¹¶è¡Œåˆå§‹åŒ– |
| ä¿®æ”¹ | `backend/infrastructure/initialization/registry_init.py` | å»¶è¿ŸéªŒè¯é€»è¾‘ |
| ä¿®æ”¹ | `backend/infrastructure/indexer/core/manager.py` | å»¶è¿ŸæŸ¥è¯¢ |

---

## é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**ï¼šå¹¶è¡Œåˆå§‹åŒ–æ—¶æ³¨æ„ `session_state` çš„çº¿ç¨‹å®‰å…¨
2. **é¦–æ¬¡æŸ¥è¯¢å»¶è¿Ÿ**ï¼šå»¶è¿ŸåŠ è½½ä¼šå¢åŠ é¦–æ¬¡æŸ¥è¯¢æ—¶é—´ï¼Œä½†æ€»ä½“ç”¨æˆ·ä½“éªŒæ›´å¥½
3. **é”™è¯¯å¤„ç†**ï¼šå»¶è¿ŸéªŒè¯çš„é”™è¯¯éœ€è¦åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶å‹å¥½æç¤º
4. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰ API ä¸å˜

---

## ä¸‹ä¸€æ­¥

ç¡®è®¤è®¡åˆ’åï¼Œä» **CP1ï¼ˆè·³è¿‡éå¿…éœ€æ¨¡å—é¢„åŠ è½½ï¼‰** å¼€å§‹æ‰§è¡Œã€‚
