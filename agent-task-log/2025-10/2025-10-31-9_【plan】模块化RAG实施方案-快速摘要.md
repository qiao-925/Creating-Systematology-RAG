# 2025-10-31 【plan】模块化 RAG 实施方案 - 快速摘要

**【Task Type】**: plan
> **任务来源**: RAG架构演进评估 - 阶段1实施  
> **创建时间**: 2025-10-31  
> **预计工作量**: 约1周（7天）  
> **文档类型**: 快速摘要

---

## 📋 方案概述

### 目标

将当前**固定流程的 RAG 系统**升级为**模块化、可配置的 RAG 系统**

### 核心价值

| 能力 | 当前 | 升级后 |
|------|------|--------|
| 切换检索策略 | 修改代码 | 配置参数 |
| 添加后处理 | 需重构 | 添加模块 |
| 实验新策略 | 困难 | 容易（1天内） |

---

## 🏗️ 架构设计

### 当前架构 → 目标架构

```
[当前] QueryEngine → CitationQueryEngine (固定)

[目标] ModularQueryEngine (工厂模式)
         ↓
       策略选择 (配置驱动)
         ├─ vector (向量检索)
         ├─ bm25 (关键词检索)
         └─ hybrid (混合检索)
         ↓
       后处理模块 (可选)
         ├─ 相似度过滤
         └─ 重排序
```

### 核心组件

**1. ModularQueryEngine** - 工厂模式，根据配置创建引擎

**2. 检索器模块（3种策略）**:
- `vector`: 语义检索，精度高
- `bm25`: 关键词检索，召回高
- `hybrid`: 混合检索，平衡精度召回

**3. 后处理模块（可选）**:
- 相似度过滤（必选）
- 重排序（可选）

---

## 🔧 技术实现

### 新建文件

```
src/modular_query_engine.py    # 核心实现（新建）
```

### 更新文件

```
src/config.py                   # 添加模块化配置
src/query_engine.py             # 添加工厂函数（向后兼容）
.env.example                    # 配置示例
```

### 关键配置

```bash
# .env 配置示例
RETRIEVAL_STRATEGY=hybrid      # vector/bm25/hybrid
ENABLE_RERANK=true             # 是否启用重排序
SIMILARITY_CUTOFF=0.6          # 相似度阈值
```

---

## 📅 实施步骤（7天）

| Day | 任务 | 产出 |
|-----|------|------|
| **Day 1** | 设计与配置 | 架构文档、配置更新 |
| **Day 2** | 核心实现 | ModularQueryEngine |
| **Day 3** | 混合检索 | BM25 + Hybrid |
| **Day 4** | 重排序模块 | Rerank 集成 |
| **Day 5** | 配置化改造 | CLI + Web 集成 |
| **Day 6-7** | 测试与优化 | 测试报告、文档 |

### 详细任务拆解

#### Day 1: 设计与配置
- ✅ 设计模块化架构（2h）
- ✅ 更新配置模块（2h）
- ✅ 编写单元测试框架（2h）

#### Day 2: 核心实现
- ✅ 实现 ModularQueryEngine（4h）
- ✅ 实现向量检索器（1h）
- ✅ 实现后处理模块（2h）

#### Day 3: 混合检索
- ✅ 实现 BM25 检索器（3h）
- ✅ 实现混合检索器（3h）
- ✅ 测试各检索策略（2h）

#### Day 4: 重排序模块
- ✅ 集成重排序模块（3h）
- ✅ 测试重排序效果（2h）
- ✅ 调优重排序参数（2h）

#### Day 5: 配置化改造
- ✅ 环境变量配置（2h）
- ✅ CLI 参数支持（2h）
- ✅ Web UI 集成（3h）

#### Day 6-7: 测试与优化
- ✅ 单元测试（3h）
- ✅ 集成测试（3h）
- ✅ 性能测试（2h）
- ✅ 对比基线效果（3h）
- ✅ 文档更新（2h）

---

## 🧪 测试验证

### 测试策略

| 层级 | 内容 | 工具 |
|------|------|------|
| 单元测试 | 各模块独立功能 | pytest |
| 集成测试 | 模块组合效果 | pytest |
| 性能测试 | 检索速度、精度 | 自定义脚本 |
| 对比测试 | 新旧实现对比 | 自定义脚本 |

### 性能对比（预期）

| 策略 | 检索时间 | 精度 | 召回 | 适用场景 |
|------|---------|------|------|---------|
| vector | 快 (~1s) | 高 | 中 | 概念理解 |
| bm25 | 很快 (~0.5s) | 中 | 高 | 精确匹配 |
| hybrid | 中等 (~2s) | 很高 | 高 | 综合查询 |
| hybrid+rerank | 慢 (~3s) | 极高 | 高 | 高要求场景 |

### 验收标准

#### ✅ 必须满足

- ✅ 支持3种检索策略
- ✅ 支持重排序模块
- ✅ 配置化切换无需修改代码
- ✅ 向后兼容（现有API不变）
- ✅ 单元测试覆盖率 >80%

---

## ⚠️ 风险与应对

### 技术风险

| 风险 | 可能性 | 应对措施 |
|------|--------|---------|
| BM25 依赖安装失败 | 中 | 降级为仅vector |
| 重排序性能差 | 中 | 默认关闭，提供禁用选项 |
| 向后不兼容 | 低 | 保留现有类，严格测试 |

### 回退方案

- **方案1**: 保留现有 `QueryEngine`，删除新代码
- **方案2**: 仅启用已验证的模块（如vector策略）
- **方案3**: 优化后重新尝试

---

## 🎯 核心代码示例

### ModularQueryEngine 使用示例

```python
from src.modular_query_engine import ModularQueryEngine
from src.indexer import IndexManager

# 创建索引
index_manager = IndexManager(collection_name="my_docs")

# 创建模块化查询引擎
engine = ModularQueryEngine(
    index_manager=index_manager,
    retrieval_strategy="hybrid",  # 混合检索
    enable_rerank=True,            # 启用重排序
    similarity_cutoff=0.6,         # 相似度阈值
)

# 查询
answer, sources, trace = engine.query("什么是系统科学？")

print(f"答案: {answer}")
print(f"来源数: {len(sources)}")
```

### 配置化使用

```python
# 通过配置文件（.env）控制
# RETRIEVAL_STRATEGY=hybrid
# ENABLE_RERANK=true

from src.modular_query_engine import ModularQueryEngine

# 自动读取配置
engine = ModularQueryEngine(index_manager)  # 使用默认配置
```

---

## 📊 预期效果

### 短期（1周内）
- ✅ 完成模块化实施
- ✅ 支持3种检索策略
- ✅ 配置化切换

### 中期（1个月）
- ✅ 通过实际使用验证效果
- ✅ 根据反馈优化参数
- ✅ 识别最优策略组合

### 长期（3个月）
- ✅ 积累丰富的使用经验
- ✅ 为 Agentic RAG 打下基础
- ✅ 建立系统化的 RAG 优化流程

---

## 📄 相关文档

- 📄 **[完整实施方案](2025-10-31-9_模块化RAG实施方案_实施方案.md)** - 详细技术方案
- 📄 [RAG架构演进评估调研报告](2025-10-31-8_RAG架构演进评估_调研报告.md) - 背景调研
- 📄 [TRACKER.md](../docs/TRACKER.md) - 任务追踪

---

## 🚀 下一步行动

1. **评审方案** - 团队评审技术方案
2. **确认资源** - 确认开发人员和时间
3. **启动实施** - 按步骤开始开发
4. **持续跟进** - 每日同步进度和问题

---

**方案创建时间**: 2025-10-31  
**方案状态**: ✅ 已完成，等待评审  
**下一步**: 确认是否启动实施







