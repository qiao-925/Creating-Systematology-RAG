# files_via_content å’Œ files_via_metadata æ£€ç´¢å™¨å®ç°æ–¹æ¡ˆ

> **ä»»åŠ¡ç±»å‹**: åŠŸèƒ½å®ç°  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-04  
> **çŠ¶æ€**: æ–¹æ¡ˆè®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

### ç›®æ ‡
å®ç°ä¸¤ä¸ªæ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨ï¼Œå®Œæˆè‡ªåŠ¨è·¯ç”±åŠŸèƒ½ï¼š
1. **`files_via_content`** - å®½æ³›ä¸»é¢˜æŸ¥è¯¢ï¼ˆæ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢ï¼‰
2. **`files_via_metadata`** - æ–‡ä»¶åæŸ¥è¯¢ï¼ˆæ–‡ä»¶çº§åˆ«å…ƒæ•°æ®æ£€ç´¢ï¼‰

### å½“å‰é—®é¢˜
- è·¯ç”±é€»è¾‘å·²å®ç°ï¼Œèƒ½æ­£ç¡®è¯†åˆ«æŸ¥è¯¢ç±»å‹
- ä½†æ£€ç´¢å™¨åªæ˜¯å ä½ç¬¦ï¼Œå®é™…é™çº§ä½¿ç”¨ `chunk` æ£€ç´¢å™¨
- æ—¥å¿—ä¸­æ˜¾ç¤ºè­¦å‘Šï¼š"files_via_contentæ£€ç´¢å™¨å°šæœªå®Œå…¨å®ç°ï¼Œä½¿ç”¨chunkæ£€ç´¢å™¨"

### æœŸæœ›æ•ˆæœ
- æŸ¥è¯¢ "ä»€ä¹ˆæ˜¯ç³»ç»Ÿç§‘å­¦ï¼Ÿ" â†’ è·¯ç”±åˆ° `files_via_content` â†’ è¿”å›ç›¸å…³æ–‡ä»¶çš„å®Œæ•´å†…å®¹
- æŸ¥è¯¢ "ç³»ç»Ÿç§‘å­¦.mdæ–‡ä»¶çš„å†…å®¹" â†’ è·¯ç”±åˆ° `files_via_metadata` â†’ è¿”å›åŒ¹é…æ–‡ä»¶çš„å®Œæ•´å†…å®¹

---

## ğŸ” éœ€æ±‚ç†è§£ä¸è¾¹ç•Œåˆ†æ

### æ ¸å¿ƒåŠŸèƒ½ç‚¹
1. **æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢** (`files_via_content`)
   - å…ˆé€šè¿‡è¯­ä¹‰ç›¸ä¼¼åº¦æ‰¾åˆ°ç›¸å…³æ–‡ä»¶
   - å†æ£€ç´¢è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰ chunks
   - è¿”å›æ–‡ä»¶çº§åˆ«çš„å®Œæ•´å†…å®¹

2. **æ–‡ä»¶çº§åˆ«å…ƒæ•°æ®æ£€ç´¢** (`files_via_metadata`)
   - å…ˆé€šè¿‡æ–‡ä»¶å/è·¯å¾„åŒ¹é…æ‰¾åˆ°æ–‡ä»¶
   - å†æ£€ç´¢è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰ chunks
   - è¿”å›æ–‡ä»¶çº§åˆ«çš„å®Œæ•´å†…å®¹

### è¾¹ç•Œæ¡ä»¶
- âœ… æ”¯æŒç°æœ‰ç´¢å¼•ç»“æ„ï¼ˆChromaDB + VectorStoreIndexï¼‰
- âœ… å¤ç”¨ç°æœ‰çš„ metadata å­˜å‚¨ï¼ˆfile_path, file_nameï¼‰
- âœ… å…¼å®¹ç°æœ‰çš„æ£€ç´¢å™¨æ¥å£ï¼ˆè¿”å› `List[NodeWithScore]`ï¼‰
- âœ… ä¸ Grep æ£€ç´¢å™¨åŒºåˆ†ï¼ˆGrep æ˜¯æ–‡æœ¬è¡Œçº§åˆ«ï¼Œè¿™æ˜¯æ–‡ä»¶çº§åˆ«ï¼‰
- âŒ ä¸éœ€è¦é‡æ–°æ„å»ºç´¢å¼•ï¼ˆä½¿ç”¨ç°æœ‰ç´¢å¼•ï¼‰
- âŒ ä¸éœ€è¦ä¿®æ”¹ IndexManagerï¼ˆä»…æ‰©å±•æ£€ç´¢é€»è¾‘ï¼‰

### æ½œåœ¨é£é™©
1. **æ€§èƒ½é£é™©**ï¼šæ–‡ä»¶çº§åˆ«æ£€ç´¢éœ€è¦å…ˆæ‰¾æ–‡ä»¶ï¼Œå†æ£€ç´¢æ‰€æœ‰ chunksï¼Œå¯èƒ½æ¯” chunk æ£€ç´¢æ…¢
2. **ç»“æœæ•°é‡é£é™©**ï¼šä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ª chunksï¼Œè¿”å›ç»“æœå¯èƒ½è¾ƒå¤š
3. **å…ƒæ•°æ®åŒ¹é…é£é™©**ï¼šæ–‡ä»¶ååŒ¹é…å¯èƒ½éœ€è¦æ”¯æŒæ¨¡ç³ŠåŒ¹é…

### å¯å‚è€ƒå®ç°
- âœ… `src/retrievers/grep_retriever.py` - æ£€ç´¢å™¨æ¥å£è®¾è®¡
- âœ… `src/indexer.py` - `_get_vector_ids_by_metadata()` æ–¹æ³•ï¼ˆæŒ‰ file_path æŸ¥è¯¢ï¼‰
- âœ… `src/routers/query_router.py` - è·¯ç”±é€»è¾‘å’Œæ£€ç´¢å™¨é›†æˆ

---

## ğŸ’¡ é‡è¦é€»è¾‘çš„å®ç°æ€è·¯

### 1. æ¶æ„è®¾è®¡

#### æ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨çš„æ ¸å¿ƒæ€è·¯
```
ç”¨æˆ·æŸ¥è¯¢
  â†“
Step 1: æ–‡ä»¶çº§åˆ«ç­›é€‰ï¼ˆæ–‡ä»¶ç²’åº¦ï¼‰
  - files_via_content: è¯­ä¹‰æ£€ç´¢æ‰¾åˆ°ç›¸å…³æ–‡ä»¶
  - files_via_metadata: å…ƒæ•°æ®åŒ¹é…æ‰¾åˆ°æ–‡ä»¶
  â†“
Step 2: æ–‡ä»¶å†…å®¹æ£€ç´¢ï¼ˆchunkç²’åº¦ï¼‰
  - ä»å·²ç­›é€‰çš„æ–‡ä»¶ä¸­ï¼Œæ£€ç´¢æ‰€æœ‰ç›¸å…³çš„ chunks
  - ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æ’åº
  â†“
Step 3: ç»“æœèšåˆä¸å»é‡
  - æŒ‰æ–‡ä»¶åˆ†ç»„ chunks
  - ä¿ç•™ top_k ä¸ªæ–‡ä»¶
  - æ¯ä¸ªæ–‡ä»¶ä¿ç•™ top_k ä¸ªæœ€ç›¸å…³çš„ chunks
```

#### æŠ€æœ¯é€‰å‹

**æ–¹æ¡ˆ A: ä¸¤é˜¶æ®µæ£€ç´¢ï¼ˆæ¨èï¼‰**
- é˜¶æ®µ1ï¼šæ–‡ä»¶çº§åˆ«ç­›é€‰ï¼ˆä½¿ç”¨æ–‡æ¡£æ‘˜è¦æˆ–æ–‡ä»¶å…ƒæ•°æ®ï¼‰
- é˜¶æ®µ2ï¼šæ–‡ä»¶å†…å®¹æ£€ç´¢ï¼ˆä½¿ç”¨ç°æœ‰å‘é‡ç´¢å¼•ï¼‰

**æ–¹æ¡ˆ B: ç›´æ¥æ£€ç´¢ + åå¤„ç†**
- ä½¿ç”¨ç°æœ‰å‘é‡ç´¢å¼•æ£€ç´¢æ‰€æœ‰ chunks
- æŒ‰ file_path åˆ†ç»„ï¼Œé€‰æ‹© top_k æ–‡ä»¶
- ä»æ¯ä¸ªæ–‡ä»¶ä¸­é€‰æ‹© top_k chunks

**é€‰æ‹©æ–¹æ¡ˆ A**ï¼Œç†ç”±ï¼š
- æ›´ç¬¦åˆæ–‡ä»¶çº§åˆ«æ£€ç´¢çš„è¯­ä¹‰
- æ€§èƒ½æ›´å¥½ï¼ˆå…ˆç­›é€‰æ–‡ä»¶ï¼Œå‡å°‘æ£€ç´¢èŒƒå›´ï¼‰
- é€»è¾‘æ›´æ¸…æ™°ï¼ˆæ–‡ä»¶ â†’ chunks ä¸¤å±‚ç»“æ„ï¼‰

### 2. FilesViaContentRetriever å®ç°æ€è·¯

```python
class FilesViaContentRetriever:
    """æ–‡ä»¶çº§åˆ«å†…å®¹æ£€ç´¢å™¨ï¼ˆå®½æ³›ä¸»é¢˜æŸ¥è¯¢ï¼‰
    
    å®ç°æ­¥éª¤ï¼š
    1. ä½¿ç”¨è¯­ä¹‰æ£€ç´¢æ‰¾åˆ°ç›¸å…³æ–‡ä»¶ï¼ˆé€šè¿‡æ–‡æ¡£æ‘˜è¦æˆ–æ–‡ä»¶æ ‡é¢˜ï¼‰
    2. ä»ç›¸å…³æ–‡ä»¶ä¸­æ£€ç´¢æ‰€æœ‰ chunks
    3. æŒ‰æ–‡ä»¶åˆ†ç»„ï¼Œæ¯ä¸ªæ–‡ä»¶ä¿ç•™ top_k ä¸ªæœ€ç›¸å…³çš„ chunks
    """
    
    def retrieve(self, query: str, top_k: int) -> List[NodeWithScore]:
        # Step 1: æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢
        # æ–¹æ¡ˆï¼šä½¿ç”¨æ–‡æ¡£æ‘˜è¦çš„å‘é‡ç´¢å¼•ï¼Œæˆ–ç›´æ¥æ£€ç´¢æ‰€æœ‰ chunks åæŒ‰æ–‡ä»¶åˆ†ç»„
        relevant_files = self._find_relevant_files(query, top_k_files)
        
        # Step 2: ä»æ–‡ä»¶ä¸­æ£€ç´¢ chunks
        all_nodes = []
        for file_path in relevant_files:
            file_chunks = self._retrieve_file_chunks(query, file_path, top_k_per_file)
            all_nodes.extend(file_chunks)
        
        # Step 3: æ’åºå’Œå»é‡
        return self._rank_and_deduplicate(all_nodes, top_k)
```

**å…³é”®å®ç°ç»†èŠ‚**ï¼š
- **æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢**ï¼šä½¿ç”¨ç°æœ‰å‘é‡ç´¢å¼•ï¼Œæ£€ç´¢æ‰€æœ‰ chunksï¼ŒæŒ‰ `file_path` åˆ†ç»„ï¼Œé€‰æ‹© top_k ä¸ªæœ€ç›¸å…³çš„æ–‡ä»¶
- **æ–‡ä»¶å†…å®¹æ£€ç´¢**ï¼šä»å·²é€‰æ–‡ä»¶çš„æ‰€æœ‰ chunks ä¸­ï¼Œé€‰æ‹©ä¸æŸ¥è¯¢æœ€ç›¸å…³çš„ top_k ä¸ª chunks
- **åˆ†æ•°è®¡ç®—**ï¼šç»“åˆæ–‡ä»¶çº§åˆ«åˆ†æ•°å’Œ chunk çº§åˆ«åˆ†æ•°

### 3. FilesViaMetadataRetriever å®ç°æ€è·¯

```python
class FilesViaMetadataRetriever:
    """æ–‡ä»¶çº§åˆ«å…ƒæ•°æ®æ£€ç´¢å™¨ï¼ˆæ–‡ä»¶åæŸ¥è¯¢ï¼‰
    
    å®ç°æ­¥éª¤ï¼š
    1. ä»æŸ¥è¯¢ä¸­æå–æ–‡ä»¶å/è·¯å¾„å…³é”®è¯
    2. ä½¿ç”¨å…ƒæ•°æ®åŒ¹é…æ‰¾åˆ°æ–‡ä»¶
    3. ä»åŒ¹é…æ–‡ä»¶ä¸­æ£€ç´¢æ‰€æœ‰ chunks
    """
    
    def retrieve(self, query: str, top_k: int) -> List[NodeWithScore]:
        # Step 1: ä»æŸ¥è¯¢ä¸­æå–æ–‡ä»¶åå…³é”®è¯
        file_keywords = self._extract_file_keywords(query)
        
        # Step 2: å…ƒæ•°æ®åŒ¹é…æ‰¾åˆ°æ–‡ä»¶
        matched_files = self._match_files_by_metadata(file_keywords)
        
        # Step 3: ä»æ–‡ä»¶ä¸­æ£€ç´¢ chunks
        all_nodes = []
        for file_path in matched_files:
            file_chunks = self._retrieve_file_chunks(query, file_path, top_k_per_file)
            all_nodes.extend(file_chunks)
        
        return self._rank_and_deduplicate(all_nodes, top_k)
```

**å…³é”®å®ç°ç»†èŠ‚**ï¼š
- **æ–‡ä»¶åæå–**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–å…³é”®è¯åŒ¹é…æå–æ–‡ä»¶åï¼ˆå¦‚ "xxx.md"ã€"xxxæ–‡ä»¶"ï¼‰
- **å…ƒæ•°æ®åŒ¹é…**ï¼šä½¿ç”¨ ChromaDB çš„ `where` æŸ¥è¯¢ï¼ŒåŒ¹é… `file_path` æˆ– `file_name` å…ƒæ•°æ®
- **æ¨¡ç³ŠåŒ¹é…**ï¼šæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚æŸ¥è¯¢ "ç³»ç»Ÿç§‘å­¦" åŒ¹é… "ç³»ç»Ÿç§‘å­¦.md"ï¼‰

### 4. ä¸ç°æœ‰ç´¢å¼•çš„é›†æˆ

**åˆ©ç”¨ç°æœ‰åŠŸèƒ½**ï¼š
- âœ… `IndexManager._get_vector_ids_by_metadata()` - æŒ‰ file_path æŸ¥è¯¢å‘é‡ID
- âœ… ChromaDB çš„ `where` æŸ¥è¯¢ - æ”¯æŒå…ƒæ•°æ®è¿‡æ»¤
- âœ… ç°æœ‰å‘é‡ç´¢å¼• - åŒ…å«æ‰€æœ‰ chunks çš„å‘é‡

**éœ€è¦æ–°å¢åŠŸèƒ½**ï¼š
- æ–‡ä»¶çº§åˆ«åˆ†ç»„å’Œèšåˆ
- æ–‡ä»¶çº§åˆ«åˆ†æ•°è®¡ç®—
- æŸ¥è¯¢ä¸­çš„æ–‡ä»¶åæå–

---

## ğŸ“Š éœ€æ±‚æŒ‰æŠ€æœ¯å®ç°çš„ä¾èµ–å…³ç³»æ‹†è§£å¹¶æ’åº

### ä¾èµ–å…³ç³»å›¾
```
åŸºç¡€å±‚ï¼ˆä¾èµ–ç°æœ‰ï¼‰
  â”œâ”€â”€ IndexManager (å·²æœ‰)
  â”œâ”€â”€ ChromaDB å…ƒæ•°æ®æŸ¥è¯¢ (å·²æœ‰)
  â””â”€â”€ å‘é‡ç´¢å¼• (å·²æœ‰)
      â†“
æ ¸å¿ƒå±‚ï¼ˆæ–°å®ç°ï¼‰
  â”œâ”€â”€ Step 1: æ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨åŸºç±»
  â”‚   â”œâ”€â”€ æ–‡ä»¶åˆ†ç»„é€»è¾‘
  â”‚   â”œâ”€â”€ æ–‡ä»¶åˆ†æ•°è®¡ç®—
  â”‚   â””â”€â”€ chunk èšåˆé€»è¾‘
  â”œâ”€â”€ Step 2: FilesViaContentRetriever
  â”‚   â”œâ”€â”€ æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢
  â”‚   â””â”€â”€ æ–‡ä»¶å†…å®¹æ£€ç´¢
  â””â”€â”€ Step 3: FilesViaMetadataRetriever
      â”œâ”€â”€ æ–‡ä»¶åæå–
      â”œâ”€â”€ å…ƒæ•°æ®åŒ¹é…
      â””â”€â”€ æ–‡ä»¶å†…å®¹æ£€ç´¢
      â†“
é›†æˆå±‚ï¼ˆé›†æˆåˆ°ç°æœ‰ç³»ç»Ÿï¼‰
  â”œâ”€â”€ Step 4: QueryRouter é›†æˆ
  â”‚   â”œâ”€â”€ æ›¿æ¢å ä½å®ç°
  â”‚   â””â”€â”€ ç§»é™¤è­¦å‘Šæ—¥å¿—
  â””â”€â”€ Step 5: æµ‹è¯•éªŒè¯
      â”œâ”€â”€ å•å…ƒæµ‹è¯•
      â””â”€â”€ é›†æˆæµ‹è¯•
```

### å®æ–½æ­¥éª¤ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰

#### Step 1: åˆ›å»ºæ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨åŸºç±»ï¼ˆåŸºç¡€å·¥å…·ï¼‰
**æ–‡ä»¶**: `src/retrievers/file_level_retrievers.py`

**åŠŸèƒ½**ï¼š
- æ–‡ä»¶åˆ†ç»„å·¥å…·å‡½æ•°
- æ–‡ä»¶åˆ†æ•°è®¡ç®—å·¥å…·
- chunk èšåˆå’Œå»é‡å·¥å…·

**ä¾èµ–**: æ— ï¼ˆçº¯å·¥å…·å‡½æ•°ï¼‰

**é¢„è®¡æ—¶é—´**: 1-2å°æ—¶

---

#### Step 2: å®ç° FilesViaContentRetriever
**æ–‡ä»¶**: `src/retrievers/file_level_retrievers.py` (ç»§ç»­)

**åŠŸèƒ½**ï¼š
- æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢ï¼ˆä½¿ç”¨å‘é‡ç´¢å¼• + æ–‡ä»¶åˆ†ç»„ï¼‰
- æ–‡ä»¶å†…å®¹æ£€ç´¢ï¼ˆä»æ–‡ä»¶ä¸­æ£€ç´¢ chunksï¼‰
- ç»“æœæ’åºå’Œå»é‡

**ä¾èµ–**: Step 1ï¼ˆåŸºç±»å·¥å…·ï¼‰

**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

#### Step 3: å®ç° FilesViaMetadataRetriever
**æ–‡ä»¶**: `src/retrievers/file_level_retrievers.py` (ç»§ç»­)

**åŠŸèƒ½**ï¼š
- æ–‡ä»¶åæå–ï¼ˆä»æŸ¥è¯¢ä¸­æå–æ–‡ä»¶åå…³é”®è¯ï¼‰
- å…ƒæ•°æ®åŒ¹é…ï¼ˆä½¿ç”¨ ChromaDB where æŸ¥è¯¢ï¼‰
- æ–‡ä»¶å†…å®¹æ£€ç´¢ï¼ˆå¤ç”¨ Step 2 çš„é€»è¾‘ï¼‰

**ä¾èµ–**: Step 1ï¼ˆåŸºç±»å·¥å…·ï¼‰ã€IndexManagerï¼ˆå…ƒæ•°æ®æŸ¥è¯¢ï¼‰

**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

#### Step 4: é›†æˆåˆ° QueryRouter
**æ–‡ä»¶**: `src/routers/query_router.py`

**åŠŸèƒ½**ï¼š
- åœ¨ `_get_files_via_content_retriever()` ä¸­åˆ›å»º FilesViaContentRetriever
- åœ¨ `_get_files_via_metadata_retriever()` ä¸­åˆ›å»º FilesViaMetadataRetriever
- ç§»é™¤è­¦å‘Šæ—¥å¿—
- æ·»åŠ æ£€ç´¢å™¨åˆå§‹åŒ–æ—¥å¿—

**ä¾èµ–**: Step 2ã€Step 3

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### Step 5: ç¼–å†™æµ‹è¯•
**æ–‡ä»¶**: 
- `tests/unit/test_file_level_retrievers.py` (å•å…ƒæµ‹è¯•)
- `tests/integration/test_file_level_retrieval_integration.py` (é›†æˆæµ‹è¯•)

**åŠŸèƒ½**ï¼š
- FilesViaContentRetriever å•å…ƒæµ‹è¯•
- FilesViaMetadataRetriever å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•ï¼ˆä¸ QueryRouter é…åˆï¼‰
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆç©ºæŸ¥è¯¢ã€æ— åŒ¹é…æ–‡ä»¶ç­‰ï¼‰

**ä¾èµ–**: Step 2ã€Step 3ã€Step 4

**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

## ğŸ“ è¾“å‡ºä¿®æ”¹æˆ–æ–°å¢æ–‡ä»¶çš„è·¯å¾„

### æ–°å¢æ–‡ä»¶

1. **`src/retrievers/file_level_retrievers.py`** (æ–°å»º)
   - æ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨åŸºç±»
   - `FilesViaContentRetriever` ç±»
   - `FilesViaMetadataRetriever` ç±»
   - æ–‡ä»¶åˆ†ç»„å’Œèšåˆå·¥å…·å‡½æ•°

### ä¿®æ”¹æ–‡ä»¶

1. **`src/routers/query_router.py`**
   - ä¿®æ”¹ `_get_files_via_content_retriever()` æ–¹æ³•ï¼ˆç¬¬ 235-242 è¡Œï¼‰
   - ä¿®æ”¹ `_get_files_via_metadata_retriever()` æ–¹æ³•ï¼ˆç¬¬ 226-233 è¡Œï¼‰
   - æ·»åŠ å¯¼å…¥è¯­å¥
   - ç§»é™¤è­¦å‘Šæ—¥å¿—

2. **`src/retrievers/__init__.py`** (å¯é€‰)
   - å¯¼å‡ºæ–°çš„æ£€ç´¢å™¨ç±»ï¼ˆå¦‚æœéœ€è¦ï¼‰

### æµ‹è¯•æ–‡ä»¶

1. **`tests/unit/test_file_level_retrievers.py`** (æ–°å»º)
   - å•å…ƒæµ‹è¯•ï¼šFilesViaContentRetriever
   - å•å…ƒæµ‹è¯•ï¼šFilesViaMetadataRetriever
   - å·¥å…·å‡½æ•°æµ‹è¯•

2. **`tests/integration/test_file_level_retrieval_integration.py`** (æ–°å»º)
   - é›†æˆæµ‹è¯•ï¼šä¸ QueryRouter é…åˆ
   - é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯æŸ¥è¯¢æµç¨‹
   - æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### æ–‡æ¡£æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

1. **`docs/RETRIEVAL_STRATEGY_FLOW.md`** (æ›´æ–°)
   - æ·»åŠ æ–‡ä»¶çº§åˆ«æ£€ç´¢çš„è¯´æ˜
   - æ›´æ–°æ£€ç´¢ç­–ç•¥æµç¨‹å›¾

---

## âœ… è¾“å‡ºæµ‹è¯•è¦ç‚¹

### å•å…ƒæµ‹è¯•è¦ç‚¹

#### 1. FilesViaContentRetriever æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_files_via_content_init` - åˆå§‹åŒ–æµ‹è¯•
- âœ… `test_files_via_content_retrieve_basic` - åŸºç¡€æ£€ç´¢æµ‹è¯•
- âœ… `test_files_via_content_find_relevant_files` - æ–‡ä»¶çº§åˆ«ç­›é€‰æµ‹è¯•
- âœ… `test_files_via_content_retrieve_file_chunks` - æ–‡ä»¶å†…å®¹æ£€ç´¢æµ‹è¯•
- âœ… `test_files_via_content_rank_and_deduplicate` - æ’åºå’Œå»é‡æµ‹è¯•
- âœ… `test_files_via_content_top_k` - Top-K é™åˆ¶æµ‹è¯•
- âœ… `test_files_via_content_empty_query` - ç©ºæŸ¥è¯¢è¾¹ç•Œæµ‹è¯•
- âœ… `test_files_via_content_no_matching_files` - æ— åŒ¹é…æ–‡ä»¶è¾¹ç•Œæµ‹è¯•

**Mock ç­–ç•¥**ï¼š
- Mock `IndexManager.get_index()` è¿”å›æ¨¡æ‹Ÿç´¢å¼•
- Mock å‘é‡æ£€ç´¢ç»“æœ
- Mock ChromaDB æŸ¥è¯¢ç»“æœ

#### 2. FilesViaMetadataRetriever æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_files_via_metadata_init` - åˆå§‹åŒ–æµ‹è¯•
- âœ… `test_files_via_metadata_extract_file_keywords` - æ–‡ä»¶åæå–æµ‹è¯•
- âœ… `test_files_via_metadata_match_files_by_metadata` - å…ƒæ•°æ®åŒ¹é…æµ‹è¯•
- âœ… `test_files_via_metadata_retrieve_basic` - åŸºç¡€æ£€ç´¢æµ‹è¯•
- âœ… `test_files_via_metadata_fuzzy_match` - æ¨¡ç³ŠåŒ¹é…æµ‹è¯•
- âœ… `test_files_via_metadata_multiple_files` - å¤šæ–‡ä»¶åŒ¹é…æµ‹è¯•
- âœ… `test_files_via_metadata_no_matching_files` - æ— åŒ¹é…æ–‡ä»¶è¾¹ç•Œæµ‹è¯•

**Mock ç­–ç•¥**ï¼š
- Mock `IndexManager._get_vector_ids_by_metadata()` è¿”å›æ¨¡æ‹Ÿå‘é‡ID
- Mock ChromaDB `where` æŸ¥è¯¢ç»“æœ

#### 3. å·¥å…·å‡½æ•°æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_group_nodes_by_file` - æ–‡ä»¶åˆ†ç»„æµ‹è¯•
- âœ… `test_calculate_file_score` - æ–‡ä»¶åˆ†æ•°è®¡ç®—æµ‹è¯•
- âœ… `test_aggregate_file_chunks` - chunk èšåˆæµ‹è¯•

### é›†æˆæµ‹è¯•è¦ç‚¹

#### 1. QueryRouter é›†æˆæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_router_files_via_content` - è·¯ç”±åˆ° files_via_content
- âœ… `test_router_files_via_metadata` - è·¯ç”±åˆ° files_via_metadata
- âœ… `test_router_auto_routing_wide_query` - å®½æ³›æŸ¥è¯¢è‡ªåŠ¨è·¯ç”±
- âœ… `test_router_auto_routing_file_query` - æ–‡ä»¶åæŸ¥è¯¢è‡ªåŠ¨è·¯ç”±
- âœ… `test_router_fallback_to_chunk` - é™çº§åˆ° chunk æ£€ç´¢

#### 2. ç«¯åˆ°ç«¯æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_end_to_end_files_via_content` - å®Œæ•´æŸ¥è¯¢æµç¨‹ï¼ˆfiles_via_contentï¼‰
- âœ… `test_end_to_end_files_via_metadata` - å®Œæ•´æŸ¥è¯¢æµç¨‹ï¼ˆfiles_via_metadataï¼‰
- âœ… `test_end_to_end_performance` - æ€§èƒ½æµ‹è¯•ï¼ˆå“åº”æ—¶é—´ï¼‰

#### 3. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
- âœ… `test_empty_index` - ç©ºç´¢å¼•æµ‹è¯•
- âœ… `test_single_file_index` - å•æ–‡ä»¶ç´¢å¼•æµ‹è¯•
- âœ… `test_large_file_index` - å¤§æ–‡ä»¶ç´¢å¼•æµ‹è¯•ï¼ˆæ€§èƒ½ï¼‰
- âœ… `test_malformed_query` - å¼‚å¸¸æŸ¥è¯¢æµ‹è¯•

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**: â‰¥ 80%
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡**: æ ¸å¿ƒæµç¨‹ 100%
- **è¾¹ç•Œæ¡ä»¶è¦†ç›–ç‡**: ä¸»è¦è¾¹ç•Œæ¡ä»¶ 100%

---

## ğŸ¯ å…³é”®æŠ€æœ¯å†³ç­–ç‚¹

### å†³ç­–ç‚¹ 1: æ–‡ä»¶çº§åˆ«è¯­ä¹‰æ£€ç´¢çš„å®ç°æ–¹å¼

**é€‰é¡¹ A**: ä½¿ç”¨æ–‡æ¡£æ‘˜è¦å‘é‡ç´¢å¼•ï¼ˆéœ€è¦é¢å¤–ç´¢å¼•ï¼‰
**é€‰é¡¹ B**: ä½¿ç”¨ç°æœ‰ chunk ç´¢å¼• + æ–‡ä»¶åˆ†ç»„ï¼ˆæ¨èï¼‰

**é€‰æ‹©**: é€‰é¡¹ B
**ç†ç”±**: 
- ä¸éœ€è¦é‡æ–°æ„å»ºç´¢å¼•
- å®ç°ç®€å•ï¼Œæ€§èƒ½å¯æ¥å—
- å¯ä»¥å¤ç”¨ç°æœ‰å‘é‡ç´¢å¼•

### å†³ç­–ç‚¹ 2: æ–‡ä»¶åˆ†æ•°è®¡ç®—æ–¹å¼

**é€‰é¡¹ A**: æ–‡ä»¶åˆ†æ•° = è¯¥æ–‡ä»¶æ‰€æœ‰ chunks çš„å¹³å‡åˆ†æ•°
**é€‰é¡¹ B**: æ–‡ä»¶åˆ†æ•° = è¯¥æ–‡ä»¶ top_k chunks çš„å¹³å‡åˆ†æ•°ï¼ˆæ¨èï¼‰

**é€‰æ‹©**: é€‰é¡¹ B
**ç†ç”±**:
- æ›´èƒ½åæ˜ æ–‡ä»¶çš„ç›¸å…³æ€§
- é¿å…å•ä¸ªæ— å…³ chunk æ‹‰ä½æ–‡ä»¶åˆ†æ•°

### å†³ç­–ç‚¹ 3: æ–‡ä»¶ååŒ¹é…çš„æ¨¡ç³Šåº¦

**é€‰é¡¹ A**: ç²¾ç¡®åŒ¹é…ï¼ˆä¸¥æ ¼ï¼‰
**é€‰é¡¹ B**: æ¨¡ç³ŠåŒ¹é…ï¼ˆæ¨èï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼‰

**é€‰æ‹©**: é€‰é¡¹ B
**ç†ç”±**:
- ç”¨æˆ·ä½“éªŒæ›´å¥½
- æ”¯æŒ "ç³»ç»Ÿç§‘å­¦" åŒ¹é… "ç³»ç»Ÿç§‘å­¦.md"

---

## âš ï¸ æ½œåœ¨é—®é¢˜ä¸é£é™©

### 1. æ€§èƒ½é—®é¢˜
- **é£é™©**: æ–‡ä»¶çº§åˆ«æ£€ç´¢éœ€è¦ä¸¤æ¬¡æ£€ç´¢ï¼ˆæ–‡ä»¶ + chunksï¼‰ï¼Œå¯èƒ½æ¯” chunk æ£€ç´¢æ…¢
- **ç¼“è§£**: 
  - ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼ˆæ£€ç´¢å™¨å®ä¾‹ç¼“å­˜ï¼‰
  - é™åˆ¶æ–‡ä»¶æ•°é‡ï¼ˆtop_k_filesï¼‰
  - å¼‚æ­¥å¹¶è¡Œæ£€ç´¢ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### 2. ç»“æœæ•°é‡é—®é¢˜
- **é£é™©**: ä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ª chunksï¼Œè¿”å›ç»“æœå¯èƒ½è¾ƒå¤š
- **ç¼“è§£**:
  - æ¯ä¸ªæ–‡ä»¶é™åˆ¶ top_k ä¸ª chunks
  - æœ€ç»ˆç»“æœé™åˆ¶æ€»æ•°é‡

### 3. å…ƒæ•°æ®åŒ¹é…å‡†ç¡®æ€§
- **é£é™©**: æ–‡ä»¶åæå–å¯èƒ½ä¸å‡†ç¡®
- **ç¼“è§£**:
  - æ”¯æŒå¤šç§æ–‡ä»¶åæ ¼å¼ï¼ˆxxx.mdã€xxxæ–‡ä»¶ã€xxxæ–‡æ¡£ï¼‰
  - æä¾›é™çº§ç­–ç•¥ï¼ˆåŒ¹é…å¤±è´¥æ—¶é™çº§åˆ° chunk æ£€ç´¢ï¼‰

---

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

### ä»£ç å®ç°å‰
- [ ] ç¡®è®¤æ–¹æ¡ˆç†è§£æ— è¯¯
- [ ] ç¡®è®¤æŠ€æœ¯é€‰å‹åˆç†
- [ ] ç¡®è®¤ä¾èµ–å…³ç³»æ¸…æ™°

### ä»£ç å®ç°ä¸­
- [ ] Step 1: åˆ›å»ºæ–‡ä»¶çº§åˆ«æ£€ç´¢å™¨åŸºç±»
- [ ] Step 2: å®ç° FilesViaContentRetriever
- [ ] Step 3: å®ç° FilesViaMetadataRetriever
- [ ] Step 4: é›†æˆåˆ° QueryRouter
- [ ] Step 5: ç¼–å†™æµ‹è¯•

### ä»£ç å®ç°å
- [ ] è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆpytest tests/unit/test_file_level_retrievers.pyï¼‰
- [ ] è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆpytest tests/integration/test_file_level_retrieval_integration.pyï¼‰
- [ ] éªŒè¯æ—¥å¿—è¾“å‡ºï¼ˆæ— è­¦å‘Šæ—¥å¿—ï¼‰
- [ ] éªŒè¯ç«¯åˆ°ç«¯æŸ¥è¯¢æµç¨‹
- [ ] æ›´æ–°æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

### ä»£ç å‚è€ƒ
- `src/retrievers/grep_retriever.py` - æ£€ç´¢å™¨æ¥å£è®¾è®¡
- `src/indexer.py` - `_get_vector_ids_by_metadata()` æ–¹æ³•
- `src/routers/query_router.py` - è·¯ç”±é€»è¾‘

### æ–‡æ¡£å‚è€ƒ
- `docs/RETRIEVAL_STRATEGY_FLOW.md` - æ£€ç´¢ç­–ç•¥æµç¨‹
- `docs/ARCHITECTURE.md` - æ¶æ„è®¾è®¡

---

**æœ€åæ›´æ–°**: 2025-11-04  
**æ–¹æ¡ˆçŠ¶æ€**: âœ… å¾…ç¡®è®¤

