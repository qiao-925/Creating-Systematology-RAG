# 模块化RAG架构规划 - 核心思路总结

> **创建时间**: 2025-11-01  
> **文档类型**: 设计文档  
> **状态**: 核心思路确立

---

## 一、整体架构思路

### 三层架构 + 渐进式迁移

```
前端层 → 业务层 → 基础设施层
  ↓        ↓         ↓
解耦     模块化    可插拔
```

**核心要点**：
- **分层职责清晰**：前端只做交互，业务层负责逻辑，基础设施层提供资源
- **渐进式迁移**：P0→P1→P2→P3，分阶段实施，降低风险
- **向后兼容**：旧接口保留，新旧并存，平滑升级

---

## 二、检索策略核心思路

### 从单一策略到多策略融合

#### 1. 传统Top-k检索（已完成）

**思路**：向量相似度搜索，语义匹配

**适用场景**：
- 语义理解
- 概念查询
- 抽象问题

#### 2. 自动路由模式（新增）

**思路**：轻量级Agent分析查询意图，智能选择检索方式

**决策逻辑**：
- `chunk`模式：精确信息查询
- `files_via_content`模式：宽泛主题查询
- `files_via_metadata`模式：文件名查询

**价值**：提升检索精准度

#### 3. Grep文本检索（新增）

**思路**：借鉴Cursor Cloud方案，直接文件系统搜索，无需预索引

**核心优势**：
- ✅ **实时搜索**：无需预处理和索引
- ✅ **精确匹配**：支持正则表达式
- ✅ **零延迟**：无索引延迟
- ✅ **低成本**：不需要向量化

**适用场景**：
- 精确关键词搜索（函数名、类名、术语）
- 文件名/路径查找
- 代码库搜索
- 结构化数据查询（表格、列表）

#### 4. 多策略并行检索（新增）

**思路**：并行执行多种检索策略，然后合并结果

**策略组合**：
```
VectorRetriever（语义） + BM25Retriever（关键词） + GrepRetriever（精确匹配）
```

**合并方式**：
- **Reciprocal Rank Fusion (RRF)**：倒数排名融合，业界标准
- **Weighted Score Fusion**：加权分数融合，可自定义权重
- **去重**：避免重复结果

---

## 三、模块化设计核心思路

### 统一的可插拔架构

所有模块遵循相同的设计模式：

```
抽象基类（BaseXXX）
    ↓
具体实现（LocalXXX, APIXXX）
    ↓
工厂函数（create_xxx）
    ↓
管理器/协调器（XXXManager）
```

**已实现模块**：
- ✅ Embedding层：BaseEmbedding → LocalEmbedding / APIEmbedding
- ✅ Observer层：BaseObserver → PhoenixObserver / LlamaDebugObserver
- ✅ Retriever层：Vector / BM25 / Hybrid（在ModularQueryEngine中）

**待实施模块**：
- 📋 Reranker层：BaseReranker → BGEReranker / SentenceTransformerReranker
- ✨ Router层：QueryRouter（自动路由）
- ✨ MultiStrategy层：MultiStrategyRetriever + ResultMerger

---

## 四、多策略检索核心思路

### 策略模式 + 结果合并

#### 1. 策略模式（Strategy Pattern）

```
BaseRetriever（抽象）
    ├─ VectorRetriever（语义检索）
    ├─ BM25Retriever（关键词检索）
    ├─ GrepRetriever（文本搜索）✨
    └─ HybridRetriever（混合检索）
```

#### 2. 并行执行

```
查询
  ↓
并行执行
  ├─ VectorRetriever.retrieve() ──┐
  ├─ BM25Retriever.retrieve() ────┤
  ├─ GrepRetriever.retrieve() ────┤
  └─ HybridRetriever.retrieve() ───┘
  ↓
结果合并（ResultMerger）
  ├─ 去重
  ├─ RRF融合
  └─ 重排序
  ↓
返回Top-K
```

#### 3. 结果合并算法

**Reciprocal Rank Fusion (RRF)**：
```
RRF_score = Σ(weight / (k + rank))
```

- k = 60（常数）
- rank = 排名（从1开始）
- weight = 检索器权重

**优势**：
- ✅ 无需调优分数权重
- ✅ 多策略结果自然融合
- ✅ 业界标准算法

---

## 五、Grep检索核心思路

### 文件系统直接访问 + 实时搜索

```
用户查询（关键词/正则）
    ↓
GrepRetriever
    ├─ 构建grep命令（支持正则）
    ├─ 执行文件系统搜索
    ├─ 解析结果（文件路径、行号、内容）
    ├─ 计算相关性分数（基于匹配次数）
    └─ 转换为NodeWithScore格式
    ↓
返回结果（与向量检索结果格式一致）
```

**关键特点**：
- ✅ **无需预处理**：直接搜索文件系统
- ✅ **实时性**：零索引延迟
- ✅ **精确匹配**：支持正则表达式
- ✅ **完整上下文**：可以返回完整文件，而非碎片

---

## 六、迁移策略核心思路

### 分阶段 + 等待代码拆分

#### 阶段0：等待代码拆分（当前）

- ⏸️ 等待300行规则拆分完成
- 📋 评估拆分后的文件结构
- 🔄 调整迁移计划（如有必要）

#### 阶段1：独立模块实施（可并行）

- Reranker模块（~3h）
- Grep检索器（~4h）
- 多策略检索框架（~5h）
- 自动路由模式（~4h）
- RAGAS评估器（~3h）

**思路**：这些模块独立，不依赖架构迁移，可以立即实施

#### 阶段2-5：架构迁移（P0-P3）

- P0：统一服务接口（RAGService）
- P1：流水线编排（PipelineExecutor）
- P2：模块注册中心（ModuleRegistry）
- P3：事件钩子与策略治理（可选）

**思路**：依赖关系明确，分阶段实施，每阶段可验证

---

## 七、关键技术思路

### 1. 统一接口抽象

**所有检索器统一接口**：
```python
class BaseRetriever:
    def retrieve(query: str, top_k: int) -> List[NodeWithScore]:
        pass
```

**好处**：
- ✅ 可插拔：轻松替换检索器
- ✅ 可组合：多策略并行执行
- ✅ 可测试：统一接口便于Mock

### 2. 配置驱动

**环境变量控制**：
```python
ENABLED_RETRIEVAL_STRATEGIES = "vector,bm25,grep"
MERGE_STRATEGY = "reciprocal_rank_fusion"
RETRIEVER_WEIGHTS = '{"vector": 1.0, "bm25": 0.8, "grep": 0.6}'
```

**好处**：
- ✅ 无需修改代码
- ✅ 运行时切换策略
- ✅ 支持A/B测试

### 3. 结果去重与融合

**去重策略**：
- 基于节点内容hash
- 保留最高分数节点

**融合策略**：
- RRF（默认）：无需调优
- 加权融合：可自定义权重

---

## 八、价值与优势

### 1. 检索全面性提升

**多策略覆盖**：
- 向量检索：语义理解
- BM25：关键词匹配
- Grep：精确文本搜索

**互补优势**：
- ✅ 向量检索可能遗漏精确关键词 → Grep可以弥补
- ✅ Grep无法理解语义 → 向量检索可以补充
- ✅ 多策略融合 → 获得最佳效果

### 2. 灵活性提升

**可配置的策略组合**：
```
场景1：精确搜索 → 只启用Grep
场景2：语义理解 → 只启用Vector
场景3：全面检索 → 启用所有策略
```

### 3. 性能优化

**并行执行**：
- ✅ 多种检索策略并行，不串行等待
- ✅ 总延迟 = max(各策略延迟)

**智能路由**：
- ✅ 自动路由模式根据查询选择最优策略
- ✅ 避免不必要的计算

---

## 九、实施优先级

### 高优先级（立即实施）

1. **Grep检索器**（~4h）- 新能力，价值高
2. **多策略检索框架**（~5h）- 核心架构
3. **Reranker模块**（~3h）- 设计已完成
4. **自动路由模式**（~4h）- 智能化提升

### 中优先级（近期实施）

5. **RAGAS评估器**（~3h）- 评估能力
6. **P0迁移**（4-6h）- 架构基础

### 低优先级（后续实施）

7. **P1-P3迁移**（28-36h）- 完整架构

---

## 十、核心设计原则

1. **可插拔**：模块可替换、可组合
2. **配置驱动**：通过配置控制行为
3. **向后兼容**：不破坏现有功能
4. **渐进式**：分阶段实施，风险可控
5. **统一接口**：相同功能使用相同API
6. **策略模式**：多策略可并行、可融合

---

## 十一、总结

### 核心思路一句话

> 通过模块化设计、多策略检索融合、智能路由和渐进式迁移，构建一个灵活、可扩展、高性能的RAG系统，从传统的Top-k检索演进到智能多策略检索架构。

### 关键创新点

1. **Grep检索器**：文件系统直接访问，无需预索引
2. **多策略并行**：向量+BM25+Grep同时执行，融合结果
3. **自动路由**：智能选择检索策略
4. **统一架构**：所有模块遵循相同的可插拔模式

### 架构演进路径

```
Phase 1: Top-k检索（当前）
    ↓
Phase 2: 自动路由 + 多策略检索（目标）
    ↓
Phase 3: 完整模块化三层架构（未来）
```

---

**文档创建时间**: 2025-11-01  
**状态**: ✅ 核心思路确立  
**下一步**: 开始实施独立模块（阶段1）

