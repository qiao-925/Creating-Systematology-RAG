# 2025-11-01 【plan】模块化顶层设计 - 实施方案

****【Task Type】**: plan

**日期**: 2025-11-01  
**任务编号**: #2  
**文档类型**: 实施方案

---

## 1. 任务背景
- 现有 `src/` 目录已具备初步分层，但 UI、检索链路、兜底策略、可观测性仍相互耦合，缺少统一的顶层规划。
- 目标是共创一份“模块化顶层设计”，确立未来演进时的架构蓝图，支撑后续 Agentic、闭环优化等能力。

## 2. 设计目标
- 明确三层职责：前端层（用户交互）、业务层（核心逻辑）、基础设施层（技术支撑）。
- 定义统一接口契约，使检索器、生成器、格式化器等业务模块具备可替换性。
- 引入模块注册中心，实现模块可插拔、版本化管理和运行期策略切换。
- 为可观测性、策略自适应等高级能力预留标准挂载点。

## 3. 分层设计（三层架构）

### 3.1 前端层（Presentation Layer）
**职责**：用户交互与展示，不包含业务逻辑

**组成**：
- `app.py` - Streamlit Web 主界面
- `pages/` - Streamlit 多页面（设置页等）
- `main.py` - CLI 命令行工具
- `src/ui_components.py` - UI 复用组件

**交互方式**：
- 前端层只调用业务层提供的统一服务接口（如 `RAGService.query()`）
- 不直接操作基础设施层（如向量库、LLM 客户端）
- 不持有业务模块实例，仅传递用户输入和展示返回结果

**原则**：
- 前端层专注于用户交互、状态管理（如 Streamlit session_state）、展示格式化
- 所有业务逻辑下沉到业务层

---

### 3.2 业务层（Business Layer）
**职责**：核心业务逻辑、模块编排、策略管理

**组成**：

**3.2.1 能力模块（Capability Modules）**
- `Retriever` - 向量检索模块
- `Ranker` - 重排序模块（可选）
- `Generator` - 答案生成模块
- `Formatter` - 响应格式化模块
- `FallbackStrategy` - 兜底策略模块
- `Evaluator` - 质量评估模块（可选）
- `DataSource` - 数据源适配模块

**3.2.2 编排服务（Orchestration Services）**
- `PipelineExecutor` - 流水线执行器（组装能力模块）
- `RAGService` - RAG 查询服务（对外统一接口）
- `ContextManager` - 上下文管理（在步骤间传递状态）
- `ErrorHandler` - 错误处理与回退策略

**交互方式**：
- 业务层通过依赖注入从基础设施层获取资源（向量库连接、LLM 客户端、配置、模块注册中心等）
- 能力模块通过统一协议接口协作，禁止直接实例化其他模块
- 编排服务负责组装能力模块，按配置执行流水线
- 模块实例通过基础设施层的 `ModuleRegistry` 创建

**原则**：
- 所有业务能力必须遵守统一接口契约（Protocol/ABC）
- 模块间通过编排层传递上下文，而非直接调用
- 支持配置驱动的模块装配和策略切换

---

### 3.3 基础设施层（Infrastructure Layer）
**职责**：技术基础设施，无业务逻辑

**组成**：

**3.3.1 基础服务**
- `config.py` - 配置管理（环境变量、参数读取）
- `logger.py` - 日志系统（结构化日志）
- `cache_manager.py` - 缓存管理（文件缓存、内存缓存）
- `phoenix_utils.py` - 可观测性适配器（Phoenix、OpenTelemetry）

**3.3.2 外部服务客户端**
- 向量数据库客户端（Chroma）
- LLM 客户端（DeepSeek）
- 文件系统操作、Git 操作等底层工具

**3.3.3 模块注册中心（Module Registry）**
- `ModuleRegistry` - 模块注册表（维护模块元数据、工厂函数）
- `ModuleFactory` - 模块工厂（根据配置创建模块实例）
- **说明**：模块注册是框架能力，属于技术基础设施，不属于业务逻辑

**交互方式**：
- 基础设施层向上提供统一的服务接口（如 `get_vector_store()`, `get_llm_client()`, `get_module_registry()`）
- 不依赖业务层和前端层
- 通过依赖注入容器向业务层提供资源实例
- 模块注册中心提供模块创建能力，业务层通过注册中心获取模块实例

**原则**：
- 基础设施层保持纯净，不包含任何业务逻辑
- 所有技术细节（如向量库选择、LLM 切换、模块注册）封装在此层
- 提供统一的资源生命周期管理

## 4. 统一接口契约设计

### 4.1 业务层服务接口（对外）
**位置**：业务层 → 前端层

**统一服务接口**：
```python
class RAGService:
    """RAG 查询服务 - 前端层调用的统一接口"""
    def query(self, question: str, user_id: str, session_id: str) -> RAGResponse:
        """执行 RAG 查询，返回答案和引用来源"""
        pass
    
    def build_index(self, source: DataSource, collection_name: str) -> IndexResult:
        """构建索引"""
        pass
```

**数据结构**：
- `RAGResponse`: 包含 `answer`, `sources`, `trace_info` 等
- 前端层只需了解这些数据结构，不关心内部实现

---

### 4.2 能力模块协议（对内）
**位置**：业务层内部模块间

**核心协议定义**（使用 Python `Protocol` 或 `ABC`）：

```python
# 检索器协议
class RetrieverProtocol(Protocol):
    def retrieve(self, query: Query, context: PipelineContext) -> RetrievalResult:
        """检索相关文档片段"""
        pass

# 生成器协议
class GeneratorProtocol(Protocol):
    def generate(self, prompt: Prompt, context: PipelineContext) -> GenerationResult:
        """生成答案"""
        pass

# 格式化器协议
class FormatterProtocol(Protocol):
    def format(self, answer: GenerationResult, sources: List[Source]) -> str:
        """格式化输出"""
        pass

# 兜底策略协议
class FallbackStrategyProtocol(Protocol):
    def should_trigger(self, context: PipelineContext) -> bool:
        """判断是否触发兜底"""
        pass
    
    def produce_answer(self, query: Query, context: PipelineContext) -> GenerationResult:
        """生成兜底答案"""
        pass
```

**统一数据结构**（采用 `TypedDict` 或 `pydantic`）：
- `Query`: 用户查询（文本、元数据）
- `PipelineContext`: 流水线上下文（检索结果、中间状态、追踪信息）
- `RetrievalResult`: 检索结果（chunks、scores、metadata）
- `GenerationResult`: 生成结果（answer、metadata）
- `Source`: 引用来源（text、metadata、score）

**依赖注入原则**：
- 所有能力模块通过构造函数接收基础设施层资源（向量库、LLM、配置）
- 禁止在模块内部直接读取全局 `config` 或实例化其他模块
- 编排服务负责构建 `PipelineContext`，在步骤间传递

## 5. 模块注册与可插拔

### 5.1 模块注册中心（基础设施层）
**位置**：基础设施层 → `ModuleRegistry`

**说明**：模块注册中心属于框架能力，放在基础设施层更合理，业务层通过依赖注入获取注册中心实例。

**模块元数据结构**：
```python
@dataclass
class ModuleMetadata:
    id: str                    # 模块唯一标识，如 "chroma_retriever"
    type: str                  # 模块类型，如 "retriever", "generator"
    version: str               # 版本号，如 "v1", "v2"
    factory: Callable          # 工厂函数，用于创建模块实例
    dependencies: List[str]    # 依赖的其他模块ID
    capabilities: Dict         # 能力标签，如 {"supports_streaming": True}
    description: str           # 模块描述
```

**注册中心 API**：
```python
class ModuleRegistry:
    def register(self, metadata: ModuleMetadata) -> None:
        """注册模块"""
        pass
    
    def get(self, module_id: str, version: str = None) -> ModuleMetadata:
        """获取模块元数据"""
        pass
    
    def list_by_type(self, module_type: str) -> List[ModuleMetadata]:
        """按类型列出模块"""
        pass
    
    def create_instance(self, module_id: str, dependencies: Dict) -> Any:
        """创建模块实例（通过工厂函数）"""
        pass
```

---

### 5.2 配置驱动（Pipeline 配置）
**位置**：业务层 → `PipelineExecutor` 读取配置

**流水线配置文件示例**（YAML）：
```yaml
# config/pipelines/default_rag.yaml
pipeline:
  name: default_rag
  version: v1
  steps:
    - type: retriever
      module: chroma_retriever@v1
      config:
        similarity_top_k: 3
        threshold: 0.6
    
    - type: generator
      module: deepseek_generator@v2
      config:
        temperature: 0.5
        max_tokens: 4096
    
    - type: formatter
      module: markdown_formatter@v1
    
    - type: fallback
      module: general_definition_fallback@v1
      condition: "retrieval.max_score < 0.6"
```

**编排服务执行流程**：
1. `PipelineExecutor` 读取 YAML 配置
2. 解析每个步骤的 `module` 字段（如 `chroma_retriever@v1`）
3. 向 `ModuleRegistry` 请求对应模块元数据
4. 调用 `ModuleFactory.create_instance()` 创建模块实例
5. 按顺序执行流水线，传递 `PipelineContext`

---

### 5.3 可插拔机制
**运行时切换**：
- 前端层通过业务层 API 动态切换策略（如 A/B 测试）
- `RAGService` 支持传入 `pipeline_name` 参数选择不同流水线
- 模块注册中心支持热加载新模块（无需重启）

**版本管理**：
- 同一模块可注册多个版本（如 `chroma_retriever@v1`, `chroma_retriever@v2`）
- 配置文件中指定版本，支持版本回滚
- 注册中心校验依赖兼容性（如 v2 依赖的向量库版本）

**模块隔离**：
- 每个模块实例独立，互不干扰
- 通过依赖注入获取基础设施层资源，不共享状态
- 支持模块级别的单元测试

## 6. 可观测性与事件钩子

### 6.1 事件钩子（业务层编排服务）
**位置**：业务层 → `PipelineExecutor` 提供事件钩子

**事件类型**：
```python
class PipelineEvent:
    BEFORE_STEP = "before_step"      # 步骤执行前
    AFTER_STEP = "after_step"        # 步骤执行后
    ON_ERROR = "on_error"            # 发生错误
    ON_FALLBACK = "on_fallback"      # 触发兜底策略
    PIPELINE_START = "pipeline_start" # 流水线开始
    PIPELINE_END = "pipeline_end"     # 流水线结束
```

**事件数据结构**：
```python
@dataclass
class PipelineEventData:
    event_type: str
    step_name: str
    context: PipelineContext
    timestamp: float
    metadata: Dict
```

**编排服务集成**：
```python
class PipelineExecutor:
    def __init__(self, observers: List[EventObserver]):
        self.observers = observers  # 基础设施层的可观测性适配器
    
    def _emit_event(self, event: PipelineEventData):
        """发送事件给所有观察者"""
        for observer in self.observers:
            observer.on_event(event)
```

---

### 6.2 可观测性适配器（基础设施层）
**位置**：基础设施层 → `phoenix_utils.py`, `logger.py`

**职责**：
- 订阅业务层的事件钩子
- 将事件转换为结构化日志、指标、trace
- 与 Phoenix、OpenTelemetry 等外部工具对接

**实现示例**：
```python
class PhoenixObserver(EventObserver):
    """Phoenix 可观测性适配器"""
    def on_event(self, event: PipelineEventData):
        # 发送 trace 到 Phoenix
        # 记录指标（耗时、错误率等）
        pass

class StructuredLoggerObserver(EventObserver):
    """结构化日志适配器"""
    def on_event(self, event: PipelineEventData):
        # 输出结构化日志（JSON 格式）
        pass
```

**集成方式**：
- 在业务层 `PipelineExecutor` 初始化时，注入基础设施层的观察者
- 基础设施层通过依赖注入提供观察者实例，业务层不关心具体实现

---

### 6.3 策略治理（业务层）
**位置**：业务层 → 基于模块注册中心

**功能**：
- 记录每次流水线执行使用的模块版本
- 收集性能指标（通过可观测性适配器）
- 支持 A/B 测试：同时运行多个 pipeline 配置，对比效果
- 提供策略切换 API（前端层可调用）

**实现**：
- `StrategyManager` 维护策略配置（哪些 pipeline 启用、A/B 分配比例）
- 与 `ModuleRegistry` 协作，跟踪模块版本使用情况
- 通过事件钩子收集执行指标，支撑决策

## 7. 渐进式落地路线

### 阶段 1：接口契约定义（业务层）
**目标**：建立统一接口契约，明确模块间协作方式

**任务**：
1. 定义能力模块协议（`RetrieverProtocol`, `GeneratorProtocol`, `FormatterProtocol`, `FallbackStrategyProtocol`）
2. 定义统一数据结构（`Query`, `PipelineContext`, `RetrievalResult`, `GenerationResult`）
3. 将现有 `QueryEngine`、`HybridQueryEngine` 拆分为协议 + 默认实现
4. 提取 `response_formatter` 为符合 `FormatterProtocol` 的实现

**产出**：
- `src/business/protocols.py` - 所有协议定义
- `src/business/models.py` - 统一数据结构

---

### 阶段 2：业务层服务接口（前端层 → 业务层）
**目标**：前端层通过统一服务接口调用业务逻辑

**任务**：
1. 创建 `RAGService` 统一服务接口
2. 实现 `PipelineExecutor` 最小版本（顺序执行：检索 → 生成 → 格式化）
3. 重构 `app.py`、`main.py`，移除直接调用 `QueryEngine` 的代码
4. 前端层只调用 `RAGService.query()`，不持有业务模块实例

**产出**：
- `src/business/services/rag_service.py` - RAG 服务接口
- `src/business/services/pipeline_executor.py` - 流水线执行器
- 前端层代码简化，职责清晰

---

### 阶段 3：模块注册中心（基础设施层）
**目标**：实现模块可插拔机制

**任务**：
1. 在基础设施层实现 `ModuleRegistry` 和 `ModuleFactory`
2. 为现有模块（检索器、生成器、格式化器、兜底策略）注册元数据
3. 支持 YAML 配置文件定义流水线
4. `PipelineExecutor` 通过依赖注入获取注册中心，从注册中心加载模块实例

**产出**：
- `src/infrastructure/registry/module_registry.py` - 模块注册中心（基础设施层）
- `config/pipelines/default_rag.yaml` - 流水线配置示例
- 新增模块可通过注册中心挂载，无需修改编排代码

---

### 阶段 4：事件钩子与可观测性（业务层 ↔ 基础设施层）
**目标**：统一可观测性接入方式

**任务**：
1. `PipelineExecutor` 实现事件钩子（`before_step`, `after_step`, `on_error`）
2. 基础设施层实现 `PhoenixObserver`、`StructuredLoggerObserver`
3. 替换散落的 `print` 语句，统一通过事件钩子输出
4. 基础设施层通过依赖注入向业务层提供观察者

**产出**：
- 所有执行步骤可通过 Phoenix 可视化追踪
- 结构化日志统一输出
- 业务层与基础设施层解耦

---

### 阶段 5：策略治理（业务层）
**目标**：支持策略切换和 A/B 测试

**任务**：
1. 实现 `StrategyManager`，维护策略配置
2. `RAGService` 支持传入 `pipeline_name` 参数
3. 前端层提供策略切换 UI（设置页）
4. 记录模块版本使用情况和性能指标

**产出**：
- 支持运行时切换策略
- 支持 A/B 测试
- 策略决策记录在 `DECISIONS.md`

## 8. 分层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层（Presentation）                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  app.py      │  │  pages/      │  │  main.py     │     │
│  │ (Streamlit)  │  │ (设置页)     │  │ (CLI)        │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           │                                │
│                   只调用 RAGService                         │
└───────────────────────────┼────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   业务层（Business）                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │          RAGService (统一服务接口)                    │  │
│  │  query(question) -> RAGResponse                      │  │
│  └───────────────────┬──────────────────────────────────┘  │
│                      │                                      │
│         ┌────────────┼────────────┐                        │
│         ▼            ▼            ▼                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │Pipeline  │  │Strategy  │  │Context   │                │
│  │Executor  │  │Manager   │  │Manager   │                │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                │
│       │             │             │                        │
│       └─────────────┼─────────────┘                        │
│                     │                                      │
│  ┌──────────────────┼──────────────────┐                  │
│  │    能力模块（通过协议协作）            │                  │
│  │  Retriever → Generator → Formatter   │                  │
│  │  → FallbackStrategy                  │                  │
│  └──────────────────────────────────────┘                  │
│                                                             │
│  通过依赖注入获取基础设施层资源（含ModuleRegistry）           │
└───────────────────────────┬────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│               基础设施层（Infrastructure）                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ config   │  │ logger   │  │ Phoenix  │  │ Chroma   │  │
│  │ 配置管理  │  │ 日志系统  │  │ 可观测性  │  │ 向量库    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │ DeepSeek │  │ Cache    │  │Module    │                │
│  │ LLM客户端│  │ 缓存管理  │  │Registry  │                │
│  └──────────┘  └──────────┘  └──────────┘                │
│                                                             │
│  向上提供统一服务接口，无业务逻辑                            │
│  模块注册中心提供模块创建能力                                │
└─────────────────────────────────────────────────────────────┘
```

**依赖方向**：
- 前端层 → 业务层（调用服务接口）
- 业务层 → 基础设施层（通过依赖注入获取资源）
- 禁止反向依赖（基础设施层不依赖业务层和前端层）

---

## 9. 风险与待决事项

### 技术风险
- **协议设计**：需兼顾同步/异步流式场景，建议先覆盖同步链路，后续扩展异步能力
- **依赖注入**：初期可简化实现（构造函数注入），待复杂度提升再引入 DI 容器框架
- **模块注册中心**：初期可内存实现，待需求增长再引入持久化与权限管理

### 实施风险
- **重构影响**：现有 `QueryEngine`、`HybridQueryEngine` 需重构，可能影响现有功能
- **测试覆盖**：新架构需要补充单元测试和集成测试，确保重构后功能完整
- **文档同步**：需同步更新 `ARCHITECTURE.md`、`DECISIONS.md`，保持文档与实现一致

### 待决事项
- **Agentic RAG 集成**：未来与 Agentic RAG 结合时，需新增策略代理模块，届时再补充详细设计
- **流式响应**：当前设计以同步为主，流式响应需扩展 `GeneratorProtocol` 支持 `async generate_stream()`
- **配置管理**：流水线配置文件的版本管理和热重载机制需进一步细化

---

## 10. 验收指标

### 功能验收
- ✅ 至少有一个完整流水线通过业务层 `PipelineExecutor` 运行
- ✅ 前端层（`app.py`、`main.py`）全量迁移到 `RAGService` 接口，不再直接调用 `QueryEngine`
- ✅ 新增模块可通过 `ModuleRegistry` 挂载，无需修改编排代码

### 架构验收
- ✅ 三层职责清晰：前端层只负责交互，业务层包含所有业务逻辑，基础设施层无业务逻辑
- ✅ 模块间通过协议接口协作，禁止直接实例化其他模块
- ✅ 基础设施层通过依赖注入向业务层提供资源，业务层不直接读取全局 `config`

### 可观测性验收
- ✅ 所有执行步骤可通过 Phoenix 可视化追踪
- ✅ 结构化日志统一输出，替换散落的 `print` 语句
- ✅ 事件钩子正常工作，可观测性适配器能正确订阅事件

### 文档验收
- ✅ 设计与实施过程均记录在 `agent-task-log/`，便于后续复盘
- ✅ `ARCHITECTURE.md` 更新为三层架构说明
- ✅ `DECISIONS.md` 记录关键架构决策

---

**时间**：2025-11-01  
**状态**：设计阶段（待实施）


