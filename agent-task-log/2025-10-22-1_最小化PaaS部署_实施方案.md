# 最小化 PaaS 部署 - 实施方案

**任务时间**: 2025-10-22  
**任务类型**: 部署配置  
**完成状态**: ✅ 已完成

---

## 任务概述

为系统科学知识库 RAG 应用准备 Zeabur/Railway 部署配置，采用最简单可行方案，保留多用户认证功能，其他部分简化处理。

## 部署策略

### 核心原则

- **最小化复杂度**：快速上线收集反馈
- **数据暂不持久化**：重启后重建索引（演示阶段可接受）
- **Embedding 模型启动时下载**：首次启动约 5-10 分钟
- **环境变量通过平台 UI 配置**：简化部署流程
- **保留多用户认证**：JSON 文件存储（容器内）

### 预期结果

- ✅ 5 分钟内完成部署配置
- ✅ 单命令启动应用
- ✅ 国内访问友好（Zeabur 优先）

---

## 实施步骤

### 1. 创建 Dockerfile（容器化配置）

**文件路径**：`Dockerfile`

**关键配置**：
```dockerfile
# 基础镜像
FROM python:3.12-slim

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

# 安装 uv（快速依赖安装）
RUN pip install uv

# 工作目录
WORKDIR /app

# 复制依赖文件
COPY pyproject.toml .

# 安装 Python 依赖（使用 uv 加速）
RUN uv pip install --system -r pyproject.toml

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8501

# 启动命令
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

**设计要点**：
- 使用 Python 3.12 slim 镜像（体积小）
- 安装 git（GitHub 数据源需要）
- 使用 uv 加速依赖安装
- Streamlit 配置为监听所有地址（容器环境必需）

---

### 2. 创建 .dockerignore（优化镜像体积）

**文件路径**：`.dockerignore`

**排除内容**：
```
# Python 缓存
__pycache__/
*.py[cod]
*.pyc

# 虚拟环境
venv/
.venv/
ENV/
env/

# 测试和覆盖率
.pytest_cache/
.coverage
htmlcov/
tests/

# 本地数据（不打包到镜像）
vector_store/
sessions/
data/processed/
data/users.json
data/github_metadata.json
data/github_repos/

# 日志
*.log
logs/

# IDE 和 Git
.git/
.idea/
.vscode/
*.swp

# 环境变量（敏感信息）
.env

# 文档和任务日志
docs/
agent-task-log/
README.md
*.md

# 其他
.DS_Store
Thumbs.db
```

**原因**：减少镜像体积，排除敏感信息和不必要文件

---

### 3. 创建 Zeabur 配置文件

**文件路径**：`zeabur.json`

**配置内容**：
```json
{
  "name": "systematology-rag",
  "build": {
    "dockerfile": "Dockerfile"
  },
  "env": {
    "DEEPSEEK_API_KEY": {
      "description": "DeepSeek API 密钥",
      "required": true
    },
    "EMBEDDING_MODEL": {
      "default": "BAAI/bge-base-zh-v1.5"
    },
    "HF_ENDPOINT": {
      "default": "https://hf-mirror.com"
    },
    "APP_PORT": {
      "default": "8501"
    }
  },
  "ports": [
    {
      "port": 8501,
      "protocol": "http"
    }
  ]
}
```

**说明**：
- 指定 Dockerfile 构建方式
- 预定义环境变量（API 密钥必填，其他有默认值）
- 声明服务端口 8501

---

### 4. 创建 Railway 配置文件

**文件路径**：`railway.toml`

**配置内容**：
```toml
[build]
builder = "dockerfile"
dockerfilePath = "Dockerfile"

[deploy]
startCommand = "streamlit run app.py --server.port=8501 --server.address=0.0.0.0"
healthcheckPath = "/"
healthcheckTimeout = 100
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
```

**说明**：
- 使用 Dockerfile 构建
- 设置健康检查（Railway 特性）
- 配置重启策略（失败时重试最多 3 次）

---

### 5. 优化 pyproject.toml（可选）

**检查项**：
- ✅ 所有运行时依赖已声明
- ✅ 测试依赖在 `[project.optional-dependencies.test]` 中
- ✅ 没有本地路径依赖

**结论**：当前依赖已完善，无需修改。

---

### 6. 创建部署文档

**文件路径**：`docs/DEPLOYMENT.md`

**内容大纲**：
- Zeabur 部署步骤（推荐，国内友好）
- Railway 部署步骤（备选）
- 环境变量说明
- 注意事项和成本预估
- 后续优化方向

---

### 7. 更新 README.md

**修改位置**：在"快速开始"后添加"在线部署"章节

**新增内容**：
- Zeabur 一键部署按钮
- Railway 一键部署按钮
- 部署注意事项

---

### 8. 创建本地测试脚本（可选）

**文件路径**：`scripts/docker-run.sh`

**用途**：本地快速测试 Docker 镜像

---

## 文件清单

需要创建/修改的文件：

- [x] `Dockerfile` - 容器配置
- [x] `.dockerignore` - 镜像排除规则
- [x] `zeabur.json` - Zeabur 配置
- [x] `railway.toml` - Railway 配置
- [x] `docs/DEPLOYMENT.md` - 部署文档
- [x] `README.md` - 更新部署说明
- [x] `scripts/docker-run.sh` - 本地测试脚本（可选）

---

## 测试验证

### 本地 Docker 测试

1. 构建镜像：`docker build -t test-rag .`
2. 运行容器：`docker run -p 8501:8501 -e DEEPSEEK_API_KEY=xxx test-rag`
3. 访问 `http://localhost:8501` 验证功能

### 部署到 Zeabur/Railway

1. 推送代码到 GitHub
2. 在平台创建项目，连接仓库
3. 配置环境变量
4. 触发部署
5. 访问分配的域名验证

---

## 已知限制（演示阶段）

1. **数据不持久化**：重启后索引、会话、用户数据全部丢失
2. **单实例部署**：无法水平扩展（多副本）
3. **启动较慢**：首次启动需下载模型（约 5-10 分钟）
4. **用户认证简单**：SHA256 哈希无盐值，不适合生产环境
5. **无监控告警**：仅依赖平台基础日志

---

## 后续迭代计划

### V1.1（持久化存储）
- 添加持久卷挂载（`/app/data`, `/app/vector_store`）
- 用户数据和索引数据持久化

### V1.2（性能优化）
- 模型预打包到镜像（加快启动）
- 切换到 Qdrant Cloud 向量数据库

### V1.3（企业级）
- Docker Compose 多服务编排
- 添加监控（Prometheus + Grafana）
- 配置 HTTPS 和自定义域名

---

## 环境变量说明

| 变量名 | 必填 | 默认值 | 说明 |
|--------|------|--------|------|
| DEEPSEEK_API_KEY | ✅ | - | DeepSeek API 密钥 |
| EMBEDDING_MODEL | ❌ | BAAI/bge-base-zh-v1.5 | Embedding 模型 |
| HF_ENDPOINT | ❌ | https://hf-mirror.com | HuggingFace 镜像 |
| APP_PORT | ❌ | 8501 | 应用端口 |

---

## 成本预估

### Zeabur
- **免费层**：开发版足够使用
- **付费层**：按需升级

### Railway
- **免费层**：$5 额度/月
- **运行时间**：约 500 小时/月
- **建议**：演示阶段免费层足够

---

---

## 实施总结

### 已完成的工作

✅ **Dockerfile 创建**
- 基于 Python 3.12-slim 镜像
- 安装 git 和 uv 依赖管理工具
- 配置 Streamlit 启动命令
- 暴露 8501 端口

✅ **.dockerignore 配置**
- 排除 Python 缓存和虚拟环境
- 排除测试文件和本地数据
- 排除敏感信息（.env 文件）
- 排除文档和任务日志

✅ **Zeabur 配置文件**
- 指定 Dockerfile 构建方式
- 预定义环境变量（API 密钥必填）
- 声明 HTTP 端口映射

✅ **Railway 配置文件**
- 配置 Dockerfile 构建
- 设置健康检查和重启策略
- 指定启动命令

✅ **部署文档**
- 详细的 Zeabur 和 Railway 部署步骤
- 环境变量说明表格
- 注意事项和成本预估
- 后续优化方向

✅ **README.md 更新**
- 添加在线部署章节
- 集成一键部署按钮
- 添加重要注意事项

✅ **本地测试脚本**
- 创建 `scripts/docker-run.sh`
- 添加执行权限
- 提供本地 Docker 测试命令

### 部署准备就绪

现在项目已完全准备好进行 PaaS 部署：

1. **推送代码到 GitHub**
2. **选择部署平台**：
   - Zeabur（推荐，国内友好）
   - Railway（备选）
3. **配置环境变量**：`DEEPSEEK_API_KEY`
4. **一键部署**

### 预期效果

- ✅ 5 分钟内完成部署配置
- ✅ 单命令启动应用
- ✅ 国内访问友好
- ✅ 保留多用户认证功能
- ✅ 最小化复杂度

---

---

## 部署配置完成总结

### 🎉 配置完成状态

**所有部署配置文件已成功创建并配置完成！**

### 📁 已创建的文件清单

| 文件名 | 状态 | 用途 | 说明 |
|--------|------|------|------|
| `Dockerfile` | ✅ 已创建 | 容器化配置 | Python 3.12-slim + Streamlit |
| `.dockerignore` | ✅ 已创建 | 镜像优化 | 排除缓存、测试、敏感文件 |
| `zeabur.json` | ✅ 已创建 | Zeabur 平台配置 | 构建方式 + 环境变量 |
| `railway.toml` | ✅ 已创建 | Railway 平台配置 | 构建 + 健康检查 + 重启策略 |
| `docs/DEPLOYMENT.md` | ✅ 已创建 | 部署指南 | 详细步骤 + 注意事项 |
| `README.md` | ✅ 已更新 | 项目说明 | 添加在线部署章节 |
| `scripts/docker-run.sh` | ✅ 已创建 | 本地测试脚本 | Docker 构建运行命令 |

### 🔧 技术实现细节

#### Dockerfile 配置
```dockerfile
FROM python:3.12-slim
RUN apt-get update && apt-get install -y git
RUN pip install uv
WORKDIR /app
COPY pyproject.toml .
RUN uv pip install --system -r pyproject.toml
COPY . .
EXPOSE 8501
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

#### 平台配置对比

| 特性 | Zeabur | Railway |
|------|--------|---------|
| 构建方式 | Dockerfile | Dockerfile |
| 环境变量 | JSON 预定义 | TOML 配置 |
| 健康检查 | 自动 | 手动配置 |
| 重启策略 | 默认 | 自定义 |
| 国内访问 | ✅ 友好 | ⚠️ 一般 |

#### 环境变量配置
- **DEEPSEEK_API_KEY**: 必填，DeepSeek API 密钥
- **EMBEDDING_MODEL**: 可选，默认 BAAI/bge-base-zh-v1.5
- **HF_ENDPOINT**: 可选，默认 https://hf-mirror.com
- **APP_PORT**: 可选，默认 8501

### 🚀 部署就绪状态

#### 立即可执行的部署步骤

1. **推送代码到 GitHub**
   ```bash
   git add .
   git commit -m "feat: 添加 PaaS 部署配置"
   git push origin main
   ```

2. **选择部署平台**
   - **Zeabur**（推荐）：国内访问快，配置简单
   - **Railway**（备选）：功能丰富，社区活跃

3. **配置环境变量**
   - 在平台 UI 中设置 `DEEPSEEK_API_KEY`
   - 其他变量使用默认值

4. **一键部署**
   - 点击部署按钮
   - 等待构建完成（5-10 分钟）

#### 预期部署时间线

| 阶段 | 耗时 | 说明 |
|------|------|------|
| 代码推送 | 1 分钟 | Git push 到 GitHub |
| 平台连接 | 1 分钟 | 连接 GitHub 仓库 |
| 环境配置 | 1 分钟 | 设置 API 密钥 |
| 镜像构建 | 3-5 分钟 | Docker 构建 + 依赖安装 |
| 应用启动 | 5-10 分钟 | 下载 Embedding 模型 |
| **总计** | **10-18 分钟** | **首次完整部署** |

### 📊 部署验证清单

#### 本地测试（可选）
```bash
# 构建镜像
docker build -t systematology-rag:latest .

# 运行容器
docker run -p 8501:8501 -e DEEPSEEK_API_KEY=your_key systematology-rag:latest

# 访问测试
curl http://localhost:8501
```

#### 在线部署验证
- [ ] 应用正常启动（无错误日志）
- [ ] Web 界面可访问
- [ ] 用户注册/登录功能正常
- [ ] 文档上传功能正常
- [ ] 对话功能正常
- [ ] 引用溯源功能正常

### ⚠️ 重要提醒

#### 演示阶段限制
1. **数据不持久化**：重启后所有数据丢失
2. **单实例部署**：无法水平扩展
3. **启动较慢**：首次需下载 400MB 模型
4. **简单认证**：SHA256 无盐值哈希

#### 成本控制
- **Zeabur**：免费层足够演示
- **Railway**：免费层 $5/月，约 500 小时

### 🔄 后续迭代路径

#### V1.1（数据持久化）
- 添加持久卷挂载
- 用户数据和索引持久化
- 会话历史保存

#### V1.2（性能优化）
- 模型预打包到镜像
- 切换到 Qdrant Cloud
- 添加查询缓存

#### V1.3（企业级）
- Docker Compose 编排
- 监控和告警
- HTTPS 和自定义域名

---

**实施人员**: AI Assistant  
**审核状态**: ✅ 已完成  
**完成时间**: 2025-10-22  
**配置状态**: ✅ 部署就绪

