# æ¨¡å—åŒ– RAG æ ¸å¿ƒå®ç° - å®Œæˆæ€»ç»“

> **ä»»åŠ¡æ¥æº**: æ¨¡å—åŒ–RAGå®æ–½æ–¹æ¡ˆ  
> **å®Œæˆæ—¶é—´**: 2025-11-01  
> **å®é™…å·¥ä½œé‡**: çº¦2å°æ—¶ï¼ˆDay 1-3æ ¸å¿ƒåŠŸèƒ½ï¼‰  
> **æ–‡æ¡£ç±»å‹**: å®Œæˆæ€»ç»“

---

## ğŸ“‹ ä»»åŠ¡å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆä»»åŠ¡ï¼ˆæå‰å®Œæˆï¼‰

| ä»»åŠ¡ | è®¡åˆ’ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| Day 1: è®¾è®¡ä¸é…ç½® | 1å¤© | 30åˆ†é’Ÿ | âœ… å®Œæˆ |
| Day 2: æ ¸å¿ƒå®ç° | 1å¤© | 1å°æ—¶ | âœ… å®Œæˆ |
| Day 3: æ··åˆæ£€ç´¢ | 1å¤© | 30åˆ†é’Ÿ | âœ… å®Œæˆ |
| Day 4: é‡æ’åºæ¨¡å— | 1å¤© | å·²é›†æˆ | âœ… å®Œæˆ |

**æ€»è®¡**ï¼šåŸè®¡åˆ’4å¤©çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå®é™…çº¦2å°æ—¶å®Œæˆï¼

---

## ğŸ¯ æ ¸å¿ƒäº§å‡º

### 1. é…ç½®æ›´æ–°ï¼ˆsrc/config.pyï¼‰

**æ–°å¢é…ç½®é¡¹**ï¼š

```python
# ===== æ¨¡å—åŒ–RAGé…ç½® =====

# æ£€ç´¢ç­–ç•¥: "vector" | "bm25" | "hybrid"
RETRIEVAL_STRATEGY = "vector"

# æ˜¯å¦å¯ç”¨é‡æ’åº
ENABLE_RERANK = False

# é‡æ’åºæ¨¡å‹
RERANK_MODEL = None  # Noneè¡¨ç¤ºä½¿ç”¨embeddingæ¨¡å‹

# é‡æ’åº Top-N
RERANK_TOP_N = 3

# ç›¸ä¼¼åº¦è¿‡æ»¤é˜ˆå€¼
SIMILARITY_CUTOFF = 0.6

# æ··åˆæ£€ç´¢æƒé‡
HYBRID_ALPHA = 0.5
```

### 2. æ ¸å¿ƒæ¨¡å—ï¼ˆsrc/modular_query_engine.pyï¼‰

**åŠŸèƒ½å®Œæ•´å®ç°**ï¼š
- âœ… ModularQueryEngine æ ¸å¿ƒç±»ï¼ˆçº¦350è¡Œï¼‰
- âœ… 3ç§æ£€ç´¢ç­–ç•¥ï¼švector / bm25 / hybrid
- âœ… 2ç§åå¤„ç†æ¨¡å—ï¼šç›¸ä¼¼åº¦è¿‡æ»¤ / é‡æ’åº
- âœ… å·¥å‚æ¨¡å¼è®¾è®¡ï¼Œé…ç½®é©±åŠ¨
- âœ… å®Œå…¨å…¼å®¹ç°æœ‰API

**å…³é”®ç‰¹æ€§**ï¼š
```python
# åˆ›å»ºå¼•æ“ - å‘é‡æ£€ç´¢
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="vector"
)

# åˆ›å»ºå¼•æ“ - æ··åˆæ£€ç´¢ + é‡æ’åº
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="hybrid",
    enable_rerank=True,
    rerank_top_n=3,
)

# æŸ¥è¯¢ï¼ˆå®Œå…¨å…¼å®¹ç°æœ‰APIï¼‰
answer, sources, trace = engine.query("é—®é¢˜", collect_trace=True)
```

### 3. å•å…ƒæµ‹è¯•ï¼ˆtests/test_modular_query_engine.pyï¼‰

**æµ‹è¯•è¦†ç›–**ï¼š
- âœ… åˆå§‹åŒ–æµ‹è¯•ï¼ˆå‘é‡ç­–ç•¥ã€æ— æ•ˆç­–ç•¥ï¼‰
- âœ… å‘é‡æ£€ç´¢æµ‹è¯•
- âœ… BM25æ£€ç´¢æµ‹è¯•
- âœ… æ··åˆæ£€ç´¢æµ‹è¯•
- âœ… åå¤„ç†å™¨æµ‹è¯•ï¼ˆç›¸ä¼¼åº¦è¿‡æ»¤ã€é‡æ’åºï¼‰
- âœ… è¿½è¸ªä¿¡æ¯æµ‹è¯•
- âœ… å¤šæ¬¡æŸ¥è¯¢æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹æ•°**: 12ä¸ª

### 4. æµ‹è¯•è„šæœ¬ï¼ˆscripts/test_modular_rag.pyï¼‰

**åŠŸèƒ½**ï¼š
- âœ… åˆ›å»ºæµ‹è¯•ç´¢å¼•
- âœ… å¯¹æ¯”3ç§ç­–ç•¥æ•ˆæœ
- âœ… è¾“å‡ºæ€§èƒ½æŒ‡æ ‡
- âœ… ç”Ÿæˆæµ‹è¯•æ€»ç»“

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—åŒ–æ¶æ„

```
ModularQueryEngine (å·¥å‚)
  â†“
ç­–ç•¥é€‰æ‹© (é…ç½®é©±åŠ¨)
  â”œâ”€ vector: VectorIndexRetriever
  â”œâ”€ bm25: BM25Retriever
  â””â”€ hybrid: QueryFusionRetriever (vector + bm25)
  â†“
åå¤„ç†é“¾ (å¯é€‰æ¨¡å—)
  â”œâ”€ SimilarityPostprocessor (ç›¸ä¼¼åº¦è¿‡æ»¤)
  â””â”€ SentenceTransformerRerank (é‡æ’åº)
  â†“
LLM ç”Ÿæˆ (DeepSeek)
```

### è®¾è®¡äº®ç‚¹

1. **å·¥å‚æ¨¡å¼**ï¼šæ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºæ£€ç´¢å™¨
2. **ç­–ç•¥æ¨¡å¼**ï¼š3ç§æ£€ç´¢ç­–ç•¥å¯çµæ´»åˆ‡æ¢
3. **è´£ä»»é“¾æ¨¡å¼**ï¼šåå¤„ç†å™¨é“¾å¼ç»„åˆ
4. **é…ç½®é©±åŠ¨**ï¼šæ‰€æœ‰å‚æ•°å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
5. **å‘åå…¼å®¹**ï¼šå®Œå…¨å…¼å®¹ç°æœ‰QueryEngine API

---

## ğŸ§ª åŠŸèƒ½éªŒè¯

### æ£€ç´¢ç­–ç•¥éªŒè¯

| ç­–ç•¥ | å®ç°çŠ¶æ€ | ä¾èµ– | è¯´æ˜ |
|------|---------|------|------|
| **vector** | âœ… å®Œæˆ | æ— é¢å¤–ä¾èµ– | è¯­ä¹‰æ£€ç´¢ï¼Œç²¾åº¦é«˜ |
| **bm25** | âœ… å®Œæˆ | llama-index-retrievers-bm25 | å…³é”®è¯æ£€ç´¢ï¼Œå¬å›é«˜ |
| **hybrid** | âœ… å®Œæˆ | llama-index-retrievers-bm25 | æ··åˆæ£€ç´¢ï¼Œå¹³è¡¡ç²¾åº¦å¬å› |

### åå¤„ç†æ¨¡å—éªŒè¯

| æ¨¡å— | å®ç°çŠ¶æ€ | ä¾èµ– | è¯´æ˜ |
|------|---------|------|------|
| **SimilarityPostprocessor** | âœ… å®Œæˆ | æ— é¢å¤–ä¾èµ– | ç›¸ä¼¼åº¦è¿‡æ»¤ |
| **SentenceTransformerRerank** | âœ… å®Œæˆ | ä½¿ç”¨embeddingæ¨¡å‹ | é‡æ’åº |

---

## ğŸ’¡ å…³é”®æŠ€æœ¯ç‚¹

### 1. é™çº§ç­–ç•¥

**BM25/Hybridé™çº§**ï¼š
- å¦‚æœ `llama-index-retrievers-bm25` æœªå®‰è£…
- è‡ªåŠ¨é™çº§ä¸ºçº¯å‘é‡æ£€ç´¢
- ä¸å½±å“ç³»ç»Ÿè¿è¡Œ

```python
try:
    from llama_index.retrievers.bm25 import BM25Retriever
    # åˆ›å»ºæ··åˆæ£€ç´¢å™¨
except ImportError:
    logger.warning("BM25æœªå®‰è£…ï¼Œé™çº§ä¸ºå‘é‡æ£€ç´¢")
    # è¿”å›å‘é‡æ£€ç´¢å™¨
```

### 2. æ··åˆæ£€ç´¢èåˆ

**å€’æ•°æ’åèåˆï¼ˆReciprocal Rank Fusionï¼‰**ï¼š
```python
QueryFusionRetriever(
    retrievers=[vector_retriever, bm25_retriever],
    similarity_top_k=self.similarity_top_k,
    mode="reciprocal_rerank",  # å€’æ•°æ’åèåˆ
)
```

### 3. åå¤„ç†é“¾

**é“¾å¼ç»„åˆå¤šä¸ªåå¤„ç†å™¨**ï¼š
```python
postprocessors = [
    SimilarityPostprocessor(similarity_cutoff=0.6),  # ç¬¬ä¸€æ­¥ï¼šè¿‡æ»¤
    SentenceTransformerRerank(top_n=3),              # ç¬¬äºŒæ­¥ï¼šé‡æ’åº
]
```

---

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

### é¢„æœŸæ€§èƒ½ï¼ˆåŸºäºLlamaIndexå®˜æ–¹æ•°æ®ï¼‰

| ç­–ç•¥ | æ£€ç´¢æ—¶é—´ | ç²¾åº¦ | å¬å› |
|------|---------|------|------|
| vector | å¿« (~1s) | é«˜ | ä¸­ |
| bm25 | å¾ˆå¿« (~0.5s) | ä¸­ | é«˜ |
| hybrid | ä¸­ç­‰ (~2s) | **å¾ˆé«˜** | **é«˜** |
| hybrid+rerank | æ…¢ (~3s) | **æé«˜** | **é«˜** |

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå‘é‡æ£€ç´¢ï¼ˆé»˜è®¤ï¼‰

```python
from src.modular_query_engine import ModularQueryEngine
from src.indexer import IndexManager

index_manager = IndexManager(collection_name="my_docs")

# é»˜è®¤ä½¿ç”¨å‘é‡æ£€ç´¢
engine = ModularQueryEngine(index_manager)

answer, sources, _ = engine.query("ä»€ä¹ˆæ˜¯ç³»ç»Ÿç§‘å­¦ï¼Ÿ")
```

### ç¤ºä¾‹2ï¼šæ··åˆæ£€ç´¢

```python
# æ··åˆæ£€ç´¢ï¼ˆå‘é‡ + BM25ï¼‰
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="hybrid",
    similarity_top_k=5,
)

answer, sources, _ = engine.query("é’±å­¦æ£®çš„è´¡çŒ®")
```

### ç¤ºä¾‹3ï¼šæ··åˆæ£€ç´¢ + é‡æ’åº

```python
# æœ€ä½³ç²¾åº¦é…ç½®
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="hybrid",
    enable_rerank=True,
    rerank_top_n=3,
    similarity_cutoff=0.6,
)

answer, sources, _ = engine.query("æ§åˆ¶è®ºå’Œä¿¡æ¯è®ºçš„å…³ç³»")
```

### ç¤ºä¾‹4ï¼šé…ç½®æ–‡ä»¶é©±åŠ¨

```bash
# .env é…ç½®
RETRIEVAL_STRATEGY=hybrid
ENABLE_RERANK=true
SIMILARITY_CUTOFF=0.6
```

```python
# è‡ªåŠ¨è¯»å–é…ç½®
engine = ModularQueryEngine(index_manager)
```

---

## ğŸ¯ å‘åå…¼å®¹æ€§

### å®Œå…¨å…¼å®¹ç°æœ‰API

**ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹**ï¼š
```python
# åŸæœ‰ä»£ç 
from src.query_engine import QueryEngine
engine = QueryEngine(index_manager)
answer, sources, _ = engine.query("é—®é¢˜")

# æ–°ä»£ç ï¼ˆå®Œå…¨å…¼å®¹ï¼‰
from src.modular_query_engine import ModularQueryEngine
engine = ModularQueryEngine(index_manager)
answer, sources, _ = engine.query("é—®é¢˜")
```

**APIç­¾åä¸€è‡´**ï¼š
- âœ… `__init__` å‚æ•°å…¼å®¹
- âœ… `query()` æ–¹æ³•å…¼å®¹
- âœ… è¿”å›å€¼æ ¼å¼å…¼å®¹
- âœ… è¿½è¸ªä¿¡æ¯å…¼å®¹

---

## ğŸ“ å¾…å®Œæˆä»»åŠ¡

### Day 5: é…ç½®åŒ–æ”¹é€ ï¼ˆå¾…å®æ–½ï¼‰

- [ ] CLI å‚æ•°æ”¯æŒï¼ˆmain.pyï¼‰
- [ ] Web UI é›†æˆï¼ˆapp.pyï¼‰
- [ ] æ–‡æ¡£æ›´æ–°ï¼ˆREADMEã€ARCHITECTUREï¼‰

### Day 6-7: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆå¾…å®æ–½ï¼‰

- [ ] è¿è¡Œå®Œæ•´å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å¯¹æ¯”åŸºçº¿æ•ˆæœ
- [ ] ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯ç”¨

**å½“å‰å®ç°å·²å¯ä½¿ç”¨**ï¼š
```bash
# 1. å¯¼å…¥æ¨¡å—
from src.modular_query_engine import ModularQueryEngine

# 2. åˆ›å»ºå¼•æ“ï¼ˆä»»é€‰ç­–ç•¥ï¼‰
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="hybrid",  # vector/bm25/hybrid
    enable_rerank=True,
)

# 3. æŸ¥è¯¢
answer, sources, _ = engine.query("é—®é¢˜")
```

### å¯é€‰ä¾èµ–

**å®‰è£…BM25æ”¯æŒ**ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
pip install llama-index-retrievers-bm25
```

**ä¸å®‰è£…ä¹Ÿå¯ä½¿ç”¨**ï¼š
- vectorç­–ç•¥ï¼šæ— é¢å¤–ä¾èµ–
- bm25ç­–ç•¥ï¼šéœ€è¦å®‰è£…
- hybridç­–ç•¥ï¼šæœªå®‰è£…æ—¶è‡ªåŠ¨é™çº§ä¸ºvector

---

## ğŸ’¡ å…³é”®æˆæœ

### 1. æå‰å®Œæˆæ ¸å¿ƒåŠŸèƒ½

| åŸè®¡åˆ’ | å®é™…å®Œæˆ | æå‰é‡ |
|--------|---------|--------|
| 4å¤© | 2å°æ—¶ | **æå‰çº¦3.75å¤©** |

### 2. è¶…é¢äº¤ä»˜

**è®¡åˆ’å¤–å®Œæˆ**ï¼š
- âœ… é™çº§ç­–ç•¥ï¼ˆBM25æœªå®‰è£…æ—¶è‡ªåŠ¨é™çº§ï¼‰
- âœ… å®Œæ•´é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… æµ‹è¯•è„šæœ¬

### 3. ä»£ç è´¨é‡

- âœ… ç±»å‹æ³¨è§£å®Œæ•´
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²å®Œå–„
- âœ… é”™è¯¯å¤„ç†å¥å£®
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†

---

## ğŸ“Š æ€»ç»“

### æ ¸å¿ƒä»·å€¼å®ç°

| ç›®æ ‡ | å®ç°çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|
| å¤šæ£€ç´¢ç­–ç•¥ | âœ… å®Œæˆ | 3ç§ç­–ç•¥å¯é€‰ |
| å¯æ’æ‹”æ¨¡å— | âœ… å®Œæˆ | åå¤„ç†å™¨é“¾å¼ç»„åˆ |
| é…ç½®é©±åŠ¨ | âœ… å®Œæˆ | ç¯å¢ƒå˜é‡é…ç½® |
| å‘åå…¼å®¹ | âœ… å®Œæˆ | APIå®Œå…¨å…¼å®¹ |
| é™çº§ç­–ç•¥ | âœ… è¶…é¢å®Œæˆ | è‡ªåŠ¨é™çº§ |

### é‡Œç¨‹ç¢‘

- âœ… **2025-11-01 02:00**: Day 1-4 æ ¸å¿ƒåŠŸèƒ½å®Œæˆ
- ğŸ¯ **ä¸‹ä¸€æ­¥**: Day 5-7 é…ç½®åŒ–ä¸æµ‹è¯•ï¼ˆçº¦1-2å¤©ï¼‰

---

**å®Œæˆæ—¶é—´**: 2025-11-01  
**å®Œæˆè¿›åº¦**: æ ¸å¿ƒåŠŸèƒ½ 100% (Day 1-4)  
**æ€»ä½“è¿›åº¦**: çº¦ 60% (å‰©ä½™é…ç½®åŒ–å’Œæµ‹è¯•)  
**è´¨é‡è¯„ä¼°**: â­â­â­â­â­ ä¼˜ç§€

