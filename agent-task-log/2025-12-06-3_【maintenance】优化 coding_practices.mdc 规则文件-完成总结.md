# 2025-12-06 【maintenance】优化 coding_practices.mdc 规则文件 - 完成总结

**【Task Type】**: maintenance
**创建日期**: 2025-12-06  
**任务**: 优化 coding_practices.mdc 规则文件，突出重点，确保 AI 能准确理解并执行  
**状态**: ✅ 已完成

---

## 📋 任务概述

本次任务对 `.cursor/rules/coding_practices.mdc` 规则文件进行了全面优化，主要目标是：

1. **突出核心强制要求**：特别是 300 行限制等关键规则
2. **明确 AI Agent 行为要求**：让 AI 清楚知道在创建/修改/审查代码时应该做什么
3. **使用指令性语言**：用"必须"、"禁止"等明确指令替代清单格式
4. **强化关键规则**：将 300 行限制标注为硬性限制，不允许例外

**问题背景**：
- 用户反馈规则无法自动生效，特别是 300 行限制问题
- 规则重点不突出，导致 AI 无法完全理解
- 需要优化规则结构，让 AI 能够准确理解并执行

---

## ✅ 完成内容

### 1. 规则结构重构

**原有结构**：
- 使用清单格式（`- [ ]`），重点不突出
- 300 行限制混在基线设置中，不够醒目
- 缺少明确的 AI Agent 行为指导

**优化后结构**：
- ✅ **新增"⚠️ 核心强制要求"部分**：放在最前面，突出关键规则
- ✅ **新增"AI Agent 行为要求"部分**：明确告诉 AI 应该怎么做
- ✅ **保留"详细规范要求"部分**：作为补充说明
- ✅ **优化验收标准**：将 300 行限制放在第一条

### 2. 核心强制要求突出

**1. 文件行数限制（最优先）**
- 标注为"⚠️ 单个代码文件必须 ≤ 300 行，这是硬性限制，不允许例外"
- 明确检查时机：创建新文件时、修改现有文件后
- 明确执行方式：超过 300 行必须立即拆分
- 明确禁止行为：不允许以任何理由超过 300 行

**2. 类型提示**
- 标注为"所有函数、方法、类声明必须补全类型提示"
- 明确要求：缺值返回使用 `-> None`，公共 API 提供完整 docstring

**3. 日志规范**
- 标注为"业务代码统一通过 `src.logger.setup_logger` 获取 logger，禁止使用 `print`"
- 明确例外：测试示例代码除外
- 明确要求：错误路径必须使用 `logger.error` 或 `logger.exception`

### 3. AI Agent 行为要求明确化

**创建新文件时**：
- 必须检查行数：创建文件后立即检查，超过 300 行立即停止
- 必须添加类型提示：所有函数、方法、类声明补全类型提示
- 必须使用日志：通过 `src.logger.setup_logger` 获取 logger，禁止 print

**修改现有文件时**：
- 必须检查行数：修改后立即检查文件总行数，超过 300 行必须主动提出拆分建议
- 必须保持规范：新增代码必须符合类型提示要求，新增日志必须使用 logger

**代码审查时**：
- 必须检查行数：检查所有相关文件是否 ≤ 300 行，发现超过必须立即指出并要求拆分
- 必须检查类型提示：检查所有函数、方法、类是否有类型提示
- 必须检查日志：检查是否使用了 print，检查错误路径是否使用了 logger.error

### 4. 语言风格优化

**从清单格式改为指令性语言**：
- ❌ 原有：`- [ ] 单个代码文件 ≤ 300 行；超过需拆分并说明职责划分。`
- ✅ 优化后：`**⚠️ 单个代码文件必须 ≤ 300 行，这是硬性限制，不允许例外。**`

**使用明确的动作词**：
- "必须"、"禁止"、"立即停止"、"立即指出"等
- 让 AI 清楚知道应该采取什么行动

### 5. 规则文件元信息优化

**Frontmatter 更新**：
- 添加 `globs: ["**/*.py"]`：明确适用范围
- 添加 `priority: 1`：提高优先级
- 优化 `description`：更详细地描述规则内容

---

## 🔍 关键决策

### 决策1：将 300 行限制放在最前面

**背景**：用户反馈 300 行限制无法自动生效，AI 无法完全理解

**决策**：
- 将 300 行限制放在"⚠️ 核心强制要求"部分的第一条
- 使用醒目的格式标注（加粗、警告符号）
- 明确标注为"硬性限制，不允许例外"

**理由**：
- 最优先的规则应该放在最前面
- 醒目的格式能够吸引 AI 的注意力
- 明确的限制说明能够避免 AI 寻找例外理由

### 决策2：新增"AI Agent 行为要求"部分

**背景**：原有规则使用清单格式，AI 不知道具体应该怎么做

**决策**：
- 新增专门的"AI Agent 行为要求"部分
- 按照"创建新文件时"、"修改现有文件时"、"代码审查时"三个场景分类
- 每个场景下明确列出必须执行的检查项

**理由**：
- 明确的场景分类让 AI 知道在什么时候应该做什么
- 具体的检查项让 AI 有明确的执行步骤
- 参考了其他规则文件（如 `single-responsibility-principle.mdc`）的成功经验

### 决策3：使用指令性语言替代清单格式

**背景**：清单格式（`- [ ]`）不够明确，AI 可能理解为可选项

**决策**：
- 核心强制要求使用指令性语言（"必须"、"禁止"等）
- 详细规范要求保留清单格式，但作为补充说明
- 验收标准使用清单格式，但明确标注为"硬性要求"

**理由**：
- 指令性语言更明确，AI 更容易理解
- 核心要求和详细规范分开，突出重点
- 验收标准使用清单格式便于检查

### 决策4：强化禁止行为说明

**背景**：AI 可能会寻找理由超过 300 行限制

**决策**：
- 明确列出禁止行为："不允许以'功能复杂'、'暂时无法拆分'等理由超过 300 行"
- 在 AI Agent 行为要求中强调"立即停止"、"必须主动提出拆分建议"

**理由**：
- 明确的禁止行为能够防止 AI 寻找例外
- 强调"立即停止"能够确保 AI 不会继续执行
- 强调"必须主动提出拆分建议"能够确保 AI 不会忽略问题

---

## 📝 实施方法

### 1. 规则结构分析

**步骤**：
1. 读取现有规则文件内容
2. 分析用户反馈的问题点
3. 参考其他规则文件的结构（如 `single-responsibility-principle.mdc`、`file-header-comments.mdc`）
4. 设计新的规则结构

**工具**：`read_file`

### 2. 核心要求提取

**步骤**：
1. 识别最关键的规则（300 行限制、类型提示、日志规范）
2. 将这些规则提取到"⚠️ 核心强制要求"部分
3. 使用醒目的格式标注
4. 明确标注为硬性限制

**工具**：`read_file`, `search_replace`

### 3. AI Agent 行为要求编写

**步骤**：
1. 分析 AI 在代码开发中的三个主要场景：创建、修改、审查
2. 为每个场景列出必须执行的检查项
3. 使用明确的指令性语言
4. 强调关键检查点（特别是 300 行限制）

**工具**：参考其他规则文件的成功经验

### 4. 规则文件重写

**步骤**：
1. 使用 `write` 工具重写整个规则文件
2. 确保结构清晰、重点突出
3. 更新 frontmatter 元信息
4. 更新版本信息

**工具**：`write`

---

## 🧪 测试与验证

### 1. 格式检查

- ✅ 使用 `read_lints` 检查规则文件格式
- ✅ 确认 Markdown 语法正确性
- ✅ 确认 frontmatter 格式正确

### 2. 内容完整性检查

- ✅ 确认核心强制要求部分包含所有关键规则
- ✅ 确认 AI Agent 行为要求覆盖所有场景
- ✅ 确认详细规范要求完整
- ✅ 确认验收标准明确

### 3. 重点突出检查

- ✅ 确认 300 行限制放在最前面
- ✅ 确认使用醒目的格式标注
- ✅ 确认使用指令性语言
- ✅ 确认禁止行为明确说明

---

## 📊 结果与交付

### 交付文件

1. **`.cursor/rules/coding_practices.mdc`** - 规则文件（已优化）
   - 结构重构：新增"⚠️ 核心强制要求"和"AI Agent 行为要求"部分
   - 300 行限制突出：放在最前面，标注为硬性限制
   - 语言优化：使用指令性语言替代清单格式
   - 元信息优化：添加 globs、priority 等配置

### 改进效果

1. **重点突出**：
   - 核心强制要求放在最前面，使用醒目格式
   - 300 行限制明确标注为硬性限制，不允许例外
   - 关键规则使用指令性语言，更易理解

2. **行为明确**：
   - AI Agent 行为要求部分明确告诉 AI 应该怎么做
   - 按照场景分类，每个场景都有明确的检查项
   - 强调关键检查点，确保 AI 不会忽略

3. **可执行性提升**：
   - 明确的检查时机和执行方式
   - 明确的禁止行为说明
   - 明确的验收标准

### 规则文件统计

- **文件行数**：从 64 行增加到 178 行
- **核心强制要求**：3 条（文件行数限制、类型提示、日志规范）
- **AI Agent 行为要求**：3 个场景（创建、修改、审查）
- **详细规范要求**：3 个部分（结构与命名、日志与异常、注释与可读性）

---

## 🔗 相关文件

### 修改的文件

- `.cursor/rules/coding_practices.mdc` - 规则文件（全面优化）

### 参考的文件

- `.cursor/rules/single-responsibility-principle.mdc` - 单一职责原则规则（参考结构）
- `.cursor/rules/file-header-comments.mdc` - 文件头部注释规则（参考结构）

---

## 💡 经验总结

### 成功经验

1. **用户反馈优先**：根据用户明确反馈的问题进行针对性优化
2. **结构参考**：参考其他成功的规则文件结构，学习最佳实践
3. **重点突出**：将最关键的规则放在最前面，使用醒目的格式
4. **行为明确**：明确告诉 AI 应该怎么做，而不是只列出要求

### 注意事项

1. **规则可执行性**：规则不仅要明确要求，还要告诉 AI 如何执行
2. **语言风格**：指令性语言比清单格式更明确，AI 更容易理解
3. **禁止行为**：明确列出禁止行为，防止 AI 寻找例外理由
4. **场景分类**：按照场景分类，让 AI 知道在什么时候应该做什么

---

## 📋 后续建议

### 可优化方向

1. **规则测试**：在实际代码开发中测试规则是否能够自动生效
2. **反馈收集**：收集 AI 执行规则时的反馈，持续优化
3. **规则联动**：考虑与其他规则文件的联动，确保规则之间不冲突
4. **规则文档**：考虑添加规则使用示例，帮助 AI 更好地理解

### 维护建议

1. **定期审查**：定期审查规则文件，确保与实际需求一致
2. **用户反馈**：根据用户反馈持续优化规则内容和结构
3. **版本管理**：保持版本信息的准确性，记录每次优化的内容

---

**最后更新**: 2025-12-06  
**状态**: ✅ 已完成
