# æ¨¡å—åŒ–RAGæ¶æ„å®æ–½ - æœ€ç»ˆæ€»ç»“

> **åˆ›å»ºæ—¶é—´**: 2025-11-01  
> **æ–‡æ¡£ç±»å‹**: æœ€ç»ˆæ€»ç»“  
> **çŠ¶æ€**: âœ… é˜¶æ®µ1å®Œæˆï¼Œç­‰å¾…ä»£ç æ‹†åˆ†

---

## ä¸€ã€å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½æŒ‰ç…§è§„åˆ’å®Œæˆäº†**é˜¶æ®µ1ï¼šç‹¬ç«‹æ¨¡å—å®æ–½**çš„æ‰€æœ‰ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **Grepæ£€ç´¢å™¨** - åŸºäºæ–‡æœ¬æœç´¢çš„æ£€ç´¢æ–¹å¼
2. âœ… **å¤šç­–ç•¥æ£€ç´¢æ¡†æ¶** - å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€ç´¢ç­–ç•¥å¹¶åˆå¹¶ç»“æœ
3. âœ… **Rerankeræ¨¡å—** - å¯æ’æ‹”çš„é‡æ’åºå™¨æ¶æ„
4. âœ… **RAGASè¯„ä¼°å™¨** - RAGç³»ç»Ÿè¯„ä¼°èƒ½åŠ›

---

## äºŒã€å·²å®Œæˆæ¨¡å—

### 2.1 Grepæ£€ç´¢å™¨

**æ–‡ä»¶**ï¼š
- `src/retrievers/grep_retriever.py` - Grepæ£€ç´¢å™¨å®ç°
- `src/retrievers/__init__.py` - æ¨¡å—å¯¼å‡º

**ç‰¹ç‚¹**ï¼š
- âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/Macï¼‰
- âœ… æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æœç´¢
- âœ… æ–‡ä»¶ç³»ç»Ÿç›´æ¥è®¿é—®ï¼Œæ— éœ€é¢„ç´¢å¼•
- âœ… å®æ—¶æœç´¢ï¼Œé›¶å»¶è¿Ÿ

### 2.2 å¤šç­–ç•¥æ£€ç´¢æ¡†æ¶

**æ–‡ä»¶**ï¼š
- `src/retrievers/multi_strategy_retriever.py` - å¤šç­–ç•¥æ£€ç´¢å™¨
- `src/retrievers/result_merger.py` - ç»“æœåˆå¹¶å™¨
- `src/retrievers/adapter.py` - LlamaIndexé€‚é…å™¨

**ç‰¹ç‚¹**ï¼š
- âœ… å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€ç´¢ç­–ç•¥
- âœ… æ”¯æŒRRFã€åŠ æƒèåˆç­‰åˆå¹¶ç­–ç•¥
- âœ… è‡ªåŠ¨å»é‡
- âœ… å¯é…ç½®æƒé‡

### 2.3 Rerankeræ¨¡å—

**æ–‡ä»¶**ï¼š
- `src/rerankers/base.py` - BaseRerankeræŠ½è±¡åŸºç±»
- `src/rerankers/sentence_transformer_reranker.py` - SentenceTransformerå®ç°
- `src/rerankers/bge_reranker.py` - BGEå®ç°
- `src/rerankers/factory.py` - å·¥å‚å‡½æ•°

**ç‰¹ç‚¹**ï¼š
- âœ… å¯æ’æ‹”è®¾è®¡
- âœ… ç»Ÿä¸€æ¥å£
- âœ… å·¥å‚æ¨¡å¼
- âœ… å…¨å±€ç¼“å­˜

### 2.4 RAGASè¯„ä¼°å™¨

**æ–‡ä»¶**ï¼š
- `src/observers/ragas_evaluator.py` - RAGASè¯„ä¼°å™¨

**ç‰¹ç‚¹**ï¼š
- âœ… å¤šç»´åº¦è¯„ä¼°æŒ‡æ ‡
- âœ… æ‰¹é‡è¯„ä¼°æ”¯æŒ
- âœ… è‡ªåŠ¨æ•°æ®æ”¶é›†
- âœ… å¯é€‰ä¾èµ–

---

## ä¸‰ã€é…ç½®æ›´æ–°

### æ–°å¢é…ç½®é¡¹

**å¤šç­–ç•¥æ£€ç´¢**ï¼š
```bash
ENABLED_RETRIEVAL_STRATEGIES=vector,bm25,grep
MERGE_STRATEGY=reciprocal_rank_fusion
RETRIEVER_WEIGHTS='{"vector": 1.0, "bm25": 0.8, "grep": 0.6}'
ENABLE_DEDUPLICATION=true
```

**Grepæ£€ç´¢**ï¼š
```bash
ENABLE_GREP_RETRIEVAL=false
GREP_DATA_SOURCE_PATH=data/
GREP_ENABLE_REGEX=true
GREP_MAX_RESULTS=10
```

**Reranker**ï¼š
```bash
RERANKER_TYPE=sentence-transformer
RERANK_MODEL=BAAI/bge-reranker-base
RERANK_TOP_N=3
```

**RAGASè¯„ä¼°å™¨**ï¼š
```bash
ENABLE_RAGAS=false
RAGAS_METRICS=faithfulness,context_precision,context_recall,answer_relevancy,context_relevancy
RAGAS_BATCH_SIZE=10
```

---

## å››ã€æ¶æ„é›†æˆ

### 4.1 æ£€ç´¢å™¨é›†æˆ

**æ”¯æŒçš„æ£€ç´¢ç­–ç•¥**ï¼š
- `vector` - å‘é‡æ£€ç´¢ï¼ˆå·²æœ‰ï¼‰
- `bm25` - BM25æ£€ç´¢ï¼ˆå·²æœ‰ï¼‰
- `hybrid` - æ··åˆæ£€ç´¢ï¼ˆå·²æœ‰ï¼‰
- `grep` - Grepæ–‡æœ¬æ£€ç´¢ï¼ˆæ–°å¢ï¼‰
- `multi` - å¤šç­–ç•¥æ£€ç´¢ï¼ˆæ–°å¢ï¼‰

**æ£€ç´¢å™¨å·¥å‚**ï¼š
- `src/query/modular/retriever_factory.py` - æ”¯æŒæ‰€æœ‰æ£€ç´¢ç­–ç•¥

### 4.2 é‡æ’åºå™¨é›†æˆ

**åå¤„ç†å™¨å·¥å‚**ï¼š
- `src/query/modular/postprocessor_factory.py` - é›†æˆcreate_reranker

**æŸ¥è¯¢å¼•æ“**ï¼š
- `src/query/modular/engine.py` - æ”¯æŒreranker_typeå‚æ•°

### 4.3 è§‚å¯Ÿå™¨é›†æˆ

**è§‚å¯Ÿå™¨å·¥å‚**ï¼š
- `src/observers/factory.py` - æ”¯æŒRAGASè¯„ä¼°å™¨

---

## äº”ã€ä»£ç è´¨é‡

### 5.1 Linteræ£€æŸ¥

æ‰€æœ‰æ–°å¢ä»£ç å·²é€šè¿‡linteræ£€æŸ¥ï¼Œæ— é”™è¯¯ã€‚

### 5.2 ä»£ç ç»“æ„

- âœ… éµå¾ªç»Ÿä¸€çš„è®¾è®¡æ¨¡å¼
- âœ… å®Œå–„çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… ç»Ÿä¸€çš„æ—¥å¿—è®°å½•
- âœ… é”™è¯¯å¤„ç†å®Œå–„

---

## å…­ã€å¾…å®æ–½ä»»åŠ¡

### 6.1 ç­‰å¾…ä»£ç æ‹†åˆ†ï¼ˆå¤–éƒ¨ä¾èµ–ï¼‰

- â¸ï¸ **wait-code-split** - ç­‰å¾…ä»£ç æ‹†åˆ†ä»»åŠ¡å®Œæˆ

### 6.2 P0-P3è¿ç§»ï¼ˆä¾èµ–ä»£ç æ‹†åˆ†ï¼‰

- ğŸ“‹ **P0è¿ç§»** - RAGService + å‰ç«¯å±‚è¿ç§»
- ğŸ“‹ **P1è¿ç§»** - PipelineExecutor + åè®®å®šä¹‰
- ğŸ“‹ **P2è¿ç§»** - ModuleRegistry + é…ç½®é©±åŠ¨
- ğŸ“‹ **P3è¿ç§»** - äº‹ä»¶é’©å­ + ç­–ç•¥æ²»ç†ï¼ˆå¯é€‰ï¼‰

### 6.3 æµ‹è¯•å’Œè¯„ä¼°

- ğŸ“‹ **å•å…ƒæµ‹è¯•** - æå‡æµ‹è¯•è¦†ç›–ç‡
- ğŸ“‹ **æ€§èƒ½åŸºå‡†æµ‹è¯•** - å»ºç«‹æ€§èƒ½åŸºçº¿

---

## ä¸ƒã€ä½¿ç”¨ç¤ºä¾‹

### 7.1 å¯ç”¨å¤šç­–ç•¥æ£€ç´¢

```python
from src.query.modular.engine import ModularQueryEngine
from src.indexer import IndexManager

index_manager = IndexManager()
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="multi",
)
```

### 7.2 å¯ç”¨Grepæ£€ç´¢

```python
engine = ModularQueryEngine(
    index_manager,
    retrieval_strategy="grep",
)
```

### 7.3 å¯ç”¨BGEé‡æ’åº

```python
engine = ModularQueryEngine(
    index_manager,
    enable_rerank=True,
    reranker_type="bge",
    rerank_top_n=3,
)
```

### 7.4 å¯ç”¨RAGASè¯„ä¼°

```bash
# .env
ENABLE_RAGAS=true
RAGAS_METRICS=faithfulness,context_precision,answer_relevancy
```

---

## å…«ã€æŠ€æœ¯äº®ç‚¹

1. **ç»Ÿä¸€æ¶æ„**ï¼šæ‰€æœ‰æ¨¡å—éµå¾ªç›¸åŒçš„è®¾è®¡æ¨¡å¼
2. **å¯æ’æ‹”è®¾è®¡**ï¼šæ¨¡å—å¯æ›¿æ¢ã€å¯ç»„åˆ
3. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡çµæ´»é…ç½®
4. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½
5. **è·¨å¹³å°æ”¯æŒ**ï¼šGrepæ£€ç´¢å™¨æ”¯æŒWindows/Linux/Mac

---

## ä¹ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. **ç­‰å¾…ä»£ç æ‹†åˆ†å®Œæˆ**
2. **è¯„ä¼°æ‹†åˆ†åçš„æ–‡ä»¶ç»“æ„**
3. **è°ƒæ•´è¿ç§»è®¡åˆ’ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰**

### ä»£ç æ‹†åˆ†å®Œæˆå

1. **å¯åŠ¨P0è¿ç§»** - åˆ›å»ºRAGService + å‰ç«¯å±‚è¿ç§»
2. **P1è¿ç§»** - PipelineExecutor + åè®®å®šä¹‰
3. **P2è¿ç§»** - ModuleRegistry + é…ç½®é©±åŠ¨
4. **P3è¿ç§»** - äº‹ä»¶é’©å­ + ç­–ç•¥æ²»ç†ï¼ˆå¯é€‰ï¼‰

### æµ‹è¯•å’Œè¯„ä¼°

1. **å•å…ƒæµ‹è¯•** - è¦†ç›–æ‰€æœ‰æ–°æ¨¡å—
2. **é›†æˆæµ‹è¯•** - æµ‹è¯•æ¨¡å—é—´åä½œ
3. **æ€§èƒ½åŸºå‡†æµ‹è¯•** - å»ºç«‹æ€§èƒ½åŸºçº¿

---

## åã€æ€»ç»“

### å·²å®Œæˆå·¥ä½œ

- âœ… Grepæ£€ç´¢å™¨ï¼ˆ~4hï¼‰
- âœ… å¤šç­–ç•¥æ£€ç´¢æ¡†æ¶ï¼ˆ~5hï¼‰
- âœ… Rerankeræ¨¡å—ï¼ˆ~3hï¼‰
- âœ… RAGASè¯„ä¼°å™¨ï¼ˆ~3hï¼‰

**æ€»è®¡**: çº¦15å°æ—¶

### æ ¸å¿ƒæˆæœ

1. **æ£€ç´¢èƒ½åŠ›æå‡**ï¼šä»å•ä¸€ç­–ç•¥åˆ°å¤šç­–ç•¥èåˆ
2. **é‡æ’åºå¯æ’æ‹”**ï¼šæ”¯æŒå¤šç§é‡æ’åºç®—æ³•
3. **è¯„ä¼°èƒ½åŠ›**ï¼šRAGASå¤šç»´åº¦è¯„ä¼°
4. **æ¶æ„ç»Ÿä¸€**ï¼šæ‰€æœ‰æ¨¡å—éµå¾ªç»Ÿä¸€è®¾è®¡æ¨¡å¼

### æ¶æ„æ¼”è¿›

```
Phase 1: Top-kæ£€ç´¢ï¼ˆå½“å‰ï¼‰
    â†“
Phase 2: å¤šç­–ç•¥æ£€ç´¢ + Grep + é‡æ’åºï¼ˆâœ… å·²å®Œæˆï¼‰
    â†“
Phase 3: å®Œæ•´æ¨¡å—åŒ–ä¸‰å±‚æ¶æ„ï¼ˆå¾…ä»£ç æ‹†åˆ†å®Œæˆåï¼‰
```

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-01  
**çŠ¶æ€**: âœ… é˜¶æ®µ1å®Œæˆï¼Œç­‰å¾…ä»£ç æ‹†åˆ†  
**ä¸‹ä¸€æ­¥**: P0è¿ç§»ï¼ˆä»£ç æ‹†åˆ†å®Œæˆåï¼‰

