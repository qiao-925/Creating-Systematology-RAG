# æ¨¡å—åŒ–RAGæ¶æ„å®æ–½ - å®Œæ•´æ€»ç»“

> **åˆ›å»ºæ—¶é—´**: 2025-11-01  
> **æ–‡æ¡£ç±»å‹**: å®Œæ•´æ€»ç»“  
> **çŠ¶æ€**: âœ… P0-P3è¿ç§»å…¨éƒ¨å®Œæˆ

---

## ä¸€ã€å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½å®Œæˆäº†**æ¨¡å—åŒ–RAGæ¶æ„**çš„æ‰€æœ‰æ ¸å¿ƒè¿ç§»ä»»åŠ¡ï¼ˆP0-P3ï¼‰ï¼Œä»¥åŠ**é˜¶æ®µ1ï¼šç‹¬ç«‹æ¨¡å—å®æ–½**çš„æ‰€æœ‰ä»»åŠ¡ã€‚

---

## äºŒã€å·²å®Œæˆå·¥ä½œ

### 2.1 é˜¶æ®µ1ï¼šç‹¬ç«‹æ¨¡å—å®æ–½ï¼ˆå…¨éƒ¨å®Œæˆï¼‰âœ…

1. **Grepæ£€ç´¢å™¨**ï¼ˆ~4hï¼‰
   - `src/retrievers/grep_retriever.py`
   - è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/Macï¼‰
   - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æœç´¢

2. **å¤šç­–ç•¥æ£€ç´¢æ¡†æ¶**ï¼ˆ~5hï¼‰
   - `src/retrievers/multi_strategy_retriever.py`
   - `src/retrievers/result_merger.py`
   - `src/retrievers/adapter.py`
   - å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€ç´¢ç­–ç•¥
   - RRFã€åŠ æƒèåˆã€å»é‡

3. **Rerankeræ¨¡å—**ï¼ˆ~3hï¼‰
   - `src/rerankers/base.py`
   - `src/rerankers/sentence_transformer_reranker.py`
   - `src/rerankers/bge_reranker.py`
   - `src/rerankers/factory.py`
   - å¯æ’æ‹”è®¾è®¡

4. **RAGASè¯„ä¼°å™¨**ï¼ˆ~3hï¼‰
   - `src/observers/ragas_evaluator.py`
   - å¤šç»´åº¦è¯„ä¼°æŒ‡æ ‡
   - æ‰¹é‡è¯„ä¼°æ”¯æŒ

5. **è‡ªåŠ¨è·¯ç”±æ¨¡å¼**ï¼ˆ~4hï¼‰
   - `src/routers/query_router.py`
   - æ™ºèƒ½é€‰æ‹©æ£€ç´¢ç­–ç•¥

### 2.2 P0è¿ç§»ï¼šç»Ÿä¸€æœåŠ¡æ¥å£ âœ…

**æ–‡ä»¶**ï¼š
- `src/business/services/rag_service.py` - RAGServiceæ›´æ–°
- `src/business/services/modules/query.py` - æŸ¥è¯¢å¤„ç†
- `src/business/services/modules/index.py` - ç´¢å¼•æ„å»º
- `src/business/services/modules/chat.py` - å¯¹è¯å¤„ç†

**ç‰¹ç‚¹**ï¼š
- âœ… æ”¯æŒModularQueryEngine
- âœ… å‘åå…¼å®¹æ—§QueryEngine
- âœ… ç»Ÿä¸€æœåŠ¡æ¥å£

### 2.3 P1è¿ç§»ï¼šæµæ°´çº¿ç¼–æ’ âœ…

**æ–‡ä»¶**ï¼š
- `src/business/protocols.py` - åè®®å®šä¹‰ï¼ˆå·²å­˜åœ¨ï¼‰
- `src/business/pipeline/executor.py` - PipelineExecutorï¼ˆå·²å­˜åœ¨ï¼‰
- `src/business/pipeline/adapters.py` - ModularQueryEngineé€‚é…å™¨ï¼ˆæ–°å¢ï¼‰
- `src/business/pipeline/adapter_factory.py` - é€‚é…å™¨å·¥å‚ï¼ˆæ–°å¢ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… åè®®é©±åŠ¨
- âœ… æµæ°´çº¿ç¼–æ’
- âœ… ModularQueryEngineé›†æˆ

### 2.4 P2è¿ç§»ï¼šæ¨¡å—æ³¨å†Œä¸­å¿ƒ âœ…

**æ–‡ä»¶**ï¼š
- `src/business/registry.py` - ModuleRegistryå®ç°ï¼ˆæ–°å¢ï¼‰
- `src/business/registry_init.py` - æ¨¡å—æ³¨å†Œåˆå§‹åŒ–ï¼ˆæ–°å¢ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… æ¨¡å—å…ƒæ•°æ®ç®¡ç†
- âœ… YAMLé…ç½®æ”¯æŒ
- âœ… ç‰ˆæœ¬ç®¡ç†

### 2.5 P3è¿ç§»ï¼šäº‹ä»¶é’©å­ + ç­–ç•¥ç®¡ç† âœ…

**æ–‡ä»¶**ï¼š
- `src/business/pipeline/modules/hooks.py` - HookManagerï¼ˆå·²å­˜åœ¨ï¼‰
- `src/business/strategy_manager.py` - StrategyManagerï¼ˆæ–°å¢ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… äº‹ä»¶é’©å­æ”¯æŒ
- âœ… ç­–ç•¥ç®¡ç†
- âœ… A/Bæµ‹è¯•æ”¯æŒ

---

## ä¸‰ã€æ ¸å¿ƒæ¶æ„

### 3.1 ä¸‰å±‚æ¶æ„

```
å‰ç«¯å±‚ï¼ˆPresentationï¼‰
  â”œâ”€ app.py
  â”œâ”€ main.py
  â””â”€ pages/
      â””â”€ è°ƒç”¨ RAGService

ä¸šåŠ¡å±‚ï¼ˆBusinessï¼‰
  â”œâ”€ RAGServiceï¼ˆç»Ÿä¸€æœåŠ¡æ¥å£ï¼‰
  â”œâ”€ PipelineExecutorï¼ˆæµæ°´çº¿ç¼–æ’ï¼‰
  â”œâ”€ ModuleRegistryï¼ˆæ¨¡å—æ³¨å†Œä¸­å¿ƒï¼‰
  â””â”€ StrategyManagerï¼ˆç­–ç•¥ç®¡ç†ï¼‰
      â””â”€ èƒ½åŠ›æ¨¡å—ï¼ˆå¯æ’æ‹”ï¼‰

åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰
  â”œâ”€ Embedding
  â”œâ”€ DataSource
  â”œâ”€ Observer
  â””â”€ Config
```

### 3.2 æ¨¡å—åŒ–è®¾è®¡

**æ£€ç´¢æ¨¡å—**ï¼š
- VectorRetriever
- BM25Retriever
- GrepRetriever
- MultiStrategyRetriever

**åå¤„ç†æ¨¡å—**ï¼š
- SimilarityFilter
- Rerankerï¼ˆå¯æ’æ‹”ï¼‰

**ç”Ÿæˆæ¨¡å—**ï¼š
- DeepSeekGenerator

**æ ¼å¼åŒ–æ¨¡å—**ï¼š
- ResponseFormatter

---

## å››ã€é…ç½®æ›´æ–°

### 4.1 æ–°å¢é…ç½®é¡¹

```bash
# Grepæ£€ç´¢
ENABLE_GREP_RETRIEVAL=false
GREP_DATA_SOURCE_PATH=data/
GREP_ENABLE_REGEX=true
GREP_MAX_RESULTS=10

# å¤šç­–ç•¥æ£€ç´¢
ENABLED_RETRIEVAL_STRATEGIES=vector,bm25,grep
MERGE_STRATEGY=reciprocal_rank_fusion
RETRIEVER_WEIGHTS='{"vector": 1.0, "bm25": 0.8, "grep": 0.6}'
ENABLE_DEDUPLICATION=true

# Reranker
RERANKER_TYPE=sentence-transformer
RERANK_MODEL=BAAI/bge-reranker-base
RERANK_TOP_N=3

# RAGASè¯„ä¼°å™¨
ENABLE_RAGAS=false
RAGAS_METRICS=faithfulness,context_precision,context_recall,answer_relevancy,context_relevancy
RAGAS_BATCH_SIZE=10

# è‡ªåŠ¨è·¯ç”±
ENABLE_AUTO_ROUTING=false

# æ¨¡å—æ³¨å†Œä¸­å¿ƒ
MODULE_CONFIG_PATH=config/modules.yaml
AUTO_REGISTER_MODULES=true
```

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 ä½¿ç”¨RAGService

```python
from src.business.services.rag_service import RAGService

service = RAGService(
    collection_name="default",
    use_modular_engine=True,
    retrieval_strategy="multi",
    enable_auto_routing=True,
)

response = service.query("ç³»ç»Ÿç§‘å­¦æ˜¯ä»€ä¹ˆï¼Ÿ")
```

### 5.2 ä½¿ç”¨PipelineExecutor

```python
from src.business.pipeline.adapter_factory import create_modular_rag_pipeline
from src.business.pipeline.executor import PipelineExecutor
from src.business.protocols import PipelineContext

# åˆ›å»ºæµæ°´çº¿
pipeline = create_modular_rag_pipeline(
    index_manager=index_manager,
    enable_reranking=True,
    enable_formatting=True,
)

# æ‰§è¡ŒæŸ¥è¯¢
executor = PipelineExecutor()
context = PipelineContext(query="ç³»ç»Ÿç§‘å­¦æ˜¯ä»€ä¹ˆï¼Ÿ")
result = executor.execute(pipeline, context)
```

### 5.3 ä½¿ç”¨ModuleRegistry

```python
from src.business.registry import get_registry

registry = get_registry()

# åˆ›å»ºæ¨¡å—å®ä¾‹
module = registry.create_module(
    name="modular_retrieval",
    config={"retrieval_strategy": "multi"},
)
```

### 5.4 ä½¿ç”¨StrategyManager

```python
from src.business.strategy_manager import (
    get_strategy_manager,
    StrategyType,
)

manager = get_strategy_manager()

# å¯ç”¨A/Bæµ‹è¯•
manager.enable_ab_test(StrategyType.RETRIEVAL, enabled=True)

# è·å–ç­–ç•¥
strategy = manager.get_strategy(
    StrategyType.RETRIEVAL,
    enable_ab_test=True,
)
```

---

## å…­ã€æŠ€æœ¯äº®ç‚¹

1. **ç»Ÿä¸€æ¶æ„**ï¼šæ‰€æœ‰æ¨¡å—éµå¾ªç›¸åŒçš„è®¾è®¡æ¨¡å¼
2. **å¯æ’æ‹”è®¾è®¡**ï¼šæ¨¡å—å¯æ›¿æ¢ã€å¯ç»„åˆ
3. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡å’ŒYAMLçµæ´»é…ç½®
4. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½
5. **æµæ°´çº¿ç¼–æ’**ï¼šæ”¯æŒæ¨¡å—åŒ–æ‰§è¡Œæµç¨‹
6. **ç­–ç•¥ç®¡ç†**ï¼šæ”¯æŒA/Bæµ‹è¯•å’Œæ€§èƒ½ç›‘æ§

---

## ä¸ƒã€æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

**æ£€ç´¢æ¨¡å—**ï¼š
- `src/retrievers/grep_retriever.py`
- `src/retrievers/multi_strategy_retriever.py`
- `src/retrievers/result_merger.py`
- `src/retrievers/adapter.py`
- `src/retrievers/__init__.py`

**é‡æ’åºæ¨¡å—**ï¼š
- `src/rerankers/base.py`
- `src/rerankers/sentence_transformer_reranker.py`
- `src/rerankers/bge_reranker.py`
- `src/rerankers/factory.py`
- `src/rerankers/__init__.py`

**è·¯ç”±æ¨¡å—**ï¼š
- `src/routers/query_router.py`
- `src/routers/__init__.py`

**Pipelineæ¨¡å—**ï¼š
- `src/business/pipeline/adapters.py`
- `src/business/pipeline/adapter_factory.py`

**æ³¨å†Œä¸­å¿ƒ**ï¼š
- `src/business/registry.py`
- `src/business/registry_init.py`

**ç­–ç•¥ç®¡ç†**ï¼š
- `src/business/strategy_manager.py`

### æ›´æ–°æ–‡ä»¶

- `src/config/settings.py` - æ–°å¢é…ç½®é¡¹
- `src/query/modular/engine.py` - æ”¯æŒè‡ªåŠ¨è·¯ç”±
- `src/business/services/rag_service.py` - æ”¯æŒModularQueryEngine
- `src/business/pipeline/__init__.py` - å¯¼å‡ºæ–°å¢æ¨¡å—

---

## å…«ã€å¾…å®æ–½ä»»åŠ¡

### 8.1 ç­‰å¾…å¤–éƒ¨ä¾èµ–

- â¸ï¸ **å‰ç«¯å±‚è¿ç§»** - ç­‰å¾…ä»£ç æ‹†åˆ†å®Œæˆ
  - app.pyè¿ç§»åˆ°RAGService
  - main.pyè¿ç§»åˆ°RAGService
  - pages/è¿ç§»åˆ°RAGService

### 8.2 æµ‹è¯•å’Œè¯„ä¼°

- ğŸ“‹ **å•å…ƒæµ‹è¯•** - æå‡æµ‹è¯•è¦†ç›–ç‡
- ğŸ“‹ **æ€§èƒ½åŸºå‡†æµ‹è¯•** - å»ºç«‹æ€§èƒ½åŸºçº¿

---

## ä¹ã€æ€»ç»“

### å·²å®Œæˆå·¥ä½œ

- âœ… Grepæ£€ç´¢å™¨ï¼ˆ~4hï¼‰
- âœ… å¤šç­–ç•¥æ£€ç´¢æ¡†æ¶ï¼ˆ~5hï¼‰
- âœ… Rerankeræ¨¡å—ï¼ˆ~3hï¼‰
- âœ… RAGASè¯„ä¼°å™¨ï¼ˆ~3hï¼‰
- âœ… è‡ªåŠ¨è·¯ç”±æ¨¡å¼ï¼ˆ~4hï¼‰
- âœ… P0è¿ç§»ï¼šRAGServiceæ›´æ–°ï¼ˆ~1hï¼‰
- âœ… P1è¿ç§»ï¼šPipelineExecutor + ModularQueryEngineå¯¹æ¥ï¼ˆ~6hï¼‰
- âœ… P2è¿ç§»ï¼šModuleRegistry + é…ç½®é©±åŠ¨ï¼ˆ~8hï¼‰
- âœ… P3è¿ç§»ï¼šäº‹ä»¶é’©å­ + StrategyManagerï¼ˆ~10hï¼‰

**æ€»è®¡**: çº¦44å°æ—¶å·¥ä½œé‡

### æ ¸å¿ƒæˆæœ

1. **æ£€ç´¢èƒ½åŠ›æå‡**ï¼šä»å•ä¸€ç­–ç•¥åˆ°å¤šç­–ç•¥èåˆ
2. **é‡æ’åºå¯æ’æ‹”**ï¼šæ”¯æŒå¤šç§é‡æ’åºç®—æ³•
3. **è¯„ä¼°èƒ½åŠ›**ï¼šRAGASå¤šç»´åº¦è¯„ä¼°
4. **æ™ºèƒ½è·¯ç”±**ï¼šè‡ªåŠ¨é€‰æ‹©æ£€ç´¢ç­–ç•¥
5. **æ¶æ„ç»Ÿä¸€**ï¼šæ‰€æœ‰æ¨¡å—éµå¾ªç»Ÿä¸€è®¾è®¡æ¨¡å¼
6. **æµæ°´çº¿ç¼–æ’**ï¼šæ”¯æŒæ¨¡å—åŒ–æ‰§è¡Œæµç¨‹
7. **é…ç½®é©±åŠ¨**ï¼šYAMLé…ç½®æ”¯æŒ
8. **ç­–ç•¥ç®¡ç†**ï¼šæ”¯æŒA/Bæµ‹è¯•

### æ¶æ„æ¼”è¿›

```
Phase 1: Top-kæ£€ç´¢ï¼ˆåŸå§‹ï¼‰
    â†“
Phase 2: å¤šç­–ç•¥æ£€ç´¢ + Grep + é‡æ’åº + è‡ªåŠ¨è·¯ç”±ï¼ˆâœ… å·²å®Œæˆï¼‰
    â†“
Phase 3: å®Œæ•´æ¨¡å—åŒ–ä¸‰å±‚æ¶æ„ï¼ˆâœ… P0-P3è¿ç§»å®Œæˆï¼‰
```

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-11-01  
**çŠ¶æ€**: âœ… P0-P3è¿ç§»å…¨éƒ¨å®Œæˆ  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ä»£ç æ‹†åˆ†å®Œæˆåï¼Œè¿›è¡Œå‰ç«¯å±‚è¿ç§»

