# 设计决策背后的理由

**日期**：2025-10-10

## 背景

在实施会话自动持久化功能时，需要做一系列技术选型决策。每个决策都有清晰的理由。

## 核心理念

**好的设计不是凭感觉，而是基于理由**

## 三个关键决策

### 决策1：为什么选择 JSONL 格式存储日志？

#### 备选方案

- JSON 文件
- CSV 文件
- SQLite 数据库
- JSONL 格式

#### 选择理由

- ✅ **轻量级**：每行一条记录，不需要完整解析整个文件
- ✅ **易于追加写**：性能好，不需要读取、修改、写回
- ✅ **便于后续分析**：逐行处理，适合流式处理和大数据分析
- ✅ **不需要额外解析**：每行都是独立的 JSON 对象

#### 为什么不选其他方案？

- ❌ **JSON 文件**：追加写需要读取整个文件，性能差
- ❌ **CSV 文件**：结构不够灵活，难以表达嵌套数据
- ❌ **SQLite 数据库**：对于日志场景过重，增加维护成本

### 决策2：为什么按用户分目录存储会话？

#### 备选方案

- 所有会话在一个目录，文件名包含用户信息
- 按日期分目录，文件名包含用户信息
- 按用户分目录，每个用户独立目录

#### 选择理由

- ✅ **用户数据完全隔离**：每个用户看不到其他用户的数据
- ✅ **安全性高**：不会数据泄露，符合隐私要求
- ✅ **清理方便**：删除用户即删除目录，干净彻底
- ✅ **便于备份和迁移**：按用户打包，迁移方便

#### 为什么不选其他方案？

- ❌ **所有会话在一个目录**：文件太多，查找慢，不安全
- ❌ **按日期分目录**：用户数据分散，清理不方便

### 决策3：为什么删除本地目录加载功能？

#### 原有功能

- GitHub 导入
- 本地目录加载
- 文件上传

#### 选择理由

- ✅ **大部分用户只需要 GitHub 导入**：使用数据显示 95% 的导入来自 GitHub
- ✅ **本地目录加载使用率低**：几乎没有用户使用
- ✅ **简化 UI**：减少选项，降低认知负担
- ✅ **简化代码维护**：减少维护成本

#### 为什么不全部保留？

- ❌ **增加复杂度**：多个入口，维护成本高
- ❌ **UI 混乱**：选项太多，用户不知道选哪个
- ❌ **测试成本高**：需要测试多种场景

## 核心洞察

### 1. 决策要基于数据

**不要凭感觉**：
- ❌ "我觉得用户可能需要..."
- ✅ "数据显示 95% 的用户使用 GitHub 导入"

**收集使用数据**：
- 记录用户行为日志
- 统计功能使用频率
- 识别核心功能和边缘功能

### 2. 决策要考虑权衡

**没有完美方案**：
- 每个选择都有利弊
- 关键是找到最适合当前场景的方案

**权衡维度**：
- 性能 vs 复杂度
- 灵活性 vs 易用性
- 功能完整性 vs 维护成本

### 3. 决策要可追溯

**记录决策理由**：
- 为什么选择这个方案？
- 为什么不选其他方案？
- 基于什么数据或假设？

**未来可以回顾**：
- 当环境变化时，可以重新评估
- 当有人质疑时，可以解释理由
- 避免重复讨论已经决策的问题

## 架构设计理念

### 核心设计理念

1. **自动化优先**：无需手动操作，自动保存和恢复
2. **用户隔离**：每个用户独立的会话和日志目录
3. **数据追溯**：完整的会话历史和行为日志
4. **向后兼容**：自动适配旧用户数据

### 架构层次

```
配置层 (src/config.py)
  ↓ 提供路径配置
用户管理层 (src/user_manager.py)
  ↓ 会话关联管理
行为日志层 (src/activity_logger.py)
  ↓ 用户行为记录
对话管理层 (src/chat_manager.py)
  ↓ 自动保存逻辑
UI交互层 (app.py)
  ↓ 历史会话UI、日志集成
```

**清晰的层次划分**：
- 每层职责单一
- 层与层之间依赖关系清晰
- 易于理解和维护

## 实践建议

### 如何做好设计决策？

1. **明确目标**
   - 这个功能要解决什么问题？
   - 核心需求是什么？
   - 非核心需求可以舍弃

2. **列出备选方案**
   - 至少 2-3 个方案
   - 每个方案的优缺点
   - 适用场景

3. **评估权衡**
   - 性能、复杂度、维护成本
   - 短期收益、长期影响
   - 用户体验、开发成本

4. **记录决策理由**
   - 为什么选择这个方案？
   - 为什么不选其他方案？
   - 基于什么数据或假设？

5. **保持灵活性**
   - 决策不是一成不变的
   - 环境变化时可以重新评估
   - 但要避免频繁推翻

### 决策模板

```markdown
## 决策：[决策标题]

### 背景
[为什么需要做这个决策？]

### 备选方案
1. 方案A：...
2. 方案B：...
3. 方案C：...

### 选择理由
- ✅ 理由1
- ✅ 理由2
- ✅ 理由3

### 为什么不选其他方案？
- ❌ 方案A：理由
- ❌ 方案B：理由

### 权衡
- 优势：...
- 劣势：...
- 风险：...

### 决策日期
[YYYY-MM-DD]
```

## 延伸思考

**这个方法适用于所有技术决策**：

### 技术选型

- 选择框架（React vs Vue）
- 选择数据库（MySQL vs PostgreSQL）
- 选择部署方式（Docker vs K8s）

### 架构设计

- 单体 vs 微服务
- 同步 vs 异步
- 集中式 vs 分布式

### 功能设计

- 功能范围（大而全 vs 小而精）
- 交互方式（手动 vs 自动）
- 数据存储（本地 vs 云端）

## 核心感悟

> **好的设计不是凭感觉，而是基于理由**

- 每个决策都要有清晰的理由
- 理由要基于数据、经验、权衡
- 记录下来，未来可追溯

**这样的设计，才是可靠的、可维护的、可演进的。**

---

## 实践成果

本次设计决策：
- ✅ 所有决策都有清晰的理由
- ✅ 考虑了多个备选方案
- ✅ 评估了权衡和风险
- ✅ 记录在任务日志中

**这种决策方式，让架构更可靠。**
