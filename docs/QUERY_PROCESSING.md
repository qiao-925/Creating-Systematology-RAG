# 查询处理与策略选择

## 📋 概述

本文档说明查询处理流程（意图理解+改写）和检索策略选择机制。

---

## 🔄 查询处理流程

### 标准化流程

```
用户原始查询
  ↓
QueryProcessor.process()
  ├─ 简单查询 → 直接返回（不走LLM，快速路径）
  └─ 复杂查询 → LLM处理（意图理解+改写，质量路径）
     ↓
策略选择（基于意图理解结果）
  ├─ 有意图理解 → 基于理解结果选择
  └─ 无意图理解 → 规则匹配
     ↓
执行检索（使用改写后的查询）
  ↓
生成答案
```

### 分层决策

- **简单查询**：不走LLM，直接使用原始查询（快速、低成本）
- **复杂查询**：使用LLM同时完成意图理解和查询改写（准确、高质量）

---

## 🔧 核心实现

### QueryProcessor

**位置**：`src/query/modular/query_processor.py`

**功能**：
- 一次LLM调用同时完成意图理解和查询改写
- 分层决策：简单查询跳过LLM
- 缓存机制：LRU缓存，最多100个

**关键方法**：
- `process(query)`: 处理查询，返回意图理解和改写结果

### QueryRouter

**位置**：`src/routers/query_router.py`

**功能**：
- 基于意图理解结果选择检索策略
- 支持规则匹配（兜底）

**关键方法**：
- `route_with_understanding(query, understanding)`: 基于意图理解选择策略

---

## 📊 检索策略

### 支持的策略

1. **vector** - 向量检索（默认）
2. **bm25** - 关键词检索
3. **hybrid** - 混合检索（vector + bm25）
4. **grep** - 正则检索
5. **multi** - 多策略并行检索

### 策略选择逻辑

**自动路由模式**：
- `specific` → `files_via_metadata`
- `exploratory` → `files_via_content`
- 其他 → `chunk`

**固定策略模式**：
- 使用初始化时配置的策略

---

## 📝 日志记录

所有关键步骤都有详细日志：

- 查询处理：原始查询 → 改写后查询
- 处理方式：simple / llm
- 意图理解：类型、复杂度、实体
- 策略选择：决策和原因

---

## 🔗 相关文档

- [检索策略执行流程](RETRIEVAL_STRATEGY_FLOW.md)
- [架构设计](ARCHITECTURE.md)

---

**最后更新**: 2025-11-03

