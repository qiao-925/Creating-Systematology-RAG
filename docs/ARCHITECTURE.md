# æ¶æ„è®¾è®¡æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç³»ç»Ÿç§‘å­¦çŸ¥è¯†åº“RAGåº”ç”¨çš„æ¶æ„è®¾è®¡ã€æ¨¡å—å…³ç³»å’Œå®ç°æ€è·¯

## ç›®å½•

- [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
- [æ¨¡å—è®¾è®¡](#æ¨¡å—è®¾è®¡)
- [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
- [æ ¸å¿ƒæŠ€æœ¯é€‰å‹](#æ ¸å¿ƒæŠ€æœ¯é€‰å‹)
- [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)

---

## æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ç•Œé¢å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Streamlit Web   â”‚         â”‚   CLI å‘½ä»¤è¡Œå·¥å…·         â”‚  â”‚
â”‚  â”‚     (app.py)     â”‚         â”‚     (main.py)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                â”‚
            â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸šåŠ¡é€»è¾‘å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ChatManager     â”‚         â”‚   QueryEngine           â”‚  â”‚
â”‚  â”‚  (å¯¹è¯ç®¡ç†)       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   (æŸ¥è¯¢å¼•æ“)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                               â”‚                  â”‚
â”‚           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   IndexManager            â”‚            â”‚
â”‚                     â”‚   (ç´¢å¼•ç®¡ç†)              â”‚            â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®è®¿é—®å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DataLoader      â”‚         â”‚   Chroma VectorStore    â”‚  â”‚
â”‚  â”‚  (æ•°æ®åŠ è½½)       â”‚         â”‚   (å‘é‡æ•°æ®åº“)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨æœåŠ¡å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DeepSeek API    â”‚         â”‚  HuggingFace Embeddings â”‚  â”‚
â”‚  â”‚  (LLMæœåŠ¡)        â”‚         â”‚  (å‘é‡åŒ–æ¨¡å‹)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œä½è€¦åˆé«˜å†…èš
2. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢
3. **é…ç½®é©±åŠ¨**ï¼šæ‰€æœ‰é…ç½®é›†ä¸­ç®¡ç†ï¼Œæ˜“äºè°ƒæ•´
4. **åˆ†å±‚æ¶æ„**ï¼šæ¸…æ™°çš„å±‚æ¬¡åˆ’åˆ†ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

---

## æ¨¡å—è®¾è®¡

### 1. é…ç½®ç®¡ç†æ¨¡å—ï¼ˆsrc/config.pyï¼‰

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®å‚æ•°

**æ ¸å¿ƒç±»**ï¼š`Config`

**è®¾è®¡æ€è·¯**ï¼š
- å•ä¾‹æ¨¡å¼ï¼šå…¨å±€å”¯ä¸€é…ç½®å®ä¾‹
- ç¯å¢ƒå˜é‡ä¼˜å…ˆï¼šæ”¯æŒé€šè¿‡ `.env` æ–‡ä»¶é…ç½®
- è·¯å¾„è‡ªåŠ¨å¤„ç†ï¼šç›¸å¯¹è·¯å¾„è‡ªåŠ¨è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
- é…ç½®éªŒè¯ï¼šå¯åŠ¨æ—¶éªŒè¯é…ç½®å®Œæ•´æ€§

**å…³é”®æ–¹æ³•**ï¼š
```python
class Config:
    def __init__(self):
        # åŠ è½½ç¯å¢ƒå˜é‡
        # åˆå§‹åŒ–å„é¡¹é…ç½®
        
    def validate(self) -> tuple[bool, Optional[str]]:
        # éªŒè¯é…ç½®æ˜¯å¦å®Œæ•´å’Œåˆæ³•
        
    def ensure_directories(self):
        # ç¡®ä¿æ‰€æœ‰å¿…è¦ç›®å½•å­˜åœ¨
```

**æ‰©å±•ç‚¹**ï¼š
- æ·»åŠ æ–°é…ç½®é¡¹ï¼šåœ¨ `__init__` ä¸­æ·»åŠ æ–°å±æ€§
- æ·»åŠ éªŒè¯è§„åˆ™ï¼šåœ¨ `validate` æ–¹æ³•ä¸­æ·»åŠ æ£€æŸ¥é€»è¾‘

---

### 2. æ•°æ®åŠ è½½æ¨¡å—ï¼ˆsrc/data_loader.pyï¼‰

**èŒè´£**ï¼šä»å¤šç§æ•°æ®æºåŠ è½½å’Œé¢„å¤„ç†æ–‡æ¡£

**æ ¸å¿ƒç»„ä»¶**ï¼ˆä½¿ç”¨LlamaIndexå®˜æ–¹ç»„ä»¶ï¼‰ï¼š
- `SimpleDirectoryReader`ï¼šåŠ è½½æœ¬åœ°æ–‡ä»¶ï¼ˆæ”¯æŒ40+æ ¼å¼ï¼‰
- `SimpleWebPageReader`ï¼šæŠ“å–ç½‘é¡µå†…å®¹
- `DocumentProcessor`ï¼šå¯é€‰çš„æ–‡æ¡£é¢„å¤„ç†å·¥å…·

**è®¾è®¡æ€è·¯**ï¼š
- **ä½¿ç”¨å®˜æ–¹ç»„ä»¶**ï¼šé¿å…é‡å¤é€ è½®å­ï¼Œåˆ©ç”¨LlamaIndexæˆç†Ÿçš„å®ç°
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰åŠ è½½å™¨è¿”å›ç»Ÿä¸€çš„ `LlamaDocument` æ ¼å¼
- **å®¹é”™å¤„ç†**ï¼šå†…ç½®é”™è¯¯å¤„ç†ï¼ŒåŠ è½½å¤±è´¥ä¸ä¸­æ–­
- **è‡ªåŠ¨å…ƒæ•°æ®**ï¼šè‡ªåŠ¨æå–æ ‡å‡†å…ƒæ•°æ®ï¼ˆæ–‡ä»¶è·¯å¾„ã€åç§°ã€ç±»å‹ã€æ—¶é—´æˆ³ç­‰ï¼‰

**æ•°æ®æµç¨‹**ï¼š
```
åŸå§‹æ•°æ®æº â†’ LlamaIndex Reader â†’ LlamaDocument â†’ (å¯é€‰)Processor.clean() â†’ æ¸…æ´æ–‡æ¡£
```

**SimpleDirectoryReader ä½¿ç”¨**ï¼š
```python
from llama_index.core import SimpleDirectoryReader

def load_documents_from_directory(directory_path, recursive=True):
    """ä½¿ç”¨å®˜æ–¹SimpleDirectoryReaderåŠ è½½æ–‡æ¡£"""
    reader = SimpleDirectoryReader(
        input_dir=str(directory_path),
        recursive=recursive,
        required_exts=[".md", ".markdown"],  # å¯æ‰©å±•ä¸ºæ›´å¤šæ ¼å¼
        filename_as_id=True,
    )
    return reader.load_data()
```

**SimpleWebPageReader ä½¿ç”¨**ï¼š
```python
from llama_index.readers.web import SimpleWebPageReader

def load_documents_from_urls(urls):
    """ä½¿ç”¨å®˜æ–¹SimpleWebPageReaderåŠ è½½ç½‘é¡µ"""
    reader = SimpleWebPageReader(html_to_text=True)
    return reader.load_data(urls)
```

**ä¼˜åŠ¿**ï¼š
- **ä»£ç ç®€åŒ–**ï¼šä»~300è¡Œå‡å°‘åˆ°~50è¡Œï¼ˆå‡å°‘83%ï¼‰
- **åŠŸèƒ½æ›´å¼º**ï¼šæ”¯æŒ40+æ–‡ä»¶æ ¼å¼ï¼Œæ˜“äºæ‰©å±•
- **ç»´æŠ¤æˆæœ¬ä½**ï¼šå®˜æ–¹ç»´æŠ¤å’Œæ›´æ–°
- **è‡ªåŠ¨å…ƒæ•°æ®**ï¼šæ ‡å‡†åŒ–çš„å…ƒæ•°æ®æå–

**æ‰©å±•ç‚¹**ï¼š
- æ–°å¢æ–‡ä»¶æ ¼å¼ï¼šåœ¨`required_exts`ä¸­æ·»åŠ æ‰©å±•åï¼ˆå¦‚`.pdf`ã€`.docx`ï¼‰
- è‡ªå®šä¹‰å…ƒæ•°æ®ï¼šä½¿ç”¨`file_metadata`å‚æ•°æ·»åŠ è‡ªå®šä¹‰å…ƒæ•°æ®æå–é€»è¾‘
- è‡ªå®šä¹‰é¢„å¤„ç†ï¼šä½¿ç”¨`DocumentProcessor`è¿›è¡Œæ–‡æœ¬æ¸…ç†

---

### 3. ç´¢å¼•æ„å»ºæ¨¡å—ï¼ˆsrc/indexer.pyï¼‰

**èŒè´£**ï¼šæ„å»ºå’Œç®¡ç†å‘é‡ç´¢å¼•

**æ ¸å¿ƒç±»**ï¼š`IndexManager`

**è®¾è®¡æ€è·¯**ï¼š
- **å‘é‡å­˜å‚¨æŠ½è±¡**ï¼šä½¿ç”¨ LlamaIndex çš„æŠ½è±¡å±‚ï¼Œä¾¿äºåˆ‡æ¢å‘é‡æ•°æ®åº“
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šä½¿ç”¨ Chroma çš„ PersistentClient
- **å¢é‡æ›´æ–°**ï¼šæ”¯æŒåœ¨ç°æœ‰ç´¢å¼•ä¸Šæ·»åŠ æ–°æ–‡æ¡£
- **å…¨å±€é…ç½®**ï¼šé€šè¿‡ LlamaIndex çš„ Settings é…ç½® embedding æ¨¡å‹

**åˆå§‹åŒ–æµç¨‹**ï¼š
```
1. åŠ è½½ Embedding æ¨¡å‹ï¼ˆHuggingFaceï¼‰
   â†“
2. é…ç½® LlamaIndex Settingsï¼ˆå…¨å±€é…ç½®ï¼‰
   â†“
3. åˆå§‹åŒ– Chroma å®¢æˆ·ç«¯ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰
   â†“
4. åˆ›å»ºæˆ–è·å– Collection
   â†“
5. æ„å»º VectorStore å’Œ StorageContext
```

**ç´¢å¼•æ„å»ºæµç¨‹**ï¼š
```
æ–‡æ¡£åˆ—è¡¨ â†’ SentenceSplitter (åˆ†å—) â†’ Embedding (å‘é‡åŒ–) â†’ Chroma (å­˜å‚¨)
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class IndexManager:
    def build_index(self, documents: List[LlamaDocument]) -> VectorStoreIndex:
        # 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰ç´¢å¼•
        # 2. å¦‚æœæ²¡æœ‰ï¼šVectorStoreIndex.from_documents()
        # 3. å¦‚æœå·²æœ‰ï¼šé€ä¸ª insert() æ–‡æ¡£
        # 4. è¿”å›ç´¢å¼•å¯¹è±¡
        
    def get_index(self) -> VectorStoreIndex:
        # 1. å¦‚æœå†…å­˜ä¸­æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›
        # 2. å¦åˆ™å°è¯•ä»å‘é‡å­˜å‚¨åŠ è½½
        # 3. éƒ½æ²¡æœ‰åˆ™åˆ›å»ºç©ºç´¢å¼•
```

**åˆ†å—ç­–ç•¥**ï¼š
- ä½¿ç”¨ `SentenceSplitter`ï¼ˆLlamaIndex å†…ç½®ï¼‰
- `chunk_size=512`ï¼šæ¯å—æœ€å¤š 512 tokens
- `chunk_overlap=50`ï¼šç›¸é‚»å—é‡å  50 tokensï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯

**æ‰©å±•ç‚¹**ï¼š
- åˆ‡æ¢å‘é‡æ•°æ®åº“ï¼šæ›¿æ¢ `ChromaVectorStore` ä¸ºå…¶ä»–å®ç°
- è‡ªå®šä¹‰åˆ†å—ï¼šä¿®æ”¹ `chunk_size` å’Œ `chunk_overlap`
- åˆ‡æ¢ Embedding æ¨¡å‹ï¼šä¿®æ”¹é…ç½®ä¸­çš„ `EMBEDDING_MODEL`

---

### 4. æŸ¥è¯¢å¼•æ“æ¨¡å—ï¼ˆsrc/query_engine.pyï¼‰

**èŒè´£**ï¼šå¤„ç†ç”¨æˆ·æŸ¥è¯¢ï¼Œç”Ÿæˆå¸¦å¼•ç”¨çš„ç­”æ¡ˆ

**æ ¸å¿ƒç±»**ï¼š
- `QueryEngine`ï¼šå¸¦å¼•ç”¨æº¯æºçš„æŸ¥è¯¢å¼•æ“
- `SimpleQueryEngine`ï¼šç®€å•æŸ¥è¯¢å¼•æ“ï¼ˆæ— å¼•ç”¨ï¼‰

**è®¾è®¡æ€è·¯**ï¼š
- **å¼•ç”¨æº¯æºæ ¸å¿ƒ**ï¼šä½¿ç”¨ LlamaIndex çš„ `CitationQueryEngine`
- **LLM æŠ½è±¡**ï¼šé€šè¿‡ OpenAI å…¼å®¹æ¥å£é›†æˆ DeepSeek
- **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šæŸ¥è¯¢é€»è¾‘ä¸ LLM é…ç½®åˆ†ç¦»

**æŸ¥è¯¢æµç¨‹ï¼ˆCitationQueryEngineï¼‰**ï¼š
```
ç”¨æˆ·é—®é¢˜
  â†“
1. å‘é‡æ£€ç´¢ï¼ˆRetrievalï¼‰
   - å°†é—®é¢˜å‘é‡åŒ–
   - åœ¨ Chroma ä¸­æœç´¢ top_k ä¸ªç›¸ä¼¼æ–‡æ¡£å—
  â†“
2. ä¸Šä¸‹æ–‡æ„å»ºï¼ˆContext Buildingï¼‰
   - æ•´ç†æ£€ç´¢åˆ°çš„æ–‡æ¡£å—
   - æ„å»º prompt ä¸Šä¸‹æ–‡
  â†“
3. LLM ç”Ÿæˆï¼ˆGenerationï¼‰
   - è°ƒç”¨ DeepSeek API
   - ç”Ÿæˆç­”æ¡ˆå¹¶æ ‡æ³¨å¼•ç”¨
  â†“
4. ç»“æœè¿”å›
   - ç­”æ¡ˆæ–‡æœ¬
   - å¼•ç”¨æ¥æºåˆ—è¡¨ï¼ˆsource_nodesï¼‰
```

**æ ¸å¿ƒå®ç°**ï¼š
```python
class QueryEngine:
    def __init__(self, index_manager, ...):
        # 1. é…ç½® DeepSeek LLM
        self.llm = OpenAI(
            api_key=...,
            api_base="https://api.deepseek.com/v1",
            model="deepseek-chat",
            temperature=0.1  # ä½æ¸©åº¦ï¼Œæ›´ç¨³å®š
        )
        
        # 2. åˆ›å»º CitationQueryEngine
        self.query_engine = CitationQueryEngine.from_args(
            index,
            llm=self.llm,
            similarity_top_k=3,  # æ£€ç´¢3ä¸ªæœ€ç›¸ä¼¼æ–‡æ¡£
            citation_chunk_size=512  # å¼•ç”¨å—å¤§å°
        )
    
    def query(self, question: str) -> Tuple[str, List[dict]]:
        # 1. æ‰§è¡ŒæŸ¥è¯¢
        response = self.query_engine.query(question)
        
        # 2. æå–ç­”æ¡ˆå’Œå¼•ç”¨
        answer = str(response)
        sources = extract_sources(response.source_nodes)
        
        return answer, sources
```

**DeepSeek é›†æˆè¦ç‚¹**ï¼š
- ä½¿ç”¨ OpenAI SDKï¼ˆDeepSeek å…¼å®¹ OpenAI APIï¼‰
- è®¾ç½® `api_base` æŒ‡å‘ DeepSeek ç«¯ç‚¹
- `temperature=0.1`ï¼šé™ä½éšæœºæ€§ï¼Œæé«˜ç­”æ¡ˆç¨³å®šæ€§

**æ‰©å±•ç‚¹**ï¼š
- åˆ‡æ¢ LLMï¼šä¿®æ”¹ `api_base` å’Œ `model` å‚æ•°
- è°ƒæ•´æ£€ç´¢æ•°é‡ï¼šä¿®æ”¹ `similarity_top_k`
- è‡ªå®šä¹‰ Promptï¼šç»§æ‰¿ `CitationQueryEngine` å¹¶é‡å†™ prompt

---

### 5. å¯¹è¯ç®¡ç†æ¨¡å—ï¼ˆsrc/chat_manager.pyï¼‰

**èŒè´£**ï¼šç®¡ç†å¤šè½®å¯¹è¯ã€ä¸Šä¸‹æ–‡è®°å¿†å’Œä¼šè¯æŒä¹…åŒ–

**æ ¸å¿ƒç±»**ï¼š
- `ChatTurn`ï¼šå•è½®å¯¹è¯æ•°æ®ç»“æ„
- `ChatSession`ï¼šä¼šè¯ç®¡ç†
- `ChatManager`ï¼šå¯¹è¯ç®¡ç†å™¨

**è®¾è®¡æ€è·¯**ï¼š
- **æ•°æ®ç»“æ„åˆ†ç¦»**ï¼šå¯¹è¯æ•°æ®ï¼ˆChatSessionï¼‰ä¸ç®¡ç†é€»è¾‘ï¼ˆChatManagerï¼‰åˆ†ç¦»
- **è®°å¿†ç®¡ç†**ï¼šä½¿ç”¨ LlamaIndex çš„ `ChatMemoryBuffer`
- **ä¼šè¯æŒä¹…åŒ–**ï¼šJSON æ ¼å¼ä¿å­˜ï¼Œä¾¿äºæŸ¥çœ‹å’Œæ¢å¤

**å¯¹è¯æµç¨‹**ï¼š
```
ç”¨æˆ·æ¶ˆæ¯
  â†“
1. å†å²ä¸Šä¸‹æ–‡åŠ è½½ï¼ˆä» Memoryï¼‰
  â†“
2. é—®é¢˜å‹ç¼©ï¼ˆCondense Questionï¼‰
   - ç»“åˆå†å²å¯¹è¯ç†è§£å½“å‰é—®é¢˜
   - ç”Ÿæˆç‹¬ç«‹çš„æŸ¥è¯¢è¯­å¥
  â†“
3. æ–‡æ¡£æ£€ç´¢ï¼ˆåŒ QueryEngineï¼‰
  â†“
4. ä¸Šä¸‹æ–‡å¯¹è¯ç”Ÿæˆ
   - ç»“åˆæ£€ç´¢å†…å®¹å’Œå¯¹è¯å†å²
   - ç”Ÿæˆè¿è´¯å›ç­”
  â†“
5. æ›´æ–°è®°å¿†
   - ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œ AI å›ç­”
  â†“
6. ä¿å­˜åˆ°ä¼šè¯å†å²
```

**CondensePlusContextChatEngine å·¥ä½œåŸç†**ï¼š
```
å†å²å¯¹è¯ï¼š
  User: ä»€ä¹ˆæ˜¯ç³»ç»Ÿç§‘å­¦ï¼Ÿ
  AI: ç³»ç»Ÿç§‘å­¦æ˜¯ç ”ç©¶ç³»ç»Ÿä¸€èˆ¬è§„å¾‹çš„å­¦ç§‘...
  
å½“å‰é—®é¢˜ï¼š
  User: å®ƒæœ‰å“ªäº›åˆ†æ”¯ï¼Ÿ

å¤„ç†æµç¨‹ï¼š
  1. Condense: "å®ƒ" â†’ "ç³»ç»Ÿç§‘å­¦"
     ç”Ÿæˆç‹¬ç«‹é—®é¢˜: "ç³»ç»Ÿç§‘å­¦æœ‰å“ªäº›åˆ†æ”¯ï¼Ÿ"
  2. Retrieve: æ£€ç´¢ç›¸å…³æ–‡æ¡£
  3. Generate: ç»“åˆä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ
```

**ä¼šè¯æŒä¹…åŒ–**ï¼š
```python
class ChatSession:
    def save(self, save_dir: Path):
        # åºåˆ—åŒ–ä¸º JSON
        data = {
            'session_id': self.session_id,
            'created_at': self.created_at,
            'history': [turn.to_dict() for turn in self.history]
        }
        # ä¿å­˜åˆ°æ–‡ä»¶
        
    @classmethod
    def load(cls, file_path: Path):
        # ä» JSON æ–‡ä»¶åŠ è½½
        # ååºåˆ—åŒ–ä¸ºå¯¹è±¡
```

**æ‰©å±•ç‚¹**ï¼š
- è‡ªå®šä¹‰è®°å¿†ç­–ç•¥ï¼šæ›¿æ¢ `ChatMemoryBuffer`
- è°ƒæ•´è®°å¿†å®¹é‡ï¼šä¿®æ”¹ `memory_token_limit`
- æ·»åŠ ä¼šè¯å…ƒæ•°æ®ï¼šæ‰©å±• `ChatSession` ç±»

---

## æ•°æ®æµç¨‹

### å®Œæ•´æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataLoader.load()      â”‚  â† Markdown/URL
â”‚  è¿”å› LlamaDocument[]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IndexManager           â”‚
â”‚  .build_index()         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. SentenceSplitter     â”‚  â† åˆ†å—
â”‚ 2. HuggingFace Embed    â”‚  â† å‘é‡åŒ–
â”‚ 3. Chroma.add()         â”‚  â† å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é‡ç´¢å¼•å·²å°±ç»ª          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

--- æŸ¥è¯¢é˜¶æ®µ ---

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æé—®        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QueryEngine/ChatManagerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. é—®é¢˜å‘é‡åŒ–           â”‚  â† HuggingFace Embed
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. å‘é‡ç›¸ä¼¼åº¦æœç´¢       â”‚  â† Chroma.search()
â”‚     è¿”å› top_k æ–‡æ¡£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ„å»º Prompt          â”‚
â”‚     é—®é¢˜ + æ£€ç´¢æ–‡æ¡£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è°ƒç”¨ DeepSeek API    â”‚  â† LLM ç”Ÿæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è¿”å›ç­”æ¡ˆ + å¼•ç”¨æ¥æº   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæŠ€æœ¯é€‰å‹

### LlamaIndex æ¶æ„é›†æˆ

**ä¸ºä»€ä¹ˆé€‰æ‹© LlamaIndexï¼Ÿ**
- ä¸“é—¨ä¸º RAG åœºæ™¯è®¾è®¡
- å†…ç½®å¼•ç”¨æº¯æºåŠŸèƒ½
- æŠ½è±¡å±‚è®¾è®¡è‰¯å¥½ï¼Œæ˜“äºåˆ‡æ¢åº•å±‚å®ç°
- æ´»è·ƒçš„ç¤¾åŒºå’Œå®Œå–„çš„æ–‡æ¡£

**LlamaIndex æ ¸å¿ƒæ¦‚å¿µæ˜ å°„**ï¼š

| LlamaIndex æ¦‚å¿µ | æœ¬é¡¹ç›®ä½¿ç”¨ | è¯´æ˜ |
|----------------|-----------|------|
| Document | LlamaDocument | åŸå§‹æ–‡æ¡£ |
| Node | è‡ªåŠ¨åˆ›å»º | æ–‡æ¡£åˆ†å—åçš„èŠ‚ç‚¹ |
| VectorStoreIndex | IndexManager | å‘é‡ç´¢å¼• |
| VectorStore | ChromaVectorStore | å‘é‡å­˜å‚¨åç«¯ |
| Embedding | HuggingFaceEmbedding | å‘é‡åŒ–æ¨¡å‹ |
| LLM | OpenAI (DeepSeek) | å¤§è¯­è¨€æ¨¡å‹ |
| QueryEngine | CitationQueryEngine | æŸ¥è¯¢å¼•æ“ |
| ChatEngine | CondensePlusContextChatEngine | å¯¹è¯å¼•æ“ |

### Chroma æ•°æ®æŒä¹…åŒ–

**å­˜å‚¨ç»“æ„**ï¼š
```
vector_store/
â””â”€â”€ chroma.sqlite3          # SQLite æ•°æ®åº“
    â”œâ”€â”€ collections è¡¨       # é›†åˆä¿¡æ¯
    â”œâ”€â”€ embeddings è¡¨        # å‘é‡æ•°æ®
    â””â”€â”€ documents è¡¨         # æ–‡æ¡£å…ƒæ•°æ®
```

**ä¸ºä»€ä¹ˆé€‰æ‹© Chromaï¼Ÿ**
- è½»é‡çº§ï¼šå•æœºéƒ¨ç½²ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- æŒä¹…åŒ–ï¼šæ”¯æŒæœ¬åœ°æ–‡ä»¶å­˜å‚¨
- æ€§èƒ½ï¼šå¯¹äºä¸­ç­‰è§„æ¨¡ï¼ˆ<1000 æ–‡æ¡£ï¼‰è¶³å¤Ÿå¿«
- æ˜“ç”¨ï¼šPython API ç®€æ´ç›´è§‚

### DeepSeek API é›†æˆ

**API å…¼å®¹æ€§**ï¼š
```python
# DeepSeek å…¼å®¹ OpenAI API æ ¼å¼
OpenAI(
    api_key="sk-xxx",
    api_base="https://api.deepseek.com/v1",  # å…³é”®ï¼šæŒ‡å‘ DeepSeek
    model="deepseek-chat"
)
```

**è¯·æ±‚æµç¨‹**ï¼š
```
LlamaIndex â†’ OpenAI SDK â†’ DeepSeek API â†’ è¿”å›ç”Ÿæˆæ–‡æœ¬
```

---

## æ‰©å±•æŒ‡å—

### 1. æ·»åŠ æ–°çš„æ•°æ®æº

**æ­¥éª¤**ï¼š

1. åˆ›å»ºæ–°çš„ Loader ç±»ï¼š

```python
# src/data_loader.py

class PDFLoader:
    def load_file(self, file_path: Path) -> Optional[LlamaDocument]:
        # 1. è¯»å– PDF
        # 2. æå–æ–‡æœ¬
        # 3. æ„å»ºå…ƒæ•°æ®
        # 4. è¿”å› LlamaDocument
        pass
```

2. æ·»åŠ ä¾¿æ·å‡½æ•°ï¼š

```python
def load_documents_from_pdfs(directory: Path) -> List[LlamaDocument]:
    loader = PDFLoader()
    return loader.load_directory(directory)
```

3. åœ¨ UI ä¸­é›†æˆï¼ˆå¦‚éœ€è¦ï¼‰ã€‚

### 2. åˆ‡æ¢å‘é‡æ•°æ®åº“

**ä» Chroma åˆ‡æ¢åˆ° Qdrant**ï¼š

```python
# src/indexer.py

from llama_index.vector_stores.qdrant import QdrantVectorStore
import qdrant_client

class IndexManager:
    def __init__(self, ...):
        # æ›¿æ¢ Chroma
        client = qdrant_client.QdrantClient(path=str(self.persist_dir))
        self.vector_store = QdrantVectorStore(
            client=client,
            collection_name=self.collection_name
        )
        # å…¶ä½™ä»£ç ä¿æŒä¸å˜
```

**ä¼˜åŠ¿**ï¼šLlamaIndex çš„æŠ½è±¡å±‚ä½¿å¾—åˆ‡æ¢æˆæœ¬æä½ï¼

### 3. åˆ‡æ¢ LLM

**ä½¿ç”¨ Azure OpenAI**ï¼š

```python
# src/query_engine.py

from llama_index.llms.azure_openai import AzureOpenAI

class QueryEngine:
    def __init__(self, ...):
        self.llm = AzureOpenAI(
            deployment_name="gpt-4",
            api_key=azure_api_key,
            azure_endpoint=azure_endpoint
        )
        # å…¶ä½™ä»£ç ä¿æŒä¸å˜
```

**ä½¿ç”¨æœ¬åœ° Ollama**ï¼š

```python
from llama_index.llms.ollama import Ollama

self.llm = Ollama(model="llama2", request_timeout=120.0)
```

### 4. è‡ªå®šä¹‰åˆ†å—ç­–ç•¥

**ä½¿ç”¨è¯­ä¹‰åˆ†å—**ï¼š

```python
# src/indexer.py

from llama_index.core.node_parser import SemanticSplitterNodeParser

Settings.node_parser = SemanticSplitterNodeParser(
    buffer_size=1,
    breakpoint_percentile_threshold=95,
    embed_model=self.embed_model
)
```

### 5. æ·»åŠ æ–°çš„æŸ¥è¯¢æ¨¡å¼

**å®ç°æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰**ï¼š

```python
# src/query_engine.py

class HybridQueryEngine:
    def __init__(self, index_manager):
        # 1. å‘é‡æ£€ç´¢
        self.vector_retriever = index_manager.get_index().as_retriever()
        
        # 2. BM25 å…³é”®è¯æ£€ç´¢
        from llama_index.retrievers.bm25 import BM25Retriever
        self.bm25_retriever = BM25Retriever.from_defaults(...)
        
        # 3. æ··åˆæ£€ç´¢
        from llama_index.core.retrievers import QueryFusionRetriever
        self.retriever = QueryFusionRetriever(
            [self.vector_retriever, self.bm25_retriever],
            similarity_top_k=5,
        )
```

### 6. æ·»åŠ è¯„ä¼°å’Œç›‘æ§

**å®ç°æŸ¥è¯¢è´¨é‡è¯„ä¼°**ï¼š

```python
# æ–°å»º src/evaluator.py

from llama_index.core.evaluation import FaithfulnessEvaluator

class QueryEvaluator:
    def __init__(self, llm):
        self.faithfulness_evaluator = FaithfulnessEvaluator(llm=llm)
    
    def evaluate_response(self, query, response):
        # è¯„ä¼°ç­”æ¡ˆçš„å¿ å®åº¦ï¼ˆæ˜¯å¦åŸºäºæ£€ç´¢å†…å®¹ï¼‰
        result = self.faithfulness_evaluator.evaluate_response(
            query=query,
            response=response
        )
        return result.passing  # True/False
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Embedding æ¨¡å‹ä¼˜åŒ–

**å½“å‰**ï¼šæœ¬åœ° bge-base-zh-v1.5ï¼ˆçº¦400MBï¼‰

**ä¼˜åŒ–é€‰é¡¹**ï¼š
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹ï¼š`m3e-small`ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
- ä½¿ç”¨ APIï¼šåˆ‡æ¢åˆ° OpenAI embeddingsï¼ˆæ›´å¿«ï¼Œä½†æœ‰æˆæœ¬ï¼‰
- GPU åŠ é€Ÿï¼šé…ç½® CUDA åŠ é€Ÿå‘é‡åŒ–

### 2. ç´¢å¼•ä¼˜åŒ–

**æ‰¹é‡ç´¢å¼•**ï¼š
```python
# ä¸æ¨èï¼šé€ä¸ªæ’å…¥
for doc in documents:
    index.insert(doc)

# æ¨èï¼šæ‰¹é‡æ’å…¥
index = VectorStoreIndex.from_documents(documents, ...)
```

**å¢é‡ç´¢å¼•ç­–ç•¥**ï¼š
```python
# åªç´¢å¼•æ–°æ–‡æ¡£
new_docs = filter_new_documents(documents)
index_manager.build_index(new_docs)
```

### 3. æŸ¥è¯¢ä¼˜åŒ–

**ç¼“å­˜å¸¸è§æŸ¥è¯¢**ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_query(question: str):
    return query_engine.query(question)
```

**è°ƒæ•´æ£€ç´¢æ•°é‡**ï¼š
```python
# æ ¹æ®æ–‡æ¡£æ•°é‡åŠ¨æ€è°ƒæ•´
if doc_count < 100:
    similarity_top_k = 3
elif doc_count < 500:
    similarity_top_k = 5
else:
    similarity_top_k = 10
```

---

## æ€»ç»“

æœ¬æ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒç†å¿µï¼š

1. **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
2. **å¯æ‰©å±•**ï¼šé€šè¿‡æŠ½è±¡å’Œæ¥å£è®¾è®¡ï¼Œæ”¯æŒçµæ´»æ›¿æ¢å’Œæ‰©å±•
3. **é…ç½®é©±åŠ¨**ï¼šæ‰€æœ‰å…³é”®å‚æ•°å¯é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
4. **æ–‡æ¡£ä¼˜å…ˆ**ï¼šè¯¦ç»†çš„æ–‡æ¡£å’Œæ³¨é‡Šï¼Œé™ä½ç†è§£é—¨æ§›

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œå¼€å‘è€…åº”è¯¥èƒ½å¤Ÿï¼š
- ç†è§£æ•´ä½“æ¶æ„å’Œæ•°æ®æµç¨‹
- å¿«é€Ÿå®šä½éœ€è¦ä¿®æ”¹çš„æ¨¡å—
- æ‰©å±•æ–°åŠŸèƒ½è€Œä¸ç ´åç°æœ‰ç³»ç»Ÿ
- ä¼˜åŒ–æ€§èƒ½å’Œè°ƒæ•´å‚æ•°

## ç›¸å…³æ–‡æ¡£

- [å¼€å‘è€…æŒ‡å—](DEVELOPER_GUIDE.md) - è¯¦ç»†çš„ä»£ç è¯´æ˜å’Œå¼€å‘æŒ‡å—
- [APIå‚è€ƒ](API.md) - å®Œæ•´çš„APIæ¥å£æ–‡æ¡£
- [æŠ€æœ¯å†³ç­–](DECISIONS.md) - æŠ€æœ¯é€‰å‹çš„åŸå› å’Œè€ƒé‡
- [å¼€å‘æ—¥å¿—](CHANGELOG.md) - é¡¹ç›®è¿›å±•è®°å½•

ç¥å¼€å‘æ„‰å¿«ï¼ğŸš€

